<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shared Event Countdowns</title>
  <style>
    :root {
      /* Typography Scale */
      --font-size-xs: 11px;
      --font-size-sm: 13px;
      --font-size-base: 15px;
      --font-size-lg: 18px;
      --font-size-xl: 22px;
      --font-size-2xl: 28px;
      --font-size-3xl: 36px;
      
      /* Font Weights */
      --font-weight-normal: 400;
      --font-weight-medium: 500;
      --font-weight-semibold: 600;
      --font-weight-bold: 700;
      
      /* Spacing Scale */
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-8: 32px;
      --space-10: 40px;
      
      /* Border Radius Scale */
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 14px;
      --radius-xl: 18px;
      
      /* Colors */
      --bg: #ffffff;
      --card: #ffffff;
      --text: #1a1a2e;
      --muted: #6b7280;
      --accent: #667eea;
      --accent2: #764ba2;
      --danger: #ef4444;
      --success: #10b981;
      --shadow: 0 2px 8px rgba(0,0,0,0.08);
      --shadow-hover: 0 4px 16px rgba(0,0,0,0.12);
      --border: #e5e7eb;
      --font: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --input-bg: #ffffff;
      --day-other: #fafafa;
      --day-hover: #f9fafb;
      --btn-secondary-bg: #f3f4f6;
      --btn-secondary-hover: #e5e7eb;
      --focus-ring: 0 0 0 3px rgba(102, 126, 234, 0.4);
    }

    body.dark {
      --bg: #0f172a;
      --card: #1e293b;
      --text: #f1f5f9;
      --muted: #94a3b8;
      --border: #334155;
      --shadow: 0 2px 8px rgba(0,0,0,0.3);
      --shadow-hover: 0 4px 16px rgba(0,0,0,0.4);
      --input-bg: #1e293b;
      --day-other: #1a2535;
      --day-hover: #273548;
      --btn-secondary-bg: #334155;
      --btn-secondary-hover: #475569;
      --focus-ring: 0 0 0 3px rgba(102, 126, 234, 0.5);
    }

    /* Accessibility: Focus visible */
    :focus-visible {
      outline: none;
      box-shadow: var(--focus-ring);
    }
    
    /* Reduced motion for users who prefer it */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* Priority Colors */
    .priority-urgent { --priority-color: #ef4444; --priority-bg: #fef2f2; }
    .priority-high { --priority-color: #f97316; --priority-bg: #fff7ed; }
    .priority-medium { --priority-color: #eab308; --priority-bg: #fefce8; }
    .priority-low { --priority-color: #22c55e; --priority-bg: #f0fdf4; }
    .priority-none { --priority-color: #6b7280; --priority-bg: var(--day-other); }
    
    body.dark .priority-urgent { --priority-bg: rgba(239, 68, 68, 0.15); }
    body.dark .priority-high { --priority-bg: rgba(249, 115, 22, 0.15); }
    body.dark .priority-medium { --priority-bg: rgba(234, 179, 8, 0.15); }
    body.dark .priority-low { --priority-bg: rgba(34, 197, 94, 0.15); }
    body.dark .priority-none { --priority-bg: var(--day-other); }

    /* Fixed Header Bar */
    .fixed-header-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 20px;
      gap: 12px;
      z-index: 100;
      box-shadow: var(--shadow);
    }
    .header-btn {
      padding: 10px 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--card);
      color: var(--text);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .header-btn:hover {
      background: var(--day-hover);
      border-color: var(--accent);
    }
    .header-btn.icon-only {
      width: 40px;
      height: 40px;
      padding: 0;
      justify-content: center;
      font-size: 18px;
    }
    .header-spacer {
      flex: 1;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font);
      background: var(--bg);
      min-height: 100vh;
      color: var(--text);
    }

    .app-layout {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 520px;
      min-width: 360px;
      max-width: 90vw;
      background: var(--card);
      border-left: 1px solid var(--border);
      padding: var(--space-5);
      display: flex;
      flex-direction: column;
      order: 1;
      transition: transform 0.3s;
      overflow: auto;
      resize: horizontal;
      flex: 0 0 auto;
      box-sizing: border-box;
    }

    .sidebar.hidden {
      transform: translateX(100%);
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
    }

    .main-content {
      flex: 1;
      padding: var(--space-6);
      overflow-y: auto;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    /* Body offset for fixed header */
    body {
      padding-top: 60px;
    }

    .header {
      text-align: center;
      margin-bottom: var(--space-8);
      color: var(--text);
    }
    .header h1 {
      font-size: var(--font-size-3xl);
      font-weight: var(--font-weight-bold);
      margin-bottom: var(--space-2);
      letter-spacing: -0.5px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .header p {
      font-size: 16px;
      color: var(--muted);
    }

    /* Calendar Styles */
    .calendar-container {
      direction: rtl;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      box-shadow: var(--shadow);
      margin-bottom: 14px;
      flex: 0 0 auto;
      overflow: visible;
      width: 100%;
    }
    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      gap: 10px;
    }
    .calendar-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text);
    }
    .calendar-nav {
      display: flex;
      gap: 8px;
    }
    .calendar-nav button {
      width: 36px;
      height: 36px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--card);
      color: var(--text);
      font-size: 18px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .calendar-nav button:hover {
      background: var(--day-hover);
      border-color: var(--accent);
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      grid-auto-rows: minmax(56px, auto);
      gap: 4px;
      margin-top: 8px;
      align-items: stretch;
      width: 100%;
      box-sizing: border-box;
    }
    .calendar-day-name {
      text-align: center;
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      padding: var(--space-2) 0;
    }
    .calendar-day {
      min-height: 56px;
      padding: var(--space-2);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      flex-direction: column;
      background: var(--card);
      overflow: hidden;
    }
    .calendar-day:hover {
      background: var(--day-hover);
      border-color: var(--border);
    }
    .calendar-day.other-month {
      background: var(--day-other);
      opacity: 0.5;
    }
    .calendar-day.today {
      border: 2px solid var(--accent);
      background: rgba(102,126,234,0.05);
    }
    .calendar-day-number {
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-bold);
      margin-bottom: var(--space-1);
      text-align: right;
      letter-spacing: -0.2px;
    }
    .calendar-day.today .calendar-day-number {
      color: var(--accent);
    }
    .calendar-day-events {
      display: flex;
      flex-direction: column;
      gap: var(--space-1);
      overflow: hidden;
      flex: 1;
      justify-content: flex-start;
    }
    .calendar-event-chip {
      font-size: var(--font-size-xs);
      padding: 3px var(--space-2);
      border-radius: var(--radius-sm);
      white-space: normal;
      overflow: visible;
      text-overflow: clip;
      color: white;
      font-weight: var(--font-weight-semibold);
      box-shadow: 0 1px 2px rgba(0,0,0,0.12);
      line-height: 1.25;
    }
    .calendar-more {
      font-size: 10px;
      color: var(--muted);
      text-align: center;
      margin-top: 2px;
    }

    /* Monthly Event List */
    .sidebar-section {
      margin-top: var(--space-5);
      padding-top: var(--space-5);
      border-top: 1px solid var(--border);
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .sidebar-section-title {
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-semibold);
      color: var(--text);
      margin-bottom: var(--space-3);
    }
    .month-events {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
      max-height: 350px;
      overflow-y: auto;
      flex: 1;
      min-height: 180px;
    }
    .month-event-item {
      padding: 10px 12px;
      background: var(--day-other);
      border-radius: 8px;
      border-right: 4px solid var(--accent);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .month-event-color {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .month-event-info {
      flex: 1;
      min-width: 0;
    }
    .month-event-name {
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .month-event-date {
      font-size: var(--font-size-xs);
      color: var(--muted);
      margin-top: 2px;
    }
    .no-events-msg {
      font-size: var(--font-size-sm);
      color: var(--muted);
      text-align: center;
      padding: var(--space-5);
    }

    /* Input Panel */
    .input-panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--space-5);
      box-shadow: var(--shadow);
      margin-bottom: var(--space-5);
      direction: rtl;
    }
    .input-row {
      display: flex;
      gap: var(--space-3);
      align-items: center;
    }
    .input-row input {
      flex: 1;
      padding: var(--space-3) var(--space-4);
      border: 2px solid var(--border);
      border-radius: var(--radius-md);
      font-size: var(--font-size-base);
      transition: border-color 0.2s, box-shadow 0.2s;
      outline: none;
      direction: rtl;
      text-align: right;
      background: var(--input-bg);
      color: var(--text);
    }
    .input-row input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(102,126,234,0.15);
    }
    .input-row input[type="text"] { min-width: 180px; }
    .input-row input[type="datetime-local"] { min-width: 200px; }

    .btn {
      padding: var(--space-3) var(--space-6);
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-semibold);
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: white;
      box-shadow: 0 4px 12px rgba(102,126,234,0.3);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(102,126,234,0.4);
    }
    .btn-primary:active { transform: translateY(0); }
    .btn-ghost {
      background: #fef2f2;
      color: var(--danger);
    }
    .btn-ghost:hover { background: #fee2e2; }
    .btn-cancel {
      background: var(--btn-secondary-bg);
      color: var(--muted);
      display: none;
    }
    .btn-cancel:hover { background: var(--btn-secondary-hover); }

    .event-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .event-row {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 20px;
      box-shadow: var(--shadow);
      transition: transform 0.15s, box-shadow 0.15s, background 0.2s;
    }
    .event-row:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
      border-color: #d1d5db;
    }
    .event-row.highlighted {
      border: 2px solid;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .color-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .event-info {
      flex: 1;
      min-width: 0;
      text-align: right;
    }
    .event-name {
      font-size: 17px;
      font-weight: 600;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .event-date {
      font-size: 13px;
      color: var(--muted);
      margin-top: 3px;
    }

    .star-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      color: #d1d5db;
      font-size: 22px;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }
    .star-btn:hover {
      background: #fef3c7;
      color: #f59e0b;
      transform: scale(1.1);
    }
    .star-btn.active {
      color: #f59e0b;
    }

    .edit-btn {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      color: #9ca3af;
      font-size: 16px;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }
    .edit-btn:hover {
      background: #eff6ff;
      color: var(--accent);
      transform: scale(1.1);
    }

    .timer {
      display: flex;
      gap: 8px;
    }
    .time-unit {
      text-align: center;
      background: var(--day-other);
      border-radius: 8px;
      padding: 8px 12px;
      min-width: 60px;
      transition: all 0.2s;
    }
    .time-unit:hover {
      background: var(--day-hover);
      transform: translateY(-1px);
    }
    .time-val {
      display: block;
      font-size: 22px;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      line-height: 1.2;
    }
    .time-label {
      display: block;
      font-size: 10px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 3px;
    }

    .badge {
      font-size: 11px;
      font-weight: 600;
      padding: 5px 10px;
      border-radius: 20px;
      white-space: nowrap;
    }
    .badge-upcoming {
      background: #ecfdf5;
      color: #059669;
    }
    .badge-ended {
      background: #fef2f2;
      color: #dc2626;
    }

    .delete-btn {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      color: #9ca3af;
      font-size: 20px;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }
    .delete-btn:hover {
      background: #fef2f2;
      color: var(--danger);
      transform: scale(1.1);
    }

    .event-actions {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      color: var(--muted);
      display: none;
    }
    .empty-state svg {
      width: 48px;
      height: 48px;
      margin-bottom: 12px;
      opacity: 0.4;
    }
    .empty-state p {
      font-size: 14px;
    }

    .input-panel.editing {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(102,126,234,0.15);
    }

    /* Undo toast */
    .undo-toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 220;
      display: none;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: white;
      border-radius: 12px;
      box-shadow: var(--shadow-hover);
      font-size: 14px;
    }
    .undo-toast.show { display: flex; }
    .undo-toast button {
      border: none;
      background: rgba(255,255,255,0.2);
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.15s;
    }
    .undo-toast button:hover { background: rgba(255,255,255,0.3); }

    /* Clear confirmation modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 16px;
    }
    .modal-backdrop.open { display: flex; }
    .modal-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 20px;
      max-width: 420px;
      width: 100%;
      box-shadow: var(--shadow-hover);
      text-align: center;
    }
    .modal-card h3 {
      font-size: 18px;
      margin-bottom: 8px;
      color: var(--text);
    }
    .modal-card p {
      color: var(--muted);
      margin-bottom: 16px;
      line-height: 1.4;
    }
    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .modal-actions .btn {
      padding: var(--space-3) var(--space-4);
    }
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    .btn-danger:hover {
      background: #dc2626;
    }
    
    /* Day Drawer/Popover */
    .day-drawer-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 250;
      padding: var(--space-4);
      backdrop-filter: blur(2px);
    }
    .day-drawer-backdrop.open { display: flex; }
    
    .day-drawer {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      width: 100%;
      max-width: 420px;
      max-height: 85vh;
      overflow: hidden;
      box-shadow: var(--shadow-hover);
      display: flex;
      flex-direction: column;
      direction: rtl;
      animation: drawerSlideIn 0.25s ease-out;
    }
    @keyframes drawerSlideIn {
      from { opacity: 0; transform: scale(0.95) translateY(10px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }
    
    .day-drawer-header {
      padding: var(--space-5);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: white;
    }
    .day-drawer-title {
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-bold);
    }
    .day-drawer-subtitle {
      font-size: var(--font-size-sm);
      opacity: 0.9;
      margin-top: var(--space-1);
    }
    .day-drawer-close {
      background: rgba(255,255,255,0.2);
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: var(--font-size-lg);
      cursor: pointer;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .day-drawer-close:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .day-drawer-content {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-4);
    }
    
    .day-drawer-section {
      margin-bottom: var(--space-5);
    }
    .day-drawer-section:last-child {
      margin-bottom: 0;
    }
    .day-drawer-section-title {
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: var(--space-3);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    .day-drawer-section-title .count {
      background: var(--accent);
      color: white;
      font-size: var(--font-size-xs);
      padding: 2px 8px;
      border-radius: 10px;
    }
    
    .day-drawer-empty {
      color: var(--muted);
      font-size: var(--font-size-sm);
      text-align: center;
      padding: var(--space-4);
      background: var(--day-other);
      border-radius: var(--radius-md);
    }
    
    .day-drawer-item {
      padding: var(--space-3);
      background: var(--day-other);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-2);
      display: flex;
      align-items: center;
      gap: var(--space-3);
      cursor: pointer;
      transition: all 0.15s;
      border-right: 3px solid transparent;
    }
    .day-drawer-item:hover {
      background: var(--day-hover);
      border-right-color: var(--accent);
    }
    .day-drawer-item:last-child {
      margin-bottom: 0;
    }
    
    .day-drawer-item-color {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .day-drawer-item-info {
      flex: 1;
      min-width: 0;
    }
    .day-drawer-item-name {
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-medium);
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .day-drawer-item-time {
      font-size: var(--font-size-xs);
      color: var(--muted);
      margin-top: 2px;
    }
    .day-drawer-item-priority {
      font-size: var(--font-size-xs);
      padding: 2px var(--space-2);
      border-radius: var(--radius-sm);
      font-weight: var(--font-weight-medium);
    }
    .day-drawer-item.task-completed .day-drawer-item-name {
      text-decoration: line-through;
      opacity: 0.6;
    }
    
    .day-drawer-actions {
      padding: var(--space-4);
      border-top: 1px solid var(--border);
      display: flex;
      gap: var(--space-2);
    }
    .day-drawer-actions .btn {
      flex: 1;
      padding: var(--space-3) var(--space-4);
      font-size: var(--font-size-sm);
    }

    /* Notes/Description */
    .input-row-notes {
      margin-top: 12px;
    }
    .input-row-notes textarea {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      min-height: 60px;
      max-height: 150px;
      outline: none;
      direction: rtl;
      text-align: right;
      background: var(--input-bg);
      color: var(--text);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .input-row-notes textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(102,126,234,0.15);
    }
    .event-notes {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 40px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .event-notes.expanded {
      max-height: none;
    }
    .notes-toggle {
      font-size: 11px;
      color: var(--accent);
      cursor: pointer;
      margin-top: 2px;
      display: inline-block;
    }
    .notes-toggle:hover {
      text-decoration: underline;
    }

    /* Task Manager Fullscreen Modal */
    .task-manager-overlay {
      position: fixed;
      inset: 0;
      background: var(--bg);
      z-index: 300;
      display: none;
      flex-direction: column;
      overflow: hidden;
    }
    .task-manager-overlay.open {
      display: flex;
    }
    
    .task-manager-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-4) var(--space-6);
      background: var(--card);
      border-bottom: 1px solid var(--border);
      box-shadow: var(--shadow);
      gap: var(--space-4);
      flex-wrap: wrap;
    }
    
    .task-manager-title {
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-bold);
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    
    .task-manager-close {
      width: 40px;
      height: 40px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--card);
      color: var(--text);
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .task-manager-close:hover {
      background: #fef2f2;
      color: var(--danger);
    }
    
    .task-search-bar {
      flex: 1;
      max-width: 500px;
      position: relative;
    }
    .task-search-bar input {
      width: 100%;
      padding: 12px 16px 12px 44px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 15px;
      background: var(--input-bg);
      color: var(--text);
      outline: none;
      transition: all 0.2s;
    }
    .task-search-bar input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(102,126,234,0.15);
    }
    .task-search-bar::before {
      content: 'üîç';
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 16px;
    }
    
    .task-manager-body {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }
    
    /* Quick Add Task */
    .quick-add-task {
      max-width: 600px;
      margin: 0 auto 32px auto;
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      box-shadow: var(--shadow);
      transition: all 0.2s;
    }
    .quick-add-task:focus-within {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(102,126,234,0.15);
    }
    .quick-add-task input[type="text"] {
      width: 100%;
      border: none;
      font-size: 16px;
      padding: 8px 0;
      background: transparent;
      color: var(--text);
      outline: none;
    }
    .quick-add-task input[type="text"]::placeholder {
      color: var(--muted);
    }
    .quick-add-row {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    .quick-add-row .btn {
      padding: 10px 18px;
      font-size: 14px;
    }
    
    /* Color Picker */
    .color-picker {
      display: flex;
      gap: 6px;
    }
    .color-option {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 3px solid transparent;
      cursor: pointer;
      transition: all 0.15s;
    }
    .color-option:hover {
      transform: scale(1.15);
    }
    .color-option.selected {
      border-color: var(--text);
      box-shadow: 0 0 0 2px var(--card);
    }
    
    /* Label/Tag Input */
    .label-input-wrapper {
      display: flex;
      align-items: center;
      gap: 6px;
      background: var(--day-other);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
    }
    .label-input-wrapper input {
      border: none;
      background: transparent;
      font-size: 13px;
      width: 80px;
      color: var(--text);
      outline: none;
    }
    
    /* Task List */
    .task-sections {
      max-width: 900px;
      margin: 0 auto;
    }
    .task-section-title {
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: var(--space-4);
      padding-left: var(--space-2);
    }
    .task-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
      margin-bottom: var(--space-8);
    }
    
    /* Task Item (List style) */
    .task-item {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--space-4) var(--space-5);
      box-shadow: var(--shadow);
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: var(--space-4);
      border-left: 4px solid var(--priority-color, var(--border));
    }
    .task-item:hover {
      box-shadow: var(--shadow-hover);
      background: var(--priority-bg, var(--card));
    }
    .task-item.completed {
      opacity: 0.6;
      background: var(--day-other);
    }
    
    .task-checkbox {
      width: 24px;
      height: 24px;
      border: 2px solid var(--priority-color, var(--border));
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s;
      background: transparent;
      color: transparent;
      font-size: var(--font-size-sm);
    }
    .task-checkbox:hover {
      background: var(--priority-bg, var(--day-hover));
    }
    .task-item.completed .task-checkbox {
      background: var(--priority-color, var(--success));
      border-color: var(--priority-color, var(--success));
      color: white;
    }
    
    .task-main {
      flex: 1;
      min-width: 0;
      cursor: pointer;
    }
    .task-title-row {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      margin-bottom: var(--space-1);
    }
    .task-title {
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-semibold);
      color: var(--text);
      word-break: break-word;
    }
    .task-item.completed .task-title {
      text-decoration: line-through;
      color: var(--muted);
    }
    .task-priority-badge {
      font-size: 10px;
      font-weight: var(--font-weight-bold);
      padding: 3px var(--space-2);
      border-radius: var(--radius-lg);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: var(--priority-color);
      color: white;
      flex-shrink: 0;
    }
    
    .task-meta {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      flex-wrap: wrap;
    }
    .task-due {
      font-size: var(--font-size-sm);
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: var(--space-1);
    }
    .task-due.overdue {
      color: var(--danger);
      font-weight: var(--font-weight-semibold);
    }
    .task-due.soon {
      color: #f97316;
      font-weight: var(--font-weight-semibold);
    }
    .task-countdown {
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-semibold);
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-lg);
      background: var(--day-other);
      color: var(--text);
      font-variant-numeric: tabular-nums;
    }
    .task-countdown.overdue {
      background: #fef2f2;
      color: var(--danger);
    }
    .task-countdown.soon {
      background: #fff7ed;
      color: #f97316;
    }
    
    .task-subtasks {
      margin-top: var(--space-2);
      padding-top: var(--space-2);
      border-top: 1px dashed var(--border);
    }
    .task-subtask {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 0;
      font-size: 14px;
      color: var(--text);
    }
    .task-subtask input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--accent);
      cursor: pointer;
    }
    .task-subtask.checked span {
      text-decoration: line-through;
      color: var(--muted);
    }
    .task-subtask-progress {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    
    .task-actions {
      display: flex;
      gap: 4px;
      flex-shrink: 0;
    }
    .task-action-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 16px;
      cursor: pointer;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    .task-action-btn:hover {
      background: var(--day-hover);
      color: var(--text);
    }
    .task-action-btn.delete:hover {
      background: #fef2f2;
      color: var(--danger);
    }
    
    /* Task Edit Modal */
    .task-edit-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 400;
      padding: 20px;
    }
    .task-edit-modal.open {
      display: flex;
    }
    .task-edit-card {
      background: var(--card);
      border-radius: 16px;
      padding: 24px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .task-edit-card input[type="text"],
    .task-edit-card textarea {
      width: 100%;
      border: none;
      background: transparent;
      color: var(--text);
      outline: none;
      resize: none;
    }
    .task-edit-card input[type="text"] {
      font-size: 20px;
      font-weight: 600;
      padding: 8px 0;
    }
    .task-edit-card textarea {
      font-size: 15px;
      line-height: 1.6;
      min-height: 150px;
      margin-top: 16px;
    }
    
    .task-edit-section {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    .task-edit-section-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 12px;
    }
    
    .checklist-add {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 12px;
    }
    .checklist-add input {
      flex: 1;
      padding: 10px 14px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      background: var(--input-bg);
      color: var(--text);
      outline: none;
    }
    .checklist-add input:focus {
      border-color: var(--accent);
    }
    
    .task-edit-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
      flex-wrap: wrap;
      gap: 12px;
    }
    
    /* Empty Tasks State */
    .tasks-empty {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }
    .tasks-empty-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    .tasks-empty h3 {
      font-size: 20px;
      color: var(--text);
      margin-bottom: 8px;
    }
    .tasks-empty p {
      font-size: 14px;
    }
    
    /* Suggested Tasks Banner */
    .suggested-tasks-banner {
      background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1));
      border: 1px solid var(--accent);
      border-radius: 10px;
      padding: 12px 16px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: var(--text);
    }
    .suggested-tasks-banner .suggested-icon {
      font-size: 18px;
    }
    
    /* Task Subject Tag (when showing suggested) */
    .task-subject-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: rgba(102,126,234,0.15);
      color: var(--accent);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      margin-left: 8px;
    }
    .task-subject-tag .tag-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }
    
    /* Filter Pills */
    .task-filters {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .filter-pill {
      padding: 8px 16px;
      border: 1px solid var(--border);
      border-radius: 20px;
      background: var(--card);
      color: var(--muted);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }
    .filter-pill:hover {
      background: var(--day-hover);
    }
    .filter-pill.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    
    /* Priority Selector */
    .priority-selector {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .priority-option {
      padding: 8px 16px;
      border: 2px solid transparent;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }
    .priority-option:hover {
      transform: scale(1.05);
    }
    .priority-option.selected {
      border-color: var(--text);
    }
    .priority-option[data-priority="urgent"] { background: #fef2f2; color: #ef4444; }
    .priority-option[data-priority="high"] { background: #fff7ed; color: #f97316; }
    .priority-option[data-priority="medium"] { background: #fefce8; color: #eab308; }
    .priority-option[data-priority="low"] { background: #f0fdf4; color: #22c55e; }
    .priority-option[data-priority="none"] { background: var(--day-other); color: var(--muted); }
    
    /* Task Checklist in Edit Modal */
    .task-checklist {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .task-checklist-item {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      padding: 8px 0;
    }
    .task-checklist-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
      cursor: pointer;
    }
    .task-checklist-item.checked span {
      text-decoration: line-through;
      color: var(--muted);
    }
    
    /* Subject Tabs */
    .subject-tabs-container {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      border-bottom: 1px solid var(--border);
      overflow-x: auto;
      background: var(--card);
      flex-wrap: wrap;
    }
    .subject-tabs {
      display: flex;
      gap: 8px;
      flex: 1;
      overflow-x: auto;
      padding: 4px 0;
      flex-wrap: wrap;
    }
    .subject-tabs::-webkit-scrollbar {
      height: 4px;
    }
    .subject-tabs::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }
    .subject-tab {
      padding: 8px 16px;
      border: 2px solid var(--border);
      border-radius: 20px;
      background: var(--card);
      color: var(--muted);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 6px;
      position: relative;
    }
    .subject-tab:hover {
      background: var(--day-hover);
      border-color: var(--accent);
    }
    .subject-tab.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    .subject-tab.smart-view {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: white;
      border: none;
    }
    .subject-tab.smart-view:not(.active) {
      background: var(--day-other);
      color: var(--muted);
    }
    .subject-tab .tab-count {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      background: rgba(255,255,255,0.25);
      min-width: 18px;
      text-align: center;
    }
    .subject-tab:not(.active) .tab-count {
      background: var(--day-other);
      color: var(--muted);
    }
    .subject-tab .tab-color,
    .subject-tab-color {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    
    /* Smart Views Section */
    .smart-views-section {
      display: flex;
      gap: 6px;
      padding-right: 12px;
      border-right: 1px solid var(--border);
      margin-right: 4px;
    }
    
    /* Subject with sub-subjects */
    .subject-tab.has-children .subject-tab-inner {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .subject-tab .expand-arrow {
      font-size: 8px;
      transition: transform 0.2s;
      opacity: 0.7;
    }
    .subject-tab.expanded .expand-arrow {
      transform: rotate(180deg);
    }
    
    /* Sub-subjects list (inline chips) */
    .sub-subjects-inline {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin-left: 4px;
      padding-left: 8px;
      border-left: 2px solid var(--border);
    }
    .sub-subject-chip {
      padding: 4px 10px;
      border-radius: 12px;
      background: var(--day-other);
      color: var(--text);
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.15s;
    }
    .sub-subject-chip:hover {
      background: var(--day-hover);
    }
    .sub-subject-chip.active {
      background: var(--accent);
      color: white;
    }
    .sub-subject-chip .chip-color {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    
    /* Task Manager Layout with Sidebar */
    .task-manager-layout {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    
    .task-manager-sidebar {
      width: 260px;
      min-width: 200px;
      background: var(--card);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .task-manager-sidebar-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .task-manager-sidebar-header h3 {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin: 0;
    }
    
    .task-manager-sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }
    
    /* Collapsible Subject List */
    .subject-list-item {
      margin-bottom: 4px;
    }
    
    .subject-list-header {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
      gap: 8px;
    }
    
    .subject-list-header:hover {
      background: var(--day-hover);
    }
    
    .subject-list-header:hover .subject-actions {
      opacity: 1;
    }
    
    /* Subject Action Buttons */
    .subject-actions {
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.2s;
      margin-right: auto;
    }
    
    .subject-action-btn {
      width: 28px;
      height: 28px;
      border: 1px solid transparent;
      background: rgba(0,0,0,0.05);
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      color: var(--text);
      opacity: 0.8;
    }
    
    body.dark .subject-action-btn {
      background: rgba(255,255,255,0.1);
    }
    
    .subject-action-btn:hover {
      background: rgba(0,0,0,0.15);
      opacity: 1;
      transform: scale(1.1);
      border-color: var(--border);
    }
    
    body.dark .subject-action-btn:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .subject-list-header.active .subject-action-btn {
      background: rgba(255,255,255,0.15);
      color: white;
    }
    
    .subject-list-header.active .subject-action-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .subject-action-btn.delete:hover {
      background: rgba(239, 68, 68, 0.15);
      color: var(--danger);
      border-color: var(--danger);
    }
    
    .subject-child-item .subject-action-btn {
      width: 26px;
      height: 26px;
      font-size: 13px;
    }
    
    .subject-child-item:hover .subject-actions {
      opacity: 1;
    }
    
    .subject-list-header.active {
      background: var(--accent);
      color: white;
    }
    
    .subject-list-header .subject-color-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    
    .subject-list-header .subject-name {
      flex: 1;
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .subject-list-header .subject-count {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 8px;
      background: rgba(0,0,0,0.1);
      color: inherit;
    }
    
    .subject-list-header.active .subject-count {
      background: rgba(255,255,255,0.2);
    }
    
    .subject-list-header .collapse-arrow {
      font-size: 10px;
      transition: transform 0.25s ease;
      opacity: 0.6;
      cursor: pointer;
    }
    
    .subject-list-header .collapse-arrow:hover {
      opacity: 1;
    }
    
    .subject-list-item.expanded .collapse-arrow {
      transform: rotate(180deg);
    }
    
    .subject-list-children {
      padding-right: 20px;
      margin-top: 0;
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transition: max-height 0.3s ease, opacity 0.25s ease, margin-top 0.25s ease;
    }
    
    .subject-list-item.expanded .subject-list-children {
      max-height: 500px; /* Large enough for many children */
      opacity: 1;
      margin-top: 4px;
    }
    
    .subject-child-item {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      gap: 8px;
      margin-bottom: 2px;
      transform: translateX(0);
    }
    
    .subject-child-item:hover {
      background: var(--day-hover);
      transform: translateX(-2px);
    }
    
    .subject-child-item.active {
      background: var(--accent);
      color: white;
    }
    
    .subject-child-item .child-color {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    
    .subject-child-item .child-name {
      flex: 1;
      font-size: 12px;
    }
    
    .subject-child-item .child-count {
      font-size: 10px;
      opacity: 0.7;
    }
    
    /* Smart Views in Sidebar */
    .smart-views-list {
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }
    
    .smart-view-item {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
      gap: 8px;
      margin-bottom: 2px;
    }
    
    .smart-view-item:hover {
      background: var(--day-hover);
    }
    
    .smart-view-item.active {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: white;
    }
    
    .smart-view-item .view-icon {
      font-size: 14px;
    }
    
    .smart-view-item .view-name {
      flex: 1;
      font-size: 13px;
      font-weight: 500;
    }
    
    .smart-view-item .view-count {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 8px;
      background: rgba(0,0,0,0.1);
    }
    
    .smart-view-item.active .view-count {
      background: rgba(255,255,255,0.2);
    }
    
    .subjects-list-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 8px 12px 4px;
    }
    
    /* Add Subject Button in Sidebar */
    .add-subject-sidebar-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border: 2px dashed var(--border);
      border-radius: 8px;
      background: transparent;
      color: var(--muted);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
      width: 100%;
      margin-top: 8px;
    }
    
    .add-subject-sidebar-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(102,126,234,0.05);
    }
    
    /* Context Menu */
    .context-menu {
      position: fixed;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
      padding: 8px;
      min-width: 180px;
      z-index: 1000;
      display: none;
    }
    .context-menu.open {
      display: block;
    }
    .context-menu-item {
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text);
      font-size: 13px;
      transition: background 0.1s;
    }
    .context-menu-item:hover {
      background: var(--day-hover);
    }
    .context-menu-item.danger {
      color: var(--danger);
    }
    .context-menu-item.danger:hover {
      background: #fef2f2;
    }
    .context-menu-divider {
      height: 1px;
      background: var(--border);
      margin: 6px 0;
    }
    
    /* Daily Reminder Modal */
    .reminder-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 600;
      padding: 20px;
    }
    .reminder-modal.open {
      display: flex;
    }
    .reminder-card {
      background: var(--card);
      border-radius: 20px;
      padding: 28px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      text-align: center;
    }
    .reminder-card h2 {
      font-size: 24px;
      margin-bottom: 8px;
      color: var(--text);
    }
    .reminder-card .reminder-date {
      color: var(--muted);
      font-size: 14px;
      margin-bottom: 20px;
    }
    .reminder-section {
      text-align: right;
      margin-bottom: 16px;
    }
    .reminder-section h3 {
      font-size: 14px;
      color: var(--accent);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .reminder-task-item {
      padding: 12px;
      background: var(--day-other);
      border-radius: 10px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
      text-align: right;
    }
    .reminder-task-item .task-priority-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .reminder-task-item .task-info {
      flex: 1;
    }
    .reminder-task-item .task-title {
      font-weight: 600;
      color: var(--text);
      font-size: 14px;
    }
    .reminder-task-item .task-time {
      font-size: 12px;
      color: var(--muted);
    }
    .reminder-empty {
      color: var(--muted);
      font-size: 14px;
      padding: 12px;
    }
    .reminder-actions {
      margin-top: 20px;
    }
    
    /* Natural Language Input Hint */
    .nl-hint {
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
      direction: rtl;
      line-height: 1.6;
    }
    .nl-hint code {
      background: var(--day-other);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: inherit;
      color: var(--accent);
      font-weight: 500;
    }
    .nl-hint-toggle {
      color: var(--accent);
      cursor: pointer;
      text-decoration: underline;
      margin-right: 8px;
    }
    .nl-hint-examples {
      display: none;
      margin-top: 8px;
      padding: 12px;
      background: var(--day-other);
      border-radius: 8px;
      font-size: 11px;
    }
    .nl-hint-examples.show {
      display: block;
    }
    .nl-hint-examples div {
      margin-bottom: 6px;
      padding-bottom: 6px;
      border-bottom: 1px solid var(--border);
    }
    .nl-hint-examples div:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }
    .nl-hint-examples .example-input {
      font-weight: 600;
      color: var(--text);
    }
    .nl-hint-examples .example-result {
      color: var(--muted);
      font-size: 10px;
    }
    
    .add-subject-btn {
      width: 36px;
      height: 36px;
      border: 2px dashed var(--border);
      border-radius: 50%;
      background: transparent;
      color: var(--muted);
      font-size: 20px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .add-subject-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(102,126,234,0.1);
    }
    
    /* Subject Modal */
    .subject-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 500;
      padding: 20px;
    }
    .subject-modal.open {
      display: flex;
    }
    .subject-modal-card {
      background: var(--card);
      border-radius: 16px;
      padding: 24px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .subject-modal-card h3 {
      font-size: 20px;
      margin-bottom: 20px;
      color: var(--text);
    }
    .subject-modal-card input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 15px;
      background: var(--input-bg);
      color: var(--text);
      outline: none;
      margin-bottom: 16px;
    }
    .subject-modal-card input:focus {
      border-color: var(--accent);
    }
    .subject-color-picker {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .subject-color-option {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 3px solid transparent;
      cursor: pointer;
      transition: all 0.15s;
    }
    .subject-color-option:hover {
      transform: scale(1.15);
    }
    .subject-color-option.selected {
      border-color: var(--text);
      box-shadow: 0 0 0 2px var(--card);
    }
    .subject-modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    .subject-modal-actions .btn {
      padding: 12px 20px;
    }
    
    /* Subject badge in task item */
    .task-subject-badge {
      font-size: 11px;
      font-weight: 600;
      padding: 3px 10px;
      border-radius: 12px;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 6px;
      background: color-mix(in srgb, var(--subject-color, #667eea) 15%, transparent);
      color: var(--subject-color, #667eea);
      border: 1px solid color-mix(in srgb, var(--subject-color, #667eea) 30%, transparent);
    }
    .task-subject-badge::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--subject-color, #667eea);
      flex-shrink: 0;
    }
    .task-subject-badge .badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    
    /* Subject selector in quick add */
    .subject-selector {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .subject-selector-option {
      padding: 6px 14px;
      border: 2px solid var(--border);
      border-radius: 16px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .subject-selector-option:hover {
      border-color: var(--accent);
    }
    .subject-selector-option.selected {
      border-color: var(--text);
      background: var(--day-hover);
    }
    .subject-selector-option .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    
    /* Edit subject button */
    .edit-subject-btn {
      padding: 4px 8px;
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 12px;
      cursor: pointer;
      border-radius: 4px;
      margin-left: 4px;
    }
    .edit-subject-btn:hover {
      background: var(--day-hover);
      color: var(--text);
    }

    /* Notification permission button */
    @media (max-width: 1100px) {
      .sidebar {
        position: fixed;
        right: 0;
        top: 0;
        bottom: 0;
        z-index: 50;
        box-shadow: -4px 0 20px rgba(0,0,0,0.1);
      }
      .sidebar.hidden {
        transform: translateX(100%);
      }
    }

    @media (max-width: 640px) {
      .main-content { padding: 12px; padding-top: 70px; }
      .header { margin-bottom: 20px; }
      .header h1 { font-size: 22px; }
      .header p { font-size: 13px; }

      .fixed-header-bar {
        height: 50px;
        padding: 0 12px;
        gap: 8px;
      }
      .header-btn {
        padding: 8px 12px;
        font-size: 12px;
      }
      .header-btn.icon-only {
        width: 36px;
        height: 36px;
      }
      body {
        padding-top: 50px;
      }

      .task-manager-header {
        padding: 12px 16px;
      }
      .task-manager-title {
        font-size: 18px;
      }
      .task-search-bar {
        order: 10;
        max-width: 100%;
        flex-basis: 100%;
      }
      .quick-add-task {
        margin: 0 0 24px 0;
      }
      .task-item {
        flex-wrap: wrap;
      }
      .task-main {
        width: 100%;
        order: 2;
      }
      .task-actions {
        order: 3;
        width: 100%;
        justify-content: center;
        padding-top: 12px;
        border-top: 1px solid var(--border);
        margin-top: 12px;
      }

      .input-panel { padding: 14px; }
      .input-row { 
        flex-direction: column;
        gap: 10px;
      }
      .input-row input { 
        width: 100%;
        padding: 12px 14px;
        font-size: 16px;
      }
      .input-row .btn {
        width: 100%;
        padding: 12px;
      }
      .input-row-notes textarea {
        font-size: 16px;
      }

      .event-row { 
        flex-direction: column;
        align-items: stretch;
        padding: 14px;
        gap: 12px;
      }
      .color-dot { display: none; }
      .event-info {
        order: 1;
        text-align: center;
      }
      .event-name { font-size: 16px; }
      .timer { 
        order: 2;
        width: 100%;
        justify-content: center;
        gap: 6px;
      }
      .time-unit { 
        min-width: 50px;
        padding: 8px 6px;
        flex: 1;
      }
      .time-val { font-size: 18px; }
      .time-label { font-size: 9px; }
      .badge {
        order: 3;
        align-self: center;
      }
      .event-actions {
        order: 4;
        display: flex;
        justify-content: center;
        gap: 16px;
        padding-top: 8px;
        border-top: 1px solid var(--border);
        width: 100%;
      }
      .star-btn, .edit-btn, .delete-btn {
        width: 40px;
        height: 40px;
        font-size: 20px;
      }

      .sidebar {
        width: 100%;
      }
      
      /* Task manager sidebar on mobile */
      .task-manager-layout {
        flex-direction: column;
      }
      
      .task-manager-sidebar {
        width: 100%;
        max-height: 200px;
        border-left: none;
        border-bottom: 1px solid var(--border);
      }
      
      .task-manager-sidebar-content {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 8px;
      }
      
      .smart-views-list {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }
      
      .smart-view-item {
        padding: 6px 10px;
        font-size: 12px;
      }
      
      .subjects-list-title {
        display: none;
      }
      
      .subjects-list {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
      }
      
      .subject-list-item {
        margin-bottom: 0;
      }
      
      .subject-list-header {
        padding: 6px 10px;
      }
      
      .subject-list-children {
        position: absolute;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 8px;
        box-shadow: var(--shadow);
        padding: 8px;
        z-index: 100;
        padding-right: 0;
        margin-top: 0;
      }
      
      .add-subject-sidebar-btn {
        padding: 6px 10px;
        font-size: 12px;
        margin-top: 0;
      }
      
      .calendar-day { min-height: 48px; padding: 6px; }
      .calendar-day-number { font-size: 12px; }
      .calendar-event-chip { font-size: 9px; padding: 2px 4px; }
      .calendar-grid { gap: 4px; }

      .modal-card { padding: 16px; }
      .modal-actions { flex-direction: column; }
      .modal-actions .btn { width: 100%; }
    }
  </style>
</head>
<body>
  <!-- Fixed Header Bar -->
  <div class="fixed-header-bar">
    <button class="header-btn" id="toggleSidebar">üìÖ ◊ú◊ï◊ó ◊©◊†◊î</button>
    <button class="header-btn" id="toggleTasks">üìù ◊û◊©◊ô◊û◊ï◊™</button>
    <div class="header-spacer"></div>
    <button class="header-btn icon-only" id="themeToggle" aria-label="Toggle dark mode">üåô</button>
  </div>

  <!-- Task Manager Fullscreen -->
  <div class="task-manager-overlay" id="taskManagerOverlay">
    <div class="task-manager-header">
      <div class="task-manager-title">üìù Task Manager</div>
      <div class="task-search-bar">
        <input type="text" id="taskSearch" placeholder="◊ó◊ô◊§◊ï◊© ◊û◊©◊ô◊û◊ï◊™... / Search tasks..." />
      </div>
      <div class="task-filters">
        <button class="filter-pill active" data-filter="all">◊î◊õ◊ú</button>
        <button class="filter-pill" data-filter="active">◊§◊¢◊ô◊ú</button>
        <button class="filter-pill" data-filter="completed">◊î◊ï◊©◊ú◊ù</button>
      </div>
      <button class="task-manager-close" id="closeTaskManager" aria-label="◊°◊í◊ï◊® ◊û◊†◊î◊ú ◊û◊©◊ô◊û◊ï◊™">√ó</button>
    </div>
    
    <!-- Task Manager Layout with Sidebar -->
    <div class="task-manager-layout">
      <!-- Sidebar -->
      <div class="task-manager-sidebar" id="taskSidebar">
        <div class="task-manager-sidebar-header">
          <h3>üìö ◊†◊ï◊©◊ê◊ô◊ù</h3>
        </div>
        <div class="task-manager-sidebar-content">
          <!-- Smart Views -->
          <div class="smart-views-list" id="smartViewsList">
            <div class="smart-view-item" data-view="all">
              <span class="view-icon">üìã</span>
              <span class="view-name">◊õ◊ú ◊î◊û◊©◊ô◊û◊ï◊™</span>
              <span class="view-count" id="countAll">0</span>
            </div>
            <div class="smart-view-item" data-view="today">
              <span class="view-icon">üìÖ</span>
              <span class="view-name">◊î◊ô◊ï◊ù</span>
              <span class="view-count" id="countToday">0</span>
            </div>
            <div class="smart-view-item" data-view="week">
              <span class="view-icon">üìÜ</span>
              <span class="view-name">7 ◊ô◊û◊ô◊ù ◊î◊ë◊ê◊ô◊ù</span>
              <span class="view-count" id="countWeek">0</span>
            </div>
            <div class="smart-view-item" data-view="overdue">
              <span class="view-icon">‚ö†Ô∏è</span>
              <span class="view-name">◊ë◊ê◊ô◊ó◊ï◊®</span>
              <span class="view-count" id="countOverdue">0</span>
            </div>
            <div class="smart-view-item" data-view="nodate">
              <span class="view-icon">üì≠</span>
              <span class="view-name">◊ú◊ú◊ê ◊™◊ê◊®◊ô◊ö</span>
              <span class="view-count" id="countNoDate">0</span>
            </div>
          </div>
          
          <!-- Subjects List -->
          <div class="subjects-list-title">◊†◊ï◊©◊ê◊ô◊ù</div>
          <div class="subjects-list" id="subjectsList"></div>
          <button class="add-subject-sidebar-btn" id="addSubjectSidebarBtn">
            <span>+</span>
            <span>◊î◊ï◊°◊£ ◊†◊ï◊©◊ê</span>
          </button>
        </div>
      </div>
      
      <!-- Main Content -->
      <div class="task-manager-body">
      <div class="quick-add-task" id="quickAddTask">
        <input type="text" id="newTaskTitle" placeholder="◊î◊ï◊°◊£ ◊û◊©◊ô◊û◊î... (◊ú◊ì◊ï◊í◊û◊î: ◊ú◊î◊í◊ô◊© ◊™◊®◊í◊ô◊ú ◊û◊ó◊® 23:00 #◊û◊™◊û◊ò◊ô◊ß◊î ◊ì◊ó◊ï◊£)" dir="auto" />
        <div class="nl-hint">
          üí° <strong>◊ß◊¶◊®◊™ ◊ì◊®◊ö:</strong> ◊õ◊™◊ï◊ë ◊ë◊©◊§◊î ◊ò◊ë◊¢◊ô◊™ ◊ï◊ú◊ó◊• Enter!
          <span class="nl-hint-toggle" onclick="document.getElementById('nlExamples').classList.toggle('show')">◊ì◊ï◊í◊û◊ê◊ï◊™ ‚ñº</span>
          <div class="nl-hint-examples" id="nlExamples">
            <div>
              <div class="example-input">◊ú◊î◊í◊ô◊© ◊™◊®◊í◊ô◊ú ◊û◊ó◊® 23:59 #◊û◊™◊û◊ò◊ô◊ß◊î ◊ì◊ó◊ï◊£</div>
              <div class="example-result">‚Üí ◊û◊ó◊® ◊ë-23:59, ◊†◊ï◊©◊ê: ◊û◊™◊û◊ò◊ô◊ß◊î, ◊¢◊ì◊ô◊§◊ï◊™: ◊ì◊ó◊ï◊£</div>
            </div>
            <div>
              <div class="example-input">◊ú◊ß◊®◊ï◊ê ◊§◊®◊ß 5 ◊ë◊ô◊ï◊ù ◊®◊ê◊©◊ï◊ü #"◊°◊ò◊ò◊ô◊°◊ò◊ô◊ß◊î 2"</div>
              <div class="example-result">‚Üí ◊ô◊ï◊ù ◊®◊ê◊©◊ï◊ü ◊î◊ß◊®◊ï◊ë, ◊†◊ï◊©◊ê: ◊°◊ò◊ò◊ô◊°◊ò◊ô◊ß◊î 2 (◊¢◊ù ◊®◊ï◊ï◊ó ◊ë◊û◊®◊õ◊ê◊ï◊™)</div>
            </div>
            <div>
              <div class="example-input">◊û◊ë◊ó◊ü ◊î◊ô◊ï◊ù 14:00 ◊í◊ë◊ï◊î</div>
              <div class="example-result">‚Üí ◊î◊ô◊ï◊ù ◊ë-14:00, ◊¢◊ì◊ô◊§◊ï◊™: ◊í◊ë◊ï◊î◊î</div>
            </div>
            <div>
              <div class="example-input">◊§◊í◊ô◊©◊î ◊¢◊ù ◊ô◊ï◊¢◊• ◊ë◊©◊ë◊ï◊¢ ◊î◊ë◊ê</div>
              <div class="example-result">‚Üí ◊¢◊ï◊ì 7 ◊ô◊û◊ô◊ù</div>
            </div>
            <div style="border-bottom: none; padding-top: 8px; color: var(--text);">
              <strong>◊û◊ô◊ú◊ï◊™ ◊û◊§◊™◊ó:</strong><br>
              üìÖ <code>◊î◊ô◊ï◊ù</code> <code>◊û◊ó◊®</code> <code>◊û◊ó◊®◊™◊ô◊ô◊ù</code> <code>◊ë◊©◊ë◊ï◊¢ ◊î◊ë◊ê</code> <code>◊ë◊ô◊ï◊ù ◊®◊ê◊©◊ï◊ü/◊©◊†◊ô/...</code><br>
              ‚è∞ <code>14:30</code> <code>23:59</code> (◊©◊¢◊î ◊ê◊ï◊§◊¶◊ô◊ï◊†◊ú◊ô◊™)<br>
              üè∑Ô∏è <code>#◊†◊ï◊©◊ê</code> <code>#"◊†◊ï◊©◊ê ◊¢◊ù ◊®◊ï◊ï◊ó"</code> <code>#◊†◊ï◊©◊ê/◊™◊™-◊†◊ï◊©◊ê</code><br>
              üö® <code>◊ì◊ó◊ï◊£</code> <code>◊í◊ë◊ï◊î</code> <code>◊ë◊ô◊†◊ï◊†◊ô</code> <code>◊†◊û◊ï◊ö</code>
            </div>
          </div>
        </div>
        <div class="quick-add-row" id="quickAddRow" style="display: none;">
          <div class="priority-selector" id="taskPriorityPicker">
            <div class="priority-option" data-priority="urgent">üî¥ ◊ì◊ó◊ï◊£</div>
            <div class="priority-option" data-priority="high">üü† ◊í◊ë◊ï◊î</div>
            <div class="priority-option selected" data-priority="medium">üü° ◊ë◊ô◊†◊ï◊†◊ô</div>
            <div class="priority-option" data-priority="low">üü¢ ◊†◊û◊ï◊ö</div>
            <div class="priority-option" data-priority="none">‚ö™ ◊ú◊ú◊ê</div>
          </div>
          <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap; width: 100%;">
            <div class="label-input-wrapper" style="flex-shrink: 0;">
              <span>üìÅ</span>
              <select id="newTaskSubject" style="border: none; background: transparent; color: var(--text); font-size: 13px; outline: none; cursor: pointer;">
                <option value="">◊ú◊ú◊ê ◊†◊ï◊©◊ê</option>
              </select>
            </div>
            <div class="label-input-wrapper">
              <span>üìÖ</span>
              <input type="datetime-local" id="newTaskDue" style="width: 180px; border: none; background: transparent; color: var(--text);" />
            </div>
            <button class="btn btn-primary" id="addTaskBtn">◊î◊ï◊°◊£</button>
          </div>
        </div>
      </div>
      
      <div class="task-sections" id="taskSections">
        <!-- Active Tasks -->
        <div id="activeSection">
          <div class="task-section-title">üìã ◊û◊©◊ô◊û◊ï◊™ ◊§◊¢◊ô◊ú◊ï◊™</div>
          <div class="task-list" id="activeTasks"></div>
        </div>
        
        <!-- Completed Tasks -->
        <div id="completedSection" style="display: none;">
          <div class="task-section-title">‚úÖ ◊î◊ï◊©◊ú◊û◊ï</div>
          <div class="task-list" id="completedTasks"></div>
        </div>
        
        <!-- Empty State -->
        <div class="tasks-empty" id="tasksEmpty" style="display: none;">
          <div class="tasks-empty-icon">üìù</div>
          <h3>◊ê◊ô◊ü ◊û◊©◊ô◊û◊ï◊™ ◊¢◊ì◊ô◊ô◊ü</h3>
          <p>◊î◊ï◊°◊£ ◊û◊©◊ô◊û◊î ◊®◊ê◊©◊ï◊†◊î ◊ú◊û◊¢◊ú◊î ◊õ◊ì◊ô ◊ú◊î◊™◊ó◊ô◊ú!</p>
        </div>
      </div>
    </div>
    </div><!-- close task-manager-layout -->
  </div>
  
  <!-- Task Edit Modal -->
  <div class="task-edit-modal" id="taskEditModal">
    <div class="task-edit-card" id="taskEditCard">
      <input type="text" id="editTaskTitle" placeholder="Task title..." />
      <textarea id="editTaskContent" placeholder="Add notes..."></textarea>
      
      <div class="task-edit-section">
        <div class="task-edit-section-title">Subject</div>
        <select id="editTaskSubject" style="padding: 12px 14px; border: 2px solid var(--border); border-radius: 10px; font-size: 14px; background: var(--input-bg); color: var(--text); outline: none; width: 100%; max-width: 250px; cursor: pointer;">
          <option value="">No Subject</option>
        </select>
      </div>
      
      <div class="task-edit-section">
        <div class="task-edit-section-title">Priority</div>
        <div class="priority-selector" id="editTaskPriority">
          <div class="priority-option" data-priority="urgent">üî¥ Urgent</div>
          <div class="priority-option" data-priority="high">üü† High</div>
          <div class="priority-option" data-priority="medium">üü° Medium</div>
          <div class="priority-option" data-priority="low">üü¢ Low</div>
          <div class="priority-option" data-priority="none">‚ö™ None</div>
        </div>
      </div>
      
      <div class="task-edit-section">
        <div class="task-edit-section-title">Due Date</div>
        <input type="datetime-local" id="editTaskDue" style="padding: 12px 14px; border: 2px solid var(--border); border-radius: 10px; font-size: 14px; background: var(--input-bg); color: var(--text); outline: none; width: 100%; max-width: 250px;" />
        <button class="btn" id="clearDueBtn" style="margin-left: 8px; padding: 10px 14px; background: var(--day-other); color: var(--muted);">Clear</button>
      </div>
      
      <div class="task-edit-section">
        <div class="task-edit-section-title">Subtasks / Checklist</div>
        <div class="task-checklist" id="editTaskChecklist"></div>
        <div class="checklist-add">
          <input type="text" id="newChecklistItem" placeholder="Add subtask..." />
          <button class="btn btn-primary" id="addChecklistItem" style="padding: 10px 16px;" aria-label="◊î◊ï◊°◊£ ◊§◊®◊ô◊ò">+</button>
        </div>
      </div>
      
      <div class="task-edit-footer">
        <div style="display: flex; gap: 8px;">
          <button class="task-action-btn delete" id="deleteTaskBtn" title="Delete" aria-label="◊û◊ó◊ß ◊û◊©◊ô◊û◊î">üóëÔ∏è</button>
        </div>
        <button class="btn btn-primary" id="saveTaskBtn">Save</button>
      </div>
    </div>
  </div>
  
  <!-- Subject Modal -->
  <div class="subject-modal" id="subjectModal">
    <div class="subject-modal-card">
      <h3 id="subjectModalTitle">◊î◊ï◊°◊£ ◊†◊ï◊©◊ê ◊ó◊ì◊©</h3>
      <input type="text" id="subjectNameInput" placeholder="◊©◊ù ◊î◊†◊ï◊©◊ê (◊ú◊ì◊ï◊í◊û◊î: ◊û◊™◊û◊ò◊ô◊ß◊î, ◊¢◊ë◊ï◊ì◊î, ◊ê◊ô◊©◊ô)" dir="auto" />
      
      <div class="task-edit-section-title" style="margin: 16px 0 10px 0;">◊†◊ï◊©◊ê ◊ê◊ë (◊ê◊ï◊§◊¶◊ô◊ï◊†◊ú◊ô)</div>
      <select id="parentSubjectSelect" style="width: 100%; padding: 12px 14px; border: 2px solid var(--border); border-radius: 10px; font-size: 14px; background: var(--input-bg); color: var(--text); outline: none; cursor: pointer; margin-bottom: 16px;">
        <option value="">◊ú◊ú◊ê (◊†◊ï◊©◊ê ◊®◊ê◊©◊ô)</option>
      </select>
      
      <div class="task-edit-section-title" style="margin-bottom: 10px;">◊¶◊ë◊¢</div>
      <div class="subject-color-picker" id="subjectColorPicker">
        <div class="subject-color-option selected" style="background: #667eea;" data-color="#667eea"></div>
        <div class="subject-color-option" style="background: #ef4444;" data-color="#ef4444"></div>
        <div class="subject-color-option" style="background: #f97316;" data-color="#f97316"></div>
        <div class="subject-color-option" style="background: #eab308;" data-color="#eab308"></div>
        <div class="subject-color-option" style="background: #22c55e;" data-color="#22c55e"></div>
        <div class="subject-color-option" style="background: #06b6d4;" data-color="#06b6d4"></div>
        <div class="subject-color-option" style="background: #8b5cf6;" data-color="#8b5cf6"></div>
        <div class="subject-color-option" style="background: #ec4899;" data-color="#ec4899"></div>
      </div>
      <div class="subject-modal-actions">
        <button class="btn" id="cancelSubjectBtn" style="background: var(--day-other); color: var(--muted);">◊ë◊ô◊ò◊ï◊ú</button>
        <button class="btn btn-danger" id="deleteSubjectBtn" style="display: none;">◊û◊ó◊ß</button>
        <button class="btn btn-primary" id="saveSubjectBtn">◊©◊û◊ï◊®</button>
      </div>
    </div>
  </div>

  <!-- Context Menu for Subjects -->
  <div class="context-menu" id="contextMenu">
    <div class="context-menu-item" data-action="edit">‚úèÔ∏è ◊¢◊®◊ô◊õ◊î</div>
    <div class="context-menu-item" data-action="add-sub">‚ûï ◊î◊ï◊°◊£ ◊™◊™-◊†◊ï◊©◊ê</div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item danger" data-action="delete">üóëÔ∏è ◊û◊ó◊ß</div>
  </div>
  
  <!-- Context Menu for Countdown Events -->
  <div class="context-menu" id="eventContextMenu">
    <div class="context-menu-item" data-action="star">‚≠ê ◊°◊û◊ü ◊õ◊û◊ï◊¢◊ì◊£</div>
    <div class="context-menu-item" data-action="edit">‚úèÔ∏è ◊¢◊®◊ô◊õ◊î</div>
    <div class="context-menu-item" data-action="duplicate">üìã ◊©◊õ◊§◊ú</div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item danger" data-action="delete">üóëÔ∏è ◊û◊ó◊ß</div>
  </div>
  
  <!-- Context Menu for Adding New Event -->
  <div class="context-menu" id="addEventContextMenu">
    <div class="context-menu-item" data-action="add">‚ûï ◊î◊ï◊°◊£ ◊ê◊ô◊®◊ï◊¢ ◊ó◊ì◊©</div>
    <div class="context-menu-item" data-action="add-tomorrow">üìÖ ◊ê◊ô◊®◊ï◊¢ ◊ú◊û◊ó◊®</div>
    <div class="context-menu-item" data-action="add-week">üìÜ ◊ê◊ô◊®◊ï◊¢ ◊ú◊©◊ë◊ï◊¢ ◊î◊ë◊ê</div>
  </div>

  <!-- Daily Reminder Modal -->
  <div class="reminder-modal" id="reminderModal">
    <div class="reminder-card">
      <h2>‚òÄÔ∏è ◊ë◊ï◊ß◊® ◊ò◊ï◊ë!</h2>
      <div class="reminder-date" id="reminderDate"></div>
      
      <div class="reminder-section" id="todayTasksSection">
        <h3>üìÖ ◊û◊©◊ô◊û◊ï◊™ ◊ú◊î◊ô◊ï◊ù</h3>
        <div id="todayTasksList"></div>
      </div>
      
      <div class="reminder-section" id="tomorrowTasksSection">
        <h3>üìÜ ◊û◊©◊ô◊û◊ï◊™ ◊ú◊û◊ó◊®</h3>
        <div id="tomorrowTasksList"></div>
      </div>
      
      <div class="reminder-actions">
        <button class="btn btn-primary" id="closeReminderBtn" style="width: 100%;">◊î◊ë◊†◊™◊ô, ◊™◊ï◊ì◊î! üëç</button>
      </div>
    </div>
  </div>

  <div class="app-layout">
    <div class="main-content">
      <div class="container">
        <header class="header">
          <h1>‚è±Ô∏è Shared Event Countdowns</h1>
          <p>Events sync live across all devices</p>
        </header>

        <div class="input-panel" id="inputPanel">
          <div class="input-row">
            <input type="text" id="eventName" placeholder="Event name..." autocomplete="off" aria-label="Event name" />
            <input type="datetime-local" id="eventDate" aria-label="Event date and time" max="9999-12-31T23:59" />
            <button class="btn btn-primary" id="addBtn">Add Event</button>
            <button class="btn btn-cancel" id="cancelBtn">Cancel</button>
            <button class="btn btn-ghost" id="clearBtn">Clear All</button>
          </div>
          <div class="input-row-notes">
            <textarea id="eventNotes" placeholder="Notes (optional)..." aria-label="Event notes"></textarea>
          </div>
        </div>

        <div class="event-list" id="eventList" role="list">
          <p style="text-align:center; padding: 20px;">Loading shared events...</p>
        </div>

        <div class="empty-state" id="emptyState">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <p>No events yet. Add your first countdown above! üéâ</p>
        </div>
      </div>
    </div>

    <aside class="sidebar hidden" id="sidebar">
      <div class="calendar-container">
        <div class="calendar-header">
          <div class="calendar-nav">
            <button id="prevMonth" aria-label="◊ó◊ï◊ì◊© ◊ß◊ï◊ì◊ù">‚Äπ</button>
            <button id="todayBtn" aria-label="◊î◊ô◊ï◊ù" title="◊î◊ô◊ï◊ù">‚óè</button>
            <button id="nextMonth" aria-label="◊ó◊ï◊ì◊© ◊î◊ë◊ê">‚Ä∫</button>
          </div>
          <div class="calendar-title" id="calendarTitle"></div>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-section-title" id="monthEventsTitle">◊ê◊ô◊®◊ï◊¢◊ô ◊î◊ó◊ï◊ì◊©</div>
        <div class="month-events" id="monthEvents">
          <div class="no-events-msg">◊ê◊ô◊ü ◊ê◊ô◊®◊ï◊¢◊ô◊ù ◊î◊ó◊ï◊ì◊©</div>
        </div>
      </div>
    </aside>
  </div>

  <div class="modal-backdrop" id="clearModal" role="dialog" aria-modal="true" aria-labelledby="clearModalTitle" aria-describedby="clearModalDesc">
    <div class="modal-card">
      <h3 id="clearModalTitle">Clear all shared events?</h3>
      <p id="clearModalDesc">This removes every event for everyone. Do you want to continue?</p>
      <div class="modal-actions">
        <button class="btn btn-danger" id="confirmClearBtn">Yes, clear everything</button>
        <button class="btn btn-cancel" id="cancelClearModalBtn" style="display:inline-block;">Keep events</button>
      </div>
    </div>
  </div>

  <!-- Day Drawer -->
  <div class="day-drawer-backdrop" id="dayDrawer" role="dialog" aria-modal="true" aria-labelledby="dayDrawerTitle">
    <div class="day-drawer">
      <div class="day-drawer-header">
        <div>
          <div class="day-drawer-title" id="dayDrawerTitle"></div>
          <div class="day-drawer-subtitle" id="dayDrawerSubtitle"></div>
        </div>
        <button class="day-drawer-close" id="closeDayDrawer" aria-label="◊°◊í◊ï◊®">√ó</button>
      </div>
      <div class="day-drawer-content">
        <div class="day-drawer-section" id="dayDrawerEvents">
          <div class="day-drawer-section-title">
            üìÖ ◊ê◊ô◊®◊ï◊¢◊ô◊ù <span class="count" id="dayEventsCount">0</span>
          </div>
          <div id="dayEventsList"></div>
        </div>
        <div class="day-drawer-section" id="dayDrawerTasks">
          <div class="day-drawer-section-title">
            ‚úÖ ◊û◊©◊ô◊û◊ï◊™ <span class="count" id="dayTasksCount">0</span>
          </div>
          <div id="dayTasksList"></div>
        </div>
      </div>
      <div class="day-drawer-actions">
        <button class="btn btn-primary" id="addEventToDay">üìÖ ◊î◊ï◊°◊£ ◊ê◊ô◊®◊ï◊¢</button>
        <button class="btn" id="addTaskToDay" style="background: var(--btn-secondary-bg); color: var(--text);">‚úÖ ◊î◊ï◊°◊£ ◊û◊©◊ô◊û◊î</button>
      </div>
    </div>
  </div>

  <div class="undo-toast" id="undoToast" role="status" aria-live="polite">
    <span id="undoToastMsg">Event deleted</span>
    <button id="undoToastUndo" aria-label="Undo delete">Undo</button>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, set, onValue, push, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB_IflOD8CwVLQQjqtz_ZKWzbfgCiOm2Js",
    authDomain: "countdown-463de.firebaseapp.com",
    databaseURL: "https://countdown-463de-default-rtdb.firebaseio.com",
    projectId: "countdown-463de",
    storageBucket: "countdown-463de.firebasestorage.app",
    messagingSenderId: "1016385864732",
    appId: "1:1016385864732:web:8a82e771e1f4be567a8bd9"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const eventsRef = ref(db, 'events');

  const COLORS = ['#667eea','#f59e0b','#10b981','#ec4899','#8b5cf6','#06b6d4','#ef4444','#84cc16'];
  const HEBREW_DAYS = ['◊ê◊≥', '◊ë◊≥', '◊í◊≥', '◊ì◊≥', '◊î◊≥', '◊ï◊≥', '◊©◊≥'];
  const HEBREW_MONTHS = ['◊ô◊†◊ï◊ê◊®', '◊§◊ë◊®◊ï◊ê◊®', '◊û◊®◊•', '◊ê◊§◊®◊ô◊ú', '◊û◊ê◊ô', '◊ô◊ï◊†◊ô', '◊ô◊ï◊ú◊ô', '◊ê◊ï◊í◊ï◊°◊ò', '◊°◊§◊ò◊û◊ë◊®', '◊ê◊ï◊ß◊ò◊ï◊ë◊®', '◊†◊ï◊ë◊û◊ë◊®', '◊ì◊¶◊û◊ë◊®'];

  const escapeHtml = (str) => String(str || '').replace(/[&<>"']/g, (c) => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;'
  })[c]);

  const $ = id => document.getElementById(id);
  const eventList = $("eventList");
  const emptyState = $("emptyState");
  const eventName = $("eventName");
  const eventDate = $("eventDate");
  const inputPanel = $("inputPanel");
  const addBtn = $("addBtn");
  const cancelBtn = $("cancelBtn");
  const clearBtn = $("clearBtn");
  const sidebar = $("sidebar");
  const calendarGrid = $("calendarGrid");
  const calendarTitle = $("calendarTitle");
  const monthEventsEl = $("monthEvents");
  const monthEventsTitle = $("monthEventsTitle");
  const clearModal = $("clearModal");
  const confirmClearBtn = $("confirmClearBtn");
  const cancelClearModalBtn = $("cancelClearModalBtn");
  const themeToggle = $("themeToggle");
  const eventNotes = $("eventNotes");
  const undoToast = $("undoToast");
  const undoToastMsg = $("undoToastMsg");
  const undoToastUndo = $("undoToastUndo");

  const STORAGE_KEYS = {
    THEME: 'countdown-theme',
    SIDEBAR_WIDTH: 'countdown-sidebar-width'
  };

  let editingId = null;
  let events = [];
  let currentMonth = new Date();
  const pendingDeletes = new Map();
  let lastDeletedId = null;
  const DELETE_TIMEOUT_MS = 10000;

  const getActiveEvents = () => events.filter(evt => !pendingDeletes.has(evt.id));

  const showUndoToast = (name, id) => {
    undoToastMsg.textContent = `${name} deleted`;
    lastDeletedId = id;
    undoToast.classList.add('show');
  };

  const hideUndoToast = () => {
    lastDeletedId = null;
    undoToast.classList.remove('show');
  };

  undoToastUndo.onclick = () => {
    if (!lastDeletedId) return;
    const pending = pendingDeletes.get(lastDeletedId);
    if (pending) {
      clearTimeout(pending.timer);
      pendingDeletes.delete(lastDeletedId);
      render();
    }
    hideUndoToast();
  };

  function getEventColor(id) {
    const charCode = id.charCodeAt(id.length - 1);
    return COLORS[charCode % COLORS.length];
  }

  $("toggleSidebar").onclick = () => {
    const wasHidden = sidebar.classList.contains("hidden");
    sidebar.classList.toggle("hidden");
    // Reset to current month when opening sidebar
    if (wasHidden) {
      currentMonth = new Date();
      renderCalendar();
    }
  };

  // Dark mode toggle
  const initTheme = () => {
    const saved = localStorage.getItem(STORAGE_KEYS.THEME);
    if (saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.body.classList.add('dark');
      themeToggle.textContent = '‚òÄÔ∏è';
    }
  };
  initTheme();

  themeToggle.onclick = () => {
    document.body.classList.toggle('dark');
    const isDark = document.body.classList.contains('dark');
    themeToggle.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
    localStorage.setItem(STORAGE_KEYS.THEME, isDark ? 'dark' : 'light');
  };

  // Persist sidebar width
  const savedWidth = localStorage.getItem(STORAGE_KEYS.SIDEBAR_WIDTH);
  if (savedWidth) sidebar.style.width = savedWidth;

  const resizeObserver = new ResizeObserver(() => {
    localStorage.setItem(STORAGE_KEYS.SIDEBAR_WIDTH, sidebar.style.width || sidebar.offsetWidth + 'px');
  });
  resizeObserver.observe(sidebar);

  function parseLocal(value) {
    const match = String(value || "").match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})$/);
    if (!match) return null;
    const [, Y, Mo, D, H, Mi] = match;
    return new Date(+Y, +Mo - 1, +D, +H, +Mi, 0, 0);
  }

  function toLocalDatetime(isoString) {
    const d = new Date(isoString);
    const pad = n => String(n).padStart(2, '0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function toDateKey(date) {
    const d = new Date(date);
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }

  function getMonthEvents() {
    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth();
    return getActiveEvents().filter(evt => {
      const d = new Date(evt.date);
      return d.getFullYear() === year && d.getMonth() === month;
    }).sort((a, b) => new Date(a.date) - new Date(b.date));
  }

  function renderMonthEventsList() {
    const monthEvents = getMonthEvents();
    monthEventsTitle.textContent = `◊ê◊ô◊®◊ï◊¢◊ô ${HEBREW_MONTHS[currentMonth.getMonth()]}`;

    if (monthEvents.length === 0) {
      monthEventsEl.innerHTML = '<div class="no-events-msg">◊ê◊ô◊ü ◊ê◊ô◊®◊ï◊¢◊ô◊ù ◊î◊ó◊ï◊ì◊©</div>';
      return;
    }

    monthEventsEl.innerHTML = monthEvents.map(evt => {
      const color = getEventColor(evt.id);
      const d = new Date(evt.date);
      const dateStr = `${d.getDate()}/${d.getMonth()+1} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
      return `
        <div class="month-event-item" style="border-right-color: ${color}">
          <div class="month-event-color" style="background: ${color}"></div>
          <div class="month-event-info">
            <div class="month-event-name">${escapeHtml(evt.name)}</div>
            <div class="month-event-date">${dateStr}</div>
          </div>
        </div>
      `;
    }).join('');
  }

  function renderCalendar() {
    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth();

    calendarTitle.textContent = `${HEBREW_MONTHS[month]} ${year}`;

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDay = firstDay.getDay();
    const daysInMonth = lastDay.getDate();

    const today = new Date();
    const todayKey = toDateKey(today);

    // Build event map by date
    const eventsByDate = {};
    getActiveEvents().forEach(evt => {
      const key = toDateKey(evt.date);
      if (!eventsByDate[key]) eventsByDate[key] = [];
      eventsByDate[key].push(evt);
    });
    
    // Build task map by due date
    const tasksByDate = {};
    const allTasks = typeof tasks !== 'undefined' ? tasks : [];
    allTasks.filter(t => t.dueDate && !t.completed).forEach(task => {
      const key = toDateKey(task.dueDate);
      if (!tasksByDate[key]) tasksByDate[key] = [];
      tasksByDate[key].push(task);
    });

    let html = '';

    // Day names
    for (let i = 0; i < 7; i++) {
      html += `<div class="calendar-day-name">${HEBREW_DAYS[i]}</div>`;
    }

    // Previous month days
    const prevMonth = new Date(year, month, 0);
    const prevDays = prevMonth.getDate();
    for (let i = startDay - 1; i >= 0; i--) {
      const day = prevDays - i;
      html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
    }

    // Current month days
    for (let day = 1; day <= daysInMonth; day++) {
      const dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
      const isToday = dateKey === todayKey;
      const dayEvents = eventsByDate[dateKey] || [];
      const dayTasks = tasksByDate[dateKey] || [];
      const totalItems = dayEvents.length + dayTasks.length;

      let classes = 'calendar-day';
      if (isToday) classes += ' today';

      let eventsHtml = '<div class="calendar-day-events">';
      const maxShow = 2;
      const showTime = totalItems > 1; // Show time when multiple items on same day
      
      // Show events first
      let shown = 0;
      dayEvents.slice(0, maxShow).forEach(evt => {
        const color = getEventColor(evt.id);
        const safeName = escapeHtml(evt.name);
        const evtDate = new Date(evt.date);
        const timeStr = showTime ? `${String(evtDate.getHours()).padStart(2,'0')}:${String(evtDate.getMinutes()).padStart(2,'0')} ` : '';
        const displayText = timeStr + safeName;
        eventsHtml += `<div class="calendar-event-chip" style="background: ${color}" title="${safeName}" aria-label="${safeName}" data-event-id="${evt.id}">${displayText}</div>`;
        shown++;
      });
      
      // Show task indicator if there are tasks
      if (dayTasks.length > 0 && shown < maxShow) {
        const taskCount = dayTasks.length;
        eventsHtml += `<div class="calendar-event-chip calendar-task-chip" style="background: var(--success)" title="${taskCount} ◊û◊©◊ô◊û◊ï◊™" aria-label="${taskCount} ◊û◊©◊ô◊û◊ï◊™">‚úÖ ${taskCount} ◊û◊©◊ô◊û◊ï◊™</div>`;
        shown++;
      }
      
      // Show "more" indicator
      const remaining = totalItems - shown;
      if (remaining > 0) {
        eventsHtml += `<div class="calendar-more">+${remaining} ◊¢◊ï◊ì</div>`;
      }
      eventsHtml += '</div>';

      html += `<div class="${classes}" data-date="${dateKey}">
        <div class="calendar-day-number">${day}</div>
        ${eventsHtml}
      </div>`;
    }

    // Next month days
    const totalCells = startDay + daysInMonth;
    const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
    for (let i = 1; i <= remainingCells; i++) {
      html += `<div class="calendar-day other-month"><div class="calendar-day-number">${i}</div></div>`;
    }

    calendarGrid.innerHTML = html;
    renderMonthEventsList();

    // Click calendar chip to scroll to event in main list
    calendarGrid.querySelectorAll('.calendar-event-chip').forEach(chip => {
      chip.addEventListener('click', (e) => {
        e.stopPropagation(); // Don't trigger day click
        const eventId = chip.dataset.eventId;
        if (eventId) {
          const eventRow = document.querySelector(`.event-row[data-id="${eventId}"]`);
          if (eventRow) {
            eventRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            // Flash highlight
            eventRow.style.transition = 'background 0.3s';
            eventRow.style.background = 'var(--accent)';
            setTimeout(() => {
              eventRow.style.background = '';
            }, 800);
          }
        }
      });
    });

    // Click calendar day to open day drawer
    calendarGrid.querySelectorAll('.calendar-day:not(.other-month)').forEach(dayEl => {
      dayEl.addEventListener('click', (e) => {
        // Don't trigger if clicking on a chip (chip has its own handler)
        if (e.target.classList.contains('calendar-event-chip')) return;
        
        const dateKey = dayEl.dataset.date;
        if (!dateKey) return;
        openDayDrawer(dateKey);
      });
    });
  }
  
  // Day Drawer functionality
  const dayDrawer = $("dayDrawer");
  const dayDrawerTitle = $("dayDrawerTitle");
  const dayDrawerSubtitle = $("dayDrawerSubtitle");
  const dayEventsList = $("dayEventsList");
  const dayTasksList = $("dayTasksList");
  const dayEventsCount = $("dayEventsCount");
  const dayTasksCount = $("dayTasksCount");
  const closeDayDrawerBtn = $("closeDayDrawer");
  const addEventToDay = $("addEventToDay");
  const addTaskToDay = $("addTaskToDay");
  
  let selectedDayKey = null;
  
  function openDayDrawer(dateKey) {
    selectedDayKey = dateKey;
    const [year, month, day] = dateKey.split('-').map(Number);
    const date = new Date(year, month - 1, day);
    
    // Format title (Hebrew day + date)
    const dayOfWeek = date.getDay();
    const hebrewDayNames = ['◊ô◊ï◊ù ◊®◊ê◊©◊ï◊ü', '◊ô◊ï◊ù ◊©◊†◊ô', '◊ô◊ï◊ù ◊©◊ú◊ô◊©◊ô', '◊ô◊ï◊ù ◊®◊ë◊ô◊¢◊ô', '◊ô◊ï◊ù ◊ó◊û◊ô◊©◊ô', '◊ô◊ï◊ù ◊©◊ô◊©◊ô', '◊©◊ë◊™'];
    dayDrawerTitle.textContent = hebrewDayNames[dayOfWeek];
    dayDrawerSubtitle.textContent = `${day} ◊ë${HEBREW_MONTHS[month - 1]} ${year}`;
    
    // Get events for this day
    const dayEvents = getActiveEvents().filter(evt => toDateKey(evt.date) === dateKey)
      .sort((a, b) => new Date(a.date) - new Date(b.date));
    
    // Get tasks due this day (need to access tasks array from task manager scope)
    const dayTasks = (typeof tasks !== 'undefined' ? tasks : []).filter(task => {
      if (!task.dueDate) return false;
      return toDateKey(task.dueDate) === dateKey;
    }).sort((a, b) => {
      // Sort by completed, then priority
      if (a.completed !== b.completed) return a.completed ? 1 : -1;
      const PRIORITY_ORDER = { urgent: 0, high: 1, medium: 2, low: 3, none: 4 };
      return (PRIORITY_ORDER[a.priority] || 4) - (PRIORITY_ORDER[b.priority] || 4);
    });
    
    // Update counts
    dayEventsCount.textContent = dayEvents.length;
    dayTasksCount.textContent = dayTasks.length;
    
    // Render events
    if (dayEvents.length === 0) {
      dayEventsList.innerHTML = '<div class="day-drawer-empty">◊ê◊ô◊ü ◊ê◊ô◊®◊ï◊¢◊ô◊ù ◊ë◊ô◊ï◊ù ◊ñ◊î</div>';
    } else {
      dayEventsList.innerHTML = dayEvents.map(evt => {
        const color = getEventColor(evt.id);
        const evtDate = new Date(evt.date);
        const timeStr = `${String(evtDate.getHours()).padStart(2,'0')}:${String(evtDate.getMinutes()).padStart(2,'0')}`;
        return `
          <div class="day-drawer-item" data-event-id="${evt.id}">
            <div class="day-drawer-item-color" style="background: ${color}"></div>
            <div class="day-drawer-item-info">
              <div class="day-drawer-item-name">${escapeHtml(evt.name)}</div>
              <div class="day-drawer-item-time">üïê ${timeStr}</div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // Render tasks
    if (dayTasks.length === 0) {
      dayTasksList.innerHTML = '<div class="day-drawer-empty">◊ê◊ô◊ü ◊û◊©◊ô◊û◊ï◊™ ◊ë◊ô◊ï◊ù ◊ñ◊î</div>';
    } else {
      const PRIORITY_COLORS = { urgent: '#ef4444', high: '#f97316', medium: '#eab308', low: '#22c55e', none: '#6b7280' };
      const PRIORITY_BG = { urgent: 'rgba(239,68,68,0.15)', high: 'rgba(249,115,22,0.15)', medium: 'rgba(234,179,8,0.15)', low: 'rgba(34,197,94,0.15)', none: 'var(--day-other)' };
      const PRIORITY_LABELS_HE = { urgent: '◊ì◊ó◊ï◊£', high: '◊í◊ë◊ï◊î', medium: '◊ë◊ô◊†◊ï◊†◊ô', low: '◊†◊û◊ï◊ö', none: '' };
      
      dayTasksList.innerHTML = dayTasks.map(task => {
        const priority = task.priority || 'none';
        const priorityLabel = PRIORITY_LABELS_HE[priority];
        const completedClass = task.completed ? 'task-completed' : '';
        const due = task.dueDate ? new Date(task.dueDate) : null;
        const timeStr = due ? `${String(due.getHours()).padStart(2,'0')}:${String(due.getMinutes()).padStart(2,'0')}` : '';
        
        return `
          <div class="day-drawer-item ${completedClass}" data-task-id="${task.id}">
            <div class="day-drawer-item-color" style="background: ${PRIORITY_COLORS[priority]}"></div>
            <div class="day-drawer-item-info">
              <div class="day-drawer-item-name">${escapeHtml(task.title)}</div>
              ${timeStr ? `<div class="day-drawer-item-time">üïê ${timeStr}</div>` : ''}
            </div>
            ${priorityLabel ? `<div class="day-drawer-item-priority" style="background: ${PRIORITY_BG[priority]}; color: ${PRIORITY_COLORS[priority]}">${priorityLabel}</div>` : ''}
          </div>
        `;
      }).join('');
    }
    
    // Add click handlers for items
    dayEventsList.querySelectorAll('.day-drawer-item').forEach(item => {
      item.addEventListener('click', () => {
        const eventId = item.dataset.eventId;
        if (eventId) {
          closeDayDrawer();
          // Scroll to event in main list
          setTimeout(() => {
            const eventRow = document.querySelector(`.event-row[data-id="${eventId}"]`);
            if (eventRow) {
              eventRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
              eventRow.style.transition = 'background 0.3s';
              eventRow.style.background = 'var(--accent)';
              setTimeout(() => { eventRow.style.background = ''; }, 800);
            }
          }, 200);
        }
      });
    });
    
    dayTasksList.querySelectorAll('.day-drawer-item').forEach(item => {
      item.addEventListener('click', () => {
        const taskId = item.dataset.taskId;
        if (taskId) {
          closeDayDrawer();
          // Open task manager and highlight task
          setTimeout(() => {
            if (!taskManagerOverlay.classList.contains('open')) {
              taskManagerOverlay.classList.add('open');
              renderSubjectsSidebar();
              renderTasks();
              startTaskTicker();
            }
            setTimeout(() => {
              const taskItem = document.querySelector(`.task-item[data-id="${taskId}"]`);
              if (taskItem) {
                taskItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                taskItem.style.transition = 'box-shadow 0.3s';
                taskItem.style.boxShadow = '0 0 0 3px var(--accent)';
                setTimeout(() => { taskItem.style.boxShadow = ''; }, 1000);
              }
            }, 300);
          }, 200);
        }
      });
    });
    
    dayDrawer.classList.add('open');
  }
  
  function closeDayDrawer() {
    dayDrawer.classList.remove('open');
    selectedDayKey = null;
  }
  
  closeDayDrawerBtn.onclick = closeDayDrawer;
  
  // Close on backdrop click
  dayDrawer.addEventListener('click', (e) => {
    if (e.target === dayDrawer) closeDayDrawer();
  });
  
  // Add event to selected day
  addEventToDay.onclick = () => {
    if (!selectedDayKey) return;
    closeDayDrawer();
    eventDate.value = selectedDayKey + 'T12:00';
    eventName.focus();
    inputPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  };
  
  // Add task to selected day
  addTaskToDay.onclick = () => {
    if (!selectedDayKey) return;
    closeDayDrawer();
    // Open task manager
    taskManagerOverlay.classList.add('open');
    renderSubjectsSidebar();
    renderTasks();
    startTaskTicker();
    // Pre-fill the due date
    setTimeout(() => {
      newTaskDue.value = selectedDayKey + 'T23:59';
      newTaskTitle.focus();
      quickAddRow.style.display = 'flex';
    }, 200);
  };

  $("prevMonth").onclick = () => {
    currentMonth.setMonth(currentMonth.getMonth() - 1);
    renderCalendar();
  };

  $("nextMonth").onclick = () => {
    currentMonth.setMonth(currentMonth.getMonth() + 1);
    renderCalendar();
  };
  
  // Today button - jump to current month
  const todayBtn = $("todayBtn");
  if (todayBtn) {
    todayBtn.onclick = () => {
      currentMonth = new Date();
      renderCalendar();
    };
  }

  onValue(eventsRef, (snapshot) => {
    const data = snapshot.val();
    if (data) {
      events = Object.keys(data).map(key => ({ id: key, ...data[key] }));
    } else {
      events = [];
    }
    render();
    renderCalendar();
  });

  const saveToCloud = (eventData) => {
    const newEventRef = push(eventsRef);
    set(newEventRef, eventData);
  };

  const updateInCloud = (id, data) => {
    set(ref(db, 'events/' + id), data);
  };

  const deleteFromCloud = (id) => {
    remove(ref(db, 'events/' + id));
  };

  const clearAllCloud = () => {
    set(eventsRef, null);
  };

  function formatDate(iso) {
    return new Date(iso).toLocaleString(undefined, {
      weekday: 'short', month: 'short', day: 'numeric',
      hour: '2-digit', minute: '2-digit'
    });
  }

  function calcTime(target) {
    const diff = Math.max(0, new Date(target).getTime() - Date.now());
    return {
      ended: diff === 0,
      d: Math.floor(diff / 86400000),
      h: Math.floor((diff % 86400000) / 3600000),
      m: Math.floor((diff % 3600000) / 60000),
      s: Math.floor((diff % 60000) / 1000)
    };
  }

  function startEdit(id) {
    const evt = events.find(e => e.id === id);
    if (!evt) return;

    editingId = id;
    eventName.value = evt.name;
    eventDate.value = toLocalDatetime(evt.date);
    eventNotes.value = evt.notes || '';
    addBtn.textContent = "Save";
    cancelBtn.style.display = "block";
    clearBtn.style.display = "none";
    inputPanel.classList.add("editing");
    eventName.focus();
  }

  function cancelEdit() {
    editingId = null;
    eventName.value = "";
    eventDate.value = "";
    eventNotes.value = "";
    addBtn.textContent = "Add Event";
    cancelBtn.style.display = "none";
    clearBtn.style.display = "block";
    inputPanel.classList.remove("editing");
  }

  const refs = new Map();

  function render() {
    refs.clear();
    eventList.innerHTML = "";
    // Use getActiveEvents() to account for pending deletes
    emptyState.style.display = getActiveEvents().length ? "none" : "block";

    const now = Date.now();

    const sorted = [...events].filter(e => !pendingDeletes.has(e.id)).sort((a, b) => {
      const aTime = new Date(a.date).getTime();
      const bTime = new Date(b.date).getTime();
      const aEnded = aTime <= now;
      const bEnded = bTime <= now;

      if (!aEnded && bEnded) return -1;
      if (aEnded && !bEnded) return 1;
      return aTime - bTime;
    });

    sorted.forEach((evt) => {
      const color = getEventColor(evt.id);
      const t = calcTime(evt.date);

      const row = document.createElement("div");
      row.className = `event-row ${evt.highlighted ? 'highlighted' : ''}`;
      row.dataset.id = evt.id;

      if (evt.highlighted) {
        row.style.background = color + '12';
        row.style.borderColor = color;
      }

      const dot = document.createElement("span");
      dot.className = "color-dot";
      dot.style.background = color;

      const info = document.createElement("div");
      info.className = "event-info";

      const name = document.createElement("div");
      name.className = "event-name";
      name.textContent = evt.name;

      const date = document.createElement("div");
      date.className = "event-date";
      date.textContent = formatDate(evt.date);

      info.appendChild(name);
      info.appendChild(date);

      if (evt.notes) {
        const notes = document.createElement("div");
        notes.className = "event-notes";
        notes.textContent = evt.notes;
        info.appendChild(notes);
        if (evt.notes.length > 60 || evt.notes.includes('\n')) {
          const toggle = document.createElement("span");
          toggle.className = "notes-toggle";
          toggle.textContent = "◊î◊¶◊í ◊¢◊ï◊ì";
          toggle.onclick = (e) => {
            e.stopPropagation();
            notes.classList.toggle('expanded');
            toggle.textContent = notes.classList.contains('expanded') ? "◊î◊°◊™◊®" : "◊î◊¶◊í ◊¢◊ï◊ì";
          };
          info.appendChild(toggle);
        }
      }

      const timer = document.createElement("div");
      timer.className = "timer";

      const units = [
        { key: 'd', label: 'Days' },
        { key: 'h', label: 'Hrs' },
        { key: 'm', label: 'Min' },
        { key: 's', label: 'Sec' }
      ];

      units.forEach(({ key, label }) => {
        const unit = document.createElement("div");
        unit.className = "time-unit";

        const val = document.createElement("span");
        val.className = `time-val time-${key}`;
        val.style.color = color;
        val.textContent = key === 'd' ? t[key] : String(t[key]).padStart(2, '0');

        const lbl = document.createElement("div");
        lbl.className = "time-label";
        lbl.textContent = label;

        unit.appendChild(val);
        unit.appendChild(lbl);
        timer.appendChild(unit);
      });

      const badge = document.createElement("span");
      badge.className = `badge ${t.ended ? 'badge-ended' : 'badge-upcoming'}`;
      badge.textContent = t.ended ? 'Ended' : 'Upcoming';

      const starBtn = document.createElement("button");
      starBtn.className = `star-btn ${evt.highlighted ? 'active' : ''}`;
      starBtn.textContent = "‚òÖ";

      const editBtn = document.createElement("button");
      editBtn.className = "edit-btn";
      editBtn.textContent = "‚úé";
      editBtn.title = "Edit";

      const deleteBtn = document.createElement("button");
      deleteBtn.className = "delete-btn";
      deleteBtn.textContent = "√ó";

      const actions = document.createElement("div");
      actions.className = "event-actions";
      actions.appendChild(starBtn);
      actions.appendChild(editBtn);
      actions.appendChild(deleteBtn);

      row.appendChild(dot);
      row.appendChild(timer);
      row.appendChild(badge);
      row.appendChild(info);
      row.appendChild(actions);
      
      // Right-click context menu for events
      row.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        showEventContextMenu(e.clientX, e.clientY, evt.id);
      });

      refs.set(evt.id, {
        row,
        dEl: row.querySelector(".time-d"),
        hEl: row.querySelector(".time-h"),
        mEl: row.querySelector(".time-m"),
        sEl: row.querySelector(".time-s"),
        badge: badge,
        target: new Date(evt.date).getTime()
      });

      eventList.appendChild(row);
    });

    tick();
  }

  function tick() {
    const now = Date.now();

    refs.forEach((ref) => {
      const diff = Math.max(0, ref.target - now);
      const ended = diff === 0;

      const d = Math.floor(diff / 86400000);
      const h = Math.floor((diff % 86400000) / 3600000);
      const m = Math.floor((diff % 3600000) / 60000);
      const s = Math.floor((diff % 60000) / 1000);

      ref.dEl.textContent = d;
      ref.hEl.textContent = String(h).padStart(2, '0');
      ref.mEl.textContent = String(m).padStart(2, '0');
      ref.sEl.textContent = String(s).padStart(2, '0');

      ref.badge.className = `badge ${ended ? 'badge-ended' : 'badge-upcoming'}`;
      ref.badge.textContent = ended ? 'Ended' : 'Upcoming';
    });
  }

  let tickerHandle = null;
  function startTicker() {
    if (tickerHandle) clearTimeout(tickerHandle);
    const loop = () => {
      tick();
      const msToNext = 1000 - (Date.now() % 1000);
      tickerHandle = setTimeout(loop, msToNext);
    };
    loop();
  }

  addBtn.onclick = () => {
    const name = eventName.value.trim();
    const dateValue = eventDate.value;
    const notes = eventNotes.value.trim();

    if (!name || !dateValue) {
      alert("Please enter both event name and date");
      return;
    }

    const parsedDate = parseLocal(dateValue);
    if (!parsedDate || isNaN(parsedDate.getTime())) {
      alert("Invalid date");
      return;
    }

    if (editingId) {
      const evt = events.find(e => e.id === editingId);
      updateInCloud(editingId, {
        name,
        date: parsedDate.toISOString(),
        notes: notes || null,
        highlighted: evt ? evt.highlighted : false
      });
      cancelEdit();
    } else {
      saveToCloud({
        name,
        date: parsedDate.toISOString(),
        notes: notes || null,
        highlighted: false
      });
      eventName.value = "";
      eventDate.value = "";
      eventNotes.value = "";
      eventName.focus();
    }
  };

  cancelBtn.onclick = cancelEdit;

  eventName.onkeypress = e => {
    if (e.key === 'Enter') addBtn.click();
  };

  eventDate.onkeypress = e => {
    if (e.key === 'Enter') addBtn.click();
  };

  // Auto-advance: when datetime-local value is complete, focus stays for time editing
  eventDate.addEventListener('input', () => {
    const val = eventDate.value;
    // datetime-local format: YYYY-MM-DDTHH:MM
    if (val && val.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/)) {
      // Value is complete - user can now adjust time or press Enter
      // No action needed, browser handles focus within datetime-local
    }
  });

  const openClearModal = () => {
    if (!events.length) return;
    clearModal.classList.add("open");
  };

  const closeClearModal = () => {
    clearModal.classList.remove("open");
  };

  clearBtn.onclick = openClearModal;
  cancelClearModalBtn.onclick = closeClearModal;
  confirmClearBtn.onclick = () => {
    clearAllCloud();
    closeClearModal();
  };

  clearModal.addEventListener("click", (e) => {
    if (e.target === clearModal) closeClearModal();
  });

  // Escape key handler
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (dayDrawer.classList.contains('open')) {
        closeDayDrawer();
      } else if (clearModal.classList.contains('open')) {
        closeClearModal();
      } else if (editingId) {
        cancelEdit();
      }
    }
  });

  eventList.onclick = e => {
    const row = e.target.closest(".event-row");
    if (!row) return;
    const id = row.dataset.id;

    if (e.target.classList.contains("delete-btn")) {
      if (editingId === id) cancelEdit();
      const existing = pendingDeletes.get(id);
      if (existing) clearTimeout(existing.timer);
      const evt = events.find(evt => evt.id === id);
      const timer = setTimeout(() => {
        deleteFromCloud(id);
        pendingDeletes.delete(id);
        if (lastDeletedId === id) hideUndoToast();
      }, DELETE_TIMEOUT_MS);
      pendingDeletes.set(id, { timer });
      render();
      showUndoToast(evt ? evt.name : 'Event', id);
    } else if (e.target.classList.contains("edit-btn")) {
      startEdit(id);
    } else if (e.target.classList.contains("star-btn")) {
      const evt = events.find(evt => evt.id === id);
      if (evt) {
        updateInCloud(id, { ...evt, highlighted: !evt.highlighted });
      }
    }
  };

  renderCalendar();
  startTicker();

  // ============ TASK MANAGER ============
  const tasksRef = ref(db, 'tasks');
  
  const taskManagerOverlay = $("taskManagerOverlay");
  const closeTaskManager = $("closeTaskManager");
  const toggleTasks = $("toggleTasks");
  const taskSearch = $("taskSearch");
  const quickAddTask = $("quickAddTask");
  const quickAddRow = $("quickAddRow");
  const newTaskTitle = $("newTaskTitle");
  const newTaskDue = $("newTaskDue");
  const addTaskBtn = $("addTaskBtn");
  const taskPriorityPicker = $("taskPriorityPicker");
  const activeTasks = $("activeTasks");
  const completedTasks = $("completedTasks");
  const activeSection = $("activeSection");
  const completedSection = $("completedSection");
  const tasksEmpty = $("tasksEmpty");
  const taskEditModal = $("taskEditModal");
  const editTaskTitle = $("editTaskTitle");
  const editTaskContent = $("editTaskContent");
  const editTaskChecklist = $("editTaskChecklist");
  const newChecklistItem = $("newChecklistItem");
  const addChecklistItem = $("addChecklistItem");
  const editTaskPriority = $("editTaskPriority");
  const editTaskDue = $("editTaskDue");
  const clearDueBtn = $("clearDueBtn");
  const deleteTaskBtn = $("deleteTaskBtn");
  const saveTaskBtn = $("saveTaskBtn");
  
  let tasks = [];
  let editingTaskId = null;
  let editingTask = null;
  let selectedTaskPriority = 'medium';
  let currentFilter = 'all';
  let taskTickerHandle = null;
  
  const PRIORITY_ORDER = { urgent: 0, high: 1, medium: 2, low: 3, none: 4 };
  const PRIORITY_LABELS = { urgent: 'Urgent', high: 'High', medium: 'Medium', low: 'Low', none: '' };
  
  // Open/Close Task Manager
  toggleTasks.onclick = () => {
    taskManagerOverlay.classList.add('open');
    renderSubjectsSidebar();
    renderTasks();
    startTaskTicker();
  };
  
  closeTaskManager.onclick = () => {
    taskManagerOverlay.classList.remove('open');
    stopTaskTicker();
  };
  
  // Close on escape - handles all menus
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      // Close context menus first (highest priority)
      if (typeof hideContextMenu === 'function') hideContextMenu();
      if (typeof hideAddEventContextMenu === 'function') hideAddEventContextMenu();
      if (typeof hideEventContextMenu === 'function') hideEventContextMenu();
      
      // Then modals
      if (taskEditModal.classList.contains('open')) {
        closeTaskEditModal();
      } else if (taskManagerOverlay.classList.contains('open')) {
        taskManagerOverlay.classList.remove('open');
        stopTaskTicker();
      }
    }
  });
  
  // Quick add task - show full form on focus
  newTaskTitle.addEventListener('focus', () => {
    quickAddRow.style.display = 'flex';
  });
  
  // Collapse quick add when clicking outside
  taskManagerOverlay.addEventListener('click', (e) => {
    if (!quickAddTask.contains(e.target) && !newTaskTitle.value.trim()) {
      quickAddRow.style.display = 'none';
    }
  });
  
  // Priority picker in quick add
  taskPriorityPicker.addEventListener('click', (e) => {
    const option = e.target.closest('.priority-option');
    if (!option) return;
    taskPriorityPicker.querySelectorAll('.priority-option').forEach(o => o.classList.remove('selected'));
    option.classList.add('selected');
    selectedTaskPriority = option.dataset.priority;
  });
  
  // ============ UNIFIED ADD TASK FUNCTION ============
  function addTask() {
    const title = newTaskTitle.value.trim();
    if (!title) return;
    
    const dueValue = newTaskDue.value;
    const dueDate = dueValue ? parseLocal(dueValue) : null;
    
    const taskData = {
      title,
      content: '',
      priority: selectedTaskPriority,
      dueDate: dueDate ? dueDate.toISOString() : null,
      subject: newTaskSubject ? newTaskSubject.value || '' : '',
      checklist: [],
      completed: false,
      createdAt: new Date().toISOString()
    };
    
    const newTaskRef = push(tasksRef);
    set(newTaskRef, taskData);
    
    // Reset form
    newTaskTitle.value = '';
    newTaskDue.value = '';
    if (newTaskSubject) newTaskSubject.value = '';
    if (quickAddRow) quickAddRow.style.display = 'none';
    selectedTaskPriority = 'medium';
    taskPriorityPicker.querySelectorAll('.priority-option').forEach(o => o.classList.remove('selected'));
    taskPriorityPicker.querySelector('[data-priority="medium"]').classList.add('selected');
  }
  
  // Hook button to unified function
  addTaskBtn.onclick = addTask;
  
  // Filter pills
  document.querySelectorAll('.filter-pill').forEach(pill => {
    pill.addEventListener('click', () => {
      document.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('active'));
      pill.classList.add('active');
      currentFilter = pill.dataset.filter;
      renderTasks();
    });
  });
  
  // Search
  taskSearch.addEventListener('input', () => {
    renderTasks();
  });
  
  // Listen to tasks from Firebase
  onValue(tasksRef, (snapshot) => {
    const data = snapshot.val();
    if (data) {
      tasks = Object.keys(data).map(key => ({ id: key, ...data[key] }));
    } else {
      tasks = [];
    }
    if (taskManagerOverlay.classList.contains('open')) {
      renderTasks();
    }
    // Update calendar to show task indicators
    if (!sidebar.classList.contains('hidden')) {
      renderCalendar();
    }
  });
  
  function getFilteredTasks() {
    let filtered = [...tasks];
    
    // Apply search filter
    const searchTerm = taskSearch.value.trim().toLowerCase();
    if (searchTerm) {
      filtered = filtered.filter(t => 
        t.title.toLowerCase().includes(searchTerm) ||
        (t.content && t.content.toLowerCase().includes(searchTerm))
      );
    }
    
    // Apply status filter
    if (currentFilter === 'active') {
      filtered = filtered.filter(t => !t.completed);
    } else if (currentFilter === 'completed') {
      filtered = filtered.filter(t => t.completed);
    }
    
    return filtered;
  }
  
  function sortTasks(taskList) {
    // Sort by: priority first (urgent first), then by due date (soonest first), then by created date (newest first)
    return taskList.sort((a, b) => {
      // Priority comparison
      const priorityA = PRIORITY_ORDER[a.priority || 'none'];
      const priorityB = PRIORITY_ORDER[b.priority || 'none'];
      if (priorityA !== priorityB) return priorityA - priorityB;
      
      // Due date comparison (tasks with due dates come first, soonest first)
      if (a.dueDate && !b.dueDate) return -1;
      if (!a.dueDate && b.dueDate) return 1;
      if (a.dueDate && b.dueDate) {
        const dueDiff = new Date(a.dueDate) - new Date(b.dueDate);
        if (dueDiff !== 0) return dueDiff;
      }
      
      // Created date (newest first)
      return new Date(b.createdAt) - new Date(a.createdAt);
    });
  }
  
  function calcTaskCountdown(dueDate) {
    if (!dueDate) return null;
    const now = Date.now();
    const due = new Date(dueDate).getTime();
    const diff = due - now;
    
    if (diff <= 0) {
      return { overdue: true, text: 'Overdue', urgency: 'overdue' };
    }
    
    const days = Math.floor(diff / 86400000);
    const hours = Math.floor((diff % 86400000) / 3600000);
    const mins = Math.floor((diff % 3600000) / 60000);
    
    let text = '';
    let urgency = '';
    
    if (days > 0) {
      text = `${days}d ${hours}h`;
    } else if (hours > 0) {
      text = `${hours}h ${mins}m`;
    } else {
      text = `${mins}m`;
    }
    
    // Urgency levels for styling
    if (days === 0 && hours < 6) {
      urgency = 'soon';
    } else if (days === 0) {
      urgency = 'today';
    }
    
    return { overdue: false, text, urgency, days, hours, mins };
  }
  
  function renderTasks() {
    const filtered = getFilteredTasks();
    const active = filtered.filter(t => !t.completed);
    const completed = filtered.filter(t => t.completed);
    
    // Update sidebar counts
    updateSmartViewCounts();
    renderSubjectsSidebar();
    
    // Sort tasks
    sortTasks(active);
    sortTasks(completed);
    
    // Check if showing suggested tasks for empty sub-subject
    const showingSuggested = window.showingSuggestedTasks;
    
    // Active tasks section
    if (active.length > 0 || currentFilter === 'all' || currentFilter === 'active') {
      activeSection.style.display = 'block';
      let suggestedBanner = '';
      if (showingSuggested && active.length > 0) {
        suggestedBanner = `
          <div class="suggested-tasks-banner">
            <span class="suggested-icon">üí°</span>
            <span>◊ê◊ô◊ü ◊û◊©◊ô◊û◊ï◊™ ◊ë◊™◊™-◊†◊ï◊©◊ê ◊ñ◊î. ◊û◊ï◊¶◊í◊ï◊™ ◊û◊©◊ô◊û◊ï◊™ ◊ì◊ó◊ï◊§◊ï◊™ ◊û◊õ◊ú ◊î◊†◊ï◊©◊ê◊ô◊ù:</span>
          </div>
        `;
      }
      activeTasks.innerHTML = suggestedBanner + active.map(t => renderTaskItem(t, showingSuggested)).join('');
    } else {
      activeSection.style.display = 'none';
    }
    
    // Completed tasks section
    if (completed.length > 0 && (currentFilter === 'all' || currentFilter === 'completed') && !showingSuggested) {
      completedSection.style.display = 'block';
      completedTasks.innerHTML = completed.map(t => renderTaskItem(t)).join('');
    } else {
      completedSection.style.display = 'none';
    }
    
    // Empty state
    if (filtered.length === 0 && !showingSuggested) {
      tasksEmpty.style.display = 'block';
      activeSection.style.display = 'none';
    } else {
      tasksEmpty.style.display = 'none';
    }
    
    // Event delegation is set up once below, no need to call attachTaskEventHandlers
  }
  
  function renderTaskItem(task, showSubjectTag = false) {
    const priority = task.priority || 'none';
    const countdown = calcTaskCountdown(task.dueDate);
    
    let dueDateHtml = '';
    if (task.dueDate) {
      const dueDate = new Date(task.dueDate);
      const dateStr = dueDate.toLocaleDateString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
      const urgencyClass = countdown?.overdue ? 'overdue' : (countdown?.urgency === 'soon' ? 'soon' : '');
      dueDateHtml = `<span class="task-due ${urgencyClass}">üìÖ ${dateStr}</span>`;
    }
    
    let countdownHtml = '';
    if (countdown) {
      const countdownClass = countdown.overdue ? 'overdue' : (countdown.urgency === 'soon' ? 'soon' : '');
      countdownHtml = `<span class="task-countdown ${countdownClass}" data-due="${task.dueDate}">${countdown.text}</span>`;
    }
    
    // Subject badge - show when viewing "all" OR when explicitly requested (suggested tasks)
    let subjectHtml = '';
    if (task.subject) {
      const subj = subjects.find(s => s.id === task.subject);
      if (subj) {
        const shouldShow = (currentSubject === 'all') || showSubjectTag;
        if (shouldShow) {
          // If it's a sub-subject and showing tag, show parent > child
          let displayName = subj.name;
          if (showSubjectTag && subj.parentId) {
            const parent = subjects.find(s => s.id === subj.parentId);
            if (parent) {
              displayName = `${parent.name} ‚Ä∫ ${subj.name}`;
            }
          }
          subjectHtml = `<span class="task-subject-badge" style="--subject-color: ${subj.color};">${escapeHtml(displayName)}</span>`;
        }
      }
    }
    
    let subtasksHtml = '';
    if (task.checklist && task.checklist.length > 0) {
      const checked = task.checklist.filter(c => c.checked).length;
      const total = task.checklist.length;
      const maxShow = 3;
      const items = task.checklist.slice(0, maxShow);
      
      subtasksHtml = `
        <div class="task-subtasks">
          <div class="task-subtask-progress">${checked}/${total} completed</div>
          ${items.map((item, i) => `
            <div class="task-subtask ${item.checked ? 'checked' : ''}">
              <input type="checkbox" ${item.checked ? 'checked' : ''} data-index="${i}" />
              <span>${escapeHtml(item.text)}</span>
            </div>
          `).join('')}
          ${task.checklist.length > maxShow ? `<div style="font-size: 12px; color: var(--muted);">+${task.checklist.length - maxShow} more</div>` : ''}
        </div>
      `;
    }
    
    const priorityBadge = priority !== 'none' 
      ? `<span class="task-priority-badge">${PRIORITY_LABELS[priority]}</span>` 
      : '';
    
    return `
      <div class="task-item priority-${priority} ${task.completed ? 'completed' : ''}" data-id="${task.id}">
        <div class="task-checkbox" data-action="toggle">${task.completed ? '‚úì' : ''}</div>
        <div class="task-main">
          <div class="task-title-row">
            <span class="task-title">${escapeHtml(task.title)}</span>
            ${subjectHtml}
            ${priorityBadge}
          </div>
          <div class="task-meta">
            ${dueDateHtml}
            ${countdownHtml}
          </div>
          ${subtasksHtml}
        </div>
        <div class="task-actions">
          <button class="task-action-btn" data-action="edit" title="Edit" aria-label="◊¢◊®◊ô◊õ◊î">‚úèÔ∏è</button>
          <button class="task-action-btn delete" data-action="delete" title="Delete" aria-label="◊û◊ó◊ß">üóëÔ∏è</button>
        </div>
      </div>
    `;
  }
  
  // ============ EVENT DELEGATION FOR TASK LIST ============
  // Single click handler for all task interactions - much more efficient than per-item listeners
  function setupTaskEventDelegation() {
    const containers = [activeTasks, completedTasks];
    
    containers.forEach(container => {
      if (!container) return;
      
      container.addEventListener('click', (e) => {
        const taskItem = e.target.closest('.task-item');
        if (!taskItem) return;
        
        const taskId = taskItem.dataset.id;
        const task = tasks.find(t => t.id === taskId);
        if (!task) return;
        
        // Check what was clicked
        const action = e.target.closest('[data-action]')?.dataset.action;
        const isSubtaskCheckbox = e.target.closest('.task-subtask input[type="checkbox"]');
        const isMainArea = e.target.closest('.task-main') && !isSubtaskCheckbox;
        
        if (action === 'toggle' || e.target.closest('.task-checkbox')) {
          // Toggle complete
          e.stopPropagation();
          const { id, ...cleanTask } = task;
          set(ref(db, 'tasks/' + taskId), { ...cleanTask, completed: !task.completed });
        } else if (action === 'edit') {
          // Edit button
          e.stopPropagation();
          openTaskEditModal(taskId);
        } else if (action === 'delete') {
          // Delete button
          e.stopPropagation();
          remove(ref(db, 'tasks/' + taskId));
        } else if (isSubtaskCheckbox) {
          // Subtask checkbox
          e.stopPropagation();
          const idx = parseInt(isSubtaskCheckbox.dataset.index);
          if (task.checklist && task.checklist[idx] !== undefined) {
            task.checklist[idx].checked = isSubtaskCheckbox.checked;
            const { id, ...cleanTask } = task;
            set(ref(db, 'tasks/' + taskId), cleanTask);
          }
        } else if (isMainArea) {
          // Click on main area to edit
          openTaskEditModal(taskId);
        }
      });
    });
  }
  
  // Initialize event delegation once
  setupTaskEventDelegation();
  
  // Task countdown ticker
  function startTaskTicker() {
    if (taskTickerHandle) return;
    const tick = () => {
      document.querySelectorAll('.task-countdown[data-due]').forEach(el => {
        const dueDate = el.dataset.due;
        const countdown = calcTaskCountdown(dueDate);
        if (countdown) {
          el.textContent = countdown.text;
          el.className = 'task-countdown ' + (countdown.overdue ? 'overdue' : (countdown.urgency === 'soon' ? 'soon' : ''));
        }
      });
    };
    tick();
    taskTickerHandle = setInterval(tick, 60000); // Update every minute
  }
  
  function stopTaskTicker() {
    if (taskTickerHandle) {
      clearInterval(taskTickerHandle);
      taskTickerHandle = null;
    }
  }
  
  // Task Edit Modal
  function openTaskEditModal(taskId) {
    editingTaskId = taskId;
    editingTask = JSON.parse(JSON.stringify(tasks.find(t => t.id === taskId)));
    if (!editingTask) return;
    
    editTaskTitle.value = editingTask.title || '';
    editTaskContent.value = editingTask.content || '';
    
    // Set priority
    editTaskPriority.querySelectorAll('.priority-option').forEach(o => {
      o.classList.toggle('selected', o.dataset.priority === (editingTask.priority || 'none'));
    });
    
    // Set due date
    if (editingTask.dueDate) {
      editTaskDue.value = toLocalDatetime(editingTask.dueDate);
    } else {
      editTaskDue.value = '';
    }
    
    // Render checklist
    renderEditChecklist();
    
    taskEditModal.classList.add('open');
  }
  
  function closeTaskEditModal() {
    taskEditModal.classList.remove('open');
    editingTaskId = null;
    editingTask = null;
  }
  
  taskEditModal.addEventListener('click', (e) => {
    if (e.target === taskEditModal) closeTaskEditModal();
  });
  
  // Edit modal priority picker
  editTaskPriority.addEventListener('click', (e) => {
    const option = e.target.closest('.priority-option');
    if (!option || !editingTask) return;
    editTaskPriority.querySelectorAll('.priority-option').forEach(o => o.classList.remove('selected'));
    option.classList.add('selected');
    editingTask.priority = option.dataset.priority;
  });
  
  // Clear due date
  clearDueBtn.onclick = () => {
    editTaskDue.value = '';
    if (editingTask) editingTask.dueDate = null;
  };
  
  function renderEditChecklist() {
    if (!editingTask.checklist) editingTask.checklist = [];
    editTaskChecklist.innerHTML = editingTask.checklist.map((item, i) => `
      <div class="task-checklist-item ${item.checked ? 'checked' : ''}">
        <input type="checkbox" ${item.checked ? 'checked' : ''} data-index="${i}" />
        <span>${escapeHtml(item.text)}</span>
        <button class="task-action-btn delete" data-index="${i}" style="margin-left: auto;">√ó</button>
      </div>
    `).join('');
    
    // Add handlers
    editTaskChecklist.querySelectorAll('input[type="checkbox"]').forEach(cb => {
      cb.addEventListener('change', () => {
        const idx = parseInt(cb.dataset.index);
        editingTask.checklist[idx].checked = cb.checked;
        renderEditChecklist();
      });
    });
    
    editTaskChecklist.querySelectorAll('.task-action-btn.delete').forEach(btn => {
      btn.addEventListener('click', () => {
        const idx = parseInt(btn.dataset.index);
        editingTask.checklist.splice(idx, 1);
        renderEditChecklist();
      });
    });
  }
  
  addChecklistItem.onclick = () => {
    const text = newChecklistItem.value.trim();
    if (!text || !editingTask) return;
    editingTask.checklist.push({ text, checked: false });
    newChecklistItem.value = '';
    renderEditChecklist();
  };
  
  newChecklistItem.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') addChecklistItem.click();
  });
  
  // Delete task
  deleteTaskBtn.onclick = () => {
    if (!editingTaskId) return;
    remove(ref(db, 'tasks/' + editingTaskId));
    closeTaskEditModal();
  };
  
  // Save task
  saveTaskBtn.onclick = () => {
    if (!editingTaskId || !editingTask) return;
    
    editingTask.title = editTaskTitle.value.trim() || 'Untitled';
    editingTask.content = editTaskContent.value.trim();
    editingTask.subject = editTaskSubject.value || '';
    
    // Update due date
    const dueValue = editTaskDue.value;
    if (dueValue) {
      const parsedDue = parseLocal(dueValue);
      editingTask.dueDate = parsedDue ? parsedDue.toISOString() : null;
    } else {
      editingTask.dueDate = null;
    }
    
    // Remove id before saving to Firebase (id is the key, not data)
    const { id, ...cleanTask } = editingTask;
    set(ref(db, 'tasks/' + editingTaskId), cleanTask);
    closeTaskEditModal();
  };

  // ============ SUBJECTS / CATEGORIES ============
  const subjectsRef = ref(db, 'subjects');
  
  const subjectTabs = $("subjectTabs");
  const addSubjectBtn = $("addSubjectBtn");
  const addSubjectSidebarBtn = $("addSubjectSidebarBtn");
  const subjectsList = $("subjectsList");
  const smartViewsList = $("smartViewsList");
  const subjectModal = $("subjectModal");
  const subjectModalTitle = $("subjectModalTitle");
  const subjectNameInput = $("subjectNameInput");
  const subjectColorPicker = $("subjectColorPicker");
  const cancelSubjectBtn = $("cancelSubjectBtn");
  const deleteSubjectBtn = $("deleteSubjectBtn");
  const saveSubjectBtn = $("saveSubjectBtn");
  const newTaskSubject = $("newTaskSubject");
  const editTaskSubject = $("editTaskSubject");
  const parentSubjectSelect = $("parentSubjectSelect");
  const contextMenu = $("contextMenu");
  const eventContextMenu = $("eventContextMenu");
  const reminderModal = $("reminderModal");
  
  let subjects = [];
  let currentSubject = 'all';
  let currentSmartView = null; // 'today', 'week', 'overdue', 'nodate'
  let editingSubjectId = null;
  let selectedSubjectColor = '#667eea';
  let contextMenuTarget = null;
  let eventContextMenuTarget = null;
  let expandedSubjects = new Set(); // Track which subjects are expanded
  
  // Listen to subjects from Firebase
  onValue(subjectsRef, (snapshot) => {
    const data = snapshot.val();
    if (data) {
      subjects = Object.keys(data).map(key => ({ id: key, ...data[key] }));
    } else {
      subjects = [];
    }
    renderSubjectsSidebar();
    updateSubjectSelectors();
    updateParentSubjectSelector();
  });
  
  // Get top-level subjects (no parent)
  function getTopLevelSubjects() {
    return subjects.filter(s => !s.parentId);
  }
  
  // Get children of a subject
  function getChildSubjects(parentId) {
    return subjects.filter(s => s.parentId === parentId);
  }
  
  // Count tasks for a subject including children
  function countSubjectTasks(subjectId, includeChildren = true) {
    let count = tasks.filter(t => t.subject === subjectId && !t.completed).length;
    if (includeChildren) {
      const children = getChildSubjects(subjectId);
      children.forEach(c => {
        count += tasks.filter(t => t.subject === c.id && !t.completed).length;
      });
    }
    return count;
  }
  
  // ============ SMART VIEWS COUNTS ============
  function updateSmartViewCounts() {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    const weekLater = new Date(today);
    weekLater.setDate(weekLater.getDate() + 7);
    
    const activeTasks = tasks.filter(t => !t.completed);
    
    const allCount = activeTasks.length;
    const todayCount = activeTasks.filter(t => {
      if (!t.dueDate) return false;
      const due = new Date(t.dueDate);
      return due >= today && due < tomorrow;
    }).length;
    const weekCount = activeTasks.filter(t => {
      if (!t.dueDate) return false;
      const due = new Date(t.dueDate);
      return due >= today && due < weekLater;
    }).length;
    const overdueCount = activeTasks.filter(t => {
      if (!t.dueDate) return false;
      const due = new Date(t.dueDate);
      return due < now; // Use 'now' for accurate overdue detection
    }).length;
    const noDateCount = activeTasks.filter(t => !t.dueDate).length;
    
    // Update counts
    const countAll = $('countAll');
    const countToday = $('countToday');
    const countWeek = $('countWeek');
    const countOverdue = $('countOverdue');
    const countNoDate = $('countNoDate');
    
    if (countAll) countAll.textContent = allCount;
    if (countToday) countToday.textContent = todayCount;
    if (countWeek) countWeek.textContent = weekCount;
    if (countOverdue) countOverdue.textContent = overdueCount;
    if (countNoDate) countNoDate.textContent = noDateCount;
  }
  
  // ============ SIDEBAR SUBJECTS RENDERING ============
  function renderSubjectsSidebar() {
    if (!subjectsList) return;
    
    updateSmartViewCounts();
    
    let html = '';
    const topLevel = getTopLevelSubjects();
    
    topLevel.forEach(s => {
      const children = getChildSubjects(s.id);
      const hasChildren = children.length > 0;
      const isExpanded = expandedSubjects.has(s.id);
      const isActive = currentSubject === s.id && !currentSmartView;
      const taskCount = countSubjectTasks(s.id, true);
      
      html += `
        <div class="subject-list-item ${isExpanded ? 'expanded' : ''}" data-subject-id="${s.id}">
          <div class="subject-list-header ${isActive ? 'active' : ''}" data-subject="${s.id}">
            ${hasChildren ? `<span class="collapse-arrow">‚ñº</span>` : ''}
            <span class="subject-color-dot" style="background: ${s.color};"></span>
            <span class="subject-name">${escapeHtml(s.name)}</span>
            ${taskCount > 0 ? `<span class="subject-count">${taskCount}</span>` : ''}
            <div class="subject-actions">
              <button class="subject-action-btn" data-action="add-sub" title="◊î◊ï◊°◊£ ◊™◊™-◊†◊ï◊©◊ê" aria-label="◊î◊ï◊°◊£ ◊™◊™-◊†◊ï◊©◊ê">‚ûï</button>
              <button class="subject-action-btn" data-action="edit" title="◊¢◊®◊ô◊õ◊î" aria-label="◊¢◊®◊ô◊õ◊î">‚úèÔ∏è</button>
              <button class="subject-action-btn delete" data-action="delete" title="◊û◊ó◊ß" aria-label="◊û◊ó◊ß">üóëÔ∏è</button>
            </div>
          </div>
          ${hasChildren ? `
            <div class="subject-list-children">
              ${children.map(c => {
                const childCount = tasks.filter(t => t.subject === c.id && !t.completed).length;
                const childActive = currentSubject === c.id && !currentSmartView;
                return `
                  <div class="subject-child-item ${childActive ? 'active' : ''}" data-subject="${c.id}">
                    <span class="child-color" style="background: ${c.color};"></span>
                    <span class="child-name">${escapeHtml(c.name)}</span>
                    ${childCount > 0 ? `<span class="child-count">${childCount}</span>` : ''}
                    <div class="subject-actions">
                      <button class="subject-action-btn" data-action="edit" title="◊¢◊®◊ô◊õ◊î">‚úèÔ∏è</button>
                      <button class="subject-action-btn delete" data-action="delete" title="◊û◊ó◊ß">üóëÔ∏è</button>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          ` : ''}
        </div>
      `;
    });
    
    subjectsList.innerHTML = html;
    
    // Setup event handlers
    setupSubjectsSidebarHandlers();
    setupSmartViewsHandlers();
  }
  
  function setupSubjectsSidebarHandlers() {
    // Subject headers click - toggle collapse OR select subject
    subjectsList.querySelectorAll('.subject-list-header').forEach(header => {
      header.addEventListener('click', (e) => {
        // Don't do anything if clicking action buttons
        if (e.target.closest('.subject-actions')) {
          return;
        }
        
        const subjectId = header.dataset.subject;
        const subjectItem = header.closest('.subject-list-item');
        const hasChildren = subjectItem.querySelector('.subject-list-children');
        
        // If has children, toggle collapse on single click
        if (hasChildren) {
          toggleSubjectExpanded(subjectItem.dataset.subjectId);
        }
        
        // Always select the subject
        currentSmartView = null;
        currentSubject = subjectId;
        renderSubjectsSidebar();
        renderTasks();
      });
      
      // Right-click context menu
      header.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        showContextMenu(e.clientX, e.clientY, header.dataset.subject);
      });
    });
    
    // Collapse arrows - clicking arrow only toggles (doesn't select)
    subjectsList.querySelectorAll('.collapse-arrow').forEach(arrow => {
      arrow.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevent header click from also firing
        const subjectId = arrow.closest('.subject-list-item').dataset.subjectId;
        toggleSubjectExpanded(subjectId);
      });
    });
    
    // Subject action buttons (edit, delete, add-sub)
    subjectsList.querySelectorAll('.subject-action-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const action = btn.dataset.action;
        const subjectId = btn.closest('[data-subject]').dataset.subject;
        
        if (action === 'edit') {
          openSubjectModal(subjectId);
        } else if (action === 'add-sub') {
          openSubjectModal(null, subjectId);
        } else if (action === 'delete') {
          if (confirm('◊î◊ê◊ù ◊ê◊™◊î ◊ë◊ò◊ï◊ó ◊©◊ë◊®◊¶◊ï◊†◊ö ◊ú◊û◊ó◊ï◊ß ◊ê◊™ ◊î◊†◊ï◊©◊ê ◊î◊ñ◊î?')) {
            deleteSubjectById(subjectId);
          }
        }
      });
    });
    
    // Child items click
    subjectsList.querySelectorAll('.subject-child-item').forEach(child => {
      child.addEventListener('click', (e) => {
        // Don't select if clicking action buttons
        if (e.target.closest('.subject-actions')) {
          return;
        }
        
        currentSmartView = null;
        currentSubject = child.dataset.subject;
        renderSubjectsSidebar();
        renderTasks();
      });
      
      // Right-click context menu
      child.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        showContextMenu(e.clientX, e.clientY, child.dataset.subject);
      });
    });
  }
  
  function toggleSubjectExpanded(subjectId) {
    const item = subjectsList.querySelector(`.subject-list-item[data-subject-id="${subjectId}"]`);
    
    if (expandedSubjects.has(subjectId)) {
      expandedSubjects.delete(subjectId);
      if (item) item.classList.remove('expanded');
    } else {
      expandedSubjects.add(subjectId);
      if (item) item.classList.add('expanded');
    }
  }
  
  function setupSmartViewsHandlers() {
    if (!smartViewsList) return;
    
    // Clone and replace to remove all old event listeners
    smartViewsList.querySelectorAll('.smart-view-item').forEach(item => {
      const newItem = item.cloneNode(true);
      item.parentNode.replaceChild(newItem, item);
    });
    
    smartViewsList.querySelectorAll('.smart-view-item').forEach(item => {
      item.addEventListener('click', () => {
        const view = item.dataset.view;
        if (view === 'all') {
          currentSmartView = null;
          currentSubject = 'all';
        } else {
          currentSmartView = view;
          currentSubject = 'all';
        }
        
        // Update active states
        smartViewsList.querySelectorAll('.smart-view-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        
        renderSubjectsSidebar();
        renderTasks();
      });
    });
    
    // Set initial active state
    const activeView = currentSmartView || 'all';
    smartViewsList.querySelectorAll('.smart-view-item').forEach(item => {
      item.classList.toggle('active', item.dataset.view === activeView);
    });
  }
  
  // Add subject sidebar button handler
  if (addSubjectSidebarBtn) {
    addSubjectSidebarBtn.addEventListener('click', () => openSubjectModal());
  }
  
  // ============ CONTEXT MENU ============
  function showContextMenu(x, y, subjectId) {
    contextMenuTarget = subjectId;
    const subject = subjects.find(s => s.id === subjectId);
    
    // Update menu items based on subject type
    const addSubItem = contextMenu.querySelector('[data-action="add-sub"]');
    if (subject && subject.parentId) {
      // It's a sub-subject, hide "add sub" option
      addSubItem.style.display = 'none';
    } else {
      addSubItem.style.display = 'flex';
    }
    
    // Position and show menu
    contextMenu.style.left = x + 'px';
    contextMenu.style.top = y + 'px';
    contextMenu.classList.add('open');
  }
  
  function hideContextMenu() {
    contextMenu.classList.remove('open');
    contextMenuTarget = null;
    hideEventContextMenu();
  }
  
  // ============ EVENT CONTEXT MENU ============
  function showEventContextMenu(x, y, eventId) {
    eventContextMenuTarget = eventId;
    const evt = events.find(e => e.id === eventId);
    
    // Update star text based on current state
    const starItem = eventContextMenu.querySelector('[data-action="star"]');
    if (starItem && evt) {
      starItem.innerHTML = evt.highlighted ? '‚≠ê ◊î◊°◊® ◊û◊ï◊¢◊ì◊£' : '‚≠ê ◊°◊û◊ü ◊õ◊û◊ï◊¢◊ì◊£';
    }
    
    // Position and show menu
    eventContextMenu.style.left = x + 'px';
    eventContextMenu.style.top = y + 'px';
    eventContextMenu.classList.add('open');
  }
  
  function hideEventContextMenu() {
    if (eventContextMenu) {
      eventContextMenu.classList.remove('open');
    }
    eventContextMenuTarget = null;
    hideAddEventContextMenu();
  }
  
  // ============ ADD EVENT CONTEXT MENU ============
  const addEventContextMenu = $("addEventContextMenu");
  
  function showAddEventContextMenu(x, y) {
    if (!addEventContextMenu) return;
    
    // Position and show menu
    addEventContextMenu.style.left = x + 'px';
    addEventContextMenu.style.top = y + 'px';
    addEventContextMenu.classList.add('open');
  }
  
  function hideAddEventContextMenu() {
    if (addEventContextMenu) {
      addEventContextMenu.classList.remove('open');
    }
  }
  
  // Add event context menu item clicks
  if (addEventContextMenu) {
    addEventContextMenu.addEventListener('click', (e) => {
      const action = e.target.closest('.context-menu-item')?.dataset.action;
      if (!action) return;
      
      const now = new Date();
      let targetDate = new Date();
      
      if (action === 'add') {
        // Focus on the input panel
        eventName.focus();
        hideAddEventContextMenu();
        return;
      } else if (action === 'add-tomorrow') {
        targetDate.setDate(targetDate.getDate() + 1);
        targetDate.setHours(12, 0, 0, 0);
      } else if (action === 'add-week') {
        targetDate.setDate(targetDate.getDate() + 7);
        targetDate.setHours(12, 0, 0, 0);
      }
      
      // Pre-fill the date - format from local date directly (not via ISO/UTC)
      const pad = n => String(n).padStart(2, '0');
      const localDateStr = `${targetDate.getFullYear()}-${pad(targetDate.getMonth()+1)}-${pad(targetDate.getDate())}T${pad(targetDate.getHours())}:${pad(targetDate.getMinutes())}`;
      eventDate.value = localDateStr;
      eventName.focus();
      
      hideAddEventContextMenu();
    });
  }
  
  // Add right-click on event list area to show add event menu
  eventList.addEventListener('contextmenu', (e) => {
    // Only show add menu if not clicking on an event row
    if (!e.target.closest('.event-row')) {
      e.preventDefault();
      hideContextMenu();
      showAddEventContextMenu(e.clientX, e.clientY);
    }
  });
  
  // Also add to empty state
  emptyState.addEventListener('contextmenu', (e) => {
    e.preventDefault();
    hideContextMenu();
    showAddEventContextMenu(e.clientX, e.clientY);
  });
  
  // Event context menu item clicks
  if (eventContextMenu) {
    eventContextMenu.addEventListener('click', (e) => {
      const action = e.target.closest('.context-menu-item')?.dataset.action;
      if (!action || !eventContextMenuTarget) return;
      
      const evt = events.find(ev => ev.id === eventContextMenuTarget);
      
      if (action === 'edit') {
        startEdit(eventContextMenuTarget);
      } else if (action === 'star') {
        if (evt) {
          updateInCloud(eventContextMenuTarget, { ...evt, highlighted: !evt.highlighted });
        }
      } else if (action === 'duplicate') {
        if (evt) {
          saveToCloud({
            name: evt.name + ' (◊î◊¢◊™◊ß)',
            date: evt.date,
            notes: evt.notes || null,
            highlighted: false
          });
        }
      } else if (action === 'delete') {
        const existing = pendingDeletes.get(eventContextMenuTarget);
        if (existing) clearTimeout(existing.timer);
        const timer = setTimeout(() => {
          deleteFromCloud(eventContextMenuTarget);
          pendingDeletes.delete(eventContextMenuTarget);
          if (lastDeletedId === eventContextMenuTarget) hideUndoToast();
        }, DELETE_TIMEOUT_MS);
        pendingDeletes.set(eventContextMenuTarget, { timer });
        render();
        showUndoToast(evt ? evt.name : 'Event', eventContextMenuTarget);
      }
      
      hideEventContextMenu();
    });
  }
  
  // Context menu item clicks (subjects)
  contextMenu.addEventListener('click', (e) => {
    const action = e.target.closest('.context-menu-item')?.dataset.action;
    if (!action || !contextMenuTarget) return;
    
    if (action === 'edit') {
      openSubjectModal(contextMenuTarget);
    } else if (action === 'add-sub') {
      openSubjectModal(null, contextMenuTarget);
    } else if (action === 'delete') {
      deleteSubjectById(contextMenuTarget);
    }
    
    hideContextMenu();
  });
  
  // Hide context menu on click outside
  document.addEventListener('click', (e) => {
    if (!contextMenu.contains(e.target) && 
        (!eventContextMenu || !eventContextMenu.contains(e.target)) &&
        (!addEventContextMenu || !addEventContextMenu.contains(e.target))) {
      hideContextMenu();
      hideAddEventContextMenu();
    }
  });
  
  document.addEventListener('contextmenu', (e) => {
    // Hide menus when right-clicking elsewhere
    if (!e.target.closest('.subject-list-header') && !e.target.closest('.subject-child-item')) {
      hideContextMenu();
    }
    if (!e.target.closest('.event-row') && !e.target.closest('.event-list') && !e.target.closest('.empty-state')) {
      hideEventContextMenu();
      hideAddEventContextMenu();
    }
  });
  
  function updateSubjectSelectors() {
    // Build hierarchical options for task subject selectors
    let options = `<option value="">◊ú◊ú◊ê ◊†◊ï◊©◊ê</option>`;
    
    const topLevel = getTopLevelSubjects();
    topLevel.forEach(s => {
      options += `<option value="${s.id}">${escapeHtml(s.name)}</option>`;
      const children = getChildSubjects(s.id);
      children.forEach(c => {
        options += `<option value="${c.id}">&nbsp;&nbsp;‚Ü≥ ${escapeHtml(c.name)}</option>`;
      });
    });
    
    newTaskSubject.innerHTML = options;
    editTaskSubject.innerHTML = options;
  }
  
  function updateParentSubjectSelector() {
    // Only top-level subjects can be parents
    let options = `<option value="">◊ú◊ú◊ê (◊†◊ï◊©◊ê ◊®◊ê◊©◊ô)</option>`;
    const topLevel = getTopLevelSubjects();
    topLevel.forEach(s => {
      // Don't allow setting itself as parent when editing
      if (s.id !== editingSubjectId) {
        options += `<option value="${s.id}">${escapeHtml(s.name)}</option>`;
      }
    });
    parentSubjectSelect.innerHTML = options;
  }
  
  // Update getFilteredTasks to include subject filter AND smart views
  const originalGetFilteredTasks = getFilteredTasks;
  getFilteredTasks = function() {
    let filtered = originalGetFilteredTasks();
    
    // Apply smart view filter
    if (currentSmartView) {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      const weekLater = new Date(today);
      weekLater.setDate(weekLater.getDate() + 7);
      
      if (currentSmartView === 'today') {
        filtered = filtered.filter(t => {
          if (!t.dueDate) return false;
          const due = new Date(t.dueDate);
          return due >= today && due < tomorrow;
        });
      } else if (currentSmartView === 'week') {
        filtered = filtered.filter(t => {
          if (!t.dueDate) return false;
          const due = new Date(t.dueDate);
          return due >= today && due < weekLater;
        });
      } else if (currentSmartView === 'overdue') {
        filtered = filtered.filter(t => {
          if (!t.dueDate || t.completed) return false;
          return new Date(t.dueDate) < now;
        });
      } else if (currentSmartView === 'nodate') {
        filtered = filtered.filter(t => !t.dueDate && !t.completed);
      }
    }
    
    // Apply subject filter
    if (currentSubject !== 'all' && !currentSmartView) {
      const selectedSubject = subjects.find(s => s.id === currentSubject);
      const isSubSubject = selectedSubject && selectedSubject.parentId;
      
      // Get all valid subject IDs (current + children if parent)
      const validIds = [currentSubject];
      const children = getChildSubjects(currentSubject);
      children.forEach(c => validIds.push(c.id));
      
      const subjectFiltered = filtered.filter(t => validIds.includes(t.subject));
      
      // If this is a sub-subject with no tasks, show high priority tasks from all subjects due today/tomorrow
      if (isSubSubject && subjectFiltered.filter(t => !t.completed).length === 0) {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const dayAfterTomorrow = new Date(today);
        dayAfterTomorrow.setDate(dayAfterTomorrow.getDate() + 2);
        
        // Get high priority tasks (urgent, high) due today or tomorrow from all subjects
        filtered = filtered.filter(t => {
          if (t.completed) return false;
          const isHighPriority = t.priority === 'urgent' || t.priority === 'high';
          const hasDueDate = t.dueDate;
          if (!hasDueDate) return isHighPriority; // Include high priority without date
          const due = new Date(t.dueDate);
          const isDueSoon = due >= today && due < dayAfterTomorrow;
          return isHighPriority || isDueSoon;
        });
        
        // Sort by priority then by due date
        filtered.sort((a, b) => {
          const priorityOrder = { urgent: 0, high: 1, medium: 2, low: 3, none: 4 };
          const pDiff = (priorityOrder[a.priority] || 4) - (priorityOrder[b.priority] || 4);
          if (pDiff !== 0) return pDiff;
          if (!a.dueDate && !b.dueDate) return 0;
          if (!a.dueDate) return 1;
          if (!b.dueDate) return -1;
          return new Date(a.dueDate) - new Date(b.dueDate);
        });
        
        // Mark that we're showing suggested tasks
        window.showingSuggestedTasks = true;
      } else {
        filtered = subjectFiltered;
        window.showingSuggestedTasks = false;
      }
    } else {
      window.showingSuggestedTasks = false;
    }
    
    return filtered;
  };
  
  // Add subject button (legacy - might not exist now)
  if (addSubjectBtn) {
    addSubjectBtn.onclick = () => {
      openSubjectModal(null, null);
    };
  }
  
  function openSubjectModal(subjectId, parentId = null) {
    editingSubjectId = subjectId;
    updateParentSubjectSelector();
    
    if (subjectId) {
      const subject = subjects.find(s => s.id === subjectId);
      if (!subject) return;
      subjectModalTitle.textContent = '◊¢◊®◊ï◊ö ◊†◊ï◊©◊ê';
      subjectNameInput.value = subject.name;
      selectedSubjectColor = subject.color;
      parentSubjectSelect.value = subject.parentId || '';
      deleteSubjectBtn.style.display = 'block';
      
      // If editing a parent with children, disable parent selector
      const children = getChildSubjects(subjectId);
      parentSubjectSelect.disabled = children.length > 0;
    } else {
      subjectModalTitle.textContent = parentId ? '◊î◊ï◊°◊£ ◊™◊™-◊†◊ï◊©◊ê' : '◊î◊ï◊°◊£ ◊†◊ï◊©◊ê ◊ó◊ì◊©';
      subjectNameInput.value = '';
      selectedSubjectColor = '#667eea';
      parentSubjectSelect.value = parentId || '';
      parentSubjectSelect.disabled = false;
      deleteSubjectBtn.style.display = 'none';
    }
    
    // Update color picker selection
    subjectColorPicker.querySelectorAll('.subject-color-option').forEach(opt => {
      opt.classList.toggle('selected', opt.dataset.color === selectedSubjectColor);
    });
    
    subjectModal.classList.add('open');
    subjectNameInput.focus();
  }
  
  function closeSubjectModal() {
    subjectModal.classList.remove('open');
    editingSubjectId = null;
  }
  
  subjectModal.addEventListener('click', (e) => {
    if (e.target === subjectModal) closeSubjectModal();
  });
  
  // Color picker
  subjectColorPicker.addEventListener('click', (e) => {
    const option = e.target.closest('.subject-color-option');
    if (!option) return;
    subjectColorPicker.querySelectorAll('.subject-color-option').forEach(o => o.classList.remove('selected'));
    option.classList.add('selected');
    selectedSubjectColor = option.dataset.color;
  });
  
  // Cancel button
  cancelSubjectBtn.onclick = closeSubjectModal;
  
  // Save subject
  saveSubjectBtn.onclick = () => {
    const name = subjectNameInput.value.trim();
    if (!name) return;
    
    const parentId = parentSubjectSelect.value || null;
    
    const subjectData = {
      name,
      color: selectedSubjectColor,
      parentId,
      createdAt: new Date().toISOString()
    };
    
    if (editingSubjectId) {
      // Update existing
      set(ref(db, 'subjects/' + editingSubjectId), subjectData);
    } else {
      // Create new
      const newSubjectRef = push(subjectsRef);
      set(newSubjectRef, subjectData);
    }
    
    closeSubjectModal();
  };
  
  subjectNameInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') saveSubjectBtn.click();
  });
  
  // Delete subject by ID (used from dropdown buttons)
  function deleteSubjectById(subjectId) {
    const subject = subjects.find(s => s.id === subjectId);
    if (!subject) return;
    
    const children = getChildSubjects(subjectId);
    let message = `Delete "${subject.name}"?`;
    if (children.length > 0) {
      message += ` This will also delete ${children.length} sub-subject(s).`;
    }
    message += ' Tasks will remain but become uncategorized.';
    
    if (confirm(message)) {
      // Delete children first
      children.forEach(child => {
        tasks.forEach(task => {
          if (task.subject === child.id) {
            set(ref(db, 'tasks/' + task.id + '/subject'), '');
          }
        });
        remove(ref(db, 'subjects/' + child.id));
      });
      
      // Remove subject from all tasks that have it
      tasks.forEach(task => {
        if (task.subject === subjectId) {
          set(ref(db, 'tasks/' + task.id + '/subject'), '');
        }
      });
      
      // Delete the subject
      remove(ref(db, 'subjects/' + subjectId));
      
      // Reset to all if we were viewing that subject
      if (currentSubject === subjectId || children.some(c => c.id === currentSubject)) {
        currentSubject = 'all';
      }
    }
  }
  
  // Delete subject from modal
  deleteSubjectBtn.onclick = () => {
    if (!editingSubjectId) return;
    deleteSubjectById(editingSubjectId);
    closeSubjectModal();
  };
  
  // Update openTaskEditModal to set subject
  const originalOpenTaskEditModal = openTaskEditModal;
  openTaskEditModal = function(taskId) {
    originalOpenTaskEditModal(taskId);
    if (editingTask) {
      editTaskSubject.value = editingTask.subject || '';
    }
  };

  // ============ IMPROVED NATURAL LANGUAGE PARSING (Hebrew + English RTL-Safe) ============
  function parseNaturalLanguage(input) {
    let title = input;
    let dueDate = null;
    let priority = 'medium';
    let subjectId = '';

    // Helper: Normalize text by removing ALL spaces and converting to lowercase
    // This makes "◊°◊ò◊ò◊ô◊°◊ò◊ô◊ß◊î 2" == "◊°◊ò◊ò◊ô◊°◊ò◊ô◊ß◊î2" == "◊°◊ò◊ò◊ô◊°◊ò◊ô◊ß◊î  2"
    const normalize = (str) => str.replace(/\s+/g, '').toLowerCase();

    // ============ STEP 1: EXTRACT & REMOVE PRIORITY ============
    const priorityPatterns = [
      { level: 'urgent', patterns: [/\b(◊ì◊ó◊ï◊£|◊û◊ô◊ô◊ì◊ô|urgent|asap|!)\b/i] },
      { level: 'high', patterns: [/\b(◊í◊ë◊ï◊î|◊ó◊©◊ï◊ë|high|important)\b/i] },
      { level: 'medium', patterns: [/\b(◊ë◊ô◊†◊ï◊†◊ô|◊®◊í◊ô◊ú|medium|normal)\b/i] },
      { level: 'low', patterns: [/\b(◊†◊û◊ï◊ö|◊ú◊ê ◊ì◊ó◊ï◊£|low)\b/i] }
    ];

    for (const { level, patterns } of priorityPatterns) {
      for (const pattern of patterns) {
        if (pattern.test(title)) {
          priority = level;
          title = title.replace(pattern, ' ').trim();
          break;
        }
      }
      if (priority !== 'medium') break;
    }

    // ============ STEP 2: EXTRACT & REMOVE TIME ============
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    let hours = 23, minutes = 59;

    const timePatterns = [
      /\b(◊ë◊©◊¢◊î\s*)?(\d{1,2}):(\d{2})\b/i,
      /\bat\s*(\d{1,2}):(\d{2})\b/i
    ];

    for (const pattern of timePatterns) {
      const match = title.match(pattern);
      if (match) {
        const hourIdx = match[2] ? 2 : 1;
        const minIdx = match[2] ? 3 : 2;
        hours = parseInt(match[hourIdx]);
        minutes = parseInt(match[minIdx]);
        title = title.replace(match[0], ' ').trim();
        break;
      }
    }

    // ============ STEP 3: EXTRACT & REMOVE DATE ============
    // Note: Using 'i' flag only (not 'gi') to avoid stateful regex issues with .test()
    const dateKeywords = [
      { patterns: [/\b◊î◊ô◊ï◊ù\b/i, /\btoday\b/i], days: 0 },
      { patterns: [/\b◊û◊ó◊®\b/i, /\btomorrow\b/i], days: 1 },
      { patterns: [/\b◊û◊ó◊®◊™◊ô◊ô◊ù\b/i], days: 2 },
      { patterns: [/\b◊ë◊¢◊ï◊ì ◊ô◊ï◊û◊ô◊ô◊ù\b/i, /\bin 2 days\b/i], days: 2 },
      { patterns: [/\b◊ë◊¢◊ï◊ì 3 ◊ô◊û◊ô◊ù\b/i, /\bin 3 days\b/i], days: 3 },
      { patterns: [/\b◊î◊©◊ë◊ï◊¢\b/i, /\b◊ë◊©◊ë◊ï◊¢ ◊î◊ë◊ê\b/i, /\bthis week\b/i, /\bnext week\b/i], days: 7 },
      { patterns: [/\b◊ë◊¢◊ï◊ì ◊©◊ë◊ï◊¢\b/i], days: 7 },
      { patterns: [/\b◊ë◊¢◊ï◊ì ◊©◊ë◊ï◊¢◊ô◊ô◊ù\b/i, /\bin 2 weeks\b/i], days: 14 },
      { patterns: [/\b◊ë◊¢◊ï◊ì ◊ó◊ï◊ì◊©\b/i, /\bin a month\b/i], days: 30 },
    ];

    for (const { patterns, days } of dateKeywords) {
      for (const pattern of patterns) {
        if (pattern.test(title)) {
          dueDate = new Date(today);
          dueDate.setDate(dueDate.getDate() + days);
          dueDate.setHours(hours, minutes, 0, 0);
          title = title.replace(pattern, ' ').trim();
          break;
        }
      }
      if (dueDate) break;
    }

    // Hebrew & English day names
    if (!dueDate) {
      const hebrewDays = ['◊®◊ê◊©◊ï◊ü', '◊©◊†◊ô', '◊©◊ú◊ô◊©◊ô', '◊®◊ë◊ô◊¢◊ô', '◊ó◊û◊ô◊©◊ô', '◊©◊ô◊©◊ô', '◊©◊ë◊™'];
      const englishDays = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
      
      for (let i = 0; i < 7; i++) {
        const hebrewPattern = new RegExp(`(◊ë◊ô◊ï◊ù\\s+|◊ô◊ï◊ù\\s+)?${hebrewDays[i]}`, 'gi');
        const englishPattern = new RegExp(`(on\\s+)?${englishDays[i]}`, 'gi');
        
        if (hebrewPattern.test(title) || englishPattern.test(title)) {
          const currentDay = today.getDay();
          let daysToAdd = i - currentDay;
          if (daysToAdd <= 0) daysToAdd += 7;
          
          dueDate = new Date(today);
          dueDate.setDate(dueDate.getDate() + daysToAdd);
          dueDate.setHours(hours, minutes, 0, 0);
          title = title.replace(hebrewPattern, ' ').replace(englishPattern, ' ').trim();
          break;
        }
      }
    }

    // ============ STEP 4: SMART SUBJECT DETECTION ============
    // Sort subjects by length (longest first) to prevent partial matches
    const sortedSubjects = [...subjects].sort((a, b) => b.name.length - a.name.length);
    let matchedSubject = null;
    let textToRemove = '';

    // METHOD 1: Explicit Hashtag with character-by-character matching
    const hashIndex = title.indexOf('#');
    
    if (hashIndex !== -1) {
      const afterHash = title.substring(hashIndex + 1);
      const afterHashNormalized = normalize(afterHash);

      for (const subject of sortedSubjects) {
        const subjectNormalized = normalize(subject.name);
        
        // Check if text after # starts with subject name (space-insensitive)
        if (afterHashNormalized.startsWith(subjectNormalized)) {
          matchedSubject = subject;
          
          // Calculate exact length to remove from original string
          // by matching characters while skipping spaces
          let matchLength = 0;
          let subjectCharIdx = 0;
          const subjectNoSpaces = subject.name.replace(/\s+/g, '').toLowerCase();
          
          for (let i = 0; i < afterHash.length; i++) {
            const char = afterHash[i].toLowerCase();
            if (/\s/.test(char)) {
              matchLength++;
              continue;
            }
            if (char === subjectNoSpaces[subjectCharIdx]) {
              matchLength++;
              subjectCharIdx++;
              if (subjectCharIdx >= subjectNoSpaces.length) break;
            } else {
              break;
            }
          }
          
          textToRemove = '#' + afterHash.substring(0, matchLength);
          break;
        }
      }
      
      // METHOD 2: Quoted format #"◊†◊ï◊©◊ê ◊¢◊ù ◊®◊ï◊ï◊ó◊ô◊ù"
      if (!matchedSubject) {
        const quotedMatch = title.match(/#"([^"]+)"/);
        if (quotedMatch) {
          const searchNorm = normalize(quotedMatch[1]);
          matchedSubject = sortedSubjects.find(s => normalize(s.name) === searchNorm);
          if (matchedSubject) {
            textToRemove = quotedMatch[0];
          }
        }
      }
      
      // METHOD 3: Hierarchy format #parent/child
      if (!matchedSubject) {
        const hierarchyMatch = title.match(/#([^\s\/]+)\/([^\s]+)/);
        if (hierarchyMatch) {
          const parentSearch = normalize(hierarchyMatch[1].replace(/_/g, ' '));
          const childSearch = normalize(hierarchyMatch[2].replace(/_/g, ' '));
          
          const parent = sortedSubjects.find(s => 
            !s.parentId && normalize(s.name).includes(parentSearch)
          );
          
          if (parent) {
            matchedSubject = subjects.find(s => 
              s.parentId === parent.id && normalize(s.name).includes(childSearch)
            );
            if (matchedSubject) {
              textToRemove = hierarchyMatch[0];
            }
          }
        }
      }
      
      // METHOD 4: Fallback - text after # until keyword
      if (!matchedSubject) {
        const stopKeywords = ['◊ì◊ó◊ï◊£', '◊í◊ë◊ï◊î', '◊ë◊ô◊†◊ï◊†◊ô', '◊†◊û◊ï◊ö', '◊î◊ô◊ï◊ù', '◊û◊ó◊®', 'urgent', 'high', 'low', 'today', 'tomorrow'];
        let afterHashClean = afterHash;
        
        for (const keyword of stopKeywords) {
          const keywordIndex = afterHashClean.toLowerCase().indexOf(keyword.toLowerCase());
          if (keywordIndex > 0) {
            afterHashClean = afterHashClean.substring(0, keywordIndex);
          }
        }
        
        afterHashClean = afterHashClean.trim();
        if (afterHashClean) {
          const searchNorm = normalize(afterHashClean);
          matchedSubject = sortedSubjects.find(s => normalize(s.name) === searchNorm);
          if (!matchedSubject) {
            matchedSubject = sortedSubjects.find(s => normalize(s.name).includes(searchNorm) || searchNorm.includes(normalize(s.name)));
          }
          if (matchedSubject) {
            textToRemove = '#' + afterHashClean;
          }
        }
      }
    }

    // METHOD 5: Auto-detect without hashtag
    if (!matchedSubject) {
      for (const subject of sortedSubjects) {
        // Create flexible regex that allows spaces between letters
        const escapedName = subject.name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const flexiblePattern = escapedName.replace(/\s+/g, '\\s*');
        const regex = new RegExp(flexiblePattern, 'i');
        
        const match = title.match(regex);
        if (match) {
          matchedSubject = subject;
          textToRemove = match[0];
          break;
        }
      }
    }

    // Apply subject match
    if (matchedSubject) {
      subjectId = matchedSubject.id;
      if (textToRemove) {
        title = title.replace(textToRemove, ' ').trim();
      }
    }

    // ============ STEP 5: FINAL CLEANUP ============
    title = title.replace(/#\s*/g, ' ');
    title = title.replace(/\s+/g, ' ').trim();
    title = title.replace(/^[,.:;\-]+\s*/, '').replace(/\s*[,.:;\-]+$/, '').trim();

    return { title, dueDate, priority, subjectId };
  }
  
  // Legacy helper - kept for compatibility
  function normalizeForComparison(text) {
    return text.toLowerCase().replace(/\s+/g, '').trim();
  }
  
  // Helper function to find best matching subject (used by some methods)
  function findBestSubjectMatch(searchTerm, sortedSubjects) {
    const normalize = (str) => str.replace(/\s+/g, '').toLowerCase();
    const searchNorm = normalize(searchTerm);
    const searchLower = searchTerm.toLowerCase().trim(); // Define searchLower for fuzzy matching
    
    // 1. Exact match (space-insensitive)
    let found = sortedSubjects.find(s => normalize(s.name) === searchNorm);
    if (found) return found;
    
    // 2. Starts with
    found = sortedSubjects.find(s => normalize(s.name).startsWith(searchNorm));
    if (found) return found;
    
    // 3. Search term starts with subject name
    found = sortedSubjects.find(s => searchNorm.startsWith(normalize(s.name)));
    if (found) return found;
    
    // 4. Contains
    found = sortedSubjects.find(s => normalize(s.name).includes(searchNorm));
    if (found) return found;
    
    // 5. Reverse contains
    found = sortedSubjects.find(s => searchLower.includes(s.name.toLowerCase()));
    if (found) return found;
    
    // 6. Fuzzy match - check if all words from search appear in subject name
    const searchWords = searchLower.split(/\s+/);
    found = sortedSubjects.find(s => {
      const subjectLower = s.name.toLowerCase();
      return searchWords.every(word => subjectLower.includes(word));
    });
    if (found) return found;
    
    return null;
  }
  
  // Smart quick add with natural language
  newTaskTitle.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      const input = newTaskTitle.value.trim();
      if (!input) return;
      
      const parsed = parseNaturalLanguage(input);
      
      // If we have parsed data, use it
      if (parsed.dueDate || parsed.subjectId || parsed.priority !== 'medium') {
        const taskData = {
          title: parsed.title || input,
          content: '',
          priority: parsed.priority,
          dueDate: parsed.dueDate ? parsed.dueDate.toISOString() : null,
          subject: parsed.subjectId,
          checklist: [],
          completed: false,
          createdAt: new Date().toISOString()
        };
        
        const newTaskRef = push(tasksRef);
        set(newTaskRef, taskData);
        
        newTaskTitle.value = '';
        quickAddRow.style.display = 'none';
      } else {
        // Show the expanded form if no natural language detected
        quickAddRow.style.display = 'flex';
      }
    }
  });

  // ============ DAILY REMINDER ============
  const closeReminderBtn = $("closeReminderBtn");
  const reminderDate = $("reminderDate");
  const todayTasksList = $("todayTasksList");
  const tomorrowTasksList = $("tomorrowTasksList");
  const todayTasksSection = $("todayTasksSection");
  const tomorrowTasksSection = $("tomorrowTasksSection");
  
  function showDailyReminder() {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    const dayAfterTomorrow = new Date(tomorrow);
    dayAfterTomorrow.setDate(dayAfterTomorrow.getDate() + 1);
    
    // Format date in Hebrew
    const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    reminderDate.textContent = now.toLocaleDateString('he-IL', dateOptions);
    
    // Get today's tasks
    const todayTasks = tasks.filter(t => {
      if (!t.dueDate || t.completed) return false;
      const due = new Date(t.dueDate);
      return due >= today && due < tomorrow;
    }).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
    
    // Get tomorrow's tasks
    const tomorrowTasks = tasks.filter(t => {
      if (!t.dueDate || t.completed) return false;
      const due = new Date(t.dueDate);
      return due >= tomorrow && due < dayAfterTomorrow;
    }).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
    
    // Render today's tasks
    if (todayTasks.length > 0) {
      todayTasksSection.style.display = 'block';
      todayTasksList.innerHTML = todayTasks.map(t => renderReminderTask(t)).join('');
    } else {
      todayTasksSection.style.display = 'block';
      todayTasksList.innerHTML = '<div class="reminder-empty">üéâ ◊ê◊ô◊ü ◊û◊©◊ô◊û◊ï◊™ ◊ú◊î◊ô◊ï◊ù!</div>';
    }
    
    // Render tomorrow's tasks
    if (tomorrowTasks.length > 0) {
      tomorrowTasksSection.style.display = 'block';
      tomorrowTasksList.innerHTML = tomorrowTasks.map(t => renderReminderTask(t)).join('');
    } else {
      tomorrowTasksSection.style.display = 'none';
    }
    
    reminderModal.classList.add('open');
  }
  
  function renderReminderTask(task) {
    const priorityColors = {
      urgent: '#ef4444',
      high: '#f97316',
      medium: '#eab308',
      low: '#22c55e',
      none: '#6b7280'
    };
    const color = priorityColors[task.priority || 'none'];
    const time = task.dueDate ? new Date(task.dueDate).toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }) : '';
    
    return `
      <div class="reminder-task-item">
        <div class="task-priority-dot" style="background: ${color};"></div>
        <div class="task-info">
          <div class="task-title">${escapeHtml(task.title)}</div>
          ${time ? `<div class="task-time">‚è∞ ${time}</div>` : ''}
        </div>
      </div>
    `;
  }
  
  closeReminderBtn.onclick = () => {
    reminderModal.classList.remove('open');
    localStorage.setItem('lastReminderDate', new Date().toDateString());
  };
  
  // Check if we should show reminder (at 9:00 AM)
  function checkDailyReminder() {
    const now = new Date();
    const lastReminder = localStorage.getItem('lastReminderDate');
    const todayString = now.toDateString();
    
    // If already shown today, skip
    if (lastReminder === todayString) return;
    
    // If it's between 9:00 and 9:30 AM, show reminder
    if (now.getHours() === 9 && now.getMinutes() < 30) {
      // Wait for tasks to load
      if (tasks.length > 0 || subjects.length > 0) {
        showDailyReminder();
      }
    }
  }
  
  // Check every minute
  setInterval(checkDailyReminder, 60000);
  
  // Also check on page load (with delay to let data load)
  setTimeout(checkDailyReminder, 3000);

  // ============ INITIALIZE SMART VIEWS ============
  setupSmartViews();
</script>
</body>
</html>

