<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes,viewport-fit=cover" />
  <title>Shared Event Countdowns</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#667eea" media="(prefers-color-scheme: light)" />
  <meta name="theme-color" content="#0f172a" media="(prefers-color-scheme: dark)" />
  <meta name="description" content="Track countdowns to events and manage tasks with reminders" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Countdowns" />
  <meta name="application-name" content="Countdowns" />
  <meta name="format-detection" content="telephone=no" />
  <meta name="msapplication-TileColor" content="#667eea" />
  <meta name="msapplication-tap-highlight" content="no" />
  
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="icon.svg" />
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%23667eea'/%3E%3Cstop offset='100%25' stop-color='%23764ba2'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='16' cy='16' r='14' fill='url(%23g)'/%3E%3Cpath d='M16 8v8l5 3' stroke='white' stroke-width='2.5' stroke-linecap='round' fill='none'/%3E%3C/svg%3E" />
  <style>
    :root {
      /* Typography Scale */
      --font-size-xs: 11px;
      --font-size-sm: 13px;
      --font-size-base: 15px;
      --font-size-lg: 18px;
      --font-size-xl: 22px;
      --font-size-2xl: 28px;
      --font-size-3xl: 36px;
      
      /* Font Weights */
      --font-weight-normal: 400;
      --font-weight-medium: 500;
      --font-weight-semibold: 600;
      --font-weight-bold: 700;
      
      /* Spacing Scale */
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-8: 32px;
      --space-10: 40px;
      
      /* Border Radius Scale */
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 14px;
      --radius-xl: 18px;
      
      /* Colors */
      --bg: #ffffff;
      --card: #ffffff;
      --text: #1a1a2e;
      --muted: #6b7280;
      --accent: #667eea;
      --accent2: #764ba2;
      --danger: #ef4444;
      --success: #10b981;
      --shadow: 0 2px 8px rgba(0,0,0,0.08);
      --shadow-hover: 0 4px 16px rgba(0,0,0,0.12);
      --border: #e5e7eb;
      --font: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --input-bg: #ffffff;
      --day-other: #fafafa;
      --day-hover: #f9fafb;
      --btn-secondary-bg: #f3f4f6;
      --btn-secondary-hover: #e5e7eb;
      --focus-ring: 0 0 0 3px rgba(102, 126, 234, 0.4);
    }

    body.dark {
      --bg: #0f172a;
      --card: #1e293b;
      --text: #f1f5f9;
      --muted: #94a3b8;
      --border: #334155;
      --shadow: 0 2px 8px rgba(0,0,0,0.3);
      --shadow-hover: 0 4px 16px rgba(0,0,0,0.4);
      --input-bg: #1e293b;
      --day-other: #1a2535;
      --day-hover: #273548;
      --btn-secondary-bg: #334155;
      --btn-secondary-hover: #475569;
      --focus-ring: 0 0 0 3px rgba(102, 126, 234, 0.5);
    }

    /* Accessibility: Focus visible */
    :focus-visible {
      outline: none;
      box-shadow: var(--focus-ring);
    }
    
    /* Reduced motion for users who prefer it */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* Priority Colors */
    .priority-urgent { --priority-color: #ef4444; --priority-bg: #fef2f2; }
    .priority-high { --priority-color: #f97316; --priority-bg: #fff7ed; }
    .priority-medium { --priority-color: #eab308; --priority-bg: #fefce8; }
    .priority-low { --priority-color: #22c55e; --priority-bg: #f0fdf4; }
    .priority-none { --priority-color: #6b7280; --priority-bg: var(--day-other); }
    
    body.dark .priority-urgent { --priority-bg: rgba(239, 68, 68, 0.15); }
    body.dark .priority-high { --priority-bg: rgba(249, 115, 22, 0.15); }
    body.dark .priority-medium { --priority-bg: rgba(234, 179, 8, 0.15); }
    body.dark .priority-low { --priority-bg: rgba(34, 197, 94, 0.15); }
    body.dark .priority-none { --priority-bg: var(--day-other); }

    /* Fixed Header Bar - Always on top */
    .fixed-header-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 56px;
      background: linear-gradient(135deg, var(--card), var(--bg));
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 20px;
      gap: 12px;
      z-index: 10000;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
      backdrop-filter: blur(12px);
    }
    .header-btn {
      padding: 10px 16px;
      opacity: 1; /* Changed from 0.3 to 1 */
      border: 1px solid transparent;
      border-radius: var(--radius-md);
      background: transparent;
      color: var(--muted);
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .header-btn:hover {
      background: var(--day-hover);
      border-color: var(--accent);
    }
    .header-btn.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    .header-btn.icon-only {
      width: 40px;
      height: 40px;
      padding: 0;
      justify-content: center;
      font-size: 18px;
    }
    .sync-badge {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--day-other);
      color: var(--muted);
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-medium);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-left: auto;
    }
    .sync-badge.hidden {
      display: none;
    }
    .sync-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
      animation: syncPulse 1.6s ease-in-out infinite;
    }
    @keyframes syncPulse {
      0% { transform: scale(0.9); opacity: 0.6; }
      50% { transform: scale(1.1); opacity: 1; }
      100% { transform: scale(0.9); opacity: 0.6; }
    }
    .header-spacer {
      flex: 1;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    /* PWA/Mobile Optimizations */
    html {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      overscroll-behavior: none;
    }
    
    /* Safe area padding for notched phones */
    @supports (padding: env(safe-area-inset-top)) {
      body {
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
      }
    }
    
    /* Prevent pull-to-refresh in PWA mode */
    @media (display-mode: standalone) {
      body {
        overscroll-behavior-y: contain;
      }
    }
    
    /* Smoother touch scrolling */
    .app-layout, .sidebar, .task-list, .event-list {
      -webkit-overflow-scrolling: touch;
      scroll-behavior: smooth;
    }
    
    /* Better touch targets */
    button, a, .clickable, [role="button"] {
      touch-action: manipulation;
    }
    
    /* Prevent text selection on interactive elements */
    button, .btn, .task-checkbox, .task-action-btn {
      -webkit-user-select: none;
      user-select: none;
    }

    body {
      font-family: var(--font);
      background: var(--bg);
      min-height: 100vh;
      min-height: 100dvh;
      color: var(--text);
    }

    .app-layout {
      display: flex;
      height: calc(100vh - 60px);
      height: calc(100dvh - 60px);
      align-items: flex-start;
      overflow-y: auto;
      position: relative;
    }

    .sidebar {
      width: 450px;
      min-width: 380px;
      max-width: 90vw;
      background: var(--card);
      border-left: 1px solid var(--border);
      padding: var(--space-4);
      display: flex;
      flex-direction: column;
      order: 1;
      transition: transform 0.3s;
      overflow: visible;
      flex: 0 0 auto;
      box-sizing: border-box;
    }

    .sidebar.hidden {
      transform: translateX(100%);
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
    }

    .main-content {
      flex: 1;
      padding: var(--space-6);
      padding-top: 80px;
      overflow-y: visible;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    /* Body offset for fixed header */
    body {
      padding-top: 60px;
    }

    .header {
      text-align: center;
      margin-bottom: var(--space-8);
      color: var(--text);
    }
    .header h1 {
      font-size: var(--font-size-3xl);
      font-weight: var(--font-weight-bold);
      margin-bottom: var(--space-2);
      letter-spacing: -0.5px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .header p {
      font-size: 16px;
      color: var(--muted);
    }

    /* Calendar Styles */
    .calendar-container {
      direction: rtl;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      box-shadow: var(--shadow);
      margin-bottom: 14px;
      flex: 0 0 auto;
      overflow: visible;
      width: 100%;
    }
    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      gap: 10px;
      flex-wrap: wrap;
    }
    .calendar-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text);
    }
    .calendar-nav {
      display: flex;
      gap: 8px;
    }
    .calendar-nav button {
      width: 36px;
      height: 36px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--card);
      color: var(--text);
      font-size: 18px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .calendar-nav button:hover {
      background: var(--day-hover);
      border-color: var(--accent);
    }
    .calendar-view-toggle {
      display: flex;
      gap: 6px;
      padding: 4px;
      border-radius: 999px;
      background: var(--day-other);
      border: 1px solid var(--border);
    }
    .calendar-view-toggle button {
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 12px;
      padding: 6px 12px;
      border-radius: 999px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .calendar-view-toggle button:hover {
      color: var(--text);
    }
    .calendar-view-toggle button.active {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 2px 6px rgba(102, 126, 234, 0.25);
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      grid-auto-rows: minmax(56px, auto);
      gap: 4px;
      margin-top: 8px;
      align-items: stretch;
      width: 100%;
      box-sizing: border-box;
    }
    .calendar-day-name {
      text-align: center;
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      padding: var(--space-2) 0;
    }
    .calendar-day {
      min-height: 56px;
      padding: var(--space-2);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      flex-direction: column;
      background: var(--card);
      overflow: hidden;
    }
    #taskRightSidebar.calendar-expanded {
      width: 580px;
      min-width: 520px;
    }
    #taskRightSidebar.calendar-expanded .calendar-grid {
      grid-auto-rows: minmax(110px, auto);
    }
    #taskRightSidebar.calendar-expanded .calendar-day {
      min-height: 110px;
      overflow: visible;
      padding: var(--space-2) var(--space-3);
    }
    #taskRightSidebar.calendar-expanded .calendar-day-events {
      overflow: visible;
      gap: 3px;
    }
    #taskRightSidebar.calendar-expanded .calendar-event-chip {
      font-size: 11px;
      padding: 4px 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }
    #taskRightSidebar.calendar-expanded .calendar-day-number {
      font-size: var(--font-size-sm);
      margin-bottom: var(--space-2);
    }
    #taskRightSidebar.calendar-view-week .calendar-grid {
      grid-auto-rows: minmax(56px, auto);
    }
    #taskRightSidebar.calendar-view-week .calendar-day {
      min-height: 120px;
    }
    #taskRightSidebar.calendar-view-week.calendar-expanded .calendar-day {
      min-height: 160px;
    }
    #taskRightSidebar.calendar-view-day .calendar-grid {
      grid-template-columns: 1fr;
      grid-auto-rows: minmax(56px, auto);
    }
    #taskRightSidebar.calendar-view-day .calendar-day {
      min-height: 220px;
    }
    #taskRightSidebar.calendar-view-day.calendar-expanded .calendar-day {
      min-height: 300px;
    }
    #taskRightSidebar.calendar-view-day .calendar-day-name {
      text-align: right;
      padding-right: 10px;
    }
    /* Event calendar (sidebar) view modes */
    #sidebar.calendar-view-week .calendar-grid {
      grid-auto-rows: minmax(80px, auto);
    }
    #sidebar.calendar-view-week .calendar-day {
      min-height: 100px;
    }
    #sidebar.calendar-view-day .calendar-grid {
      grid-template-columns: 1fr;
    }
    #sidebar.calendar-view-day .calendar-day {
      min-height: 200px;
    }
    #sidebar.calendar-view-day .calendar-day-name {
      text-align: right;
      padding-right: 10px;
    }
    .calendar-day:hover {
      background: var(--day-hover);
      border-color: var(--border);
    }
    .calendar-day.other-month {
      background: var(--day-other);
      opacity: 0.5;
    }
    .calendar-day.today {
      border: 2px solid var(--accent);
      background: rgba(102,126,234,0.05);
    }
    .calendar-day-number {
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-bold);
      margin-bottom: var(--space-1);
      text-align: right;
      letter-spacing: -0.2px;
    }
    .calendar-day.today .calendar-day-number {
      color: var(--accent);
    }
    .calendar-day-events {
      display: flex;
      flex-direction: column;
      gap: var(--space-1);
      overflow: hidden;
      flex: 1;
      justify-content: flex-start;
    }
    .calendar-event-chip {
      font-size: var(--font-size-xs);
      padding: 3px var(--space-2);
      border-radius: var(--radius-sm);
      white-space: normal;
      overflow: visible;
      text-overflow: clip;
      color: white;
      font-weight: var(--font-weight-semibold);
      box-shadow: 0 1px 2px rgba(0,0,0,0.12);
      line-height: 1.25;
    }
    .calendar-more {
      font-size: 10px;
      color: var(--muted);
      text-align: center;
      margin-top: 2px;
    }

    /* Monthly Event List */
    .sidebar-section {
      margin-top: var(--space-5);
      padding-top: var(--space-5);
      border-top: 1px solid var(--border);
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .sidebar-section-title {
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-semibold);
      color: var(--text);
      margin-bottom: var(--space-3);
    }
    .month-events {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
      max-height: none;
      overflow: visible;
      flex: 1;
      min-height: 180px;
    }
    .month-event-item {
      padding: 10px 12px;
      background: var(--day-other);
      border-radius: 8px;
      border-right: 4px solid var(--accent);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .month-event-color {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .month-event-info {
      flex: 1;
      min-width: 0;
    }
    .month-event-name {
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .month-event-date {
      font-size: var(--font-size-xs);
      color: var(--muted);
      margin-top: 2px;
    }
    .no-events-msg {
      font-size: var(--font-size-sm);
      color: var(--muted);
      text-align: center;
      padding: var(--space-5);
    }

    /* Input Panel */
    .input-panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--space-5);
      box-shadow: var(--shadow);
      margin-bottom: var(--space-5);
      direction: rtl;
    }
    .input-row {
      display: flex;
      gap: var(--space-3);
      align-items: center;
      flex-wrap: wrap;
    }
    .input-row input {
      flex: 1;
      padding: var(--space-3) var(--space-4);
      border: 2px solid var(--border);
      border-radius: var(--radius-md);
      font-size: var(--font-size-base);
      transition: border-color 0.2s, box-shadow 0.2s;
      outline: none;
      direction: rtl;
      text-align: right;
      background: var(--input-bg);
      color: var(--text);
    }
    .input-row input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(102,126,234,0.15);
    }
    .input-row input[type="text"] { min-width: 180px; }
    .input-row input[type="datetime-local"] {
      min-width: 260px;
      direction: ltr;
      text-align: left;
    }
    .reminder-select {
      padding: var(--space-3) var(--space-4);
      border: 2px solid var(--border);
      border-radius: var(--radius-md);
      font-size: var(--font-size-base);
      background: var(--input-bg);
      color: var(--text);
      outline: none;
      cursor: pointer;
      min-width: 160px;
    }
    .reminder-select:focus {
      border-color: var(--accent);
    }
    .reminder-custom {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    .reminder-custom.hidden,
    .task-reminder-custom.hidden {
      display: none !important;
    }
    .task-reminder-custom {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      margin-top: var(--space-2);
    }
    .reminder-custom input,
    .reminder-custom select {
      padding: var(--space-3) var(--space-4);
      border: 2px solid var(--border);
      border-radius: var(--radius-md);
      font-size: var(--font-size-base);
      background: var(--input-bg);
      color: var(--text);
      outline: none;
      cursor: pointer;
    }
    .reminder-custom input {
      width: 110px;
      cursor: text;
      direction: ltr;
      text-align: left;
    }
    .reminder-custom select {
      min-width: 150px;
    }
    .reminder-custom input:focus,
    .reminder-custom select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(102,126,234,0.15);
    }

    .btn {
      padding: var(--space-3) var(--space-6);
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-semibold);
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: white;
      box-shadow: 0 4px 12px rgba(102,126,234,0.3);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(102,126,234,0.4);
    }
    .btn-primary:active { transform: translateY(0); }
    .btn-ghost {
      background: #fef2f2;
      color: var(--danger);
    }
    .btn-ghost:hover { background: #fee2e2; }
    .btn-cancel {
      background: var(--btn-secondary-bg);
      color: var(--muted);
      display: none;
    }
    .btn-cancel:hover { background: var(--btn-secondary-hover); }

    .event-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .event-list.loading .event-row {
      display: none;
    }
    .event-skeleton {
      display: grid;
      gap: 12px;
    }
    .event-skeleton-row {
      height: 78px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      background: linear-gradient(90deg, var(--day-other), var(--day-hover), var(--day-other));
      background-size: 200% 100%;
      animation: shimmer 1.2s ease-in-out infinite;
    }
    @keyframes shimmer {
      0% { background-position: 0% 50%; }
      100% { background-position: 200% 50%; }
    }

    .event-row {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 20px;
      box-shadow: var(--shadow);
      transition: transform 0.15s, box-shadow 0.15s, background 0.2s;
    }
    .event-row:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
      border-color: #d1d5db;
    }
    .event-row.highlighted {
      border: 2px solid;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .color-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .event-info {
      flex: 1;
      min-width: 0;
      text-align: right;
    }
    .event-name {
      font-size: 17px;
      font-weight: 600;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .event-date {
      font-size: 13px;
      color: var(--muted);
      margin-top: 3px;
    }

    /* Inline editing helpers */
    .inline-edit-input {
      font: inherit;
      color: var(--text);
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 6px 8px;
      min-width: 160px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .inline-edit-input:focus {
      outline: 2px solid var(--accent);
      border-color: var(--accent);
    }
    .inline-edit-input[type="datetime-local"] {
      direction: ltr;
      text-align: left;
    }
    .inline-edit-input.small { min-width: 260px; }

    .priority-popover {
      position: fixed;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-hover);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      z-index: 9999;
      min-width: 180px;
    }
    .priority-popover button {
      padding: 10px 12px;
      background: transparent;
      border: none;
      text-align: right;
      font: inherit;
      cursor: pointer;
    }
    .priority-popover button:hover { background: var(--btn-secondary-bg); }

    .conflict-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--danger);
      font-size: 13px;
      font-weight: 600;
    }
    .conflict-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--danger);
      display: inline-block;
      box-shadow: 0 0 0 4px rgba(239,68,68,0.18);
    }

    /* ============== DAILY PLANNER STYLES ============== */
    .planner-overlay {
      position: fixed;
      top: 56px;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg);
      z-index: 1000;
      display: none;
      flex-direction: column;
      overflow: hidden;
    }
    .planner-overlay.open { display: flex; }
    
    .planner-header-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 24px;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      gap: 16px;
      flex-wrap: wrap;
    }
    .planner-header-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .planner-date-nav {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .planner-date-nav button {
      width: 36px;
      height: 36px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      background: var(--card);
      color: var(--text);
      font-size: 18px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .planner-date-nav button:hover {
      background: var(--day-hover);
      border-color: var(--accent);
    }
    .planner-current-date {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
      min-width: 200px;
      text-align: center;
      cursor: pointer;
      padding: 8px 16px;
      border-radius: var(--radius-md);
      transition: background 0.15s;
    }
    .planner-current-date:hover {
      background: var(--day-hover);
    }
    .planner-today-btn {
      padding: 8px 16px;
      border: 1px solid var(--accent);
      border-radius: var(--radius-md);
      background: transparent;
      color: var(--accent);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }
    .planner-today-btn:hover {
      background: var(--accent);
      color: white;
    }
    .planner-view-toggle {
      display: flex;
      gap: 4px;
      padding: 4px;
      border-radius: var(--radius-md);
      background: var(--day-other);
      border: 1px solid var(--border);
    }
    .planner-view-toggle button {
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 13px;
      padding: 8px 16px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.15s;
      font-weight: 500;
    }
    .planner-view-toggle button:hover { color: var(--text); }
    .planner-view-toggle button.active {
      background: var(--accent);
      color: white;
    }
    
    .planner-main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    
    /* Planner Sidebar */
    .planner-sidebar {
      width: 320px;
      background: var(--card);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      overflow-x: hidden;
      max-height: calc(100vh - 180px);
    }
    .planner-sidebar.hidden { display: none; }
    
    .planner-sidebar-section {
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }
    .planner-sidebar-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .planner-mini-calendar {
      direction: rtl;
    }
    .planner-mini-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .planner-mini-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
    }
    .planner-mini-nav {
      display: flex;
      gap: 4px;
    }
    .planner-mini-nav button {
      width: 24px;
      height: 24px;
      border: none;
      border-radius: 4px;
      background: transparent;
      color: var(--muted);
      font-size: 12px;
      cursor: pointer;
    }
    .planner-mini-nav button:hover { background: var(--day-hover); color: var(--text); }
    .planner-mini-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }
    .planner-mini-day-name {
      text-align: center;
      font-size: 10px;
      color: var(--muted);
      padding: 4px 0;
    }
    .planner-mini-day {
      text-align: center;
      font-size: 12px;
      padding: 6px 4px;
      border-radius: 4px;
      cursor: pointer;
      color: var(--text);
    }
    .planner-mini-day:hover { background: var(--day-hover); }
    .planner-mini-day.other-month { opacity: 0.4; }
    .planner-mini-day.today { background: rgba(102,126,234,0.15); color: var(--accent); font-weight: 600; }
    .planner-mini-day.selected { background: var(--accent); color: white; }
    .planner-mini-day.has-events::after {
      content: '';
      display: block;
      width: 4px;
      height: 4px;
      background: var(--accent);
      border-radius: 50%;
      margin: 2px auto 0;
    }
    
    /* Quick Tasks List */
    .planner-quick-tasks {
      flex: 1;
      overflow-y: auto;
    }
    .planner-task-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      cursor: grab;
      transition: all 0.15s;
      margin-bottom: 4px;
      background: var(--day-other);
      border-right: 3px solid var(--accent);
    }
    .planner-task-item:hover { background: var(--day-hover); }
    .planner-task-item.dragging { opacity: 0.5; }
    .planner-task-item .task-color-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .planner-task-item .task-info {
      flex: 1;
      min-width: 0;
    }
    .planner-task-item .task-title {
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .planner-task-item .task-subject {
      font-size: 11px;
      color: var(--muted);
    }
    .planner-task-item .task-duration {
      font-size: 11px;
      color: var(--muted);
      background: var(--btn-secondary-bg);
      padding: 2px 6px;
      border-radius: 4px;
    }
    
    /* Planner Content Area */
    .planner-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px 24px;
      direction: rtl;
    }
    
    /* Day View */
    .planner-day-view {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }
    .planner-day-header {
      padding: 16px 20px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .planner-day-title {
      font-size: 18px;
      font-weight: 600;
    }
    .planner-day-summary {
      display: flex;
      gap: 20px;
      font-size: 13px;
    }
    .planner-day-summary span { opacity: 0.9; }
    
    .planner-timeline {
      position: relative;
    }
    .planner-hour-row {
      display: flex;
      min-height: 60px;
      border-bottom: 1px solid var(--border);
      position: relative;
    }
    .planner-hour-row:last-child { border-bottom: none; }
    .planner-hour-label {
      width: 70px;
      padding: 8px 12px;
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      text-align: center;
      border-left: 1px solid var(--border);
      flex-shrink: 0;
    }
    .planner-hour-content {
      flex: 1;
      position: relative;
      min-height: 60px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .planner-hour-content:hover { background: rgba(102,126,234,0.05); }
    .planner-hour-content.drop-target { background: rgba(102,126,234,0.15); }
    
    /* Time Blocks */
    .planner-block {
      position: absolute;
      right: 4px;
      left: 4px;
      background: var(--priority-bg, var(--day-other));
      border-right: 4px solid var(--priority-color, var(--accent));
      border-radius: var(--radius-sm);
      padding: 6px 10px 6px 32px;
      cursor: pointer;
      transition: all 0.15s;
      overflow: hidden;
      z-index: 1;
      min-height: 24px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }
    .planner-block:hover { 
      box-shadow: var(--shadow-hover);
      transform: scale(1.02);
      z-index: 10;
      overflow: visible;
    }
    .planner-block.dragging { opacity: 0.6; z-index: 10; }
    /* Compact mode for 15-30 min events */
    .planner-block.compact {
      flex-direction: row;
      align-items: center;
      gap: 6px;
      padding: 2px 6px 2px 24px;
      min-height: 20px;
    }
    .planner-block.compact .planner-block-title {
      font-size: 11px;
      flex: 1;
      min-width: 0;
    }
    .planner-block.compact .planner-block-time {
      margin-top: 0;
      font-size: 10px;
      flex-shrink: 0;
    }
    .planner-block.compact .planner-block-checkbox {
      width: 14px;
      height: 14px;
      left: 4px;
    }
    /* Extra compact mode for 15 min events */
    .planner-block.extra-compact {
      flex-direction: row;
      align-items: center;
      gap: 4px;
      padding: 1px 4px 1px 20px;
      min-height: 14px;
    }
    .planner-block.extra-compact .planner-block-title {
      font-size: 10px;
      flex: 1;
      min-width: 0;
    }
    .planner-block.extra-compact .planner-block-time {
      margin-top: 0;
      font-size: 9px;
      flex-shrink: 0;
    }
    .planner-block.extra-compact .planner-block-checkbox {
      width: 12px;
      height: 12px;
      left: 3px;
    }
    .planner-block-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.3;
    }
    .planner-block-time {
      font-size: 11px;
      color: var(--muted);
      margin-top: 1px;
      line-height: 1.2;
    }
    .planner-block-notes {
      font-size: 11px;
      color: var(--muted);
      margin-top: 3px;
      line-height: 1.3;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: var(--notes-lines, 1);
      line-clamp: var(--notes-lines, 1);
      -webkit-box-orient: vertical;
      opacity: 0.85;
    }
    .planner-block-notes.small-text {
      font-size: 10px;
    }
    .planner-block-notes.tiny-text {
      font-size: 9px;
    }
    .planner-block-reminder {
      font-size: 10px;
      color: var(--accent);
      margin-top: 2px;
    }
    .planner-block-completed {
      opacity: 0.6;
    }
    .planner-block-completed .planner-block-title {
      text-decoration: line-through;
    }
    .planner-block-checkbox {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      left: 6px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid var(--priority-color, var(--accent));
      background: transparent;
      cursor: pointer;
      transition: all 0.15s;
    }
    .planner-block-checkbox:hover { background: var(--priority-color); }
    .planner-block-checkbox.checked {
      background: var(--priority-color, var(--accent));
    }
    .planner-block-checkbox.checked::after {
      content: 'âœ“';
      color: white;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
    }
    
    /* Current Time Indicator */
    .planner-now-line {
      position: absolute;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, var(--accent) 0%, rgba(102,126,234,0.3) 100%);
      z-index: 5;
      pointer-events: none;
    }
    .planner-now-line::before {
      content: '';
      position: absolute;
      right: -3px;
      top: -3px;
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 4px rgba(102,126,234,0.5);
    }
    .planner-now-label {
      position: absolute;
      left: 4px;
      top: -7px;
      font-size: 9px;
      font-weight: 500;
      color: var(--accent);
      background: var(--card);
      padding: 1px 5px;
      border-radius: 3px;
      opacity: 0.8;
    }
    
    /* Week View */
    .planner-week-view {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }
    .planner-week-day {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      overflow: hidden;
      min-height: 500px;
    }
    .planner-week-day.today {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent);
    }
    .planner-week-day-header {
      padding: 12px;
      text-align: center;
      border-bottom: 1px solid var(--border);
      background: var(--day-other);
    }
    .planner-week-day-name {
      font-size: 12px;
      color: var(--muted);
      font-weight: 500;
    }
    .planner-week-day-number {
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
    }
    .planner-week-day.today .planner-week-day-number { color: var(--accent); }
    .planner-week-day-content {
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-height: 400px;
    }
    .planner-week-block {
      padding: 8px 10px;
      background: var(--priority-bg, var(--day-other));
      border-right: 3px solid var(--priority-color, var(--accent));
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.15s;
    }
    .planner-week-block:hover { 
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }
    .planner-week-block-time {
      font-size: 10px;
      color: var(--muted);
      margin-bottom: 2px;
    }
    .planner-week-block-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* Add Block Modal */
    .planner-add-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .planner-add-modal.open { display: flex; }
    .planner-add-card {
      background: var(--card);
      border-radius: var(--radius-xl);
      padding: 24px;
      width: 100%;
      max-width: 480px;
      max-height: 90vh;
      overflow-y: auto;
      direction: rtl;
    }
    .planner-add-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .planner-add-field {
      margin-bottom: 16px;
    }
    .planner-add-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 6px;
    }
    .planner-add-input {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 14px;
      background: var(--input-bg);
      color: var(--text);
      outline: none;
      transition: border-color 0.15s;
    }
    .planner-add-input:focus { border-color: var(--accent); }
    .planner-add-row {
      display: flex;
      gap: 12px;
    }
    .planner-add-row .planner-add-field { flex: 1; }
    
    .planner-add-duration-presets {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .planner-duration-btn {
      padding: 6px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--day-other);
      color: var(--text);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .planner-duration-btn:hover { border-color: var(--accent); }
    .planner-duration-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
    
    .planner-add-priority {
      display: flex;
      gap: 8px;
    }
    .planner-priority-option {
      flex: 1;
      padding: 10px;
      border: 2px solid var(--border);
      border-radius: var(--radius-md);
      background: transparent;
      cursor: pointer;
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.15s;
    }
    .planner-priority-option:hover { border-color: var(--muted); }
    .planner-priority-option.selected { border-color: var(--priority-color); background: var(--priority-bg); }
    .planner-priority-option[data-priority="urgent"] { --priority-color: #ef4444; --priority-bg: #fef2f2; }
    .planner-priority-option[data-priority="high"] { --priority-color: #f97316; --priority-bg: #fff7ed; }
    .planner-priority-option[data-priority="medium"] { --priority-color: #eab308; --priority-bg: #fefce8; }
    .planner-priority-option[data-priority="low"] { --priority-color: #22c55e; --priority-bg: #f0fdf4; }
    .planner-priority-option[data-priority="none"] { --priority-color: #6b7280; --priority-bg: var(--day-other); }
    body.dark .planner-priority-option[data-priority="urgent"] { --priority-bg: rgba(239, 68, 68, 0.15); }
    body.dark .planner-priority-option[data-priority="high"] { --priority-bg: rgba(249, 115, 22, 0.15); }
    body.dark .planner-priority-option[data-priority="medium"] { --priority-bg: rgba(234, 179, 8, 0.15); }
    body.dark .planner-priority-option[data-priority="low"] { --priority-bg: rgba(34, 197, 94, 0.15); }
    body.dark .planner-priority-option[data-priority="none"] { --priority-bg: var(--day-other); }
    
    .planner-add-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    .planner-add-actions button {
      flex: 1;
      padding: 14px;
      border-radius: var(--radius-md);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }
    .planner-add-cancel {
      background: var(--btn-secondary-bg);
      border: 1px solid var(--border);
      color: var(--text);
    }
    .planner-add-cancel:hover { background: var(--btn-secondary-hover); }
    .planner-add-save {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border: none;
      color: white;
    }
    .planner-add-save:hover { transform: translateY(-1px); box-shadow: var(--shadow-hover); }
    .planner-add-delete {
      background: var(--danger);
      border: none;
      color: white;
      flex: 0.5;
    }
    .planner-add-delete:hover { opacity: 0.9; }
    
    /* Planner Color Picker */
    .planner-color-picker {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .planner-color-option {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.15s;
      border: 2px solid transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: var(--muted);
    }
    .planner-color-option:hover {
      transform: scale(1.15);
    }
    .planner-color-option.selected {
      box-shadow: 0 0 0 3px var(--accent);
    }
    
    /* Planner Empty State */
    .planner-empty-hour {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 11px;
      color: var(--muted);
      opacity: 0;
      transition: opacity 0.15s;
      pointer-events: none;
    }
    .planner-hour-content:hover .planner-empty-hour { opacity: 1; }
    
    /* Stats Bar */
    .planner-stats-bar {
      display: flex;
      gap: 24px;
      padding: 12px 24px;
      background: var(--card);
      border-bottom: 1px solid var(--border);
    }
    .planner-stat {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .planner-stat-icon {
      width: 36px;
      height: 36px;
      border-radius: var(--radius-sm);
      background: var(--day-other);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }
    .planner-stat-info {
      display: flex;
      flex-direction: column;
    }
    .planner-stat-value {
      font-size: 16px;
      font-weight: 700;
      color: var(--text);
    }
    .planner-stat-label {
      font-size: 11px;
      color: var(--muted);
    }
    
    /* Templates */
    .planner-templates {
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }
    .planner-template-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      padding: 12px 14px;
      background: var(--day-other);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.15s;
      margin-bottom: 8px;
      font-size: 13px;
      color: var(--text);
    }
    .planner-template-btn:hover { border-color: var(--accent); background: var(--day-hover); }
    .planner-template-icon {
      font-size: 18px;
    }
    
    /* Planner Sync Sections */
    .planner-sync-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .planner-sync-btn {
      padding: 6px 12px;
      border: 1px solid var(--accent);
      border-radius: var(--radius-sm);
      background: transparent;
      color: var(--accent);
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .planner-sync-btn:hover {
      background: var(--accent);
      color: white;
    }
    .planner-sync-btn.syncing {
      opacity: 0.6;
      pointer-events: none;
    }
    .planner-sync-all-btn {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid var(--accent);
      border-radius: var(--radius-md);
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
      color: var(--accent);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    .planner-sync-all-btn:hover {
      background: var(--accent);
      color: white;
    }
    .planner-countdown-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.15s;
      margin-bottom: 4px;
      background: var(--day-other);
      border-right: 3px solid var(--accent);
    }
    .planner-countdown-item:hover { background: var(--day-hover); }
    .planner-countdown-item .countdown-color-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .planner-countdown-item .countdown-info {
      flex: 1;
      min-width: 0;
    }
    .planner-countdown-item .countdown-title {
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .planner-countdown-item .countdown-date {
      font-size: 11px;
      color: var(--muted);
    }
    .planner-countdown-item .countdown-time-left {
      font-size: 10px;
      color: var(--accent);
      background: rgba(102, 126, 234, 0.1);
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
    }
    .planner-countdown-item .add-to-planner-btn {
      width: 24px;
      height: 24px;
      border: none;
      border-radius: 50%;
      background: var(--btn-secondary-bg);
      color: var(--muted);
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      flex-shrink: 0;
    }
    .planner-countdown-item .add-to-planner-btn:hover {
      background: var(--accent);
      color: white;
    }
    .planner-scheduled-task-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.15s;
      margin-bottom: 4px;
      background: var(--day-other);
      border-right: 3px solid var(--success);
    }
    .planner-scheduled-task-item:hover { background: var(--day-hover); }
    .planner-scheduled-task-item .task-color-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .planner-scheduled-task-item .task-info {
      flex: 1;
      min-width: 0;
    }
    .planner-scheduled-task-item .task-title {
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .planner-scheduled-task-item .task-due {
      font-size: 11px;
      color: var(--muted);
    }
    .planner-scheduled-task-item .add-to-planner-btn {
      width: 24px;
      height: 24px;
      border: none;
      border-radius: 50%;
      background: var(--btn-secondary-bg);
      color: var(--muted);
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      flex-shrink: 0;
    }
    .planner-scheduled-task-item .add-to-planner-btn:hover {
      background: var(--success);
      color: white;
    }
    .planner-synced-indicator {
      font-size: 10px;
      color: var(--success);
      display: flex;
      align-items: center;
      gap: 3px;
    }
    .planner-section-collapse {
      cursor: pointer;
      user-select: none;
    }
    .planner-section-collapse .collapse-icon {
      transition: transform 0.2s;
    }
    .planner-section-collapse.collapsed .collapse-icon {
      transform: rotate(-90deg);
    }
    .planner-section-content {
      max-height: 300px;
      overflow-y: auto;
      transition: max-height 0.3s;
    }
    .planner-section-content.collapsed {
      max-height: 0;
      overflow: hidden;
    }
    
    /* Responsive */
    @media (max-width: 1024px) {
      .planner-sidebar { width: 280px; }
      .planner-week-view { grid-template-columns: repeat(4, 1fr); }
    }
    @media (max-width: 768px) {
      .planner-sidebar { display: none; }
      .planner-header-bar { padding: 12px 16px; flex-wrap: wrap; }
      .planner-week-view { grid-template-columns: repeat(2, 1fr); }
      .planner-content { padding: 12px 16px; }
      .planner-stats-bar { flex-wrap: wrap; gap: 16px; padding: 12px 16px; }
    }

    /* Pomodoro - Fullscreen like Task Manager */
    .pomodoro-overlay {
      position: fixed;
      top: 56px;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg);
      display: none;
      flex-direction: column;
      z-index: 300;
      overflow: hidden;
    }
    .pomodoro-overlay.open { display: flex; }
    
    .pomodoro-header-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 32px;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
      border-bottom: 1px solid var(--border);
    }
    
    .pomodoro-header-title {
      font-size: 22px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    @media (max-width: 768px) {
      .event-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      .inline-edit-input.small {
        min-width: 0;
        width: 100%;
      }
      .event-actions {
        width: 100%;
        justify-content: flex-end;
      }
      .timer {
        width: 100%;
        justify-content: space-between;
      }
      .event-info { width: 100%; }
      
      /* Responsive Pomodoro */
      .pomodoro-card { padding: 24px; gap: 24px; border-radius: 24px; }
      .pomodoro-timer-wrap { width: 240px; height: 240px; }
      .pomodoro-time { font-size: 52px; }
      .pomodoro-btn { width: 52px; height: 52px; font-size: 20px; }
      .pomodoro-btn.primary { width: 64px; height: 64px; font-size: 28px; }
      .pomodoro-settings-panel { grid-template-columns: repeat(2, 1fr); }
      .pomodoro-stats { grid-template-columns: repeat(3, 1fr); gap: 8px; }
      .pomodoro-stat { padding: 16px 8px; }
      .pomodoro-stat .value { font-size: 24px; }
      .pomodoro-presets { gap: 8px; }
      .pomodoro-preset { padding: 10px 16px; font-size: 12px; }
      .pomodoro-header-bar { padding: 12px 16px; }
      .pomodoro-content { padding: 20px 16px; }
      .pomodoro-timer-wrap { width: 260px; height: 260px; }
    }
    
    .pomodoro-container {
      width: 100%;
      max-width: 640px;
    }
    
    .pomodoro-card {
      background: linear-gradient(145deg, var(--card) 0%, var(--card) 100%);
      border: 1px solid rgba(102, 126, 234, 0.2);
      border-radius: 32px;
      padding: 48px 40px;
      box-shadow: 
        0 25px 80px rgba(102, 126, 234, 0.2),
        0 10px 30px rgba(0, 0, 0, 0.08),
        0 0 0 1px rgba(255,255,255,0.15) inset,
        0 0 80px rgba(102, 126, 234, 0.05) inset;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 36px;
      overflow: visible;
      backdrop-filter: blur(20px);
      position: relative;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .pomodoro-card::before {
      content: '';
      position: absolute;
      top: -1px;
      left: 20%;
      right: 20%;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.5), rgba(118, 75, 162, 0.5), transparent);
      border-radius: 999px;
    }
    
    .pomodoro-card:hover {
      transform: translateY(-2px);
      box-shadow: 
        0 30px 90px rgba(102, 126, 234, 0.25),
        0 15px 40px rgba(0, 0, 0, 0.1),
        0 0 0 1px rgba(255,255,255,0.2) inset,
        0 0 100px rgba(102, 126, 234, 0.08) inset;
    }
    
    /* Timer Circle */
    .pomodoro-timer-wrap {
      position: relative;
      width: 300px;
      height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .pomodoro-timer-wrap::before {
      content: '';
      position: absolute;
      inset: -20px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(102, 126, 234, 0.15) 0%, transparent 70%);
      animation: timerGlow 3s ease-in-out infinite;
      pointer-events: none;
    }
    
    .pomodoro-timer-ring {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: conic-gradient(
        from -90deg,
        var(--accent) 0%,
        var(--accent2) calc(var(--progress, 0%) * 0.5),
        var(--accent) var(--progress, 0%),
        rgba(102, 126, 234, 0.15) var(--progress, 0%),
        rgba(102, 126, 234, 0.08) 100%
      );
      padding: 10px;
      box-shadow: 
        0 0 40px rgba(102, 126, 234, 0.3),
        inset 0 0 30px rgba(102, 126, 234, 0.1);
      transition: background 0.3s ease;
    }
    
    .pomodoro-timer-ring::before {
      content: '';
      position: absolute;
      inset: 10px;
      background: var(--card);
      border-radius: 50%;
      box-shadow: inset 0 0 40px rgba(0, 0, 0, 0.05);
    }
    
    .pomodoro-timer-ring::after {
      content: '';
      position: absolute;
      inset: 6px;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.1);
      pointer-events: none;
    }
    
    .pomodoro-timer {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    
    .pomodoro-time {
      font-size: 64px;
      font-weight: 300;
      letter-spacing: -2px;
      color: var(--text);
      font-variant-numeric: tabular-nums;
      line-height: 1;
      text-shadow: 0 2px 20px rgba(102, 126, 234, 0.2);
    }
    
    .pomodoro-mode {
      font-size: 14px;
      font-weight: 600;
      color: var(--accent);
      margin-top: 16px;
      text-transform: uppercase;
      letter-spacing: 3px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .pomodoro-mode-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent);
      animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(0.8); }
    }
    
    .pomodoro-next {
      font-size: 13px;
      color: var(--muted);
      margin-top: 8px;
    }
    
    /* Controls */
    .pomodoro-controls {
      display: flex;
      gap: 20px;
      justify-content: center;
      align-items: center;
    }
    
    .pomodoro-btn {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
      backdrop-filter: blur(10px);
      color: var(--text);
      font-size: 22px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.2);
      position: relative;
      overflow: hidden;
    }
    
    .pomodoro-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 50%;
      padding: 2px;
      background: linear-gradient(135deg, rgba(102,126,234,0.3), rgba(118,75,162,0.3));
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
    }
    
    .pomodoro-btn:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 8px 25px rgba(102,126,234,0.3), inset 0 1px 0 rgba(255,255,255,0.3);
    }
    
    .pomodoro-btn:active {
      transform: translateY(0) scale(0.98);
    }
    
    .pomodoro-btn.primary {
      width: 72px;
      height: 72px;
      font-size: 28px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: white;
      box-shadow: 0 8px 30px rgba(102, 126, 234, 0.4), 0 0 0 4px rgba(102,126,234,0.15);
    }
    
    .pomodoro-btn.primary::before {
      display: none;
    }
    
    .pomodoro-btn.primary:hover {
      transform: translateY(-4px) scale(1.08);
      box-shadow: 0 12px 40px rgba(102, 126, 234, 0.5), 0 0 0 6px rgba(102,126,234,0.2);
    }
    
    /* Presets */
    .pomodoro-presets {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .pomodoro-preset {
      padding: 12px 24px;
      border-radius: 24px;
      border: 2px solid var(--border);
      background: transparent;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: var(--muted);
      transition: all 0.2s;
    }
    
    .pomodoro-preset:hover {
      color: var(--text);
      border-color: var(--accent);
      transform: translateY(-2px);
    }
    
    .pomodoro-preset.active {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border-color: transparent;
      color: white;
      box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
    }
    
    /* Settings Panel */
    .pomodoro-settings-panel {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      padding: 24px;
      background: var(--btn-secondary-bg);
      border-radius: 20px;
      width: 100%;
      max-width: 500px;
    }
    
    .pomodoro-field {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
    }
    
    .pomodoro-field label {
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .pomodoro-field input {
      width: 70px;
      padding: 12px;
      border: 2px solid var(--border);
      border-radius: 12px;
      background: var(--card);
      color: var(--text);
      font-size: 18px;
      font-weight: 600;
      text-align: center;
      transition: all 0.2s;
    }
    
    .pomodoro-field input:focus {
      border-color: var(--accent);
      outline: none;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }
    
    /* Options Row */
    .pomodoro-options {
      display: flex;
      gap: 24px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .pomodoro-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 20px;
      background: var(--btn-secondary-bg);
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .pomodoro-option:hover {
      background: var(--btn-secondary-hover);
    }
    
    .pomodoro-option input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: var(--accent);
      cursor: pointer;
    }
    
    .pomodoro-option label {
      font-size: 14px;
      color: var(--text);
      cursor: pointer;
    }
    
    .pomodoro-sound-select {
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: 12px;
      background: var(--card);
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
    }
    
    .pomodoro-preview-btn {
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: 12px;
      background: var(--card);
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .pomodoro-preview-btn:hover {
      border-color: var(--accent);
      background: var(--btn-secondary-bg);
    }
    
    /* Stats Cards */
    .pomodoro-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      width: 100%;
      max-width: 500px;
    }
    
    .pomodoro-stat {
      padding: 24px 16px;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
      border-radius: 20px;
      text-align: center;
      border: 1px solid rgba(102, 126, 234, 0.2);
    }
    
    .pomodoro-stat .label {
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }
    
    .pomodoro-stat .value {
      font-size: 32px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    /* Day Progress */
    .pomodoro-daily {
      width: 100%;
      max-width: 500px;
      text-align: center;
    }
    
    .pomodoro-daily-bar {
      height: 8px;
      background: var(--border);
      border-radius: 999px;
      overflow: hidden;
      margin-bottom: 12px;
    }
    
    .pomodoro-daily-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #10b981, #22d3ee);
      border-radius: 999px;
      transition: width 0.5s ease;
    }
    
    .pomodoro-daily-label {
      font-size: 13px;
      color: var(--muted);
    }
    
    /* Task Select */
    .pomodoro-task-select {
      width: 100%;
      max-width: 400px;
      padding: 14px 20px;
      border: 2px solid var(--border);
      border-radius: 16px;
      background: var(--card);
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .pomodoro-task-select:focus {
      border-color: var(--accent);
      outline: none;
    }

    /* Pomodoro Mini Player */
    .pomodoro-mini {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 16px 24px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      display: none;
      align-items: center;
      gap: 16px;
      z-index: 9999;
      cursor: pointer;
      transition: all 0.3s;
    }
    .pomodoro-mini.visible { display: flex; }
    .pomodoro-mini:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.25);
    }
    .pomodoro-mini-time {
      font-size: 28px;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .pomodoro-mini-mode {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .pomodoro-mini-close {
      border: none;
      background: var(--btn-secondary-bg);
      color: var(--muted);
      font-size: 18px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .pomodoro-mini-close:hover {
      background: var(--danger);
      color: white;
    }

    @media (max-width: 768px) {
      .event-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      .event-actions {
        width: 100%;
        justify-content: flex-end;
      }
      .timer {
        width: 100%;
        justify-content: space-between;
      }
      .event-info { width: 100%; }
      
      /* Responsive Pomodoro */
      .pomodoro-card { padding: 24px; gap: 24px; border-radius: 24px; }
      .pomodoro-timer-wrap { width: 240px; height: 240px; }
      .pomodoro-time { font-size: 52px; }
      .pomodoro-btn { width: 52px; height: 52px; font-size: 20px; }
      .pomodoro-btn.primary { width: 64px; height: 64px; font-size: 28px; }
      .pomodoro-settings-panel { grid-template-columns: repeat(2, 1fr); }
      .pomodoro-stats { grid-template-columns: repeat(3, 1fr); gap: 8px; }
      .pomodoro-stat { padding: 16px 8px; }
      .pomodoro-stat .value { font-size: 24px; }
      .pomodoro-presets { gap: 8px; }
      .pomodoro-preset { padding: 10px 16px; font-size: 12px; }
      .pomodoro-header-bar { padding: 12px 16px; }
      .pomodoro-content { padding: 20px 16px; }
    }

    /* Pomodoro - Fullscreen like Task Manager */
    .pomodoro-overlay {
      position: fixed;
      top: 56px;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg);
      display: none;
      flex-direction: column;
      z-index: 300;
      overflow: hidden;
    }
    .pomodoro-overlay.open { display: flex; }
    
    .pomodoro-header-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 32px;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
      border-bottom: 1px solid var(--border);
    }
    
    .pomodoro-header-title {
      font-size: 22px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .pomodoro-content {
      flex: 1;
      overflow-y: auto;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 40px 24px;
      background: 
        radial-gradient(ellipse at 20% 0%, rgba(102, 126, 234, 0.12) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 100%, rgba(118, 75, 162, 0.1) 0%, transparent 50%),
        radial-gradient(ellipse at 50% 50%, rgba(102, 126, 234, 0.03) 0%, transparent 70%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg) 100%);
      position: relative;
    }
    
    .pomodoro-content::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
      opacity: 0.015;
      pointer-events: none;
    }
    
    .pomodoro-container {
      width: 100%;
      max-width: 640px;
    }
    
    .pomodoro-card {
      background: linear-gradient(145deg, var(--card) 0%, var(--card) 100%);
      border: 1px solid rgba(102, 126, 234, 0.2);
      border-radius: 32px;
      padding: 48px 40px;
      box-shadow: 
        0 25px 80px rgba(102, 126, 234, 0.2),
        0 10px 30px rgba(0, 0, 0, 0.08),
        0 0 0 1px rgba(255,255,255,0.15) inset,
        0 0 80px rgba(102, 126, 234, 0.05) inset;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 36px;
      overflow: visible;
      backdrop-filter: blur(20px);
      position: relative;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .pomodoro-card::before {
      content: '';
      position: absolute;
      top: -1px;
      left: 20%;
      right: 20%;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.5), rgba(118, 75, 162, 0.5), transparent);
      border-radius: 999px;
    }
    
    .pomodoro-card:hover {
      transform: translateY(-2px);
      box-shadow: 
        0 30px 90px rgba(102, 126, 234, 0.25),
        0 15px 40px rgba(0, 0, 0, 0.1),
        0 0 0 1px rgba(255,255,255,0.2) inset,
        0 0 100px rgba(102, 126, 234, 0.08) inset;
    }
    
    /* Timer Circle */
    .pomodoro-timer-wrap {
      position: relative;
      width: 300px;
      height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .pomodoro-timer-wrap::before {
      content: '';
      position: absolute;
      inset: -20px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(102, 126, 234, 0.15) 0%, transparent 70%);
      animation: timerGlow 3s ease-in-out infinite;
      pointer-events: none;
    }
    
    @keyframes timerGlow {
      0%, 100% { opacity: 0.5; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
    }
    
    .pomodoro-timer-ring {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: conic-gradient(
        from -90deg,
        var(--accent) 0%,
        var(--accent2) calc(var(--progress, 0%) * 0.5),
        var(--accent) var(--progress, 0%),
        rgba(102, 126, 234, 0.15) var(--progress, 0%),
        rgba(102, 126, 234, 0.08) 100%
      );
      padding: 10px;
      box-shadow: 
        0 0 40px rgba(102, 126, 234, 0.3),
        inset 0 0 30px rgba(102, 126, 234, 0.1);
      transition: background 0.3s ease;
    }
    
    .pomodoro-timer-ring::before {
      content: '';
      position: absolute;
      inset: 10px;
      background: var(--card);
      border-radius: 50%;
      box-shadow: inset 0 0 40px rgba(0, 0, 0, 0.05);
    }
    
    .pomodoro-timer-ring::after {
      content: '';
      position: absolute;
      inset: 6px;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.1);
      pointer-events: none;
    }
    
    .pomodoro-timer {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    
    .pomodoro-time {
      font-size: 72px;
      font-weight: 200;
      letter-spacing: -3px;
      color: var(--text);
      font-variant-numeric: tabular-nums;
      line-height: 1;
      text-shadow: 0 4px 30px rgba(102, 126, 234, 0.25);
      background: linear-gradient(135deg, var(--text) 0%, var(--accent) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .pomodoro-mode {
      font-size: 13px;
      font-weight: 700;
      color: var(--accent);
      margin-top: 20px;
      text-transform: uppercase;
      letter-spacing: 4px;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 16px;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
      border-radius: 999px;
      border: 1px solid rgba(102, 126, 234, 0.2);
    }
    
    .pomodoro-mode-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      animation: pulseGlow 2s ease-in-out infinite;
      box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
    }
    
    @keyframes pulseGlow {
      0%, 100% { opacity: 1; transform: scale(1); box-shadow: 0 0 10px rgba(102, 126, 234, 0.5); }
      50% { opacity: 0.7; transform: scale(0.85); box-shadow: 0 0 20px rgba(102, 126, 234, 0.3); }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(0.8); }
    }
    
    .pomodoro-next {
      font-size: 13px;
      color: var(--muted);
      margin-top: 8px;
    }
    
    /* Controls */
    .pomodoro-controls {
      display: flex;
      gap: 20px;
      justify-content: center;
      align-items: center;
    }
    
    .pomodoro-btn {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
      backdrop-filter: blur(10px);
      color: var(--text);
      font-size: 22px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.2);
      position: relative;
      overflow: hidden;
    }
    
    .pomodoro-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 50%;
      padding: 2px;
      background: linear-gradient(135deg, rgba(102,126,234,0.3), rgba(118,75,162,0.3));
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
    }
    
    .pomodoro-btn:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 8px 25px rgba(102,126,234,0.3), inset 0 1px 0 rgba(255,255,255,0.3);
    }
    
    .pomodoro-btn:active {
      transform: translateY(0) scale(0.98);
    }
    
    .pomodoro-btn.primary {
      width: 72px;
      height: 72px;
      font-size: 28px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: white;
      box-shadow: 0 8px 30px rgba(102, 126, 234, 0.4), 0 0 0 4px rgba(102,126,234,0.15);
    }
    
    .pomodoro-btn.primary::before {
      display: none;
    }
    
    .pomodoro-btn.primary:hover {
      transform: translateY(-4px) scale(1.08);
      box-shadow: 0 12px 40px rgba(102, 126, 234, 0.5), 0 0 0 6px rgba(102,126,234,0.2);
    }
    
    /* Presets */
    .pomodoro-presets {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .pomodoro-preset {
      padding: 12px 24px;
      border-radius: 24px;
      border: 2px solid var(--border);
      background: transparent;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: var(--muted);
      transition: all 0.2s;
    }
    
    .pomodoro-preset:hover {
      color: var(--text);
      border-color: var(--accent);
      transform: translateY(-2px);
    }
    
    .pomodoro-preset.active {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border-color: transparent;
      color: white;
      box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
    }
    
    /* Settings Panel */
    .pomodoro-settings-panel {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      padding: 24px;
      background: var(--btn-secondary-bg);
      border-radius: 20px;
      width: 100%;
      max-width: 500px;
    }
    
    .pomodoro-field {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
    }
    
    .pomodoro-field label {
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .pomodoro-field input {
      width: 70px;
      padding: 12px;
      border: 2px solid var(--border);
      border-radius: 12px;
      background: var(--card);
      color: var(--text);
      font-size: 18px;
      font-weight: 600;
      text-align: center;
      transition: all 0.2s;
    }
    
    .pomodoro-field input:focus {
      border-color: var(--accent);
      outline: none;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }
    
    /* Options Row */
    .pomodoro-options {
      display: flex;
      gap: 24px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .pomodoro-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 20px;
      background: var(--btn-secondary-bg);
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .pomodoro-option:hover {
      background: var(--btn-secondary-hover);
    }
    
    .pomodoro-option input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: var(--accent);
      cursor: pointer;
    }
    
    .pomodoro-option label {
      font-size: 14px;
      color: var(--text);
      cursor: pointer;
    }
    
    .pomodoro-sound-select {
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: 12px;
      background: var(--card);
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
    }
    
    .pomodoro-preview-btn {
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: 12px;
      background: var(--card);
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .pomodoro-preview-btn:hover {
      border-color: var(--accent);
      background: var(--btn-secondary-bg);
    }
    
    /* Stats Cards */
    .pomodoro-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      width: 100%;
      max-width: 500px;
    }
    
    .pomodoro-stat {
      padding: 24px 16px;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
      border-radius: 20px;
      text-align: center;
      border: 1px solid rgba(102, 126, 234, 0.2);
    }
    
    .pomodoro-stat .label {
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }
    
    .pomodoro-stat .value {
      font-size: 32px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    /* Day Progress */
    .pomodoro-daily {
      width: 100%;
      max-width: 500px;
      text-align: center;
    }
    
    .pomodoro-daily-bar {
      height: 8px;
      background: var(--border);
      border-radius: 999px;
      overflow: hidden;
      margin-bottom: 12px;
    }
    
    .pomodoro-daily-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #10b981, #22d3ee);
      border-radius: 999px;
      transition: width 0.5s ease;
    }
    
    .pomodoro-daily-label {
      font-size: 13px;
      color: var(--muted);
    }
    
    /* Task Select */
    .pomodoro-task-select {
      width: 100%;
      max-width: 400px;
      padding: 14px 20px;
      border: 2px solid var(--border);
      border-radius: 16px;
      background: var(--card);
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .pomodoro-task-select:focus {
      border-color: var(--accent);
      outline: none;
    }

    /* Pomodoro Mini Player */
    .pomodoro-mini {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 16px 24px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      display: none;
      align-items: center;
      gap: 16px;
      z-index: 9999;
      cursor: pointer;
      transition: all 0.3s;
    }
    .pomodoro-mini.visible { display: flex; }
    .pomodoro-mini:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.25);
    }
    .pomodoro-mini-time {
      font-size: 28px;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .pomodoro-mini-mode {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .pomodoro-mini-close {
      border: none;
      background: var(--btn-secondary-bg);
      color: var(--muted);
      font-size: 18px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .pomodoro-mini-close:hover {
      background: var(--danger);
      color: white;
    }

    .star-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      color: #d1d5db;
      font-size: 22px;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }
    .star-btn:hover {
      background: #fef3c7;
      color: #f59e0b;
      transform: scale(1.1);
    }
    .star-btn.active {
      color: #f59e0b;
    }

    .pin-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      color: #9ca3af;
      font-size: 20px;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      opacity: 0.25;
    }
    .pin-btn:hover {
      background: #dbeafe;
      color: #3b82f6;
      transform: scale(1.1);
      opacity: 0.6;
    }
    .pin-btn.pinned {
      color: #3b82f6;
      opacity: 1;
    }
    .pin-btn.pinned:hover {
      opacity: 1;
    }

    .edit-btn {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      color: #9ca3af;
      font-size: 16px;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }
    .edit-btn:hover {
      background: #eff6ff;
      color: var(--accent);
      transform: scale(1.1);
    }

    .event-reminder-wrap {
      position: relative;
    }
    .reminder-btn {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      color: #9ca3af;
      font-size: 14px;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .reminder-btn:hover {
      background: #fef3c7;
      color: #f59e0b;
      transform: scale(1.1);
    }
    .reminder-btn.has-reminder {
      color: #f59e0b;
      background: rgba(245, 158, 11, 0.1);
    }
    .event-reminder-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      padding: 8px;
      display: none;
      z-index: 100;
      min-width: 140px;
    }
    .event-reminder-dropdown.open {
      display: block;
    }
    .event-reminder-option {
      padding: 8px 12px;
      font-size: 13px;
      color: var(--text);
      cursor: pointer;
      border-radius: 6px;
      transition: background 0.15s;
      white-space: nowrap;
    }
    .event-reminder-option:hover {
      background: var(--day-hover);
    }
    .event-reminder-option.active {
      background: rgba(102, 126, 234, 0.1);
      color: var(--accent);
    }
    .event-reminder-option.remove {
      color: #ef4444;
    }

    .timer {
      display: flex;
      gap: 8px;
    }
    .time-unit {
      text-align: center;
      background: var(--day-other);
      border-radius: 8px;
      padding: 8px 12px;
      min-width: 60px;
      transition: all 0.2s;
    }
    .time-unit:hover {
      background: var(--day-hover);
      transform: translateY(-1px);
    }
    .time-val {
      display: block;
      font-size: 22px;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      line-height: 1.2;
    }
    .time-label {
      display: block;
      font-size: 10px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 3px;
    }

    .badge {
      font-size: 11px;
      font-weight: 600;
      padding: 5px 10px;
      border-radius: 20px;
      white-space: nowrap;
    }
    .badge-upcoming {
      background: #ecfdf5;
      color: #059669;
    }
    .badge-ended {
      background: #fef2f2;
      color: #dc2626;
    }

    .delete-btn {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      color: #9ca3af;
      font-size: 20px;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }
    .delete-btn:hover {
      background: #fef2f2;
      color: var(--danger);
      transform: scale(1.1);
    }

    .event-actions {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      color: var(--muted);
      display: none;
    }
    .empty-state svg {
      width: 48px;
      height: 48px;
      margin-bottom: 12px;
      opacity: 0.4;
    }
    .empty-state p {
      font-size: 14px;
    }

    .input-panel.editing {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(102,126,234,0.15);
    }

    /* Undo toast */
    .undo-toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 220;
      display: none;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: white;
      border-radius: 12px;
      box-shadow: var(--shadow-hover);
      font-size: 14px;
    }
    .undo-toast.show { display: flex; }
    .undo-toast button {
      border: none;
      background: rgba(255,255,255,0.2);
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.15s;
    }
    .undo-toast button:hover { background: rgba(255,255,255,0.3); }

    /* AI Loading Toast */
    .ai-loading-toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 250;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(102, 126, 234, 0.4);
      font-size: 14px;
      font-weight: 500;
      animation: slideUpFadeIn 0.3s ease-out;
    }
    .ai-loading-spinner {
      width: 20px;
      height: 20px;
      border: 2.5px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    @keyframes slideUpFadeIn {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    /* Clear confirmation modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 16px;
    }
    .modal-backdrop.open { display: flex; }
    
    /* AI Chat Modal */
    .ai-chat-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 300;
      padding: 16px;
    }
    .ai-chat-modal.open { display: flex; }
    .ai-chat-container {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .ai-chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }
    .ai-chat-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .ai-chat-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--muted);
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 6px;
      transition: all 0.15s;
    }
    .ai-chat-close:hover {
      background: var(--day-hover);
      color: var(--text);
    }
    .ai-chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .ai-chat-message {
      display: flex;
      gap: 10px;
      animation: messageSlideIn 0.3s ease-out;
    }
    @keyframes messageSlideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .ai-chat-message.user {
      flex-direction: row-reverse;
    }
    .ai-chat-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }
    .ai-chat-message.user .ai-chat-avatar {
      background: linear-gradient(135deg, #667eea, #764ba2);
    }
    .ai-chat-message.ai .ai-chat-avatar {
      background: linear-gradient(135deg, #8b5cf6, #ec4899);
    }
    .ai-chat-bubble {
      max-width: 75%;
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.5;
    }
    .ai-chat-message.user .ai-chat-bubble {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border-bottom-right-radius: 4px;
    }
    .ai-chat-message.ai .ai-chat-bubble {
      background: var(--day-hover);
      color: var(--text);
      border-bottom-left-radius: 4px;
    }
    .ai-chat-input-area {
      padding: 16px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
    }
    .ai-chat-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 24px;
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
      outline: none;
      transition: all 0.15s;
    }
    .ai-chat-input:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .ai-chat-send {
      width: 44px;
      height: 44px;
      border: none;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    .ai-chat-send:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .ai-chat-send:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .ai-chat-examples {
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      background: var(--bg);
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 12px;
    }
    .ai-chat-example {
      padding: 6px 12px;
      border-radius: 12px;
      background: var(--card);
      border: 1px solid var(--border);
      color: var(--muted);
      cursor: pointer;
      transition: all 0.15s;
    }
    .ai-chat-example:hover {
      background: var(--day-hover);
      color: var(--text);
      border-color: #667eea;
    }
    
    .modal-card {
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 16px;
    }
    .modal-backdrop.open { display: flex; }
    .modal-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 20px;
      max-width: 420px;
      width: 100%;
      box-shadow: var(--shadow-hover);
      text-align: center;
    }
    .modal-card h3 {
      font-size: 18px;
      margin-bottom: 8px;
      color: var(--text);
    }
    .modal-card p {
      color: var(--muted);
      margin-bottom: 16px;
      line-height: 1.4;
    }
    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .modal-actions .btn {
      padding: var(--space-3) var(--space-4);
    }
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    .btn-danger:hover {
      background: #dc2626;
    }

    /* Shortcut cheat sheet */
    .shortcuts-backdrop {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(102,126,234,0.25), rgba(15,23,42,0.65));
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 12000;
      padding: 20px;
      backdrop-filter: blur(8px);
    }
    .shortcuts-backdrop.open { display: flex; }
    .shortcuts-card {
      width: min(760px, 100%);
      background: var(--card);
      border-radius: 22px;
      border: 1px solid rgba(102,126,234,0.35);
      box-shadow: 0 24px 70px rgba(15,23,42,0.35), 0 0 0 1px rgba(255,255,255,0.25) inset;
      overflow: hidden;
      direction: rtl;
    }
    .shortcuts-hero {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 22px 26px 18px;
      background: linear-gradient(135deg, rgba(102,126,234,0.18), rgba(118,75,162,0.12));
      border-bottom: 1px solid var(--border);
    }
    .shortcuts-eyebrow {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .shortcuts-title {
      font-size: 22px;
      font-weight: 700;
      margin-top: 6px;
    }
    .shortcuts-subtitle {
      font-size: 13px;
      color: var(--muted);
      margin-top: 6px;
    }
    .shortcuts-close {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: var(--day-other);
      color: var(--text);
      font-size: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .shortcuts-close:hover {
      background: var(--day-hover);
      transform: translateY(-1px);
    }
    .shortcuts-body {
      padding: 20px 26px 26px;
    }
    .shortcuts-section {
      margin-bottom: 18px;
    }
    .shortcuts-section:last-child { margin-bottom: 0; }
    .shortcuts-section-title {
      font-size: 13px;
      color: var(--muted);
      font-weight: 600;
      margin-bottom: 10px;
    }
    .shortcuts-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px 16px;
    }
    .shortcut-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      background: var(--day-other);
      border: 1px solid var(--border);
    }
    .shortcut-label {
      font-size: 14px;
      color: var(--text);
    }
    .shortcut-keys {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      direction: ltr;
    }
    .keycap {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 28px;
      padding: 4px 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--card);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      font-size: 12px;
      font-weight: 700;
      color: var(--text);
      text-transform: uppercase;
    }
    .keycap.wide { min-width: 44px; }
    .shortcut-note {
      font-size: 12px;
      color: var(--muted);
      margin-top: 12px;
    }

    @media (max-width: 640px) {
      .shortcuts-grid { grid-template-columns: 1fr; }
      .shortcuts-hero { flex-direction: column; align-items: flex-start; }
      .shortcuts-close { align-self: flex-end; }
    }
    
    /* Day Drawer/Popover */
    .day-drawer-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 250;
      padding: var(--space-4);
      backdrop-filter: blur(2px);
    }
    .day-drawer-backdrop.open { display: flex; }
    
    .day-drawer {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      width: 100%;
      max-width: 420px;
      max-height: 85vh;
      overflow: hidden;
      box-shadow: var(--shadow-hover);
      display: flex;
      flex-direction: column;
      direction: rtl;
      animation: drawerSlideIn 0.25s ease-out;
    }
    @keyframes drawerSlideIn {
      from { opacity: 0; transform: scale(0.95) translateY(10px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }
    
    .day-drawer-header {
      padding: var(--space-5);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: white;
    }
    .day-drawer-title {
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-bold);
    }
    .day-drawer-subtitle {
      font-size: var(--font-size-sm);
      opacity: 0.9;
      margin-top: var(--space-1);
    }
    .day-drawer-close {
      background: rgba(255,255,255,0.2);
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: var(--font-size-lg);
      cursor: pointer;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .day-drawer-close:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .day-drawer-content {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-4);
    }
    
    .day-drawer-section {
      margin-bottom: var(--space-5);
    }
    .day-drawer-section:last-child {
      margin-bottom: 0;
    }
    .day-drawer-section-title {
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: var(--space-3);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    .day-drawer-section-title .count {
      background: var(--accent);
      color: white;
      font-size: var(--font-size-xs);
      padding: 2px 8px;
      border-radius: 10px;
    }
    
    .day-drawer-empty {
      color: var(--muted);
      font-size: var(--font-size-sm);
      text-align: center;
      padding: var(--space-4);
      background: var(--day-other);
      border-radius: var(--radius-md);
    }
    
    .day-drawer-item {
      padding: var(--space-3);
      background: var(--day-other);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-2);
      display: flex;
      align-items: center;
      gap: var(--space-3);
      cursor: pointer;
      transition: all 0.15s;
      border-right: 3px solid transparent;
    }
    .day-drawer-item:hover {
      background: var(--day-hover);
      border-right-color: var(--accent);
    }
    .day-drawer-item:last-child {
      margin-bottom: 0;
    }
    
    .day-drawer-item-color {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .day-drawer-item-info {
      flex: 1;
      min-width: 0;
    }
    .day-drawer-item-name {
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-medium);
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .day-drawer-item-time {
      font-size: var(--font-size-xs);
      color: var(--muted);
      margin-top: 2px;
    }
    .day-drawer-item-priority {
      font-size: var(--font-size-xs);
      padding: 2px var(--space-2);
      border-radius: var(--radius-sm);
      font-weight: var(--font-weight-medium);
    }
    .day-drawer-item.task-completed .day-drawer-item-name {
      text-decoration: line-through;
      opacity: 0.6;
    }
    
    .day-drawer-actions {
      padding: var(--space-4);
      border-top: 1px solid var(--border);
      display: flex;
      gap: var(--space-2);
    }
    .day-drawer-actions .btn {
      flex: 1;
      padding: var(--space-3) var(--space-4);
      font-size: var(--font-size-sm);
    }

    /* Notes/Description */
    .input-row-notes {
      margin-top: 12px;
    }
    .input-row-notes textarea {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      min-height: 60px;
      max-height: 150px;
      outline: none;
      direction: rtl;
      text-align: right;
      background: var(--input-bg);
      color: var(--text);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .input-row-notes textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(102,126,234,0.15);
    }
    .event-notes {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 40px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .event-notes.expanded {
      max-height: none;
    }
    .notes-toggle {
      font-size: 11px;
      color: var(--accent);
      cursor: pointer;
      margin-top: 2px;
      display: inline-block;
    }
    .notes-toggle:hover {
      text-decoration: underline;
    }

    /* Task Manager Fullscreen Modal */
    .task-manager-overlay {
      position: fixed;
      top: 56px;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg);
      z-index: 300;
      display: none;
      flex-direction: column;
      overflow: hidden;
    }
    .task-manager-overlay.open {
      display: flex;
    }
    
    .task-manager-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-4) var(--space-6);
      background: var(--card);
      border-bottom: 1px solid var(--border);
      box-shadow: var(--shadow);
      gap: var(--space-4);
      flex-wrap: wrap;
    }
    
    .task-manager-title {
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-bold);
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    
    .task-manager-close {
      width: 40px;
      height: 40px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--card);
      color: var(--text);
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .task-manager-close:hover {
      background: #fef2f2;
      color: var(--danger);
    }
    
    .task-search-bar {
      flex: 1;
      max-width: 500px;
      position: relative;
    }
    .task-search-bar input {
      width: 100%;
      padding: 12px 16px 12px 44px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 15px;
      background: var(--input-bg);
      color: var(--text);
      outline: none;
      transition: all 0.2s;
    }
    .task-search-bar input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(102,126,234,0.15);
    }
    .task-search-bar::before {
      content: 'ðŸ”';
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 16px;
    }
    
    .task-manager-body {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }
    
    /* Quick Add Task */
    .quick-add-task {
      max-width: 600px;
      margin: 0 auto 32px auto;
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      box-shadow: var(--shadow);
      transition: all 0.2s;
    }
    .quick-add-task:focus-within {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(102,126,234,0.15);
    }
    .quick-add-task input[type="text"] {
      width: 100%;
      border: none;
      font-size: 16px;
      padding: 8px 0;
      background: transparent;
      color: var(--text);
      outline: none;
    }
    .quick-add-task input[type="text"]::placeholder {
      color: var(--muted);
    }
    .quick-add-row {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    .quick-add-row .btn {
      padding: 10px 18px;
      font-size: 14px;
    }
    
    /* Color Picker */
    .color-picker {
      display: flex;
      gap: 6px;
    }
    .color-option {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 3px solid transparent;
      cursor: pointer;
      transition: all 0.15s;
    }
    .color-option:hover {
      transform: scale(1.15);
    }
    .color-option.selected {
      border-color: var(--text);
      box-shadow: 0 0 0 2px var(--card);
    }
    
    /* Label/Tag Input */
    .label-input-wrapper {
      display: flex;
      align-items: center;
      gap: 6px;
      background: var(--day-other);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
    }
    .label-input-wrapper input {
      border: none;
      background: transparent;
      font-size: 13px;
      width: 80px;
      color: var(--text);
      outline: none;
    }
    
    /* Task List */
    .task-sections {
      max-width: 900px;
      margin: 0 auto;
    }
    .task-section-title {
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: var(--space-4);
      padding-left: var(--space-2);
    }
    .task-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
      margin-bottom: var(--space-8);
    }
    
    /* Task Item (List style) */
    .task-item {
      background-color: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--space-4) var(--space-5);
      box-shadow: var(--shadow);
      transition: all 0.25s ease;
      display: flex;
      align-items: center;
      gap: var(--space-4);
      border-left: 5px solid var(--task-color, var(--priority-color, var(--border)));
      position: relative;
      overflow: hidden;
    }
    /* Color accent overlay */
    .task-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, var(--task-color, transparent) 0%, transparent 100%);
      opacity: 0.08;
      pointer-events: none;
      border-radius: inherit;
    }
    /* Top accent stripe for colored tasks */
    .task-item::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--task-color, transparent);
      opacity: 0.6;
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    }
    .task-item.dragging {
      opacity: 0.55;
      cursor: grabbing;
    }
    .task-item:hover {
      box-shadow: var(--shadow-hover);
      background-color: var(--priority-bg, var(--card));
    }
    .task-item.completed {
      opacity: 0.6;
      background-color: var(--day-other);
    }
    
    .task-checkbox {
      width: 24px;
      height: 24px;
      border: 2px solid var(--priority-color, var(--border));
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s;
      background: transparent;
      color: transparent;
      font-size: var(--font-size-sm);
    }
    .task-checkbox:hover {
      background: var(--priority-bg, var(--day-hover));
    }
    .task-item.completed .task-checkbox {
      background: var(--priority-color, var(--success));
      border-color: var(--priority-color, var(--success));
      color: white;
    }
    
    .task-main {
      flex: 1;
      min-width: 0;
      cursor: pointer;
    }
    .task-title-row {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      margin-bottom: var(--space-1);
    }
    .task-title {
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-semibold);
      color: var(--text);
      word-break: break-word;
    }
    .task-color-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      box-shadow: 0 0 0 2px var(--card), 0 2px 4px rgba(0,0,0,0.15);
      flex-shrink: 0;
    }
    .task-item.completed .task-title {
      text-decoration: line-through;
      color: var(--muted);
    }
    .task-priority-badge {
      font-size: 10px;
      font-weight: var(--font-weight-bold);
      padding: 3px var(--space-2);
      border-radius: var(--radius-lg);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: var(--priority-color);
      color: white;
      flex-shrink: 0;
    }
    
    .task-meta {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      flex-wrap: wrap;
    }
    .task-due {
      font-size: var(--font-size-sm);
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: var(--space-1);
    }
    .task-due.overdue {
      color: var(--danger);
      font-weight: var(--font-weight-semibold);
    }
    .task-due.soon {
      color: #f97316;
      font-weight: var(--font-weight-semibold);
    }
    .task-countdown {
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-semibold);
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-lg);
      background: var(--day-other);
      color: var(--text);
      font-variant-numeric: tabular-nums;
    }
    .task-countdown.overdue {
      background: #fef2f2;
      color: var(--danger);
    }
    .task-countdown.soon {
      background: #fff7ed;
      color: #f97316;
    }
    .task-recurrence {
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-semibold);
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-lg);
      background: color-mix(in srgb, var(--accent) 14%, var(--day-other));
      color: var(--text);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    /* inline recurrence SVG uses its own inline styles; keep this as a harmless fallback */
    .recurrence-icon-svg {
      width: 13px;
      height: 13px;
      stroke: currentColor;
      fill: none;
      stroke-width: 2;
    }
    .task-reminder {
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-semibold);
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-lg);
      background: color-mix(in srgb, #f59e0b 14%, var(--day-other));
      color: var(--text);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    
    .task-subtasks {
      margin-top: var(--space-2);
      padding-top: var(--space-2);
      border-top: 1px dashed var(--border);
    }
    .task-subtask {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 0;
      font-size: 14px;
      color: var(--text);
    }
    .task-subtask input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--accent);
      cursor: pointer;
    }
    .task-subtask.checked span {
      text-decoration: line-through;
      color: var(--muted);
    }
    .task-subtask-progress {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    
    .task-actions {
      display: flex;
      gap: 4px;
      flex-shrink: 0;
    }
    .task-action-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 16px;
      cursor: pointer;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    .task-action-btn:hover {
      background: var(--day-hover);
      color: var(--text);
    }
    .task-action-btn.ai-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 14px;
    }
    .task-action-btn.ai-btn:hover {
      background: linear-gradient(135deg, #5a6fd6 0%, #6a4190 100%);
      color: white;
      transform: scale(1.05);
    }
    .task-reminder-wrap {
      position: relative;
    }
    .task-reminder-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 16px;
      cursor: pointer;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    .task-reminder-btn:hover {
      background: #fef3c7;
      color: #f59e0b;
    }
    .task-reminder-btn.has-reminder {
      color: #f59e0b;
      background: rgba(245, 158, 11, 0.1);
    }
    .task-reminder-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      padding: 8px;
      display: none;
      z-index: 100;
      min-width: 140px;
      margin-top: 4px;
    }
    .task-reminder-dropdown.open {
      display: block;
    }
    .task-reminder-option {
      padding: 8px 12px;
      font-size: 13px;
      color: var(--text);
      cursor: pointer;
      border-radius: 6px;
      transition: background 0.15s;
      white-space: nowrap;
    }
    .task-reminder-option:hover {
      background: var(--day-hover);
    }
    .task-reminder-option.active {
      background: rgba(102, 126, 234, 0.1);
      color: var(--accent);
    }
    .task-reminder-option.remove {
      color: #ef4444;
    }
    .task-action-btn.delete:hover {
      background: #fef2f2;
      color: var(--danger);
    }
    
    /* Task Edit Modal */
    .task-edit-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 400;
      padding: 20px;
    }
    .task-edit-modal.open {
      display: flex;
    }
    .task-edit-card {
      background: var(--card);
      border-radius: 16px;
      padding: 24px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .task-edit-card input[type="text"],
    .task-edit-card textarea {
      width: 100%;
      border: none;
      background: transparent;
      color: var(--text);
      outline: none;
      resize: none;
    }
    .task-edit-card input[type="text"] {
      font-size: 20px;
      font-weight: 600;
      padding: 8px 0;
    }
    .task-edit-card textarea {
      font-size: 15px;
      line-height: 1.6;
      min-height: 150px;
      margin-top: 16px;
    }
    
    .task-edit-section {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    .task-edit-section-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 12px;
    }
    
    .checklist-add {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 12px;
    }
    .checklist-add input {
      flex: 1;
      padding: 10px 14px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      background: var(--input-bg);
      color: var(--text);
      outline: none;
    }
    .checklist-add input:focus {
      border-color: var(--accent);
    }
    
    .task-edit-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
      flex-wrap: wrap;
      gap: 12px;
    }
    
    /* Empty Tasks State */
    .tasks-empty {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }
    .tasks-empty-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    .tasks-empty h3 {
      font-size: 20px;
      color: var(--text);
      margin-bottom: 8px;
    }
    .tasks-empty p {
      font-size: 14px;
    }
    
    /* Suggested Tasks Banner */
    .suggested-tasks-banner {
      background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1));
      border: 1px solid var(--accent);
      border-radius: 10px;
      padding: 12px 16px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: var(--text);
    }
    .suggested-tasks-banner .suggested-icon {
      font-size: 18px;
    }
    
    /* Task Subject Tag (when showing suggested) */
    .task-subject-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: rgba(102,126,234,0.15);
      color: var(--accent);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      margin-left: 8px;
    }
    .task-subject-tag .tag-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }
    
    /* Filter Pills */
    .task-filters {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .filter-pill {
      padding: 8px 16px;
      border: 1px solid var(--border);
      border-radius: 20px;
      background: var(--card);
      color: var(--muted);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }
    .filter-pill:hover {
      background: var(--day-hover);
    }
    .filter-pill.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    
    /* Priority Selector */
    .priority-selector {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .priority-option {
      padding: 8px 16px;
      border: 2px solid transparent;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }
    .priority-option:hover {
      transform: scale(1.05);
    }
    .priority-option.selected {
      border-color: var(--text);
    }
    .priority-option[data-priority="urgent"] { background: #fef2f2; color: #ef4444; }
    .priority-option[data-priority="high"] { background: #fff7ed; color: #f97316; }
    .priority-option[data-priority="medium"] { background: #fefce8; color: #eab308; }
    .priority-option[data-priority="low"] { background: #f0fdf4; color: #22c55e; }
    .priority-option[data-priority="none"] { background: var(--day-other); color: var(--muted); }
    
    /* Task Checklist in Edit Modal */
    .task-checklist {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .task-checklist-item {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      padding: 8px 0;
    }
    .task-checklist-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
      cursor: pointer;
    }
    .task-checklist-item.checked span {
      text-decoration: line-through;
      color: var(--muted);
    }

    .task-color-picker {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
      padding: 8px;
      background: var(--day-other);
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
    }
    .task-color-picker.compact {
      gap: 5px;
      padding: 6px 8px;
      background: transparent;
      border: none;
    }
    .task-color-option {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 600;
      color: var(--muted);
      background: var(--day-other);
      position: relative;
    }
    .task-color-option.subject {
      font-weight: 700;
      color: #fff;
      border-style: dashed;
      border-color: var(--border);
    }
    .task-color-option.disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .task-color-picker.compact .task-color-option {
      width: 20px;
      height: 20px;
      font-size: 9px;
      border-radius: 5px;
    }
    .task-color-option.none {
      color: var(--muted);
      background: var(--card);
      border: 2px dashed var(--border);
      font-size: 12px;
    }
    .task-color-option:not(.disabled):hover {
      transform: scale(1.15);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .task-color-option.selected {
      border-color: var(--text);
      box-shadow: 0 0 0 2px var(--card), 0 2px 8px rgba(0,0,0,0.2);
      transform: scale(1.1);
    }
    .task-color-option.selected.none {
      border-style: solid;
      border-color: var(--accent);
      background: var(--card);
    }
    
    
    .subject-tab {
      padding: 8px 16px;
      border: 2px solid var(--border);
      border-radius: 20px;
      background: var(--card);
      color: var(--muted);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 6px;
      position: relative;
    }
    .subject-tab:hover {
      background: var(--day-hover);
      border-color: var(--accent);
    }
    .subject-tab.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    .subject-tab.smart-view {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: white;
      border: none;
    }
    .subject-tab.smart-view:not(.active) {
      background: var(--day-other);
      color: var(--muted);
    }
    .subject-tab .tab-count {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      background: rgba(255,255,255,0.25);
      min-width: 18px;
      text-align: center;
    }
    .subject-tab:not(.active) .tab-count {
      background: var(--day-other);
      color: var(--muted);
    }
    .subject-tab .tab-color,
    .subject-tab-color {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    
    /* Smart Views Section */
    .smart-views-section {
      display: flex;
      gap: 6px;
      padding-right: 12px;
      border-right: 1px solid var(--border);
      margin-right: 4px;
    }
    
    /* Subject with sub-subjects */
    .subject-tab.has-children .subject-tab-inner {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .subject-tab .expand-arrow {
      font-size: 8px;
      transition: transform 0.2s;
      opacity: 0.7;
    }
    .subject-tab.expanded .expand-arrow {
      transform: rotate(180deg);
    }
    
    /* Sub-subjects list (inline chips) */
    .sub-subjects-inline {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin-left: 4px;
      padding-left: 8px;
      border-left: 2px solid var(--border);
    }
    .sub-subject-chip {
      padding: 4px 10px;
      border-radius: 12px;
      background: var(--day-other);
      color: var(--text);
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.15s;
    }
    .sub-subject-chip:hover {
      background: var(--day-hover);
    }
    .sub-subject-chip.active {
      background: var(--accent);
      color: white;
    }
    .sub-subject-chip .chip-color {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    
    
    
    /* -------------------- Subjects / Sidebar -------------------- */
    .add-subject-btn {
      width: 36px;
      height: 36px;
      border: 2px dashed var(--border);
      border-radius: 50%;
      background: transparent;
      color: var(--muted);
      font-size: 20px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .add-subject-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(102,126,234,0.1);
    }
    
    /* Task Calendar in Sidebar - matches countdown calendar style */
    .task-calendar-section {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    
    
    
    .task-calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      gap: 10px;
    }
    
    .task-calendar-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
    }
    
    .task-calendar-nav {
      display: flex;
      gap: 8px;
    }
    
    
    
    .task-manager-sidebar {
      width: 260px;
      min-width: 200px;
      background: var(--card);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .task-manager-sidebar-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .task-manager-sidebar-header h3 {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin: 0;
    }
    
    .task-manager-sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }
    
    /* Collapsible Subject List */
    .subject-list-item {
      margin-bottom: 4px;
    }
    
    .subjects-list {
      overflow-x: auto;
      overflow-y: visible;
    }
    
    .subject-list-header {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
      gap: 8px;
      position: relative;
    }
    
    .subject-list-header:hover {
      background: var(--day-hover);
    }
    
    /* Custom tooltip for subject names */
    .subject-list-header[title]:hover::after,
    .subject-child-item[title]:hover::after {
      content: attr(title);
      position: absolute;
      bottom: 100%;
      left: 12px;
      right: auto;
      background: var(--text);
      color: var(--bg);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
      z-index: 1001;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      pointer-events: none;
      animation: tooltipFade 0.2s ease;
      margin-bottom: 4px;
    }
    
    @keyframes tooltipFade {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .subject-list-header:hover .subject-actions {
      opacity: 1;
    }
    
    /* Subject Action Buttons */
    .subject-actions {
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.2s;
      margin-right: auto;
      flex-shrink: 0;
    }
    
    .subject-action-btn {
      width: 28px;
      height: 28px;
      border: 1px solid transparent;
      background: rgba(0,0,0,0.05);
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      color: var(--text);
      opacity: 0.8;
    }
    
    body.dark .subject-action-btn {
      background: rgba(255,255,255,0.1);
    }
    
    .subject-action-btn:hover {
      background: rgba(0,0,0,0.15);
      opacity: 1;
      transform: scale(1.1);
      border-color: var(--border);
    }
    
    body.dark .subject-action-btn:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .subject-list-header.active .subject-action-btn {
      background: rgba(255,255,255,0.15);
      color: white;
    }
    
    .subject-list-header.active .subject-action-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .subject-action-btn.delete:hover {
      background: rgba(239, 68, 68, 0.15);
      color: var(--danger);
      border-color: var(--danger);
    }
    
    .subject-child-item .subject-action-btn {
      width: 26px;
      height: 26px;
      font-size: 13px;
    }
    
    .subject-child-item:hover .subject-actions {
      opacity: 1;
    }
    
    .subject-list-header.active {
      background: var(--accent);
      color: white;
    }
    .subject-list-header.drag-over,
    .subject-child-item.drag-over {
      outline: 2px dashed var(--accent);
      background: var(--day-hover);
    }
    
    .subject-list-header .subject-color-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    
    .subject-list-header .subject-name {
      flex: 1;
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      min-width: 0;
    }
    
    .subject-list-header .subject-count {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 8px;
      background: rgba(0,0,0,0.1);
      color: inherit;
      flex-shrink: 0;
    }
    
    .subject-list-header.active .subject-count {
      background: rgba(255,255,255,0.2);
    }
    
    .subject-list-header .collapse-arrow {
      font-size: 10px;
      transition: transform 0.25s ease;
      opacity: 0.6;
      cursor: pointer;
      flex-shrink: 0;
    }
    
    .subject-list-header .collapse-arrow:hover {
      opacity: 1;
    }
    
    .subject-list-item.expanded .collapse-arrow {
      transform: rotate(180deg);
    }
    
    /* Shared subject indicator */
    .shared-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 6px;
      background: rgba(102, 126, 234, 0.15);
      color: var(--accent);
      margin-right: 4px;
      display: inline-flex;
      align-items: center;
      gap: 3px;
      flex-shrink: 0;
      position: relative;
      z-index: 1;
    }
    .shared-badge svg {
      width: 10px;
      height: 10px;
    }
    .subject-list-header.active .shared-badge {
      background: rgba(255,255,255,0.2);
      color: inherit;
    }
    
    /* Shared users pills in modal */
    .shared-user-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: var(--accent);
      color: white;
      border-radius: 16px;
      font-size: 12px;
      margin: 2px;
    }
    .shared-user-pill .remove-share {
      cursor: pointer;
      opacity: 0.8;
      margin-right: -4px;
      padding: 2px;
    }
    .shared-user-pill .remove-share:hover {
      opacity: 1;
    }
    .shared-user-pill.owner {
      background: var(--muted);
    }
    
    .subject-list-children {
      padding-right: 20px;
      margin-top: 0;
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transition: max-height 0.3s ease, opacity 0.25s ease, margin-top 0.25s ease;
    }
    
    .subject-list-item.expanded .subject-list-children {
      max-height: 500px; /* Large enough for many children */
      opacity: 1;
      margin-top: 4px;
    }
    
    .subject-child-item {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      gap: 8px;
      margin-bottom: 2px;
      transform: translateX(0);
      position: relative;
    }
    
    .subject-child-item:hover {
      background: var(--day-hover);
      transform: translateX(-2px);
    }
    
    .subject-child-item.active {
      background: var(--accent);
      color: white;
    }
    
    .subject-child-item .child-color {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    
    .subject-child-item .child-name {
      flex: 1;
      font-size: 12px;
      white-space: nowrap;
      min-width: 0;
    }
    
    .subject-child-item .child-count {
      font-size: 10px;
      opacity: 0.7;
      flex-shrink: 0;
    }
    
    /* Smart Views in Sidebar */
    .smart-views-list {
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }
    
    .smart-view-item {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
      gap: 8px;
      margin-bottom: 2px;
    }
    
    .smart-view-item:hover {
      background: var(--day-hover);
    }
    
    .smart-view-item.active {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: white;
    }
    
    .smart-view-item .view-icon {
      font-size: 14px;
    }
    
    .smart-view-item .view-name {
      flex: 1;
      font-size: 13px;
      font-weight: 500;
    }
    
    .smart-view-item .view-count {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 8px;
      background: rgba(0,0,0,0.1);
    }
    
    .smart-view-item.active .view-count {
      background: rgba(255,255,255,0.2);
    }
    
    .subjects-list-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 8px 12px 4px;
    }
    
    /* Add Subject Button in Sidebar */
    .add-subject-sidebar-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border: 2px dashed var(--border);
      border-radius: 8px;
      background: transparent;
      color: var(--muted);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
      width: 100%;
      margin-top: 8px;
    }
    
    .add-subject-sidebar-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(102,126,234,0.05);
    }
    
    /* Task Month List */
    .task-month-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    
    .task-month-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 10px;
    }
    
    .task-month-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: none;
      overflow: visible;
    }
    
    .task-month-item {
      padding: 8px 10px;
      background: var(--day-other);
      border-radius: 6px;
      border-right: 3px solid var(--accent);
      font-size: 12px;
    }
    
    .task-month-item-title {
      font-weight: 500;
      color: var(--text);
      margin-bottom: 2px;
    }
    
    .task-month-item-date {
      font-size: 10px;
      color: var(--muted);
    }

    /* Context Menu */
    .context-menu {
      position: fixed;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
      padding: 8px;
      min-width: 180px;
      z-index: 1000;
      display: none;
    }
    .context-menu.open {
      display: block;
    }
    .context-menu-item {
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text);
      font-size: 13px;
      transition: background 0.1s;
    }
    .context-menu-item:hover {
      background: var(--day-hover);
    }
    .context-menu-item.danger {
      color: var(--danger);
    }
    .context-menu-item.danger:hover {
      background: #fef2f2;
    }
    .context-menu-divider {
      height: 1px;
      background: var(--border);
      margin: 6px 0;
    }
    
    /* Daily Reminder Modal */
    .reminder-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 600;
      padding: 20px;
    }
    .reminder-modal.open {
      display: flex;
    }
    .reminder-card {
      background: var(--card);
      border-radius: 20px;
      padding: 28px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      text-align: center;
    }
    #eventAlertModal .reminder-card {
      background: linear-gradient(180deg, rgba(102, 126, 234, 0.12), var(--card));
      border: 1px solid rgba(102, 126, 234, 0.2);
      animation: alertPop 0.25s ease-out;
    }
    @keyframes alertPop {
      from { opacity: 0; transform: translateY(8px) scale(0.98); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .reminder-card h2 {
      font-size: 24px;
      margin-bottom: 8px;
      color: var(--text);
    }
    .reminder-card .reminder-date {
      color: var(--muted);
      font-size: 14px;
      margin-bottom: 20px;
    }
    .reminder-section {
      text-align: right;
      margin-bottom: 16px;
    }
    .reminder-section h3 {
      font-size: 14px;
      color: var(--accent);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .reminder-task-item {
      padding: 12px;
      background: var(--day-other);
      border-radius: 10px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
      text-align: right;
    }
    .reminder-task-item .task-priority-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .reminder-task-item .task-info {
      flex: 1;
    }
    .reminder-task-item .task-title {
      font-weight: 600;
      color: var(--text);
      font-size: 14px;
    }
    .reminder-task-item .task-time {
      font-size: 12px;
      color: var(--muted);
    }
    .reminder-empty {
      color: var(--muted);
      font-size: 14px;
      padding: 12px;
    }
    .reminder-actions {
      margin-top: 20px;
    }
    
    /* Natural Language Input Hint */
    .nl-hint {
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
      direction: rtl;
      line-height: 1.6;
    }
    .nl-hint code {
      background: var(--day-other);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: inherit;
      color: var(--accent);
      font-weight: 500;
    }
    .nl-hint-toggle {
      color: var(--accent);
      cursor: pointer;
      text-decoration: underline;
      margin-right: 8px;
    }
    .nl-hint-examples {
      display: none;
      margin-top: 12px;
      padding: 16px;
      background: var(--day-other);
      border-radius: 10px;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
      direction: rtl;
    }
    .nl-hint-examples.show {
      display: block;
    }
    .nl-hint-examples div {
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }
    .nl-hint-examples div:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }
    .nl-hint-examples .example-input {
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
      padding: 6px 10px;
      background: var(--card);
      border-radius: 6px;
      border-right: 3px solid var(--accent);
    }
    .nl-hint-examples .example-result {
      color: var(--muted);
      font-size: 11px;
      padding-right: 16px;
    }
    
    
    
    /* (duplicate .add-subject-btn removed) */
    
    
    
    .task-calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      gap: 10px;
    }
    
    .task-calendar-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
    }
    
    .task-calendar-nav {
      display: flex;
      gap: 8px;
    }
    
    
    
    /* Subject Modal */
    .subject-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 500;
      padding: 20px;
    }
    .subject-modal.open {
      display: flex;
    }
    .subject-modal-card {
      background: var(--card);
      border-radius: 16px;
      padding: 24px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .subject-modal-card h3 {
      font-size: 20px;
      margin-bottom: 20px;
      color: var(--text);
    }
    .subject-modal-card input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 15px;
      background: var(--input-bg);
      color: var(--text);
      outline: none;
      margin-bottom: 16px;
    }
    .subject-modal-card input:focus {
      border-color: var(--accent);
    }
    .subject-color-picker {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .subject-color-option {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 3px solid transparent;
      cursor: pointer;
      transition: all 0.15s;
    }
    .subject-color-option:hover {
      transform: scale(1.15);
    }
    .subject-color-option.selected {
      border-color: var(--text);
      box-shadow: 0 0 0 2px var(--card);
    }
    .subject-modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    .subject-modal-actions .btn {
      padding: 12px 20px;
    }
    
    /* Subject badge in task item */
    .task-subject-badge {
      font-size: 11px;
      font-weight: 600;
      padding: 3px 10px;
      border-radius: 12px;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 6px;
      background: color-mix(in srgb, var(--subject-color, #667eea) 28%, transparent);
      color: var(--subject-color, #667eea);
      border: 1px solid color-mix(in srgb, var(--subject-color, #667eea) 45%, transparent);
      box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--subject-color, #667eea) 12%, transparent);
    }
    .task-subject-badge::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--subject-color, #667eea);
      flex-shrink: 0;
    }
    .task-subject-badge .badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    
    /* Subject selector in quick add */
    .subject-selector {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .subject-selector-option {
      padding: 6px 14px;
      border: 2px solid var(--border);
      border-radius: 16px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .subject-selector-option:hover {
      border-color: var(--accent);
    }
    .subject-selector-option.selected {
      border-color: var(--text);
      background: var(--day-hover);
    }
    .subject-selector-option .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    
    /* Edit subject button */
    .edit-subject-btn {
      padding: 4px 8px;
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 12px;
      cursor: pointer;
      border-radius: 4px;
      margin-left: 4px;
    }
    .edit-subject-btn:hover {
      background: var(--day-hover);
      color: var(--text);
    }

    /* Notification permission button */
    @media (max-width: 1100px) {
      .sidebar {
        position: relative;
        box-shadow: none;
      }
      .sidebar.hidden {
        transform: translateX(100%);
      }

      /* Fix for Task Manager Calendar Sidebar visibility */
      #taskRightSidebar {
        z-index: 350; /* Must be higher than task-manager-overlay (300) */
      }
      #taskRightSidebar.calendar-expanded {
        width: 100%;
        min-width: 0;
      }
      
      @media (max-width: 1100px) {
        #taskRightSidebar {
          position: absolute; /* Override fixed positioning from generic .sidebar */
          height: 100%;
        }
      }
    }

    @media (max-width: 640px) {
      .main-content { padding: 12px; padding-top: 70px; }
      .header { margin-bottom: 20px; }
      .header h1 { font-size: 22px; }
      .header p { font-size: 13px; }

      .fixed-header-bar {
        height: 50px;
        padding: 0 12px;
        gap: 8px;
      }
      .header-btn {
        padding: 8px 12px;
        font-size: 12px;
      }
      .header-btn.icon-only {
        width: 36px;
        height: 36px;
      }
      body {
        padding-top: 50px;
      }
      .app-layout {
        height: calc(100vh - 50px);
      }

      .task-manager-header {
        padding: 12px 16px;
      }
      .task-manager-title {
        font-size: 18px;
      }
      .task-search-bar {
        order: 10;
        max-width: 100%;
        flex-basis: 100%;
      }
      .quick-add-task {
        margin: 0 0 24px 0;
      }
      .task-item {
        flex-wrap: wrap;
      }
      .task-main {
        width: 100%;
        order: 2;
      }
      .task-actions {
        order: 3;
        width: 100%;
        justify-content: center;
        padding-top: 12px;
        border-top: 1px solid var(--border);
        margin-top: 12px;
      }

      .input-panel { padding: 14px; }
      .input-row { 
        flex-direction: column;
        gap: 10px;
      }
      .input-row input { 
        width: 100%;
        padding: 12px 14px;
        font-size: 16px;
      }
      .input-row .reminder-select {
        width: 100%;
        padding: 12px 14px;
        font-size: 16px;
      }
      .reminder-custom {
        width: 100%;
        flex-direction: column;
      }
      .reminder-custom input,
      .reminder-custom select {
        width: 100%;
        padding: 12px 14px;
        font-size: 16px;
      }
      .input-row .btn {
        width: 100%;
        padding: 12px;
      }
      .input-row-notes textarea {
        font-size: 16px;
      }

      .event-row { 
        flex-direction: column;
        align-items: stretch;
        padding: 14px;
        gap: 12px;
      }
      .color-dot { display: none; }
      .event-info {
        order: 1;
        text-align: center;
      }
      .event-name { font-size: 16px; }
      .timer { 
        order: 2;
        width: 100%;
        justify-content: center;
        gap: 6px;
      }
      .time-unit { 
        min-width: 50px;
        padding: 8px 6px;
        flex: 1;
      }
      .time-val { font-size: 18px; }
      .time-label { font-size: 9px; }
      .badge {
        order: 3;
        align-self: center;
      }
      .event-actions {
        order: 4;
        display: flex;
        justify-content: center;
        gap: 16px;
        padding-top: 8px;
        border-top: 1px solid var(--border);
        width: 100%;
      }
      .star-btn, .edit-btn, .delete-btn {
        width: 40px;
        height: 40px;
        font-size: 20px;
      }

      .sidebar {
        width: 100%;
      }
      
      /* Task manager sidebar on mobile */
      .task-manager-layout {
        flex-direction: column;
      }
      
      .task-manager-sidebar {
        width: 100%;
        max-height: 200px;
        border-left: none;
        border-bottom: 1px solid var(--border);
      }
      
      .task-manager-sidebar-content {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 8px;
      }
      
      .smart-views-list {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }
      
      .smart-view-item {
        padding: 6px 10px;
        font-size: 12px;
      }
      
      .subjects-list-title {
        display: none;
      }
      
      .subjects-list {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
      }
      
      .subject-list-item {
        margin-bottom: 0;
      }
      
      .subject-list-header {
        padding: 6px 10px;
      }
      
      .subject-list-children {
        position: absolute;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 8px;
        box-shadow: var(--shadow);
        padding: 8px;
        z-index: 100;
        padding-right: 0;
        margin-top: 0;
      }
      
      .add-subject-sidebar-btn {
        padding: 6px 10px;
        font-size: 12px;
        margin-top: 0;
      }
      
      .calendar-day { min-height: 48px; padding: 6px; }
      .calendar-day-number { font-size: 12px; }
      .calendar-event-chip { font-size: 9px; padding: 2px 4px; }
      .calendar-grid { gap: 4px; }

      .modal-card { padding: 16px; }
      .modal-actions { flex-direction: column; }
      .modal-actions .btn { width: 100%; }
    }
    
    /* Bad Day Presets - special styling */
    .pomodoro-preset.bad-day {
      border-color: rgba(249, 115, 22, 0.3);
      background: linear-gradient(135deg, rgba(249, 115, 22, 0.05), rgba(234, 179, 8, 0.05));
      color: #f97316;
    }
    
    .pomodoro-preset.bad-day:hover {
      border-color: #f97316;
      background: linear-gradient(135deg, rgba(249, 115, 22, 0.1), rgba(234, 179, 8, 0.1));
      color: #ea580c;
    }
    
    .pomodoro-preset.bad-day.active {
      background: linear-gradient(135deg, #f97316, #eab308);
      border-color: transparent;
      color: white;
      box-shadow: 0 4px 16px rgba(249, 115, 22, 0.4);
    }
    
    /* Bad Day Tip */
    .pomodoro-bad-day-tip {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 16px 20px;
      background: linear-gradient(135deg, rgba(249, 115, 22, 0.08), rgba(234, 179, 8, 0.08));
      border: 1px solid rgba(249, 115, 22, 0.2);
      border-radius: 16px;
      width: 100%;
      max-width: 500px;
      animation: tipFadeIn 0.4s ease;
    }
    
    @keyframes tipFadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .pomodoro-bad-day-tip .tip-icon {
      font-size: 20px;
      flex-shrink: 0;
    }
    
    .pomodoro-bad-day-tip .tip-text {
      font-size: 13px;
      line-height: 1.6;
      color: var(--text);
      opacity: 0.85;
    }

    /* Pomodoro RTL tweaks */
    .pomodoro-overlay {
      direction: rtl;
    }

    .pomodoro-card,
    .pomodoro-options,
    .pomodoro-settings-panel,
    .pomodoro-presets,
    .pomodoro-daily,
    .pomodoro-stats,
    .pomodoro-task-select,
    .pomodoro-mini {
      text-align: right;
    }

    .pomodoro-mini {
      direction: rtl;
    }

    .pomodoro-time,
    .pomodoro-mini-time {
      direction: ltr;
      text-align: center;
    }

    .pomodoro-next,
    .pomodoro-mode,
    .pomodoro-mini-mode {
      text-align: center;
    }

    .pomodoro-controls,
    .pomodoro-presets,
    .pomodoro-options,
    .pomodoro-settings-panel,
    .pomodoro-stats,
    .pomodoro-daily {
      direction: rtl;
    }

    /* ==========================================================================
       MOBILE & ANDROID PWA REDESIGN
       Extensive customization for touch-based mobile usage
       Does NOT affect macOS/desktop web experience
       ========================================================================== */
    
    /* Mobile detection: smartphones and PWA standalone mode */
    @media screen and (max-width: 768px), (display-mode: standalone) and (max-width: 1024px) {
      
      /* ===== ROOT MOBILE VARIABLES ===== */
      :root {
        --mobile-touch-target: 48px;
        --mobile-spacing-xs: 6px;
        --mobile-spacing-sm: 10px;
        --mobile-spacing-md: 16px;
        --mobile-spacing-lg: 24px;
        --mobile-radius: 16px;
        --mobile-radius-lg: 24px;
        --mobile-card-shadow: 0 2px 12px rgba(0,0,0,0.08);
        --mobile-header-height: 56px;
        --mobile-bottom-nav-height: 64px;
      }
      
      /* ===== BODY & LAYOUT OPTIMIZATIONS ===== */
      body {
        padding-top: var(--mobile-header-height);
        padding-bottom: calc(var(--mobile-bottom-nav-height) + env(safe-area-inset-bottom, 0px));
        font-size: 16px; /* Prevent zoom on input focus */
        -webkit-text-size-adjust: 100%;
      }
      
      /* Hide scrollbar but keep scroll functionality */
      body::-webkit-scrollbar,
      .app-layout::-webkit-scrollbar,
      .task-list::-webkit-scrollbar,
      .event-list::-webkit-scrollbar {
        display: none;
      }
      
      body, .app-layout, .task-list, .event-list {
        scrollbar-width: none;
        -ms-overflow-style: none;
      }

      .app-layout {
        flex-direction: column;
        height: auto;
        min-height: calc(100dvh - var(--mobile-header-height) - var(--mobile-bottom-nav-height));
        padding-bottom: var(--mobile-bottom-nav-height);
      }
      
      /* ===== MOBILE HEADER BAR REDESIGN ===== */
      .fixed-header-bar {
        height: var(--mobile-header-height);
        padding: 0 var(--mobile-spacing-md);
        gap: var(--mobile-spacing-sm);
        background: var(--card);
        border-bottom: none;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
      
      /* Hide main nav buttons in header - they move to bottom nav */
      .fixed-header-bar #toggleCountdown,
      .fixed-header-bar #toggleTasks,
      .fixed-header-bar #togglePomodoro,
      .fixed-header-bar #togglePlanner,
      .fixed-header-bar #toggleSidebar {
        display: none;
      }
      
      /* Keep utility buttons visible */
      .fixed-header-bar .header-btn.icon-only {
        width: var(--mobile-touch-target);
        height: var(--mobile-touch-target);
        font-size: 22px;
        border-radius: 50%;
        background: var(--day-other);
      }
      
      .fixed-header-bar #userBtn {
        padding: var(--mobile-spacing-sm) var(--mobile-spacing-md);
        border-radius: var(--mobile-radius);
        font-size: 14px;
      }
      
      .sync-badge {
        padding: var(--mobile-spacing-xs) var(--mobile-spacing-sm);
        font-size: 11px;
      }
      
      /* ===== MOBILE BOTTOM NAVIGATION BAR ===== */
      .mobile-bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: var(--mobile-bottom-nav-height);
        padding-bottom: env(safe-area-inset-bottom, 0px);
        background: var(--card);
        border-top: 1px solid var(--border);
        display: flex !important;
        justify-content: space-around;
        align-items: stretch;
        z-index: 10001;
        box-shadow: 0 -2px 12px rgba(0,0,0,0.08);
      }
      
      .mobile-nav-item {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 2px;
        background: transparent;
        border: none;
        color: var(--muted);
        font-size: 11px;
        font-weight: 500;
        padding: 8px 4px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
      }
      
      .mobile-nav-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 3px;
        background: linear-gradient(135deg, var(--accent), var(--accent2));
        border-radius: 0 0 3px 3px;
        transition: width 0.2s ease;
      }
      
      .mobile-nav-item.active {
        color: var(--accent);
      }
      
      .mobile-nav-item.active::before {
        width: 24px;
      }
      
      .mobile-nav-icon {
        font-size: 24px;
        line-height: 1;
      }
      
      .mobile-nav-label {
        font-size: 10px;
        white-space: nowrap;
      }
      
      /* ===== MAIN CONTENT AREA ===== */
      .main-content {
        padding: var(--mobile-spacing-md);
        padding-top: calc(var(--mobile-spacing-md) + 8px);
      }
      
      .container {
        max-width: 100%;
        margin: 0;
      }
      
      .header {
        margin-bottom: var(--mobile-spacing-lg);
        text-align: right;
      }
      
      .header h1 {
        font-size: 24px;
        margin-bottom: var(--mobile-spacing-xs);
      }
      
      .header p {
        font-size: 14px;
      }
      
      /* ===== MOBILE EVENT CARDS REDESIGN ===== */
      .event-list {
        gap: var(--mobile-spacing-md);
      }
      
      .event-row {
        padding: var(--mobile-spacing-md);
        border-radius: var(--mobile-radius);
        flex-direction: column;
        gap: var(--mobile-spacing-md);
        box-shadow: var(--mobile-card-shadow);
        border: none;
        background: var(--card);
        position: relative;
        overflow: hidden;
      }
      
      /* Event color accent bar */
      .event-row::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: inherit;
        opacity: 0.8;
      }
      
      .event-row .color-dot {
        display: none;
      }
      
      .event-row .event-info {
        width: 100%;
        text-align: center;
        padding-bottom: var(--mobile-spacing-sm);
        border-bottom: 1px solid var(--border);
      }
      
      .event-row .event-name {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: var(--mobile-spacing-xs);
      }
      
      .event-row .event-date {
        font-size: 13px;
        color: var(--muted);
      }
      
      /* Mobile Timer Display - Big & Touch Friendly */
      .event-row .timer {
        width: 100%;
        justify-content: center;
        gap: var(--mobile-spacing-sm);
      }
      
      .event-row .time-unit {
        flex: 1;
        max-width: 80px;
        min-width: 60px;
        padding: var(--mobile-spacing-sm) var(--mobile-spacing-xs);
        border-radius: 12px;
        background: linear-gradient(145deg, var(--day-other), var(--day-hover));
      }
      
      .event-row .time-val {
        font-size: 26px;
        font-weight: 800;
        background: linear-gradient(135deg, var(--text), var(--muted));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      
      .event-row .time-label {
        font-size: 9px;
        font-weight: 600;
        letter-spacing: 0.3px;
        margin-top: 4px;
      }
      
      /* Mobile Badge */
      .event-row .badge {
        align-self: center;
        font-size: 12px;
        padding: var(--mobile-spacing-xs) var(--mobile-spacing-md);
        border-radius: 20px;
      }
      
      /* Mobile Event Actions - Swipe-like buttons */
      .event-row .event-actions {
        width: 100%;
        justify-content: center;
        gap: var(--mobile-spacing-md);
        padding-top: var(--mobile-spacing-sm);
        border-top: 1px solid var(--border);
      }
      
      .event-row .star-btn,
      .event-row .edit-btn,
      .event-row .delete-btn {
        width: var(--mobile-touch-target);
        height: var(--mobile-touch-target);
        font-size: 22px;
        border-radius: 50%;
        background: var(--day-other);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s, background 0.2s;
      }
      
      .event-row .star-btn:active,
      .event-row .edit-btn:active,
      .event-row .delete-btn:active {
        transform: scale(0.92);
      }
      
      /* ===== MOBILE INPUT PANEL ===== */
      .input-panel {
        padding: var(--mobile-spacing-md);
        border-radius: var(--mobile-radius);
        margin-bottom: var(--mobile-spacing-md);
        box-shadow: var(--mobile-card-shadow);
        border: none;
      }
      
      .input-row {
        flex-direction: column;
        gap: var(--mobile-spacing-sm);
      }
      
      .input-row input,
      .input-row .reminder-select,
      .reminder-custom input,
      .reminder-custom select {
        width: 100%;
        padding: var(--mobile-spacing-md);
        font-size: 16px; /* Prevents zoom on iOS */
        border-radius: var(--mobile-radius);
        min-height: var(--mobile-touch-target);
      }
      
      .input-row .btn,
      .input-panel .btn {
        width: 100%;
        padding: var(--mobile-spacing-md);
        min-height: var(--mobile-touch-target);
        font-size: 16px;
        font-weight: 600;
        border-radius: var(--mobile-radius);
      }
      
      .reminder-custom {
        flex-direction: column;
        gap: var(--mobile-spacing-sm);
      }
      
      /* ===== MOBILE TASK MANAGER REDESIGN ===== */
      .task-manager-overlay {
        top: 0;
        z-index: 10002;
      }
      
      .task-manager-header {
        padding: var(--mobile-spacing-md);
        gap: var(--mobile-spacing-sm);
        flex-wrap: wrap;
        position: relative;
      }
      
      .task-manager-title {
        font-size: 20px;
        flex: 1;
        order: 1;
      }
      
      #toggleTaskSidebar {
        display: inline-flex !important;
        order: 2;
        padding: var(--mobile-spacing-sm) var(--mobile-spacing-md);
        border-radius: var(--mobile-radius);
        font-size: 14px;
        height: 40px;
        background: var(--day-other);
        border: 1px solid var(--border);
        align-items: center;
        gap: 6px;
        font-weight: 500;
        transition: all 0.2s;
      }
      
      #toggleTaskSidebar:active {
        transform: scale(0.95);
      }
      
      #toggleTaskSidebar.active {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
      }
      
      .task-manager-close {
        width: var(--mobile-touch-target);
        height: var(--mobile-touch-target);
        font-size: 28px;
        order: 3;
      }
      
      .task-search-bar {
        width: 100%;
        order: 10;
        margin-top: var(--mobile-spacing-sm);
      }
      
      .task-search-bar input {
        padding: var(--mobile-spacing-md);
        font-size: 16px;
        border-radius: var(--mobile-radius);
        border: 2px solid var(--border);
      }
      
      .task-search-bar input:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
      }
      
      .task-filters {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        padding: var(--mobile-spacing-xs) 0;
        gap: var(--mobile-spacing-xs);
        scrollbar-width: none;
      }
      
      .task-filters::-webkit-scrollbar {
        display: none;
      }
      
      .filter-pill {
        padding: var(--mobile-spacing-sm) var(--mobile-spacing-md);
        font-size: 14px;
        min-height: 40px;
        white-space: nowrap;
        border-radius: 20px;
        font-weight: 500;
      }
      
      /* Task Manager Body */
      .task-manager-body {
        padding: var(--mobile-spacing-md);
        padding-top: var(--mobile-spacing-sm);
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      .task-list {
        display: flex;
        flex-direction: column;
        gap: var(--mobile-spacing-md);
        padding-bottom: var(--mobile-spacing-lg);
      }
      
      .task-group-header {
        font-size: 14px;
        padding: var(--mobile-spacing-sm) var(--mobile-spacing-xs);
        margin-top: var(--mobile-spacing-md);
        font-weight: 600;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      /* Mobile Task Sidebar - Slide-in Panel */
      .task-manager-sidebar {
        position: fixed;
        left: 0;
        top: var(--mobile-header-height);
        bottom: var(--mobile-bottom-nav-height);
        width: 280px !important;
        max-width: 85vw !important;
        z-index: 600;
        transform: translateX(-100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-right: 1px solid var(--border);
        border-left: none;
        box-shadow: 2px 0 12px rgba(0,0,0,0.15);
        background: var(--card);
      }
      
      .task-manager-sidebar.open {
        transform: translateX(0);
      }
      
      .task-manager-sidebar-header {
        padding: var(--mobile-spacing-md);
        border-bottom: 2px solid var(--border);
      }
      
      .task-manager-sidebar-header h3 {
        font-size: 16px;
      }
      
      .smart-views-list {
        display: flex;
        flex-direction: column;
        gap: 4px;
        padding: var(--mobile-spacing-sm);
      }
      
      .smart-view-item {
        padding: 12px var(--mobile-spacing-md);
        font-size: 14px;
        border-radius: 10px;
        min-height: 44px;
        display: flex;
        align-items: center;
      }
      
      .subjects-list {
        display: flex;
        flex-direction: column;
        gap: 4px;
        padding: var(--mobile-spacing-sm);
      }
      
      .subjects-list-title {
        display: block !important;
        padding: var(--mobile-spacing-md);
        font-size: 12px;
        text-transform: uppercase;
        font-weight: 600;
        color: var(--muted);
      }
      
      .subject-list-item {
        margin-bottom: 4px;
      }
      
      .subject-list-header {
        padding: 12px var(--mobile-spacing-md);
        font-size: 14px;
        border-radius: 10px;
        min-height: 44px;
      }
      
      .add-subject-sidebar-btn {
        margin: var(--mobile-spacing-sm);
        padding: 12px var(--mobile-spacing-md);
        font-size: 14px;
        border-radius: 10px;
        min-height: 44px;
      }
      
      /* Mobile Task Items */
      .task-item {
        padding: var(--mobile-spacing-md);
        border-radius: var(--mobile-radius);
        gap: var(--mobile-spacing-sm);
        flex-wrap: wrap;
        border-left-width: 4px;
        box-shadow: var(--mobile-card-shadow);
        border: none;
        border-left: 4px solid var(--task-color, var(--priority-color, var(--border)));
        background: var(--card);
        margin-bottom: var(--mobile-spacing-xs);
        position: relative;
        overflow: hidden;
      }
      
      /* Task item accent gradient */
      .task-item::before {
        opacity: 0.06;
      }
      
      .task-item:active {
        transform: scale(0.98);
        transition: transform 0.1s;
      }
      
      .task-item.completed {
        opacity: 0.65;
      }
      
      .task-item.dragging {
        opacity: 0.5;
        box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      }
      
      .task-checkbox {
        width: 28px;
        height: 28px;
        flex-shrink: 0;
        border-width: 2.5px;
      }
      
      .task-checkbox:active {
        transform: scale(0.9);
      }
      
      .task-main {
        flex: 1;
        min-width: 0;
        width: 100%;
      }
      
      .task-title {
        font-size: 16px;
        line-height: 1.5;
        font-weight: 600;
        margin-bottom: 6px;
      }
      
      .task-title-row {
        display: flex;
        align-items: flex-start;
        gap: var(--mobile-spacing-xs);
        flex-wrap: wrap;
      }
      
      .task-color-dot {
        width: 14px;
        height: 14px;
        margin-top: 3px;
      }
      
      .task-priority-badge {
        font-size: 10px;
        padding: 4px 8px;
        border-radius: 12px;
      }
      
      .task-meta {
        gap: var(--mobile-spacing-xs);
        margin-top: var(--mobile-spacing-xs);
        flex-wrap: wrap;
      }
      
      .task-due,
      .task-countdown,
      .task-recurrence,
      .task-reminder {
        font-size: 12px;
        padding: 6px 10px;
        border-radius: 8px;
        font-weight: 500;
      }
      
      .task-subtasks {
        margin-top: var(--mobile-spacing-sm);
        padding-top: var(--mobile-spacing-sm);
      }
      
      .task-subtask {
        padding: var(--mobile-spacing-xs) 0;
        font-size: 14px;
      }
      
      .task-actions {
        width: 100%;
        justify-content: flex-end;
        gap: var(--mobile-spacing-sm);
        padding-top: var(--mobile-spacing-sm);
        border-top: 1px solid var(--border);
        margin-top: var(--mobile-spacing-sm);
      }
      
      .task-action-btn {
        width: 44px;
        height: 44px;
        font-size: 20px;
        border-radius: 12px;
        background: var(--day-other);
      }
      
      .task-action-btn:active {
        transform: scale(0.92);
        background: var(--day-hover);
      }
      
      /* Quick Add Task - Mobile Optimized */
      .quick-add-task {
        margin: var(--mobile-spacing-md) var(--mobile-spacing-md) var(--mobile-spacing-lg);
        padding: var(--mobile-spacing-md);
        background: var(--card);
        border-radius: var(--mobile-radius);
        box-shadow: var(--mobile-card-shadow);
        border: 2px solid var(--border);
      }
      
      .quick-add-task input {
        padding: var(--mobile-spacing-md);
        font-size: 16px;
        border-radius: var(--mobile-radius);
        min-height: var(--mobile-touch-target);
        border: 2px solid var(--border);
      }
      
      .quick-add-task input:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
      }
      
      .nl-hint {
        font-size: 12px;
        padding: var(--mobile-spacing-sm);
        margin-top: var(--mobile-spacing-sm);
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
        border-radius: 10px;
        border: 1px solid rgba(102, 126, 234, 0.2);
      }
      
      .nl-hint-examples {
        margin-top: var(--mobile-spacing-sm);
        font-size: 11px;
      }
      
      /* ===== MOBILE SIDEBAR (CALENDAR) ===== */
      .sidebar {
        position: fixed;
        top: var(--mobile-header-height);
        left: 0;
        right: 0;
        bottom: var(--mobile-bottom-nav-height);
        width: 100% !important;
        max-width: 100% !important;
        min-width: 0 !important;
        z-index: 500;
        border: none;
        border-radius: 0;
        transform: translateX(100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      .sidebar:not(.hidden) {
        transform: translateX(0);
      }
      
      /* Task Right Sidebar (Calendar in Task Manager) */
      #taskRightSidebar {
        position: fixed;
        top: var(--mobile-header-height);
        right: 0;
        bottom: var(--mobile-bottom-nav-height);
        width: 90% !important;
        max-width: 340px !important;
        min-width: 0 !important;
        z-index: 601;
        transform: translateX(100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: -2px 0 12px rgba(0,0,0,0.15);
        border-left: 1px solid var(--border);
      }
      
      #taskRightSidebar:not(.hidden) {
        transform: translateX(0);
      }
      
      .calendar-container {
        border-radius: var(--mobile-radius);
        padding: var(--mobile-spacing-md);
        margin-bottom: var(--mobile-spacing-md);
      }
      
      .calendar-day {
        min-height: 50px;
        padding: var(--mobile-spacing-xs);
        border-radius: 10px;
      }
      
      .calendar-day-number {
        font-size: 13px;
        font-weight: 700;
      }
      
      .calendar-event-chip {
        font-size: 10px;
        padding: 3px 6px;
        border-radius: 6px;
      }
      
      /* ===== MOBILE POMODORO REDESIGN ===== */
      .pomodoro-overlay {
        top: 0;
        z-index: 10002;
      }
      
      .pomodoro-header-bar {
        padding: var(--mobile-spacing-md);
        height: auto;
        min-height: var(--mobile-header-height);
      }
      
      .pomodoro-header-title {
        font-size: 18px;
      }
      
      .pomodoro-content {
        padding: var(--mobile-spacing-md);
        padding-bottom: calc(var(--mobile-bottom-nav-height) + var(--mobile-spacing-lg));
      }
      
      .pomodoro-card {
        padding: var(--mobile-spacing-lg);
        border-radius: var(--mobile-radius-lg);
        gap: var(--mobile-spacing-lg);
      }
      
      .pomodoro-timer-wrap {
        width: 220px;
        height: 220px;
      }
      
      .pomodoro-time {
        font-size: 48px;
      }
      
      .pomodoro-controls {
        gap: var(--mobile-spacing-md);
      }
      
      .pomodoro-btn {
        width: var(--mobile-touch-target);
        height: var(--mobile-touch-target);
        font-size: 20px;
      }
      
      .pomodoro-btn.primary {
        width: 64px;
        height: 64px;
        font-size: 28px;
      }
      
      .pomodoro-presets {
        flex-wrap: wrap;
        justify-content: center;
        gap: var(--mobile-spacing-sm);
      }
      
      .pomodoro-preset {
        padding: var(--mobile-spacing-sm) var(--mobile-spacing-md);
        font-size: 13px;
        min-height: 40px;
      }
      
      /* ===== MOBILE DAILY PLANNER ===== */
      .planner-overlay {
        top: 0;
        z-index: 10002;
      }
      
      .planner-header-bar {
        padding: var(--mobile-spacing-md);
        flex-wrap: wrap;
        gap: var(--mobile-spacing-sm);
      }
      
      .planner-sidebar {
        display: none;
      }
      
      .planner-content {
        padding: var(--mobile-spacing-md);
      }
      
      .planner-day-column {
        min-width: 280px;
      }
      
      .planner-task-card {
        padding: var(--mobile-spacing-sm) var(--mobile-spacing-md);
        border-radius: 10px;
        min-height: 44px;
      }
      
      /* ===== MOBILE MODALS & DRAWERS ===== */
      .modal-backdrop {
        padding: var(--mobile-spacing-md);
        align-items: flex-end;
      }
      
      .modal-card {
        border-radius: var(--mobile-radius-lg) var(--mobile-radius-lg) 0 0;
        max-height: 90vh;
        width: 100%;
        max-width: 100%;
        margin: 0;
      }
      
      .modal-header {
        padding: var(--mobile-spacing-lg) var(--mobile-spacing-md);
      }
      
      .modal-body {
        padding: var(--mobile-spacing-md);
      }
      
      .modal-actions {
        padding: var(--mobile-spacing-md);
        flex-direction: column;
        gap: var(--mobile-spacing-sm);
      }
      
      .modal-actions .btn {
        width: 100%;
        min-height: var(--mobile-touch-target);
      }
      
      /* Day Drawer - Mobile Sheet Style */
      .day-drawer-backdrop {
        padding: 0;
        align-items: flex-end;
      }
      
      .day-drawer {
        max-width: 100%;
        width: 100%;
        border-radius: var(--mobile-radius-lg) var(--mobile-radius-lg) 0 0;
        max-height: 85vh;
      }
      
      .day-drawer-header {
        padding: var(--mobile-spacing-lg) var(--mobile-spacing-md);
      }
      
      .day-drawer-content {
        padding: var(--mobile-spacing-md);
      }
      
      /* ===== MOBILE SIDEBAR BACKDROP ===== */
      .mobile-sidebar-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 599;
        display: none;
        backdrop-filter: blur(2px);
      }
      
      .mobile-sidebar-backdrop.visible {
        display: block;
      }
      
      /* ===== MOBILE KEYBOARD SHORTCUTS - HIDE ===== */
      .shortcuts-overlay {
        display: none !important;
      }
      
      #helpShortcuts {
        display: none;
      }
      
      /* ===== MOBILE TOUCH FEEDBACK ===== */
      @media (hover: none) and (pointer: coarse) {
        .event-row:hover,
        .task-item:hover,
        .calendar-day:hover,
        .time-unit:hover {
          transform: none;
          box-shadow: var(--mobile-card-shadow);
        }
        
        .event-row:active,
        .task-item:active {
          transform: scale(0.98);
          transition: transform 0.1s;
        }
        
        button:active,
        .btn:active,
        .header-btn:active,
        .mobile-nav-item:active {
          transform: scale(0.95);
          opacity: 0.8;
        }
      }
      
      /* ===== FLOATING ACTION BUTTON ===== */
      .mobile-fab {
        position: fixed;
        bottom: calc(var(--mobile-bottom-nav-height) + var(--mobile-spacing-md) + env(safe-area-inset-bottom, 0px));
        right: var(--mobile-spacing-md);
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--accent), var(--accent2));
        color: white;
        border: none;
        font-size: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
        z-index: 1000;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      
      .mobile-fab:active {
        transform: scale(0.9);
      }
      
      /* ===== MOBILE SWIPE HINTS ===== */
      .swipe-indicator {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 40px;
        height: 4px;
        background: var(--border);
        border-radius: 2px;
        opacity: 0.5;
      }
      
      /* ===== PULL TO REFRESH INDICATOR ===== */
      .pull-refresh-indicator {
        position: fixed;
        top: var(--mobile-header-height);
        left: 50%;
        transform: translateX(-50%) translateY(-100%);
        background: var(--card);
        padding: 12px 20px;
        border-radius: 20px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: var(--muted);
        z-index: 100;
        transition: transform 0.3s;
      }
      
      .pull-refresh-indicator.visible {
        transform: translateX(-50%) translateY(12px);
      }
      
      /* ===== EMPTY STATES - MOBILE ===== */
      .empty-state {
        padding: var(--mobile-spacing-lg);
        border-radius: var(--mobile-radius);
        margin: var(--mobile-spacing-md);
      }
      
      .empty-state svg {
        width: 64px;
        height: 64px;
        margin-bottom: var(--mobile-spacing-md);
      }
      
      .empty-state p {
        font-size: 16px;
        line-height: 1.5;
      }
      
      /* No tasks message */
      .no-tasks-msg {
        text-align: center;
        padding: var(--mobile-spacing-lg);
        color: var(--muted);
        font-size: 15px;
        background: var(--day-other);
        border-radius: var(--mobile-radius);
        margin: var(--mobile-spacing-md);
        border: 2px dashed var(--border);
      }
      
      /* Task skeleton loading */
      .task-skeleton {
        padding: var(--mobile-spacing-md);
        border-radius: var(--mobile-radius);
        background: var(--day-other);
        margin-bottom: var(--mobile-spacing-sm);
        height: 100px;
        animation: shimmer 1.5s ease-in-out infinite;
      }
    }
    
    /* ===== EXTRA SMALL PHONES (320px-375px) ===== */
    @media screen and (max-width: 375px) {
      .event-row .time-unit {
        max-width: 65px;
        min-width: 50px;
        padding: 8px 4px;
      }
      
      .event-row .time-val {
        font-size: 22px;
      }
      
      .event-row .time-label {
        font-size: 8px;
      }
      
      .task-title {
        font-size: 15px;
      }
      
      .pomodoro-timer-wrap {
        width: 180px;
        height: 180px;
      }
      
      .pomodoro-time {
        font-size: 40px;
      }
    }
    
    /* ===== DARK MODE MOBILE ADJUSTMENTS ===== */
    @media screen and (max-width: 768px) {
      body.dark .event-row,
      body.dark .task-item,
      body.dark .input-panel,
      body.dark .calendar-container {
        box-shadow: 0 2px 12px rgba(0,0,0,0.3);
        border: 1px solid var(--border);
      }
      
      body.dark .mobile-bottom-nav {
        background: var(--card);
        box-shadow: 0 -2px 12px rgba(0,0,0,0.3);
      }
      
      body.dark .mobile-fab {
        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.5);
      }
    }
    
    /* ===== LANDSCAPE MOBILE ===== */
    @media screen and (max-width: 896px) and (orientation: landscape) {
      .mobile-bottom-nav {
        height: 52px;
      }
      
      .mobile-nav-label {
        display: none;
      }
      
      .mobile-nav-icon {
        font-size: 22px;
      }
      
      .pomodoro-timer-wrap {
        width: 160px;
        height: 160px;
      }
      
      .pomodoro-time {
        font-size: 36px;
      }
      
      body {
        padding-bottom: calc(52px + env(safe-area-inset-bottom, 0px));
      }
    }

  </style>
</head>
<body>
  <!-- Fixed Header Bar -->
	  <div class="fixed-header-bar">
	    <button class="header-btn active" id="toggleCountdown">â±ï¸ ×¡×¤×™×¨×” ×œ××—×•×¨</button>
	    <button class="header-btn" id="toggleTasks">ðŸ“ ×ž×©×™×ž×•×ª</button>
	    <button class="header-btn" id="togglePomodoro">ðŸ… ×¤×•×ž×•×“×•×¨×•</button>
	    <button class="header-btn" id="togglePlanner">ðŸ“… ×ž×ª×›× ×Ÿ ×™×•×ž×™</button>
	    <div class="header-spacer"></div>
	    <button class="header-btn" id="toggleSidebar">ðŸ“… ×œ×•×—</button>
	    <span class="sync-badge hidden" id="syncBadge"><span class="sync-dot"></span><span class="sync-text">Syncingâ€¦</span></span>
	    <button class="header-btn icon-only" id="calendarSyncBtn" aria-label="Sync with Calendar" title="×¡× ×›×¨×•×Ÿ ×¢× ×œ×•×— ×”×©× ×”">ðŸ”„</button>
	    <button class="header-btn icon-only" id="notifyBtn" aria-label="Enable notifications" title="Enable notifications">ðŸ””</button>
	    <button class="header-btn icon-only" id="helpShortcuts" aria-label="Keyboard shortcuts" title="×§×™×¦×•×¨×™× (H)">?</button>
	    <button class="header-btn icon-only" id="themeToggle" aria-label="Toggle dark mode">ðŸŒ™</button>
	    <button class="header-btn" id="userBtn" style="margin-left:8px; border:1px solid var(--accent); color:var(--accent);">ðŸ‘¤ Guest</button>
	  </div>

  <!-- Task Manager Fullscreen -->
  <div class="task-manager-overlay" id="taskManagerOverlay">
    <div class="task-manager-header">
      <div class="task-manager-title">ðŸ“ Task Manager</div>
        <button class="header-btn" id="toggleTaskSidebar" style="margin-right: 12px;">ðŸ“š × ×•×©××™×</button>
        <button class="task-manager-close" id="closeTaskManager" aria-label="Close task manager">Ã—</button>
      <div class="task-search-bar">
        <input type="text" id="taskSearch" placeholder="×—×™×¤×•×© ×ž×©×™×ž×•×ª... / Search tasks..." />
      </div>
      <div class="task-filters">
        <button class="filter-pill active" data-filter="all">×”×›×œ</button>
        <button class="filter-pill" data-filter="active">×¤×¢×™×œ</button>
        <button class="filter-pill" data-filter="completed">×”×•×©×œ×</button>
        <button class="header-btn" id="toggleTaskCalendar">ðŸ“… ×œ×•×—</button>
      </div>
    </div>
    
    <!-- Task Manager Layout with Sidebar -->
    <div class="task-manager-layout" style="display: flex; height: 100%; overflow: hidden; position: relative;">
      <!-- Sidebar -->
      <div class="task-manager-sidebar" id="taskSidebar" style="transition: margin-right 0.2s;">
        <div class="task-manager-sidebar-header">
          <h3>ðŸ“š × ×•×©××™×</h3>
          <button class="add-subject-btn" id="addSubjectBtn" title="×”×•×¡×£ × ×•×©×">+</button>
        </div>
        <div class="task-manager-sidebar-content">
          <!-- Smart Views -->
          <div class="smart-views-list" id="smartViewsList">
            <div class="smart-view-item" data-view="all">
              <span class="view-icon">ðŸ“‹</span>
              <span class="view-name">×›×œ ×”×ž×©×™×ž×•×ª</span>
              <span class="view-count" id="countAll">0</span>
            </div>
            <div class="smart-view-item" data-view="today">
              <span class="view-icon">ðŸ“…</span>
              <span class="view-name">×”×™×•×</span>
              <span class="view-count" id="countToday">0</span>
            </div>
            <div class="smart-view-item" data-view="week">
              <span class="view-icon">ðŸ“†</span>
              <span class="view-name">7 ×™×ž×™× ×”×‘××™×</span>
              <span class="view-count" id="countWeek">0</span>
            </div>
            <div class="smart-view-item" data-view="overdue">
              <span class="view-icon">âš ï¸</span>
              <span class="view-name">×‘××™×—×•×¨</span>
              <span class="view-count" id="countOverdue">0</span>
            </div>
            <div class="smart-view-item" data-view="nodate">
              <span class="view-icon">ðŸ“­</span>
              <span class="view-name">×œ×œ× ×ª××¨×™×š</span>
              <span class="view-count" id="countNoDate">0</span>
            </div>
          </div>
          
          <!-- Subjects List -->
          <div class="subjects-list-title">× ×•×©××™×</div>
          <div class="subjects-list" id="subjectsList"></div>
          <button class="add-subject-sidebar-btn" id="addSubjectSidebarBtn">
            <span>+</span>
            <span>×”×•×¡×£ × ×•×©×</span>
          </button>
          
          
        </div>
      </div>
      
      <!-- Main Content -->
      <div class="task-manager-body">
      <div class="quick-add-task" id="quickAddTask">
        <input type="text" id="newTaskTitle" placeholder="×”×•×¡×£ ×ž×©×™×ž×”... (×œ×“×•×’×ž×”: ×œ×”×’×™×© ×ª×¨×’×™×œ ×ž×—×¨ 23:00 #×ž×ª×ž×˜×™×§×” ×“×—×•×£)" dir="auto" />
        <div class="nl-hint">
          ðŸ’¡ <strong>×§×¦×¨×ª ×“×¨×š:</strong> ×›×ª×•×‘ ×‘×©×¤×” ×˜×‘×¢×™×ª ×•×œ×—×¥ Enter!
          <span class="nl-hint-toggle" onclick="document.getElementById('nlExamples').classList.toggle('show')">×“×•×’×ž××•×ª â–¼</span>
          <div class="nl-hint-examples" id="nlExamples">
            <div style="border-bottom: 2px solid var(--accent); padding-bottom: 12px; margin-bottom: 12px;">
              <strong style="color: var(--accent); font-size: 13px;">ðŸ“… ×ª××¨×™×›×™× ×•×©×¢×•×ª:</strong>
            </div>
            <div>
              <div class="example-input">×œ×”×’×™×© ×ª×¨×’×™×œ ×ž×—×¨ 23:59 #×ž×ª×ž×˜×™×§×” ×“×—×•×£</div>
              <div class="example-result">â†’ ×ž×—×¨ ×‘-23:59, × ×•×©×: ×ž×ª×ž×˜×™×§×”, ×¢×“×™×¤×•×ª: ×“×—×•×£</div>
            </div>
            <div>
              <div class="example-input">×¤×’×™×©×” ×¢× ×™×•×¢×¥ ×‘×™×•× ×©×œ×™×©×™ 14:30</div>
              <div class="example-result">â†’ ×™×•× ×©×œ×™×©×™ ×”×§×¨×•×‘ ×‘-14:30</div>
            </div>
            <div>
              <div class="example-input">×ž×‘×—×Ÿ ×”×™×•× 16:00 ×’×‘×•×”</div>
              <div class="example-result">â†’ ×”×™×•× ×‘-16:00, ×¢×“×™×¤×•×ª: ×’×‘×•×”</div>
            </div>
            <div>
              <div class="example-input">×¨×•×¤× ×‘-25/12 ×‘×©×¢×” 10:30</div>
              <div class="example-result">â†’ 25 ×‘×“×¦×ž×‘×¨ ×‘-10:30</div>
            </div>
            
            <div style="border-bottom: 2px solid var(--accent); padding-bottom: 12px; margin-bottom: 12px; margin-top: 16px;">
              <strong style="color: var(--accent); font-size: 13px;">ðŸ“š × ×•×©××™× (×›×•×œ×œ ×ª×ª-× ×•×©××™×):</strong>
            </div>
            <div>
              <div class="example-input">×œ×§×¨×•× ×¤×¨×§ 5 #×ž×ª×ž×˜×™×§×”/××œ×’×‘×¨×”</div>
              <div class="example-result">â†’ × ×•×©×: ×ž×ª×ž×˜×™×§×” â†’ ××œ×’×‘×¨×” (×ª×ª-× ×•×©×)</div>
            </div>
            <div>
              <div class="example-input">×¡×™×›×•× ×©×™×¢×•×¨ #"×”×™×¡×˜×•×¨×™×” ×ž×•×“×¨× ×™×ª"</div>
              <div class="example-result">â†’ × ×•×©× ×¢× ×¨×•×•×—×™× (×‘×’×¨×©×™×™×)</div>
            </div>
            <div>
              <div class="example-input">×¤×¨×•×™×™×§×˜ ×’×ž×¨ #×¢×‘×•×“×”/×¤×™×ª×•×—/frontend</div>
              <div class="example-result">â†’ ×¢×‘×•×“×” â†’ ×¤×™×ª×•×— â†’ frontend (3 ×¨×ž×•×ª!)</div>
            </div>
            <div>
              <div class="example-input">×ª×¨×’×™×œ ×‘×™×ª #×ž×“×¢×™_×”×ž×—×©×‘</div>
              <div class="example-result">â†’ × ×•×©× ×¢× ×§×• ×ª×—×ª×•×Ÿ ×‘×ž×§×•× ×¨×•×•×—</div>
            </div>
            <div>
              <div class="example-input">×ª×¨×’×™×œ #××œ×’×‘×¨×”</div>
              <div class="example-result">â†’ ×™×©×™×¨×•×ª ×œ×ª×ª-× ×•×©× ××œ×’×‘×¨×” (×‘×œ×™ ×”×•×¨×”!)</div>
            </div>
            <div>
              <div class="example-input">×¤×’×™×©×” #frontend</div>
              <div class="example-result">â†’ ×™×©×™×¨×•×ª ×œ×ª×ª-× ×•×©× frontend</div>
            </div>
            <div>
              <div class="example-input">×§× ×™×•×ª ×œ×©×‘×ª ×¤×™×–×™×§×”</div>
              <div class="example-result">â†’ ×–×™×”×•×™ ××•×˜×•×ž×˜×™ ×©×œ × ×•×©× ×‘×œ×™ # (×× ×§×™×™×)</div>
            </div>
            
            <div style="border-bottom: 2px solid var(--accent); padding-bottom: 12px; margin-bottom: 12px; margin-top: 16px;">
              <strong style="color: var(--accent); font-size: 13px;">ðŸš¨ ×¢×“×™×¤×•×™×•×ª:</strong>
            </div>
            <div>
              <div class="example-input">×œ×”×’×™×© ×¢×‘×•×“×” ×“×—×•×£ !!!</div>
              <div class="example-result">â†’ ×¢×“×™×¤×•×ª: ×“×—×•×£ (!!!, ×“×—×•×£, ×ž×™×™×“×™, urgent, asap)</div>
            </div>
            <div>
              <div class="example-input">×ž×‘×—×Ÿ ×—×©×•×‘ ×ž×—×¨ !</div>
              <div class="example-result">â†’ ×¢×“×™×¤×•×ª: ×’×‘×•×” (!, ×’×‘×•×”, ×—×©×•×‘, high, important)</div>
            </div>
            <div>
              <div class="example-input">×œ×§×¨×•× ×ž××ž×¨ × ×ž×•×š</div>
              <div class="example-result">â†’ ×¢×“×™×¤×•×ª: × ×ž×•×š (× ×ž×•×š, ×œ× ×“×—×•×£, low)</div>
            </div>
            
            <div style="border-bottom: none; padding-top: 16px; color: var(--text); background: var(--day-other); padding: 12px; border-radius: 8px; margin-top: 12px;">
              <strong style="display: block; margin-bottom: 8px; color: var(--accent);">ðŸ“– ×ž×™×œ×•×ª ×ž×¤×ª×—:</strong>
              <div style="line-height: 1.8; font-size: 11px;">
                <div><strong>ðŸ“… ×ª××¨×™×›×™×:</strong> ×”×™×•×, ×ž×—×¨, ×ž×—×¨×ª×™×™×, ×‘×¢×•×“ X ×™×ž×™×, ×”×©×‘×•×¢, ×‘×©×‘×•×¢ ×”×‘×, ×‘×™×•× ×¨××©×•×Ÿ/×©× ×™/..., DD/MM</div>
                <div><strong>â° ×©×¢×•×ª:</strong> 14:30, ×‘×©×¢×” 9:00, ×‘-23:59, 2:30 PM</div>
                <div><strong>ðŸ·ï¸ × ×•×©××™×:</strong> #× ×•×©×, #× ×•×©×_×¢×_×§×•_×ª×—×ª×•×Ÿ, #"× ×•×©× ×¢× ×¨×•×•×—×™×", #×”×•×¨×”/×™×œ×“, #×”×•×¨×”/×™×œ×“/× ×›×“</div>
                <div><strong>ðŸš¨ ×¢×“×™×¤×•×ª:</strong> ×“×—×•×£ (!!!), ×’×‘×•×” (!), ×‘×™× ×•× ×™, × ×ž×•×š</div>
              </div>
            </div>
            
            <div style="padding-top: 12px; color: var(--muted); font-size: 11px; text-align: center;">
              <strong>ðŸ’¡ ×˜×™×¤:</strong> ××¤×©×¨ ×œ×©×œ×‘ ×”×›×œ! ×œ×“×•×’×ž×”: "×œ×”×’×™×© ×¤×¨×•×™×§×˜ ×ž×—×¨ 23:59 #×¢×‘×•×“×”/×¤×™×ª×•×— ×“×—×•×£ !!"
            </div>
          </div>
        </div>
        <div class="quick-add-row" id="quickAddRow" style="display: none;">
          <div class="priority-selector" id="taskPriorityPicker">
            <div class="priority-option" data-priority="urgent">ðŸ”´ ×“×—×•×£</div>
            <div class="priority-option" data-priority="high">ðŸŸ  ×’×‘×•×”</div>
            <div class="priority-option selected" data-priority="medium">ðŸŸ¡ ×‘×™× ×•× ×™</div>
            <div class="priority-option" data-priority="low">ðŸŸ¢ × ×ž×•×š</div>
            <div class="priority-option" data-priority="none">âšª ×œ×œ×</div>
          </div>
          <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap; width: 100%;">
            <div class="label-input-wrapper" style="flex-shrink: 0;">
              <span>ðŸ“</span>
              <select id="newTaskSubject" style="border: none; background: transparent; color: var(--text); font-size: 13px; outline: none; cursor: pointer;">
                <option value="">×œ×œ× × ×•×©×</option>
              </select>
            </div>
            <div class="label-input-wrapper">
              <span>ðŸ“…</span>
              <input type="datetime-local" id="newTaskDue" style="width: 180px; border: none; background: transparent; color: var(--text);" />
            </div>
            <div class="label-input-wrapper">
              <span>â±ï¸</span>
              <select id="newTaskDuration" style="border: none; background: transparent; color: var(--text); font-size: 13px; outline: none; cursor: pointer;">
                <option value="0">×œ×œ× ×ž×©×š</option>
                <option value="15">15 ×“×§×³</option>
                <option value="30">30 ×“×§×³</option>
                <option value="45">45 ×“×§×³</option>
                <option value="60">×©×¢×”</option>
                <option value="90">1.5 ×©×¢×•×ª</option>
                <option value="120">×©×¢×ª×™×™×</option>
                <option value="180">3 ×©×¢×•×ª</option>
              </select>
            </div>
            <div class="label-input-wrapper">
              <span style="font-size: 11px; font-weight: 600;">×—×•×–×¨</span>
              <select id="newTaskRecurrence" style="border: none; background: transparent; color: var(--text); font-size: 13px; outline: none; cursor: pointer;">
                <option value="none">×œ×œ× ×—×–×¨×”</option>
                <option value="daily">×™×•×ž×™</option>
                <option value="weekly">×©×‘×•×¢×™</option>
                <option value="monthly">×—×•×“×©×™</option>
              </select>
            </div>
            <div class="label-input-wrapper">
              <span>ðŸ””</span>
              <select id="newTaskReminder" style="border: none; background: transparent; color: var(--text); font-size: 13px; outline: none; cursor: pointer;">
                <option value="0">×œ×œ× ×ª×–×›×•×¨×ª</option>
                <option value="1">×“×§×” ×œ×¤× ×™</option>
                <option value="5">5 ×“×§×•×ª ×œ×¤× ×™</option>
                <option value="15">15 ×“×§×•×ª ×œ×¤× ×™</option>
                <option value="30">30 ×“×§×•×ª ×œ×¤× ×™</option>
                <option value="60">×©×¢×” ×œ×¤× ×™</option>
                <option value="1440">×™×•× ×œ×¤× ×™</option>
                <option value="custom">âš™ï¸ ×ž×•×ª×× ××™×©×™×ª...</option>
              </select>
              <div class="task-reminder-custom hidden" id="newTaskReminderCustomWrap">
                <input type="number" id="newTaskReminderCustomValue" min="1" step="1" style="width: 60px; padding: 4px 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; background: var(--input-bg); color: var(--text);" placeholder="#" />
                <select id="newTaskReminderCustomUnit" style="padding: 4px 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; background: var(--input-bg); color: var(--text);">
                  <option value="minutes">×“×§×•×ª</option>
                  <option value="hours">×©×¢×•×ª</option>
                  <option value="days">×™×ž×™×</option>
                </select>
              </div>
            </div>
            <div class="label-input-wrapper">
              <span>ðŸŽ¨</span>
              <div class="task-color-picker compact" id="quickTaskColorPicker">
                <div class="task-color-option none selected" data-color="" title="×œ×œ× ×¦×‘×¢">â€“</div>
                <div class="task-color-option subject disabled" data-color="subject" title="×¦×‘×¢ × ×•×©×">S</div>
                <div class="task-color-option" data-color="#667eea" style="background: #667eea;" title="×¡×’×•×œ"></div>
                <div class="task-color-option" data-color="#ef4444" style="background: #ef4444;" title="××“×•×"></div>
                <div class="task-color-option" data-color="#f97316" style="background: #f97316;" title="×›×ª×•×"></div>
                <div class="task-color-option" data-color="#eab308" style="background: #eab308;" title="×¦×”×•×‘"></div>
                <div class="task-color-option" data-color="#22c55e" style="background: #22c55e;" title="×™×¨×•×§"></div>
                <div class="task-color-option" data-color="#06b6d4" style="background: #06b6d4;" title="×¦×™××Ÿ"></div>
                <div class="task-color-option" data-color="#8b5cf6" style="background: #8b5cf6;" title="×¡×’×•×œ ×›×”×”"></div>
              </div>
            </div>
            <button class="btn btn-primary" id="addTaskBtn">×”×•×¡×£</button>
          </div>
        </div>
      </div>
      
      <div class="task-sections" id="taskSections">
        <!-- Active Tasks -->
        <div id="activeSection">
          <div class="task-section-title">ðŸ“‹ ×ž×©×™×ž×•×ª ×¤×¢×™×œ×•×ª</div>
          <div class="task-list" id="activeTasks"></div>
        </div>
        
        <!-- Completed Tasks -->
        <div id="completedSection" style="display: none;">
          <div class="task-section-title">âœ… ×”×•×©×œ×ž×•</div>
          <div class="task-list" id="completedTasks"></div>
        </div>
        
        <!-- Empty State -->
        <div class="tasks-empty" id="tasksEmpty" style="display: none;">
          <div class="tasks-empty-icon">ðŸ“</div>
          <h3>××™×Ÿ ×ž×©×™×ž×•×ª ×¢×“×™×™×Ÿ</h3>
          <p>×”×•×¡×£ ×ž×©×™×ž×” ×¨××©×•× ×” ×œ×ž×¢×œ×” ×›×“×™ ×œ×”×ª×—×™×œ!</p>
        </div>
      </div>
    </div>
      
      <!-- Right Sidebar for Task Calendar -->
      <aside class="sidebar hidden" id="taskRightSidebar">
        <div class="calendar-container">
          <div class="calendar-header">
            <div class="calendar-nav">
              <button id="prevTaskMonth">â€¹</button>
              <button id="todayTaskBtn">â—</button>
              <button id="nextTaskMonth">â€º</button>
              <button id="toggleTaskCalendarSize" title="×”×’×“×œ/×”×§×˜×Ÿ" aria-label="×”×’×“×œ/×”×§×˜×Ÿ">â¤¢</button>
            </div>
            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
              <div class="calendar-title" id="taskCalendarTitle"></div>
              <div class="calendar-view-toggle" id="taskCalendarViewToggle" aria-label="Calendar view">
                <button data-view="month" class="active">×—×•×“×©</button>
                <button data-view="week">×©×‘×•×¢</button>
                <button data-view="day">×™×•×</button>
              </div>
            </div>
          </div>
          <div class="calendar-grid" id="taskCalendarGrid"></div>
        </div>
        
        <div class="sidebar-section">
          <div class="sidebar-section-title" id="taskMonthEventsTitle">×ž×©×™×ž×•×ª ×”×—×•×“×©</div>
          <div class="month-events" id="taskMonthEvents">
            <div class="no-events-msg">××™×Ÿ ×ž×©×™×ž×•×ª ×”×—×•×“×©</div>
          </div>
        </div>
      </aside>
    </div><!-- close task-manager-layout -->
  </div>
  
  <!-- Task Edit Modal -->
  <div class="task-edit-modal" id="taskEditModal">
    <div class="task-edit-card" id="taskEditCard">
      <input type="text" id="editTaskTitle" placeholder="Task title..." />
      <textarea id="editTaskContent" placeholder="Add notes..."></textarea>
      
      <div class="task-edit-section">
        <div class="task-edit-section-title">Subject</div>
        <select id="editTaskSubject" style="padding: 12px 14px; border: 2px solid var(--border); border-radius: 10px; font-size: 14px; background: var(--input-bg); color: var(--text); outline: none; width: 100%; max-width: 250px; cursor: pointer;">
          <option value="">No Subject</option>
        </select>
      </div>
      
      <div class="task-edit-section">
        <div class="task-edit-section-title">Priority</div>
        <div class="priority-selector" id="editTaskPriority">
          <div class="priority-option" data-priority="urgent">ðŸ”´ Urgent</div>
          <div class="priority-option" data-priority="high">ðŸŸ  High</div>
          <div class="priority-option" data-priority="medium">ðŸŸ¡ Medium</div>
          <div class="priority-option" data-priority="low">ðŸŸ¢ Low</div>
          <div class="priority-option" data-priority="none">âšª None</div>
        </div>
      </div>

      <div class="task-edit-section">
        <div class="task-edit-section-title">Color <span style="font-weight: 400; color: var(--muted); font-size: 12px;">(××•×¤×¦×™×•× ×œ×™)</span></div>
        <div class="task-color-picker" id="taskColorPicker">
          <div class="task-color-option none selected" data-color="" title="×œ×œ× ×¦×‘×¢ - ×¨×§ ×¢×“×™×¤×•×ª">â€“</div>
          <div class="task-color-option subject disabled" data-color="subject" title="×¦×‘×¢ × ×•×©×">S</div>
          <div class="task-color-option" data-color="#667eea" style="background: #667eea;" title="×¡×’×•×œ"></div>
          <div class="task-color-option" data-color="#ef4444" style="background: #ef4444;" title="××“×•×"></div>
          <div class="task-color-option" data-color="#f97316" style="background: #f97316;" title="×›×ª×•×"></div>
          <div class="task-color-option" data-color="#eab308" style="background: #eab308;" title="×¦×”×•×‘"></div>
          <div class="task-color-option" data-color="#22c55e" style="background: #22c55e;" title="×™×¨×•×§"></div>
          <div class="task-color-option" data-color="#06b6d4" style="background: #06b6d4;" title="×¦×™××Ÿ"></div>
          <div class="task-color-option" data-color="#8b5cf6" style="background: #8b5cf6;" title="×¡×’×•×œ ×›×”×”"></div>
          <div class="task-color-option" data-color="#ec4899" style="background: #ec4899;" title="×•×¨×•×“"></div>
        </div>
      </div>
      
      <div class="task-edit-section">
        <div class="task-edit-section-title">Due Date</div>
        <input type="datetime-local" id="editTaskDue" style="padding: 12px 14px; border: 2px solid var(--border); border-radius: 10px; font-size: 14px; background: var(--input-bg); color: var(--text); outline: none; width: 100%; max-width: 250px;" />
        <button class="btn" id="clearDueBtn" style="margin-left: 8px; padding: 10px 14px; background: var(--day-other); color: var(--muted);">Clear</button>
      </div>

      <div class="task-edit-section">
        <div class="task-edit-section-title">Recurrence</div>
        <select id="editTaskRecurrence" style="padding: 12px 14px; border: 2px solid var(--border); border-radius: 10px; font-size: 14px; background: var(--input-bg); color: var(--text); outline: none; width: 100%; max-width: 250px; cursor: pointer;">
          <option value="none">×œ×œ× ×—×–×¨×”</option>
          <option value="daily">×™×•×ž×™</option>
          <option value="weekly">×©×‘×•×¢×™</option>
          <option value="monthly">×—×•×“×©×™</option>
        </select>
      </div>

      <div class="task-edit-section">
        <div class="task-edit-section-title">Reminder</div>
        <div class="quick-reminder-btns" style="display: flex; gap: 8px; margin-bottom: 10px;">
          <button type="button" class="quick-reminder-btn" data-minutes="1" style="padding: 6px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--btn-secondary-bg); color: var(--text); font-size: 12px; cursor: pointer;">1 ×“×§×”</button>
          <button type="button" class="quick-reminder-btn" data-minutes="5" style="padding: 6px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--btn-secondary-bg); color: var(--text); font-size: 12px; cursor: pointer;">5 ×“×§×•×ª</button>
          <button type="button" class="quick-reminder-btn" data-minutes="15" style="padding: 6px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--btn-secondary-bg); color: var(--text); font-size: 12px; cursor: pointer;">15 ×“×§×•×ª</button>
          <button type="button" class="quick-reminder-btn" data-minutes="60" style="padding: 6px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--btn-secondary-bg); color: var(--text); font-size: 12px; cursor: pointer;">×©×¢×”</button>
        </div>
        <select id="editTaskReminder" style="padding: 12px 14px; border: 2px solid var(--border); border-radius: 10px; font-size: 14px; background: var(--input-bg); color: var(--text); outline: none; width: 100%; max-width: 250px; cursor: pointer;">
          <option value="0">ðŸ”• ×œ×œ× ×ª×–×›×•×¨×ª</option>
          <option value="1">ðŸ”” ×“×§×” ×œ×¤× ×™</option>
          <option value="5">ðŸ”” 5 ×“×§×•×ª ×œ×¤× ×™</option>
          <option value="15">ðŸ”” 15 ×“×§×•×ª ×œ×¤× ×™</option>
          <option value="30">ðŸ”” 30 ×“×§×•×ª ×œ×¤× ×™</option>
          <option value="60">ðŸ”” ×©×¢×” ×œ×¤× ×™</option>
          <option value="1440">ðŸ”” ×™×•× ×œ×¤× ×™</option>
          <option value="custom">âš™ï¸ ×ž×•×ª×× ××™×©×™×ª...</option>
        </select>
        <div class="task-reminder-custom hidden" id="editTaskReminderCustomWrap" style="display: flex; gap: 8px; margin-top: 10px;">
          <input type="number" id="editTaskReminderCustomValue" min="1" step="1" style="width: 80px; padding: 10px 12px; border: 2px solid var(--border); border-radius: 10px; font-size: 14px; background: var(--input-bg); color: var(--text);" placeholder="×ž×¡×¤×¨" />
          <select id="editTaskReminderCustomUnit" style="padding: 10px 12px; border: 2px solid var(--border); border-radius: 10px; font-size: 14px; background: var(--input-bg); color: var(--text);">
            <option value="minutes">×“×§×•×ª</option>
            <option value="hours">×©×¢×•×ª</option>
            <option value="days">×™×ž×™×</option>
          </select>
        </div>
      </div>
      
      <div class="task-edit-section">
        <div class="task-edit-section-title">
          Subtasks / Checklist
          <button class="btn" id="aiBreakDownBtn" style="margin-right: auto; padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; display: inline-flex; align-items: center; gap: 6px;" title="×”×©×ª×ž×© ×‘-AI ×œ×¤×¨×§ ××ª ×”×ž×©×™×ž×” ×œ×ª×ª-×ž×©×™×ž×•×ª">
            âœ¨ AI Break Down
          </button>
        </div>
        <div class="task-checklist" id="editTaskChecklist"></div>
        <div class="checklist-add">
          <input type="text" id="newChecklistItem" placeholder="Add subtask..." />
          <button class="btn btn-primary" id="addChecklistItem" style="padding: 10px 16px;" aria-label="×”×•×¡×£ ×¤×¨×™×˜">+</button>
        </div>
      </div>
      
      <div class="task-edit-footer">
        <div style="display: flex; gap: 8px;">
          <button class="task-action-btn" id="duplicateTaskBtn" title="Duplicate" aria-label="×©×›×¤×œ ×ž×©×™×ž×”">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
          </button>
          <button class="task-action-btn delete" id="deleteTaskBtn" title="Delete" aria-label="×ž×—×§ ×ž×©×™×ž×”">ðŸ—‘ï¸</button>
        </div>
        <button class="btn btn-primary" id="saveTaskBtn">Save</button>
      </div>
    </div>
  </div>

  <!-- Pomodoro Overlay -->
  <div class="pomodoro-overlay" id="pomodoroOverlay">
    <div class="pomodoro-header-bar">
      <div class="pomodoro-header-title">ðŸ… ×˜×™×™×ž×¨ ×¤×•×ž×•×“×•×¨×•</div>
      <label class="pomodoro-option" style="margin: 0; background: transparent;">
        <input type="checkbox" id="pomodoroMiniToggle" />
        <span style="font-size: 13px;">×”×¦×’ ×ž×™× ×™-×˜×™×™×ž×¨</span>
      </label>
    </div>
    
    <div class="pomodoro-content">
      <div class="pomodoro-container">
        <div class="pomodoro-card" id="pomodoroCard">
          
          <!-- Timer Circle -->
          <div class="pomodoro-timer-wrap">
            <div class="pomodoro-timer-ring" id="pomodoroRing" style="--progress: 0%;"></div>
            <div class="pomodoro-timer">
              <div class="pomodoro-time" id="pomodoroDisplay">25:00</div>
              <div class="pomodoro-mode">
                <span class="pomodoro-mode-dot"></span>
                <span id="pomodoroMode">×ž×™×§×•×“</span>
              </div>
              <div class="pomodoro-next" id="pomodoroNext">×”×‘×: ×”×¤×¡×§×” ×§×¦×¨×”</div>
            </div>
          </div>

          <!-- Controls -->
          <div class="pomodoro-controls">
            <button class="pomodoro-btn" id="pomodoroReset" title="××™×¤×•×¡">ðŸ”„</button>
            <button class="pomodoro-btn primary" id="pomodoroStart" title="×”×ª×—×œ">â–¶ï¸</button>
            <button class="pomodoro-btn" id="pomodoroSkip" title="×“×œ×’">â­ï¸</button>
          </div>

          <div id="pomodoroProgress" style="display:none;"></div>

          <!-- Presets -->
          <div class="pomodoro-presets">
            <button class="pomodoro-preset" data-preset="classic">25/5 ×§×œ××¡×™</button>
            <button class="pomodoro-preset" data-preset="flow">50/10 ×–×¨×™×ž×”</button>
            <button class="pomodoro-preset" data-preset="ultradian">90/20 ××•×œ×˜×¨×”</button>
            <button class="pomodoro-preset" data-preset="perfect">52/17 ×§×¦×‘ ×™×¢×™×œ</button>
            <button class="pomodoro-preset bad-day" data-preset="badday10">ðŸ˜” 10 ×“×§×³</button>
            <button class="pomodoro-preset bad-day" data-preset="badday5">ðŸ’« 5 ×“×§×³</button>
            <button class="pomodoro-preset" data-preset="custom">âš™ï¸ ×ž×•×ª×× ××™×©×™×ª</button>
          </div>
          
          <!-- Bad Day Tip -->
          <div class="pomodoro-bad-day-tip" id="pomodoroBadDayTip" style="display: none;">
            <span class="tip-icon">ðŸ’¡</span>
            <span class="tip-text">×™×•× ×ž××ª×’×¨? ×–×” ×‘×¡×“×¨. ×’× 5-10 ×“×§×•×ª ×ž×™×§×•×“ ×¢×•×–×¨×•×ª ×œ×©×ž×•×¨ ×¢×œ ×ž×•×ž× ×˜×•× ×•×œ×”×¤×—×™×ª ×¡×˜×¨×¡.</span>
          </div>

          <!-- Settings Panel -->
          <div class="pomodoro-settings-panel">
            <div class="pomodoro-field">
              <label>×–×ž×Ÿ ×ž×™×§×•×“</label>
              <input type="number" min="5" max="240" id="pomodoroFocus" value="25" />
            </div>
            <div class="pomodoro-field">
              <label>×”×¤×¡×§×” ×§×¦×¨×”</label>
              <input type="number" min="3" max="60" id="pomodoroBreak" value="5" />
            </div>
            <div class="pomodoro-field">
              <label>×”×¤×¡×§×” ××¨×•×›×”</label>
              <input type="number" min="5" max="90" id="pomodoroLong" value="15" />
            </div>
            <div class="pomodoro-field">
              <label>×”×¤×¡×§×” ××¨×•×›×” ×›×œ ×›×ž×” ×ž×—×–×•×¨×™×</label>
              <input type="number" min="1" max="8" id="pomodoroLongEvery" value="4" />
            </div>
          </div>

          <!-- Options -->
          <div class="pomodoro-options">
            <label class="pomodoro-option">
              <input type="checkbox" id="pomodoroAutoContinue" />
              <span>×ž×¢×‘×¨ ××•×˜×•×ž×˜×™ ×‘×™×Ÿ ×ž×¦×‘×™×</span>
            </label>
            <label class="pomodoro-option">
              <input type="checkbox" id="pomodoroSoundEnabled" checked />
              <span>ðŸ”” ×¦×œ×™×œ ×”×ª×¨××”</span>
            </label>
            <select class="pomodoro-sound-select" id="pomodoroSound">
              <option value="chime">ðŸŽµ ×¦×œ×¦×•×œ ×¢×“×™×Ÿ</option>
              <option value="soft">ðŸ§˜ ×ž×“×™×˜×¦×™×”</option>
              <option value="bell">ðŸ”” ×¤×¢×ž×•×Ÿ</option>
              <option value="digital">ðŸ“± ×“×™×’×™×˜×œ×™</option>
              <option value="glass">âœ¨ ×§×¨×™×¡×˜×œ</option>
              <option value="success">ðŸŽ‰ ×¤× ×¤×¨×”</option>
            </select>
            <button class="pomodoro-preview-btn" id="pomodoroPreviewSound">â–¶ï¸ ×”××–×Ÿ</button>
          </div>

          <!-- Task Select -->
          <select class="pomodoro-task-select" id="pomodoroTaskSelect">
            <option value="">ðŸ“‹ ×‘×—×¨ ×ž×©×™×ž×ª ×ž×™×§×•×“ (×œ× ×—×•×‘×”)</option>
          </select>

          <!-- Stats -->
          <div class="pomodoro-stats">
            <div class="pomodoro-stat">
              <div class="label">×ž×—×–×•×¨×™×</div>
              <div class="value" id="pomodoroSessionCount">0</div>
            </div>
            <div class="pomodoro-stat">
              <div class="label">×“×§×•×ª ×ž×™×§×•×“</div>
              <div class="value" id="pomodoroFocusMinutes">0</div>
            </div>
            <div class="pomodoro-stat">
              <div class="label">×¨×¦×£ ×™×ž×™ ×ž×™×§×•×“</div>
              <div class="value" id="pomodoroStreak">0</div>
            </div>
          </div>

          <!-- Daily Progress -->
          <div class="pomodoro-daily">
            <div class="pomodoro-daily-bar">
              <div class="pomodoro-daily-fill" id="pomodoroDayProgress"></div>
            </div>
            <div class="pomodoro-daily-label" id="pomodoroDayLabel">0/8 ×ž×—×–×•×¨×™ ×ž×™×§×•×“ ×”×™×•×</div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Pomodoro Mini Player -->
  <div class="pomodoro-mini" id="pomodoroMini">
    <div>
      <div class="pomodoro-mini-time" id="pomodoroMiniTime">25:00</div>
      <div class="pomodoro-mini-mode" id="pomodoroMiniMode">×ž×™×§×•×“</div>
    </div>
    <button class="pomodoro-mini-close" id="pomodoroMiniClose" aria-label="×¡×’×•×¨">Ã—</button>
  </div>

  <!-- ============== DAILY PLANNER ============== -->
  <div class="planner-overlay" id="plannerOverlay">
    <div class="planner-header-bar">
      <div class="planner-header-title">ðŸ“… ×ž×ª×›× ×Ÿ ×™×•×ž×™</div>
      
      <div class="planner-date-nav">
        <button id="plannerPrevDay">â€¹</button>
        <span class="planner-current-date" id="plannerCurrentDate">×™×•× ×¨××©×•×Ÿ, 1 ×‘×™× ×•××¨ 2026</span>
        <button id="plannerNextDay">â€º</button>
      </div>
      
      <button class="planner-today-btn" id="plannerTodayBtn">ðŸ“ ×”×™×•×</button>
      
      <button class="btn" id="aiAutoScheduleBtn" style="padding: 8px 14px; font-size: 13px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; display: inline-flex; align-items: center; gap: 6px; margin: 0 8px;" title="×ª×–×ž×•×Ÿ ××•×˜×•×ž×˜×™ ×©×œ ×ž×©×™×ž×•×ª ×‘××ž×¦×¢×•×ª AI">
        âœ¨ Auto-Schedule
      </button>

      <button class="btn" id="aiPlanDayBtn" style="padding: 8px 14px; font-size: 13px; background: linear-gradient(135deg, #1e3a8a, #2563eb); color: white; border: none; display: inline-flex; align-items: center; gap: 6px; margin: 0 8px;" title="×ª×›× ×•×Ÿ ×™×•× ×ž×œ× ×‘××ž×¦×¢×•×ª AI (×ž×ž×§× ×ž×©×™×ž×•×ª ×•×œ×•×—×•×ª ×–×ž× ×™×)">
        ðŸ§  Plan Day
      </button>
      
      <button class="btn" id="aiSuggestionsBtn" style="padding: 8px 14px; font-size: 13px; background: linear-gradient(135deg, #f59e0b, #ec4899); color: white; border: none; display: inline-flex; align-items: center; gap: 6px;" title="×§×‘×œ ×”×¦×¢×•×ª AI ×œ×¢×“×™×¤×•×ª ×ž×©×™×ž×•×ª">
        ðŸ¤– AI Suggestions
      </button>
      
      <button class="btn" id="aiChatBtn" style="padding: 8px 14px; font-size: 13px; background: linear-gradient(135deg, #8b5cf6, #ec4899); color: white; border: none; display: inline-flex; align-items: center; gap: 6px;" title="×¦'××˜ ×¢× AI ×œ× ×™×”×•×œ ×ž×©×™×ž×•×ª">
        ðŸ’¬ AI Chat
      </button>
      
      <div class="planner-view-toggle">
        <button class="active" data-view="day">ðŸ“‹ ×™×•×</button>
        <button data-view="week">ðŸ“† ×©×‘×•×¢</button>
      </div>
    </div>
    
    <div class="planner-stats-bar">
      <div class="planner-stat">
        <div class="planner-stat-icon">ðŸ“</div>
        <div class="planner-stat-info">
          <div class="planner-stat-value" id="plannerTotalBlocks">0</div>
          <div class="planner-stat-label">×¤×¢×™×œ×•×™×•×ª</div>
        </div>
      </div>
      <div class="planner-stat">
        <div class="planner-stat-icon">â±ï¸</div>
        <div class="planner-stat-info">
          <div class="planner-stat-value" id="plannerTotalHours">0 ×©×¢×•×ª</div>
          <div class="planner-stat-label">×–×ž×Ÿ ×ž×ª×•×›× ×Ÿ</div>
        </div>
      </div>
      <div class="planner-stat">
        <div class="planner-stat-icon">âœ…</div>
        <div class="planner-stat-info">
          <div class="planner-stat-value" id="plannerCompletedBlocks">0</div>
          <div class="planner-stat-label">×”×•×©×œ×ž×•</div>
        </div>
      </div>
      <div class="planner-stat">
        <div class="planner-stat-icon">ðŸŽ¯</div>
        <div class="planner-stat-info">
          <div class="planner-stat-value" id="plannerProgress">0%</div>
          <div class="planner-stat-label">×”×ª×§×“×ž×•×ª</div>
        </div>
      </div>
    </div>
    
    <div class="planner-main">
      <!-- Main Content -->
      <div class="planner-content" id="plannerContent">
        <!-- Day View -->
        <div class="planner-day-view" id="plannerDayView">
          <div class="planner-day-header">
            <div class="planner-day-title" id="plannerDayTitle">×”×™×•× - ×™×•× ×¨××©×•×Ÿ</div>
            <div class="planner-day-summary">
              <span id="plannerDaySummary">0 ×¤×¢×™×œ×•×™×•×ª â€¢ 0 ×©×¢×•×ª</span>
            </div>
          </div>
          <div class="planner-timeline" id="plannerTimeline">
            <!-- Hours will be generated by JS -->
          </div>
        </div>
        
        <!-- Week View (hidden by default) -->
        <div class="planner-week-view" id="plannerWeekView" style="display: none;">
          <!-- Week days will be generated by JS -->
        </div>
      </div>
      
      <!-- Sidebar -->
      <div class="planner-sidebar" id="plannerSidebar">
        <!-- Sync All Button -->
        <div style="padding: 16px 16px 0 16px;">
          <button class="planner-sync-all-btn" id="plannerSyncAllBtn">
            <span>ðŸ”„</span>
            <span>×¡× ×›×¨×Ÿ ×”×›×œ ×œ×™×•× ×”× ×•×›×—×™</span>
          </button>
        </div>
        
        <!-- Mini Calendar -->
        <div class="planner-sidebar-section">
          <div class="planner-sidebar-title">ðŸ“… ×œ×•×— ×©× ×”</div>
          <div class="planner-mini-calendar" id="plannerMiniCalendar">
            <div class="planner-mini-header">
              <button class="planner-mini-nav-btn" id="plannerMiniPrev">â€¹</button>
              <span class="planner-mini-title" id="plannerMiniTitle">×™× ×•××¨ 2026</span>
              <button class="planner-mini-nav-btn" id="plannerMiniNext">â€º</button>
            </div>
            <div class="planner-mini-grid" id="plannerMiniGrid">
              <!-- Mini calendar grid will be generated by JS -->
            </div>
          </div>
        </div>
        
        <!-- Countdowns Section -->
        <div class="planner-sidebar-section">
          <div class="planner-sync-header">
            <div class="planner-sidebar-title planner-section-collapse" id="plannerCountdownsToggle">
              <span class="collapse-icon">â–¼</span> â° ×¡×¤×™×¨×•×ª ×œ××—×•×¨
            </div>
            <button class="planner-sync-btn" id="plannerSyncCountdownsBtn">
              <span>â†“</span> ×¡× ×›×¨×Ÿ
            </button>
          </div>
          <div class="planner-section-content" id="plannerCountdownsList">
            <div class="no-events-msg">××™×Ÿ ×¡×¤×™×¨×•×ª ×œ××—×•×¨ ×œ×”×™×•×</div>
          </div>
        </div>
        
        <!-- Scheduled Tasks Section -->
        <div class="planner-sidebar-section">
          <div class="planner-sync-header">
            <div class="planner-sidebar-title planner-section-collapse" id="plannerScheduledTasksToggle">
              <span class="collapse-icon">â–¼</span> âœ… ×ž×©×™×ž×•×ª ×ž×ª×•×–×ž× ×•×ª
            </div>
            <button class="planner-sync-btn" id="plannerSyncTasksBtn">
              <span>â†“</span> ×¡× ×›×¨×Ÿ
            </button>
          </div>
          <div class="planner-section-content" id="plannerScheduledTasksList">
            <div class="no-events-msg">××™×Ÿ ×ž×©×™×ž×•×ª ×ž×ª×•×–×ž× ×•×ª ×œ×”×™×•×</div>
          </div>
        </div>
        
        <!-- Quick Templates -->
        <div class="planner-sidebar-section">
          <div class="planner-sidebar-title">âš¡ ×ª×‘× ×™×•×ª ×ž×”×™×¨×•×ª</div>
          <button class="planner-template-btn" data-template="morning">
            <span class="planner-template-icon">ðŸŒ…</span>
            <span>×©×’×¨×ª ×‘×•×§×¨</span>
          </button>
          <button class="planner-template-btn" data-template="work">
            <span class="planner-template-icon">ðŸ’¼</span>
            <span>×™×•× ×¢×‘×•×“×”</span>
          </button>
          <button class="planner-template-btn" data-template="study">
            <span class="planner-template-icon">ðŸ“š</span>
            <span>×™×•× ×œ×™×ž×•×“×™×</span>
          </button>
          <button class="planner-template-btn" data-template="relax">
            <span class="planner-template-icon">ðŸ§˜</span>
            <span>×™×•× ×ž× ×•×—×”</span>
          </button>
        </div>
        
        <!-- Unscheduled Tasks -->
        <div class="planner-sidebar-section" style="flex: 1; display: flex; flex-direction: column;">
          <div class="planner-sidebar-title">ðŸ“‹ ×ž×©×™×ž×•×ª ×œ×ª×–×ž×•×Ÿ</div>
          <div class="planner-quick-tasks" id="plannerQuickTasks">
            <!-- Tasks will be populated by JS -->
            <div class="no-events-msg" id="plannerNoTasks">××™×Ÿ ×ž×©×™×ž×•×ª ×œ×œ× ×ª×–×ž×•×Ÿ</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Planner Add/Edit Block Modal -->
  <div class="planner-add-modal" id="plannerAddModal">
    <div class="planner-add-card">
      <div class="planner-add-title" id="plannerModalTitle">âž• ×”×•×¡×£ ×¤×¢×™×œ×•×ª</div>
      
      <div class="planner-add-field">
        <label class="planner-add-label">×©× ×”×¤×¢×™×œ×•×ª *</label>
        <input type="text" class="planner-add-input" id="plannerBlockTitle" placeholder="×ž×” ××ª×” ×ž×ª×›× ×Ÿ ×œ×¢×©×•×ª?" dir="auto" />
      </div>
      
      <div class="planner-add-row">
        <div class="planner-add-field">
          <label class="planner-add-label">×©×¢×ª ×”×ª×—×œ×”</label>
          <input type="time" class="planner-add-input" id="plannerBlockStart" style="direction: ltr;" />
        </div>
        <div class="planner-add-field">
          <label class="planner-add-label">×©×¢×ª ×¡×™×•×</label>
          <input type="time" class="planner-add-input" id="plannerBlockEnd" style="direction: ltr;" />
        </div>
      </div>
      
      <div class="planner-add-field">
        <label class="planner-add-label">×ž×©×š ×–×ž×Ÿ ×ž×”×™×¨</label>
        <div class="planner-add-duration-presets">
          <button class="planner-duration-btn" data-duration="15">15 ×“×§×³</button>
          <button class="planner-duration-btn" data-duration="30">30 ×“×§×³</button>
          <button class="planner-duration-btn active" data-duration="60">×©×¢×”</button>
          <button class="planner-duration-btn" data-duration="90">1.5 ×©×¢×•×ª</button>
          <button class="planner-duration-btn" data-duration="120">×©×¢×ª×™×™×</button>
          <button class="planner-duration-btn" data-duration="180">3 ×©×¢×•×ª</button>
        </div>
      </div>
      
      <div class="planner-add-field">
        <label class="planner-add-label">×¦×‘×¢ (××•×¤×¦×™×•× ×œ×™)</label>
        <div class="planner-color-picker" id="plannerColorPicker">
          <div class="planner-color-option selected" style="background: transparent; border: 2px dashed var(--border);" data-color="">âœ•</div>
          <div class="planner-color-option" style="background: #667eea;" data-color="#667eea"></div>
          <div class="planner-color-option" style="background: #ef4444;" data-color="#ef4444"></div>
          <div class="planner-color-option" style="background: #f97316;" data-color="#f97316"></div>
          <div class="planner-color-option" style="background: #eab308;" data-color="#eab308"></div>
          <div class="planner-color-option" style="background: #22c55e;" data-color="#22c55e"></div>
          <div class="planner-color-option" style="background: #06b6d4;" data-color="#06b6d4"></div>
          <div class="planner-color-option" style="background: #8b5cf6;" data-color="#8b5cf6"></div>
          <div class="planner-color-option" style="background: #ec4899;" data-color="#ec4899"></div>
          <div class="planner-color-option" style="background: #14b8a6;" data-color="#14b8a6"></div>
          <div class="planner-color-option" style="background: #84cc16;" data-color="#84cc16"></div>
          <div class="planner-color-option" style="background: #0ea5e9;" data-color="#0ea5e9"></div>
        </div>
      </div>
      
      <div class="planner-add-field">
        <label class="planner-add-label">×¢×“×™×¤×•×ª</label>
        <div class="planner-add-priority" id="plannerPriorityPicker">
          <button class="planner-priority-option" data-priority="urgent">ðŸ”´ ×“×—×•×£</button>
          <button class="planner-priority-option" data-priority="high">ðŸŸ  ×’×‘×•×”×”</button>
          <button class="planner-priority-option selected" data-priority="medium">ðŸŸ¡ ×‘×™× ×•× ×™×ª</button>
          <button class="planner-priority-option" data-priority="low">ðŸŸ¢ × ×ž×•×›×”</button>
          <button class="planner-priority-option" data-priority="none">âšª ×œ×œ×</button>
        </div>
      </div>
      
      <div class="planner-add-field">
        <label class="planner-add-label">×§×˜×’×•×¨×™×” (××•×¤×¦×™×•× ×œ×™)</label>
        <select class="planner-add-input" id="plannerBlockCategory">
          <option value="">×œ×œ× ×§×˜×’×•×¨×™×”</option>
          <option value="work">ðŸ’¼ ×¢×‘×•×“×”</option>
          <option value="study">ðŸ“š ×œ×™×ž×•×“×™×</option>
          <option value="health">ðŸƒ ×‘×¨×™××•×ª</option>
          <option value="personal">ðŸ  ××™×©×™</option>
          <option value="social">ðŸ‘¥ ×—×‘×¨×ª×™</option>
          <option value="creative">ðŸŽ¨ ×™×¦×™×¨×ª×™</option>
          <option value="rest">ðŸ§˜ ×ž× ×•×—×”</option>
        </select>
      </div>
      
      <div class="planner-add-field">
        <label class="planner-add-label">×”×¢×¨×•×ª (××•×¤×¦×™×•× ×œ×™)</label>
        <textarea class="planner-add-input" id="plannerBlockNotes" rows="2" placeholder="×”×•×¡×£ ×¤×¨×˜×™× × ×•×¡×¤×™×..." dir="auto"></textarea>
      </div>
      
      <div class="planner-add-field">
        <label class="planner-add-label">×ª×–×›×•×¨×ª</label>
        <select class="planner-add-input" id="plannerBlockReminder">
          <option value="0">×œ×œ× ×ª×–×›×•×¨×ª</option>
          <option value="5">5 ×“×§×•×ª ×œ×¤× ×™</option>
          <option value="10">10 ×“×§×•×ª ×œ×¤× ×™</option>
          <option value="15">15 ×“×§×•×ª ×œ×¤× ×™</option>
          <option value="30">30 ×“×§×•×ª ×œ×¤× ×™</option>
          <option value="60">×©×¢×” ×œ×¤× ×™</option>
        </select>
      </div>
      
      <div class="planner-add-field">
        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
          <input type="checkbox" id="plannerBlockRepeat" />
          <span style="font-size: 13px; color: var(--text);">ðŸ”„ ×—×–×•×¨ ×›×œ ×™×•×</span>
        </label>
      </div>
      
      <div class="planner-add-actions">
        <button class="planner-add-cancel" id="plannerCancelBtn">×‘×™×˜×•×œ</button>
        <button class="planner-add-delete" id="plannerDeleteBtn" style="display: none;">ðŸ—‘ï¸</button>
        <button class="planner-add-save" id="plannerSaveBtn">ðŸ’¾ ×©×ž×•×¨</button>
      </div>
    </div>
  </div>

  <!-- Subject Modal -->
  <div class="subject-modal" id="subjectModal">
    <div class="subject-modal-card">
      <h3 id="subjectModalTitle">×”×•×¡×£ × ×•×©× ×—×“×©</h3>
      <input type="text" id="subjectNameInput" placeholder="×©× ×”× ×•×©× (×œ×“×•×’×ž×”: ×ž×ª×ž×˜×™×§×”, ×¢×‘×•×“×”, ××™×©×™)" dir="auto" />
      
      <div class="task-edit-section-title" style="margin: 16px 0 10px 0;">× ×•×©× ××‘ (××•×¤×¦×™×•× ×œ×™)</div>
      <select id="parentSubjectSelect" style="width: 100%; padding: 12px 14px; border: 2px solid var(--border); border-radius: 10px; font-size: 14px; background: var(--input-bg); color: var(--text); outline: none; cursor: pointer; margin-bottom: 16px;">
        <option value="">×œ×œ× (× ×•×©× ×¨××©×™)</option>
      </select>
      
      <div class="task-edit-section-title" style="margin-bottom: 10px;">×¦×‘×¢</div>
      <div class="subject-color-picker" id="subjectColorPicker">
        <div class="subject-color-option selected" style="background: #667eea;" data-color="#667eea"></div>
        <div class="subject-color-option" style="background: #ef4444;" data-color="#ef4444"></div>
        <div class="subject-color-option" style="background: #f97316;" data-color="#f97316"></div>
        <div class="subject-color-option" style="background: #eab308;" data-color="#eab308"></div>
        <div class="subject-color-option" style="background: #22c55e;" data-color="#22c55e"></div>
        <div class="subject-color-option" style="background: #06b6d4;" data-color="#06b6d4"></div>
        <div class="subject-color-option" style="background: #8b5cf6;" data-color="#8b5cf6"></div>
        <div class="subject-color-option" style="background: #ec4899;" data-color="#ec4899"></div>
        <div class="subject-color-option" style="background: #0ea5e9;" data-color="#0ea5e9"></div>
        <div class="subject-color-option" style="background: #14b8a6;" data-color="#14b8a6"></div>
        <div class="subject-color-option" style="background: #84cc16;" data-color="#84cc16"></div>
        <div class="subject-color-option" style="background: #f43f5e;" data-color="#f43f5e"></div>
      </div>
      
      <!-- Sharing Section -->
      <div class="task-edit-section-title" style="margin: 20px 0 10px 0;">×©×™×ª×•×£ <span style="font-weight: normal; font-size: 12px; color: var(--muted);">(××•×¤×¦×™×•× ×œ×™)</span></div>
      <div id="subjectSharingSection" style="background: var(--day-other); border-radius: 10px; padding: 12px;">
        <div id="sharedWithList" style="margin-bottom: 10px;"></div>
        <div style="display: flex; gap: 8px;">
          <input type="text" id="shareWithUserInput" placeholder="×”×–×Ÿ ×©× ×ž×©×ª×ž×© ×œ×©×™×ª×•×£" dir="auto" style="flex: 1; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 13px; background: var(--input-bg); color: var(--text);" />
          <button type="button" id="addShareUserBtn" class="btn btn-primary" style="padding: 8px 16px; font-size: 13px;">×”×•×¡×£</button>
        </div>
        <div id="shareError" style="color: #ef4444; font-size: 12px; margin-top: 6px; display: none;"></div>
      </div>
      
      <div class="subject-modal-actions">
        <button class="btn" id="cancelSubjectBtn" style="background: var(--day-other); color: var(--muted);">×‘×™×˜×•×œ</button>
        <button class="btn btn-danger" id="deleteSubjectBtn" style="display: none;">×ž×—×§</button>
        <button class="btn btn-primary" id="saveSubjectBtn">×©×ž×•×¨</button>
      </div>
    </div>
  </div>

  <!-- Context Menu for Subjects -->
  <div class="context-menu" id="contextMenu">
    <div class="context-menu-item" data-action="edit">âœï¸ ×¢×¨×™×›×”</div>
    <div class="context-menu-item" data-action="share">ðŸ”— ×©×ª×£</div>
    <div class="context-menu-item" data-action="add-sub">âž• ×”×•×¡×£ ×ª×ª-× ×•×©×</div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item danger" data-action="delete">ðŸ—‘ï¸ ×ž×—×§</div>
  </div>
  
  <!-- Context Menu for Countdown Events -->
  <div class="context-menu" id="eventContextMenu">
    <div class="context-menu-item" data-action="pin">ðŸ“Œ × ×¢×¥ ×œ×ž×¢×œ×”</div>
    <div class="context-menu-item" data-action="star">â­ ×¡×ž×Ÿ ×›×ž×•×¢×“×£</div>
    <div class="context-menu-item" data-action="edit">âœï¸ ×¢×¨×™×›×”</div>
    <div class="context-menu-item" data-action="duplicate">ðŸ“‹ ×©×›×¤×œ</div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item danger" data-action="delete">ðŸ—‘ï¸ ×ž×—×§</div>
  </div>
  
  <!-- Context Menu for Adding New Event -->
  <div class="context-menu" id="addEventContextMenu">
    <div class="context-menu-item" data-action="add">âž• ×”×•×¡×£ ××™×¨×•×¢ ×—×“×©</div>
    <div class="context-menu-item" data-action="add-tomorrow">ðŸ“… ××™×¨×•×¢ ×œ×ž×—×¨</div>
    <div class="context-menu-item" data-action="add-week">ðŸ“† ××™×¨×•×¢ ×œ×©×‘×•×¢ ×”×‘×</div>
  </div>

  <!-- Daily Reminder Modal -->
  <div class="reminder-modal" id="reminderModal">
    <div class="reminder-card">
      <h2>â˜€ï¸ ×‘×•×§×¨ ×˜×•×‘!</h2>
      <div class="reminder-date" id="reminderDate"></div>
      
      <div class="reminder-section" id="todayTasksSection">
        <h3>ðŸ“… ×ž×©×™×ž×•×ª ×œ×”×™×•×</h3>
        <div id="todayTasksList"></div>
      </div>
      
      <div class="reminder-section" id="tomorrowTasksSection">
        <h3>ðŸ“† ×ž×©×™×ž×•×ª ×œ×ž×—×¨</h3>
        <div id="tomorrowTasksList"></div>
      </div>
      
      <div class="reminder-actions">
        <button class="btn btn-primary" id="closeReminderBtn" style="width: 100%;">×”×‘× ×ª×™, ×ª×•×“×”! ðŸ‘</button>
      </div>
    </div>
  </div>
  
  <div class="reminder-modal" id="eventAlertModal" role="dialog" aria-modal="true" aria-labelledby="alertTitle">
    <div class="reminder-card" style="border-top: 5px solid var(--accent);">
      <div style="font-size: 40px; margin-bottom: 10px;">â°</div>
      <h2 id="alertTitle">Reminder!</h2>
      <p id="alertMessage" style="font-size: 18px; margin: 10px 0; color: var(--text);">Event is starting soon</p>
      <div class="reminder-actions">
        <button class="btn btn-primary" id="closeAlertBtn" style="width: 100%;">Dismiss</button>
      </div>
    </div>
  </div>

  <!-- Calendar Sync Modal -->
  <div class="reminder-modal" id="calendarSyncModal" role="dialog" aria-modal="true" aria-labelledby="calendarSyncTitle">
    <div class="reminder-card" style="max-width: 500px; border-top: 5px solid var(--accent);">
      <div style="font-size: 40px; margin-bottom: 10px;">ðŸ“…</div>
      <h2 id="calendarSyncTitle">×¡× ×›×¨×•×Ÿ ×œ×•×— ×©× ×” / Calendar Sync</h2>
      <p style="color: var(--muted); font-size: 14px; margin-bottom: 20px;">×™×™×‘×•× ××™×¨×•×¢×™× ×ž×œ×•×— ×”×©× ×” ×©×œ×š (×—×“-×›×™×•×•× ×™)</p>
      
      <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
        <button class="btn btn-primary" id="syncGoogleCalendar" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px;">
          <span style="font-size: 20px;">ðŸ“†</span>
          <span>Google Calendar</span>
        </button>
        
        <button class="btn btn-primary" id="syncAppleCalendar" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; background: linear-gradient(135deg, #667eea, #764ba2);">
          <span style="font-size: 20px;">ðŸŽ</span>
          <span>Apple Calendar (iCal)</span>
        </button>
      </div>
      
      <div id="calendarSyncStatus" style="padding: 12px; border-radius: 8px; background: var(--day-other); color: var(--muted); font-size: 13px; margin-bottom: 16px; display: none;"></div>
      
      <div id="calendarEventsList" style="max-height: 300px; overflow-y: auto; margin-bottom: 16px; display: none;">
        <div style="font-weight: 600; margin-bottom: 8px; color: var(--text);">××™×¨×•×¢×™× ×©× ×ž×¦××• / Events Found:</div>
        <div id="calendarEventsContent" style="display: flex; flex-direction: column; gap: 6px;"></div>
      </div>
      
      <div class="reminder-actions" style="display: flex; gap: 8px;">
        <button class="btn" id="closeCalendarSyncBtn" style="flex: 1; background: var(--day-other); color: var(--muted);">×¡×’×•×¨ / Close</button>
        <button class="btn btn-primary" id="importCalendarEventsBtn" style="flex: 1; display: none;">×™×™×‘× / Import</button>
      </div>
    </div>
  </div>

  <div class="app-layout">
    <div class="main-content">
      <div class="container">
        <header class="header">
          <h1>â±ï¸ Shared Event Countdowns</h1>
          <p>Events sync live across all devices</p>
        </header>

        <div class="input-panel" id="inputPanel">
          <div class="input-row">
            <input type="text" id="eventName" placeholder="Event name..." autocomplete="off" aria-label="Event name" />
            <input type="datetime-local" id="eventDate" aria-label="Event date and time" max="9999-12-31T23:59" />
            <select id="eventReminder" class="reminder-select" aria-label="Reminder time">
              <option value="0">ðŸ”• No Reminder</option>
              <option value="5">5 minutes before</option>
              <option value="60">1 hour before</option>
              <option value="1440">1 day before</option>
              <option value="2880">2 days before</option>
              <option value="4320">3 days before</option>
              <option value="10080">1 week before</option>
              <option value="custom">âš™ï¸ Customâ€¦</option>
            </select>
            <div class="reminder-custom hidden" id="reminderCustomWrap" aria-label="Custom reminder">
              <input type="number" id="eventReminderCustomValue" min="1" step="1" inputmode="numeric" placeholder="Custom" aria-label="Custom reminder value" />
              <select id="eventReminderCustomUnit" aria-label="Custom reminder unit">
                <option value="minutes">minutes</option>
                <option value="hours">hours</option>
                <option value="days">days</option>
                <option value="weeks">weeks</option>
              </select>
            </div>
            <button class="btn btn-primary" id="addBtn">Add Event</button>
            <button class="btn btn-cancel" id="cancelBtn">Cancel</button>
            <button class="btn btn-ghost" id="clearBtn">Clear All</button>
          </div>
          <div class="input-row-notes">
            <textarea id="eventNotes" placeholder="Notes (optional)..." aria-label="Event notes"></textarea>
          </div>
        </div>

        <div class="event-list loading" id="eventList" role="list">
          <div class="event-skeleton">
            <div class="event-skeleton-row"></div>
            <div class="event-skeleton-row"></div>
            <div class="event-skeleton-row"></div>
          </div>
        </div>

        <div class="empty-state" id="emptyState">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <p>No events yet. Add your first countdown above! ðŸŽ‰</p>
        </div>
      </div>
    </div>

    <aside class="sidebar hidden" id="sidebar">
      <div class="calendar-container">
        <div class="calendar-header">
          <div class="calendar-nav">
            <button id="prevMonth" aria-label="×—×•×“×© ×§×•×“×">â€¹</button>
            <button id="todayBtn" aria-label="×”×™×•×" title="×”×™×•×">â—</button>
            <button id="nextMonth" aria-label="×—×•×“×© ×”×‘×">â€º</button>
          </div>
          <div class="calendar-view-toggle" id="eventCalendarViewToggle">
            <button data-view="month" class="active">×—×•×“×©</button>
            <button data-view="week">×©×‘×•×¢</button>
            <button data-view="day">×™×•×</button>
          </div>
          <div class="calendar-title" id="calendarTitle"></div>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-section-title" id="monthEventsTitle">××™×¨×•×¢×™ ×”×—×•×“×©</div>
        <div class="month-events" id="monthEvents">
          <div class="no-events-msg">××™×Ÿ ××™×¨×•×¢×™× ×”×—×•×“×©</div>
        </div>
      </div>
    </aside>
  </div>

  <!-- Mobile Floating Action Button -->
  <button class="mobile-fab" id="mobileFab" aria-label="×”×•×¡×¤×” ×ž×”×™×¨×”" style="display: none;">+</button>

  <!-- Mobile Sidebar Backdrop -->
  <div class="mobile-sidebar-backdrop" id="mobileSidebarBackdrop"></div>

  <div class="modal-backdrop" id="clearModal" role="dialog" aria-modal="true" aria-labelledby="clearModalTitle" aria-describedby="clearModalDesc">
    <div class="modal-card">
      <h3 id="clearModalTitle">Clear all shared events?</h3>
      <p id="clearModalDesc">This removes every event for everyone. Do you want to continue?</p>
      <div class="modal-actions">
        <button class="btn btn-danger" id="confirmClearBtn">Yes, clear everything</button>
        <button class="btn btn-cancel" id="cancelClearModalBtn" style="display:inline-block;">Keep events</button>
      </div>
    </div>
  </div>

  <div class="shortcuts-backdrop" id="shortcutsModal" role="dialog" aria-modal="true" aria-labelledby="shortcutsTitle">
    <div class="shortcuts-card">
      <div class="shortcuts-hero">
        <div>
          <div class="shortcuts-eyebrow">âŒ¨ï¸ ×§×™×¦×•×¨×™ ×ž×§×œ×“×ª</div>
          <div class="shortcuts-title" id="shortcutsTitle">Shortcut Command Center</div>
          <div class="shortcuts-subtitle">H ×œ×¤×ª×™×—×”/×¡×’×™×¨×”</div>
        </div>
        <button class="shortcuts-close" id="shortcutsClose" aria-label="Close shortcuts">Ã—</button>
      </div>
      <div class="shortcuts-body">
        <div class="shortcuts-section">
          <div class="shortcuts-section-title">×™×¦×™×¨×” ×ž×”×™×¨×”</div>
          <div class="shortcuts-grid">
            <div class="shortcut-item">
              <div class="shortcut-label">×¤×•×§×•×¡ ×¢×œ ×”×•×¡×¤×” ×ž×”×™×¨×”</div>
              <div class="shortcut-keys"><span class="keycap">N</span></div>
            </div>
            <div class="shortcut-item">
              <div class="shortcut-label">×¤×ª×—/×¡×’×•×¨ ×—×œ×•×Ÿ ×§×™×¦×•×¨×™×</div>
              <div class="shortcut-keys"><span class="keycap">H</span></div>
            </div>
          </div>
        </div>
        <div class="shortcuts-section">
          <div class="shortcuts-section-title">× ×™×•×•×˜ ×•×ª×¦×•×’×•×ª</div>
          <div class="shortcuts-grid">
            <div class="shortcut-item">
              <div class="shortcut-label">×§×¤×™×¦×” ×œ×´×”×™×•××´</div>
              <div class="shortcut-keys"><span class="keycap">T</span></div>
            </div>
            <div class="shortcut-item">
              <div class="shortcut-label">×¤×ª×— ×¤×•×ž×•×“×•×¨×•</div>
              <div class="shortcut-keys"><span class="keycap">P</span></div>
            </div>
            <div class="shortcut-item">
              <div class="shortcut-label">×”×¦×’/×”×¡×ª×¨ ×œ×•×— ×©× ×”</div>
              <div class="shortcut-keys"><span class="keycap">C</span></div>
            </div>
            <div class="shortcut-item">
              <div class="shortcut-label">×ž×¢×‘×¨ ×œ×ž×©×™×ž×•×ª</div>
              <div class="shortcut-keys"><span class="keycap">M</span></div>
            </div>
            <div class="shortcut-item">
              <div class="shortcut-label">×—×–×¨×” ×œ×¡×¤×™×¨×” ×œ××—×•×¨</div>
              <div class="shortcut-keys"><span class="keycap">G</span></div>
            </div>
            <div class="shortcut-item">
              <div class="shortcut-label">×—×™×¤×•×© ×ž×©×™×ž×•×ª</div>
              <div class="shortcut-keys"><span class="keycap">/</span></div>
            </div>
          </div>
        </div>
        <div class="shortcuts-section">
          <div class="shortcuts-section-title">×ž×¢×¨×›×ª</div>
          <div class="shortcuts-grid">
            <div class="shortcut-item">
              <div class="shortcut-label">×¡×’×•×¨ ×ž×•×“××œ×™×/×—×œ×•× ×•×ª</div>
              <div class="shortcut-keys"><span class="keycap wide">Esc</span></div>
            </div>
            <div class="shortcut-item">
              <div class="shortcut-label">×ž×¦×‘ ×›×”×”/×‘×”×™×¨</div>
              <div class="shortcut-keys"><span class="keycap">D</span></div>
            </div>
            <div class="shortcut-item">
              <div class="shortcut-label">×§×œ×™×§ ×™×ž× ×™ ×‘×¨×©×™×ž×ª ××™×¨×•×¢×™×</div>
              <div class="shortcut-keys"><span class="keycap wide">âž•</span></div>
            </div>
          </div>
        </div>
        <div class="shortcut-note">×˜×™×¤: ×”×§×™×¦×•×¨×™× ×¤×•×¢×œ×™× ×¨×§ ×›×©×œ× ×ž×§×œ×™×“×™× ×‘×ª×•×š ×©×“×” ×˜×§×¡×˜.</div>
      </div>
    </div>
  </div>

  <!-- Day Drawer -->
  <div class="day-drawer-backdrop" id="dayDrawer" role="dialog" aria-modal="true" aria-labelledby="dayDrawerTitle">
    <div class="day-drawer">
      <div class="day-drawer-header">
        <div>
          <div class="day-drawer-title" id="dayDrawerTitle"></div>
          <div class="day-drawer-subtitle" id="dayDrawerSubtitle"></div>
        </div>
        <button class="day-drawer-close" id="closeDayDrawer" aria-label="×¡×’×•×¨">Ã—</button>
      </div>
      <div class="day-drawer-content">
        <div class="day-drawer-section" id="dayDrawerEvents">
          <div class="day-drawer-section-title">
            ðŸ“… ××™×¨×•×¢×™× <span class="count" id="dayEventsCount">0</span>
          </div>
          <div id="dayEventsList"></div>
        </div>
        <div class="day-drawer-section" id="dayDrawerTasks">
          <div class="day-drawer-section-title">
            âœ… ×ž×©×™×ž×•×ª <span class="count" id="dayTasksCount">0</span>
          </div>
          <div id="dayTasksList"></div>
        </div>
      </div>
      <div class="day-drawer-actions">
        <button class="btn btn-primary" id="addEventToDay">ðŸ“… ×”×•×¡×£ ××™×¨×•×¢</button>
        <button class="btn" id="addTaskToDay" style="background: var(--btn-secondary-bg); color: var(--text);">âœ… ×”×•×¡×£ ×ž×©×™×ž×”</button>
      </div>
    </div>
  </div>

  <!-- AI Chat Assistant Modal -->
  <div class="ai-chat-modal" id="aiChatModal">
    <div class="ai-chat-container">
      <div class="ai-chat-header">
        <div class="ai-chat-title">
          <span>ðŸ’¬</span>
          <span>AI Assistant</span>
        </div>
        <button class="ai-chat-close" id="aiChatClose">Ã—</button>
      </div>
      
      <div class="ai-chat-messages" id="aiChatMessages">
        <div class="ai-chat-message ai">
          <div class="ai-chat-avatar">ðŸ¤–</div>
          <div class="ai-chat-bubble">
            ×©×œ×•×! ×× ×™ ×¢×•×–×¨ AI ×©×™×›×•×œ ×œ× ×”×œ ××ª ×”×ž×©×™×ž×•×ª ×©×œ×š.<br>
            Hi! I'm your AI assistant. I can help you manage tasks.<br><br>
            Try: "Add task: Buy groceries tomorrow at 5pm" or "Schedule my tasks for today"
          </div>
        </div>
      </div>
      
      <div class="ai-chat-examples">
        <div class="ai-chat-example" data-example="Add task: Meeting with team at 2pm tomorrow">âž• Add task</div>
        <div class="ai-chat-example" data-example="Schedule all urgent tasks for today">ðŸ“… Schedule tasks</div>
        <div class="ai-chat-example" data-example="Change priority of first task to urgent">âš¡ Change priority</div>
        <div class="ai-chat-example" data-example="Move my 3pm task to 5pm">ðŸ”„ Reschedule</div>
      </div>
      
      <div class="ai-chat-input-area">
        <input 
          type="text" 
          class="ai-chat-input" 
          id="aiChatInput" 
          placeholder="Type a message... (e.g., 'Add task: Study for exam')"
          autocomplete="off"
        />
        <button class="ai-chat-send" id="aiChatSend">âž¤</button>
      </div>
    </div>
  </div>

  <div class="undo-toast" id="undoToast" role="status" aria-live="polite">
    <span id="undoToastMsg">Event deleted</span>
    <button id="undoToastUndo" aria-label="Undo delete">Undo</button>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, set, onValue, push, remove, onChildAdded, onChildChanged, onChildRemoved, goOnline, goOffline } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB_IflOD8CwVLQQjqtz_ZKWzbfgCiOm2Js",
    authDomain: "countdown-463de.firebaseapp.com",
    databaseURL: "https://countdown-463de-default-rtdb.firebaseio.com",
    projectId: "countdown-463de",
    storageBucket: "countdown-463de.firebasestorage.app",
    messagingSenderId: "1016385864732",
    appId: "1:1016385864732:web:8a82e771e1f4be567a8bd9"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const eventsRef = ref(db, 'events');

  // 2. USER AUTHENTICATION LOGIC
  const userBtn = document.getElementById('userBtn');
  let currentUser = localStorage.getItem('countdown_username');

  // Function to sanitize username (remove special chars)
  const cleanUsername = (name) => {
    return (name || '').trim().toLowerCase().replace(/[^a-z0-9_-]/g, '');
  };

  // Login Process
  if (!currentUser) {
    const input = prompt("ðŸ‘‹ Welcome! \nEnter a username to access your private tasks:\n(e.g., 'john123', 'sarah_work')");
    currentUser = cleanUsername(input);
    
    if (!currentUser) {
      currentUser = 'guest_' + Math.floor(Math.random() * 1000);
      alert("No name entered. You are logged in as: " + currentUser);
    }
    localStorage.setItem('countdown_username', currentUser);
  }

  // Update UI
  if(userBtn) userBtn.textContent = `ðŸ‘¤ ${currentUser}`;

  // 3. PRIVATE REFERENCES (Scoped to the user)
  const tasksRef = ref(db, `users/${currentUser}/tasks`);
  const subjectsRef = ref(db, `users/${currentUser}/subjects`);

  // 4. LOGOUT / SWITCH USER FUNCTION
  if(userBtn) {
    userBtn.onclick = () => {
      const switchUser = confirm(`You are logged in as "${currentUser}".\n\nDo you want to switch users?`);
      if (switchUser) {
        localStorage.removeItem('countdown_username');
        location.reload(); // Reload page to reset references
      }
    };
  }

  const COLORS = ['#667eea','#f59e0b','#10b981','#ec4899','#8b5cf6','#06b6d4','#ef4444','#84cc16'];
  const HEBREW_DAYS = ['××³', '×‘×³', '×’×³', '×“×³', '×”×³', '×•×³', '×©×³'];
  const HEBREW_MONTHS = ['×™× ×•××¨', '×¤×‘×¨×•××¨', '×ž×¨×¥', '××¤×¨×™×œ', '×ž××™', '×™×•× ×™', '×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¤×˜×ž×‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘×ž×‘×¨', '×“×¦×ž×‘×¨'];

  const escapeHtml = (str) => String(str || '').replace(/[&<>"']/g, (c) => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;'
  })[c]);

  const $ = id => document.getElementById(id);
  const eventList = $("eventList");
  const emptyState = $("emptyState");
  const eventName = $("eventName");
  const eventDate = $("eventDate");
  const eventReminder = $("eventReminder");
  const reminderCustomWrap = $("reminderCustomWrap");
  const eventReminderCustomValue = $("eventReminderCustomValue");
  const eventReminderCustomUnit = $("eventReminderCustomUnit");
  const eventAlertModal = $("eventAlertModal");
  const closeAlertBtn = $("closeAlertBtn");
  const alertTitle = $("alertTitle");
  const alertMessage = $("alertMessage");
  const inputPanel = $("inputPanel");
  const addBtn = $("addBtn");
  const cancelBtn = $("cancelBtn");
  const clearBtn = $("clearBtn");
  const sidebar = $("sidebar");
  const calendarGrid = $("calendarGrid");
  const calendarTitle = $("calendarTitle");
  const monthEventsEl = $("monthEvents");
  const monthEventsTitle = $("monthEventsTitle");
  const clearModal = $("clearModal");
  const confirmClearBtn = $("confirmClearBtn");
  const cancelClearModalBtn = $("cancelClearModalBtn");
	  const themeToggle = $("themeToggle");
	  const notifyBtn = $("notifyBtn");
	  const togglePomodoro = $("togglePomodoro");
	  const pomodoroOverlay = $("pomodoroOverlay");
  
  
  
  const eventNotes = $("eventNotes");
  const undoToast = $("undoToast");
  const undoToastMsg = $("undoToastMsg");
  const shortcutsModal = $("shortcutsModal");
  const shortcutsClose = $("shortcutsClose");
  const helpShortcuts = $("helpShortcuts");
  let shortcutsLastFocus = null;

  // Event delegation for main calendar: single handler instead of per-chip listeners
  if (calendarGrid) {
    calendarGrid.addEventListener('click', (e) => {
      const chip = e.target.closest('.calendar-event-chip');
      if (chip) {
        e.stopPropagation();
        const eventId = chip.dataset.eventId;
        if (eventId) {
          const eventRow = document.querySelector(`.event-row[data-id="${eventId}"]`);
          if (eventRow) {
            eventRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            eventRow.style.transition = 'background 0.3s';
            eventRow.style.background = 'var(--accent)';
            setTimeout(() => { eventRow.style.background = ''; }, 800);
          }
        }
        return;
      }

      const day = e.target.closest('.calendar-day:not(.other-month)');
      if (day) {
        const dateKey = day.dataset.date;
        if (!dateKey) return;
        openDayDrawer(dateKey);
      }
    });
  }
  const undoToastUndo = $("undoToastUndo");
  const pomodoroCard = $("pomodoroCard");
  const pomodoroTaskSelect = $("pomodoroTaskSelect");
  const pomodoroPresetsEls = Array.from(document.querySelectorAll('.pomodoro-preset'));
  const pomodoroFocusInput = $("pomodoroFocus");
  const pomodoroBreakInput = $("pomodoroBreak");
  const pomodoroLongInput = $("pomodoroLong");
  const pomodoroLongEveryInput = $("pomodoroLongEvery");
  const pomodoroAutoContinueEl = $("pomodoroAutoContinue");
  const pomodoroSoundEl = $("pomodoroSound");
  const pomodoroDisplay = $("pomodoroDisplay");
  const pomodoroMode = $("pomodoroMode");
  const pomodoroNext = $("pomodoroNext");
    const pomodoroProgress = $("pomodoroProgress");
    const pomodoroStart = $("pomodoroStart");
  const pomodoroSkip = $("pomodoroSkip");
  const pomodoroReset = $("pomodoroReset");
  const pomodoroSessionCount = $("pomodoroSessionCount");
  const pomodoroFocusMinutes = $("pomodoroFocusMinutes");
  const pomodoroStreak = $("pomodoroStreak");
  const pomodoroDayProgress = $("pomodoroDayProgress");
  const pomodoroDayLabel = $("pomodoroDayLabel");

  const STORAGE_KEYS = {
    THEME: 'countdown-theme',
    SIDEBAR_WIDTH: 'countdown-sidebar-width'
  };
  const CACHE_KEYS = {
    EVENTS: 'countdown-events-cache-v1',
    TASKS_PREFIX: 'countdown-tasks-cache-v1:',
    SUBJECTS_PREFIX: 'countdown-subjects-cache-v1:'
  };

  let editingId = null;
  let events = [];
  let eventsLoaded = false;
  let hasEventsCache = false;
  const eventsById = new Map();
  const refs = new Map();
  let tickerHandle = null;
  function getEventById(id) { return eventsById.get(id); }
  function upsertLocalEvent(id, data) {
    const existing = eventsById.get(id);
    if (existing) Object.assign(existing, data);
    else {
      const evt = { id, ...data };
      events.push(evt);
      eventsById.set(id, evt);
    }
  }
  let calendarRenderTimer = null;
  function scheduleCalendarRender() {
    if (calendarRenderTimer) return;
    const run = () => {
      calendarRenderTimer = null;
      renderCalendar();
    };
    if ('requestIdleCallback' in window) {
      calendarRenderTimer = requestIdleCallback(run, { timeout: 200 });
    } else {
      calendarRenderTimer = setTimeout(run, 0);
    }
  }
  let currentMonth = new Date();
  let eventCalendarView = 'month'; // 'month', 'week', 'day'
  let eventCalendarFocusDate = new Date();
  const pendingDeletes = new Map();
  let lastDeletedId = null;
  const DELETE_TIMEOUT_MS = 10000;
  const notifiedEvents = new Map();
  const notifiedTasks = new Map();
  let pendingEventAlert = null;
  const reminderAudio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3');
  reminderAudio.preload = 'auto';
  reminderAudio.volume = 0.6;

  const getActiveEvents = () => events.filter(evt => !pendingDeletes.has(evt.id));

  const readCache = (key) => {
    try {
      const raw = localStorage.getItem(key);
      if (!raw) return null;
      const parsed = JSON.parse(raw);
      if (!parsed || !Array.isArray(parsed.items)) return null;
      return parsed.items;
    } catch (e) {
      return null;
    }
  };

  const writeCache = (key, items, limit) => {
    try {
      const payload = { ts: Date.now(), items: items.slice(0, limit) };
      localStorage.setItem(key, JSON.stringify(payload));
    } catch (e) {}
  };
  
	  // Web Push (works when closed) requires: HTTPS + Service Worker + a backend sender (VAPID private key).
	  // 1) Generate VAPID keys on your backend, then paste the PUBLIC key here.
	  const PUSH_VAPID_PUBLIC_KEY = "BBU7RR-_gZR8MC-QaLiyUJuplTzrDqIYNQtnGJ0m6TlBwLKGrydNf8sBxmpW2EJhTeFNHFbXsQv6z00ZT6GPfZU";
	  const PUSH_LOCAL_USER_KEY = 'countdown_push_subscription_user';

	  const isPushSupported = () => (
	    window.isSecureContext &&
	    'serviceWorker' in navigator &&
	    'PushManager' in window
	  );

	  const urlBase64ToUint8Array = (base64String) => {
	    const padding = '='.repeat((4 - (base64String.length % 4)) % 4);
	    const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
	    const rawData = atob(base64);
	    const outputArray = new Uint8Array(rawData.length);
	    for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
	    return outputArray;
	  };

	  async function getPushRegistration() {
	    if (!('serviceWorker' in navigator)) return null;
	    return await navigator.serviceWorker.getRegistration();
	  }

	  async function ensurePushRegistration() {
	    if (!('serviceWorker' in navigator)) return null;
	    const existing = await getPushRegistration();
	    if (existing) return existing;
	    return await navigator.serviceWorker.register('./service-worker.js', { scope: './' });
	  }

	  async function sha256Base64Url(input) {
	    const data = new TextEncoder().encode(String(input || ''));
	    const digest = await crypto.subtle.digest('SHA-256', data);
	    const bytes = Array.from(new Uint8Array(digest));
	    const b64 = btoa(String.fromCharCode(...bytes));
	    return b64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/g, '');
	  }

	  async function savePushSubscriptionForUser(userId, subscription) {
	    if (!userId) return;
	    if (!subscription) return;
	    const key = await sha256Base64Url(subscription.endpoint);
	    const payload = {
	      sub: subscription.toJSON(),
	      ua: navigator.userAgent,
	      createdAt: Date.now()
	    };
	    await set(ref(db, `users/${userId}/pushSubscriptions/${key}`), payload);
	  }

	  async function removePushSubscriptionForUser(userId, subscription) {
	    if (!userId) return;
	    if (!subscription) return;
	    const key = await sha256Base64Url(subscription.endpoint);
	    await remove(ref(db, `users/${userId}/pushSubscriptions/${key}`));
	  }

	  async function syncExistingSubscriptionToCurrentUser() {
	    if (!isPushSupported()) return;
	    if (!PUSH_VAPID_PUBLIC_KEY) return;
	    try {
	      const reg = await getPushRegistration();
	      if (!reg) return;
	      let sub = await reg.pushManager.getSubscription();
	      
	      // If no subscription but permission granted, auto-resubscribe (handles expired subs)
	      if (!sub && Notification.permission === 'granted') {
	        try {
	          const appServerKey = urlBase64ToUint8Array(PUSH_VAPID_PUBLIC_KEY);
	          sub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: appServerKey });
	          console.log('[Push] Auto-resubscribed');
	        } catch (e) {
	          console.warn('[Push] Auto-resubscribe failed:', e);
	          return;
	        }
	      }
	      
	      if (!sub) return;
	      const prevUser = localStorage.getItem(PUSH_LOCAL_USER_KEY);
	      if (prevUser && prevUser !== currentUser) {
	        await removePushSubscriptionForUser(prevUser, sub).catch(() => {});
	      }
	      await savePushSubscriptionForUser(currentUser, sub);
	      localStorage.setItem(PUSH_LOCAL_USER_KEY, currentUser);
	    } catch (e) {
	      console.warn('[Push] Sync failed:', e);
	    }
	  }

	  async function refreshNotifyButton() {
	    if (!notifyBtn) return;
	    if (!("Notification" in window)) {
	      notifyBtn.textContent = "ðŸ”•";
	      notifyBtn.title = "Notifications are not supported in this browser";
	      notifyBtn.disabled = true;
	      notifyBtn.setAttribute('aria-disabled', 'true');
	      return;
	    }
	    notifyBtn.disabled = false;
	    notifyBtn.removeAttribute('aria-disabled');

	    const perm = Notification.permission;
	    if (perm === 'denied') {
	      notifyBtn.textContent = "ðŸ”•";
	      notifyBtn.title = "Notifications blocked (enable in browser settings)";
	      return;
	    }

	    if (isPushSupported()) {
	      try {
	        const reg = await getPushRegistration();
	        const sub = reg ? await reg.pushManager.getSubscription() : null;
	        if (sub && perm === 'granted') {
	          notifyBtn.textContent = "ðŸ””";
	          notifyBtn.title = `Push enabled for "${currentUser}" (works even when closed)`;
	          notifyBtn.setAttribute('aria-pressed', 'true');
	          return;
	        }
	      } catch {}
	      notifyBtn.textContent = "ðŸ””";
	      notifyBtn.title = perm === 'granted'
	        ? "Enable push (works when closed)"
	        : "Enable notifications";
	      notifyBtn.setAttribute('aria-pressed', 'false');
	      return;
	    }

	    notifyBtn.textContent = "ðŸ””";
	    notifyBtn.title = perm === 'granted'
	      ? "Notifications enabled (only while app is open)"
	      : "Enable notifications";
	    notifyBtn.setAttribute('aria-pressed', perm === 'granted' ? 'true' : 'false');
	  }

	  async function toggleNotificationsFromUser() {
	    if (!("Notification" in window)) {
	      alert("Notifications aren't supported in this browser.");
	      return;
	    }
	    if (!window.isSecureContext) {
	      alert("Notifications require HTTPS (GitHub Pages is OK) or localhost.");
	      return;
	    }
	    if (Notification.permission === 'denied') {
	      alert("Notifications are blocked for this site. Enable them in browser/OS settings and reload.");
	      return;
	    }

	    const perm = Notification.permission === 'granted'
	      ? 'granted'
	      : await Notification.requestPermission();

	    if (perm !== 'granted') {
	      await refreshNotifyButton();
	      return;
	    }

	    if (!isPushSupported()) {
	      new Notification("Notifications enabled âœ…", { body: "Youâ€™ll get reminders while this app is open." });
	      await refreshNotifyButton();
	      return;
	    }

	    if (!PUSH_VAPID_PUBLIC_KEY) {
	      alert("To enable push while closed, set PUSH_VAPID_PUBLIC_KEY in the code and run a push-sender backend.");
	      await refreshNotifyButton();
	      return;
	    }

	    const reg = await ensurePushRegistration();
	    const existing = await reg.pushManager.getSubscription();
	    if (existing) {
	      const ok = confirm(`Push is enabled for "${currentUser}".\n\nDisable it on this device?`);
	      if (!ok) return;
	      await removePushSubscriptionForUser(currentUser, existing).catch(() => {});
	      await existing.unsubscribe().catch(() => {});
	      localStorage.removeItem(PUSH_LOCAL_USER_KEY);
	      await refreshNotifyButton();
	      return;
	    }

	    const appServerKey = urlBase64ToUint8Array(PUSH_VAPID_PUBLIC_KEY);
	    const sub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: appServerKey });
	    await savePushSubscriptionForUser(currentUser, sub);
	    localStorage.setItem(PUSH_LOCAL_USER_KEY, currentUser);
	    new Notification("Push enabled âœ…", { body: `Push is enabled for "${currentUser}".` });
	    await refreshNotifyButton();
	  }

	  if (notifyBtn) notifyBtn.addEventListener('click', toggleNotificationsFromUser);
	  syncExistingSubscriptionToCurrentUser();
	  refreshNotifyButton();

	  // Optional: allow "Done" action to complete a task by deep-link.
	  // Your push sender can include: { completeUrl: "/?completeTask=TASK_ID&user=CURRENT_USER&sharedSubject=SUBJECT_ID" }
	  async function maybeHandleCompleteTaskLink() {
	    try {
	      const url = new URL(window.location.href);
	      const taskId = url.searchParams.get('completeTask');
	      const user = url.searchParams.get('user');
	      const sharedSubjectId = url.searchParams.get('sharedSubject');
	      if (!taskId) return;
	      if (user && user !== currentUser) {
	        // Switch user context, then reload once (so the app writes under the right user path).
	        localStorage.setItem('countdown_username', user);
	        url.searchParams.delete('completeTask');
	        url.searchParams.delete('user');
	        url.searchParams.delete('sharedSubject');
	        window.location.replace(url.toString());
	        return;
	      }
	      // Mark completed (leaf set keeps other fields unchanged).
	      if (sharedSubjectId) {
	        // Shared task
	        await set(ref(db, `sharedSubjects/${sharedSubjectId}/tasks/${taskId}/completed`), true);
	      } else {
	        // Own task
	        await set(ref(db, `users/${currentUser}/tasks/${taskId}/completed`), true);
	      }
	      // Clean URL to avoid re-trigger
	      url.searchParams.delete('completeTask');
	      url.searchParams.delete('user');
	      url.searchParams.delete('sharedSubject');
	      window.history.replaceState({}, '', url.toString());
	    } catch (e) {}
	  }

	  maybeHandleCompleteTaskLink();

	  // Best-effort handle notification action if app is already open.
	  if ('serviceWorker' in navigator) {
	    navigator.serviceWorker.addEventListener('message', (event) => {
	      const msg = event.data;
	      if (!msg || msg.type !== 'notificationclick') return;
	      // Currently handled via deep-link; keep hook for future enhancements.
	    });
	  }

  const setEventsLoading = (isLoading) => {
    if (!eventList) return;
    eventList.classList.toggle('loading', isLoading);
  };

  const syncBadge = $("syncBadge");
  const syncState = { events: false, tasks: false, subjects: false };
  const syncCacheUsed = { events: false, tasks: false, subjects: false };
  const SYNC_TIMEOUT_MS = 8000;
  const SUBJECTS_NO_CACHE_TIMEOUT_MS = 5000;
  const syncTimeouts = { events: null, tasks: null, subjects: null, subjectsNoCache: null };
  const clearSyncTimeouts = (key) => {
    const keys = key === 'subjects' ? ['subjects', 'subjectsNoCache'] : [key];
    keys.forEach((timeoutKey) => {
      if (syncTimeouts[timeoutKey]) {
        clearTimeout(syncTimeouts[timeoutKey]);
        syncTimeouts[timeoutKey] = null;
      }
    });
  };
  const startSyncTimeout = (key, ms, reason, onTimeout) => {
    const timeoutKey = (key === 'subjects' && reason === 'no-cache') ? 'subjectsNoCache' : key;
    syncTimeouts[timeoutKey] = setTimeout(() => {
      syncTimeouts[timeoutKey] = null;
      if (syncState[key]) return;
      console.warn(`[sync] ${key} timeout after ${ms}ms (${reason})`);
      if (typeof onTimeout === 'function') onTimeout();
      markSyncReady(key, `timeout:${reason}`);
    }, ms);
  };
  const updateSyncBadge = () => {
    if (!syncBadge) return;
    const hasCache = Object.values(syncCacheUsed).some(Boolean);
    const ready = syncState.events && syncState.tasks && syncState.subjects;
    const total = Object.keys(syncState).length;
    const readyCount = Object.values(syncState).filter(Boolean).length;
    const percent = Math.floor((readyCount / total) * 100);
    const syncText = syncBadge.querySelector('.sync-text');
    if (syncText) syncText.textContent = ready ? 'Synced' : `Syncing ${percent}%`;
    syncBadge.classList.toggle('hidden', !hasCache || ready);
  };
  const markSyncReady = (key, source = 'unknown') => {
    if (syncState[key]) {
      console.debug(`[sync] ${key} already ready (${source})`);
      return;
    }
    syncState[key] = true;
    const total = Object.keys(syncState).length;
    const readyCount = Object.values(syncState).filter(Boolean).length;
    console.debug(`[sync] ${key} ready (${source}) ${readyCount}/${total}`);
    updateSyncBadge();
  };

  const showUndoToast = (name, id) => {
    undoToastMsg.textContent = `${name} deleted`;
    lastDeletedId = id;
    undoToast.classList.add('show');
  };

  const hideUndoToast = () => {
    lastDeletedId = null;
    undoToast.classList.remove('show');
  };
  
  const closeEventAlert = () => {
    if (eventAlertModal) eventAlertModal.classList.remove('open');
  };

  const getReminderMinutesFromUI = () => {
    if (!eventReminder) return 0;
    const raw = eventReminder.value;
    if (raw !== 'custom') return parseInt(raw, 10) || 0;

    const value = parseInt(eventReminderCustomValue?.value, 10);
    const unit = eventReminderCustomUnit?.value || 'minutes';
    if (!Number.isFinite(value) || value <= 0) return null;

    const multipliers = { minutes: 1, hours: 60, days: 1440, weeks: 10080 };
    const mult = multipliers[unit] || 1;
    const minutes = value * mult;
    if (!Number.isFinite(minutes) || minutes <= 0) return null;
    return minutes;
  };

  const setReminderUIFromMinutes = (minutes) => {
    if (!eventReminder) return;
    const min = parseInt(minutes, 10) || 0;
    const optionExists = Array.from(eventReminder.options).some(o => o.value === String(min));

    if (min > 0 && !optionExists) {
      eventReminder.value = 'custom';
      if (reminderCustomWrap) reminderCustomWrap.classList.remove('hidden');

      let unit = 'minutes';
      let value = min;
      if (min % 10080 === 0) {
        unit = 'weeks';
        value = Math.round(min / 10080);
      } else if (min % 1440 === 0) {
        unit = 'days';
        value = Math.round(min / 1440);
      } else if (min % 60 === 0) {
        unit = 'hours';
        value = Math.round(min / 60);
      }
      if (eventReminderCustomUnit) eventReminderCustomUnit.value = unit;
      if (eventReminderCustomValue) eventReminderCustomValue.value = String(value);
      return;
    }

    eventReminder.value = String(min);
    if (reminderCustomWrap) reminderCustomWrap.classList.add('hidden');
    if (eventReminderCustomValue) eventReminderCustomValue.value = '';
    if (eventReminderCustomUnit) eventReminderCustomUnit.value = 'minutes';
  };

  if (eventReminder) {
    eventReminder.addEventListener('change', () => {
      const isCustom = eventReminder.value === 'custom';
      if (reminderCustomWrap) reminderCustomWrap.classList.toggle('hidden', !isCustom);
      if (isCustom) {
        if (eventReminderCustomUnit && !eventReminderCustomUnit.value) eventReminderCustomUnit.value = 'minutes';
        if (eventReminderCustomValue && !eventReminderCustomValue.value) eventReminderCustomValue.value = '10';
        if (eventReminderCustomValue) eventReminderCustomValue.focus();
      } else {
        if (eventReminderCustomValue) eventReminderCustomValue.value = '';
        if (eventReminderCustomUnit) eventReminderCustomUnit.value = 'minutes';
      }
    });
  }
  
  if (closeAlertBtn) {
    closeAlertBtn.onclick = closeEventAlert;
  }
  if (eventAlertModal) {
    eventAlertModal.addEventListener('click', (e) => {
      if (e.target === eventAlertModal) closeEventAlert();
    });
  }
  
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden && pendingEventAlert) {
      showEventAlert(pendingEventAlert.title, pendingEventAlert.message, true);
      pendingEventAlert = null;
    }
    // Force Firebase reconnect when app becomes visible (fixes mobile sync issues)
    if (!document.hidden) {
      goOffline(db);
      setTimeout(() => goOnline(db), 100);
    }
  });

  undoToastUndo.onclick = () => {
    if (!lastDeletedId) return;
    const pending = pendingDeletes.get(lastDeletedId);
    if (pending) {
      clearTimeout(pending.timer);
      pendingDeletes.delete(lastDeletedId);
      render();
    }
    hideUndoToast();
  };

  function getEventColor(id) {

      const charCode = id.charCodeAt(id.length - 1);

      return COLORS[charCode % COLORS.length];

    }

  

    $("toggleSidebar").onclick = () => {

      const wasHidden = sidebar.classList.contains("hidden");

      sidebar.classList.toggle("hidden");

      // Reset to current month when opening sidebar

      if (wasHidden) {

        currentMonth = new Date();

        renderCalendar();

      }

    };

  

    // Dark mode toggle

    const initTheme = () => {

      const saved = localStorage.getItem(STORAGE_KEYS.THEME);

      if (saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) {

        document.body.classList.add('dark');

        themeToggle.textContent = 'â˜€ï¸';

      }

    };

    initTheme();

  themeToggle.onclick = () => {
    document.body.classList.toggle('dark');
    const isDark = document.body.classList.contains('dark');
    themeToggle.textContent = isDark ? 'â˜€ï¸' : 'ðŸŒ™';
    localStorage.setItem(STORAGE_KEYS.THEME, isDark ? 'dark' : 'light');
  };

  // ========================================
  // CALENDAR SYNC FUNCTIONALITY
  // ========================================
  
  const calendarSyncBtn = $('calendarSyncBtn');
  const calendarSyncModal = $('calendarSyncModal');
  const closeCalendarSyncBtn = $('closeCalendarSyncBtn');
  const syncGoogleCalendar = $('syncGoogleCalendar');
  const syncAppleCalendar = $('syncAppleCalendar');
  const calendarSyncStatus = $('calendarSyncStatus');
  const calendarEventsList = $('calendarEventsList');
  const calendarEventsContent = $('calendarEventsContent');
  const importCalendarEventsBtn = $('importCalendarEventsBtn');

  let pendingCalendarEvents = [];

  // Google Calendar API Configuration
  const GOOGLE_API_KEY = 'AIzaSyBH6g_Wz_RJKmEZL9xYWB6J2QaQ5f8z7hY'; // Replace with your API key
  const GOOGLE_CLIENT_ID = '123456789.apps.googleusercontent.com'; // Replace with your Client ID
  const GOOGLE_SCOPES = 'https://www.googleapis.com/auth/calendar.readonly';
  
  // Helper function to show status message
  const showCalendarStatus = (message, type = 'info') => {
    calendarSyncStatus.textContent = message;
    calendarSyncStatus.style.display = 'block';
    calendarSyncStatus.style.background = type === 'error' ? '#fef2f2' : 
                                          type === 'success' ? '#f0fdf4' : 'var(--day-other)';
    calendarSyncStatus.style.color = type === 'error' ? '#ef4444' : 
                                     type === 'success' ? '#10b981' : 'var(--muted)';
  };

  const hideCalendarStatus = () => {
    calendarSyncStatus.style.display = 'none';
  };

  // Open calendar sync modal
  if (calendarSyncBtn) {
    calendarSyncBtn.onclick = () => {
      calendarSyncModal.classList.add('open');
      hideCalendarStatus();
      calendarEventsList.style.display = 'none';
      importCalendarEventsBtn.style.display = 'none';
      pendingCalendarEvents = [];
    };
  }

  // Close calendar sync modal
  if (closeCalendarSyncBtn) {
    closeCalendarSyncBtn.onclick = () => {
      calendarSyncModal.classList.remove('open');
    };
  }

  // Click outside to close
  if (calendarSyncModal) {
    calendarSyncModal.addEventListener('click', (e) => {
      if (e.target === calendarSyncModal) {
        calendarSyncModal.classList.remove('open');
      }
    });
  }

  // Google Calendar Integration
  if (syncGoogleCalendar) {
    syncGoogleCalendar.onclick = async () => {
      showCalendarStatus('ðŸ”„ Connecting to Google Calendar...', 'info');
      
      try {
        // Load Google API client library
        if (!window.gapi) {
          await loadGoogleAPI();
        }

        // Initialize Google API
        await new Promise((resolve, reject) => {
          gapi.load('client:auth2', resolve);
        });

        await gapi.client.init({
          apiKey: GOOGLE_API_KEY,
          clientId: GOOGLE_CLIENT_ID,
          discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'],
          scope: GOOGLE_SCOPES
        });

        // Sign in
        const auth = gapi.auth2.getAuthInstance();
        if (!auth.isSignedIn.get()) {
          await auth.signIn();
        }

        showCalendarStatus('âœ… Connected! Fetching events...', 'success');

        // Fetch calendar events (next 30 days)
        const now = new Date();
        const oneMonthLater = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);
        
        const response = await gapi.client.calendar.events.list({
          calendarId: 'primary',
          timeMin: now.toISOString(),
          timeMax: oneMonthLater.toISOString(),
          showDeleted: false,
          singleEvents: true,
          maxResults: 50,
          orderBy: 'startTime'
        });

        const events = response.result.items || [];
        
        if (events.length === 0) {
          showCalendarStatus('No upcoming events found in your Google Calendar', 'info');
          return;
        }

        displayCalendarEvents(events, 'google');
        
      } catch (error) {
        console.error('Google Calendar sync error:', error);
        showCalendarStatus(`âŒ Error: ${error.message || 'Failed to connect to Google Calendar'}`, 'error');
      }
    };
  }

  // Apple Calendar (iCal) Integration
  if (syncAppleCalendar) {
    syncAppleCalendar.onclick = async () => {
      showCalendarStatus('ðŸŽ Apple Calendar requires .ics file import', 'info');
      
      // Create file input for .ics files
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.ics,.ical';
      
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        showCalendarStatus('ðŸ”„ Reading calendar file...', 'info');
        
        try {
          const text = await file.text();
          const events = parseICalendar(text);
          
          if (events.length === 0) {
            showCalendarStatus('No events found in the .ics file', 'info');
            return;
          }
          
          displayCalendarEvents(events, 'apple');
          
        } catch (error) {
          console.error('iCal parse error:', error);
          showCalendarStatus(`âŒ Error: ${error.message || 'Failed to read calendar file'}`, 'error');
        }
      };
      
      input.click();
    };
  }

  // Load Google API dynamically
  function loadGoogleAPI() {
    return new Promise((resolve, reject) => {
      if (document.querySelector('script[src*="apis.google.com"]')) {
        resolve();
        return;
      }
      
      const script = document.createElement('script');
      script.src = 'https://apis.google.com/js/api.js';
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  // Parse iCalendar (.ics) format
  function parseICalendar(icsText) {
    const events = [];
    const lines = icsText.split(/\r?\n/);
    let currentEvent = null;
    
    for (let i = 0; i < lines.length; i++) {
      let line = lines[i].trim();
      
      // Handle line folding (lines starting with space or tab)
      while (i + 1 < lines.length && /^[ \t]/.test(lines[i + 1])) {
        line += lines[++i].trim();
      }
      
      if (line === 'BEGIN:VEVENT') {
        currentEvent = {};
      } else if (line === 'END:VEVENT' && currentEvent) {
        if (currentEvent.summary && currentEvent.start) {
          events.push(currentEvent);
        }
        currentEvent = null;
      } else if (currentEvent) {
        const match = line.match(/^([^:;]+)(?:;([^:]+))?:(.+)$/);
        if (match) {
          const [, key, params, value] = match;
          
          if (key === 'SUMMARY') {
            currentEvent.summary = value;
          } else if (key === 'DTSTART') {
            currentEvent.start = parseICalDate(value, params);
          } else if (key === 'DTEND') {
            currentEvent.end = parseICalDate(value, params);
          } else if (key === 'DESCRIPTION') {
            currentEvent.description = value.replace(/\\n/g, '\n');
          }
        }
      }
    }
    
    return events;
  }

  // Parse iCal date format
  function parseICalDate(dateStr, params) {
    // Format: YYYYMMDDTHHMMSS or YYYYMMDD
    const match = dateStr.match(/^(\d{4})(\d{2})(\d{2})(?:T(\d{2})(\d{2})(\d{2}))?/);
    if (!match) return null;
    
    const [, year, month, day, hour = '00', minute = '00', second = '00'] = match;
    return new Date(year, month - 1, day, hour, minute, second);
  }

  // Display calendar events for selection
  function displayCalendarEvents(calendarEvents, source) {
    pendingCalendarEvents = calendarEvents.map(evt => {
      if (source === 'google') {
        return {
          name: evt.summary || 'Untitled Event',
          date: evt.start.dateTime || evt.start.date,
          notes: evt.description || '',
          source: 'Google Calendar'
        };
      } else {
        return {
          name: evt.summary || 'Untitled Event',
          date: evt.start.toISOString(),
          notes: evt.description || '',
          source: 'Apple Calendar'
        };
      }
    });
    
    showCalendarStatus(`âœ… Found ${pendingCalendarEvents.length} events`, 'success');
    
    calendarEventsContent.innerHTML = pendingCalendarEvents.map((evt, idx) => {
      const eventDate = new Date(evt.date);
      const dateStr = eventDate.toLocaleString('he-IL', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      return `
        <label style="display: flex; align-items: center; padding: 8px; border-radius: 6px; background: var(--card); border: 1px solid var(--border); cursor: pointer; transition: all 0.2s;" 
               onmouseover="this.style.background='var(--day-hover)'" 
               onmouseout="this.style.background='var(--card)'">
          <input type="checkbox" checked data-event-idx="${idx}" style="margin-left: 8px;">
          <div style="flex: 1;">
            <div style="font-weight: 500; color: var(--text);">${escapeHtml(evt.name)}</div>
            <div style="font-size: 12px; color: var(--muted);">${dateStr}</div>
          </div>
        </label>
      `;
    }).join('');
    
    calendarEventsList.style.display = 'block';
    importCalendarEventsBtn.style.display = 'block';
  }

  // Import selected calendar events
  if (importCalendarEventsBtn) {
    importCalendarEventsBtn.onclick = async () => {
      const checkboxes = calendarEventsContent.querySelectorAll('input[type="checkbox"]:checked');
      const selectedIndices = Array.from(checkboxes).map(cb => parseInt(cb.dataset.eventIdx));
      
      if (selectedIndices.length === 0) {
        showCalendarStatus('Please select at least one event to import', 'error');
        return;
      }
      
      showCalendarStatus(`ðŸ”„ Importing ${selectedIndices.length} events...`, 'info');
      
      let imported = 0;
      for (const idx of selectedIndices) {
        const evt = pendingCalendarEvents[idx];
        try {
          await saveToCloud({
            name: evt.name,
            date: evt.date,
            notes: evt.notes ? `${evt.notes}\n\n[Imported from ${evt.source}]` : `[Imported from ${evt.source}]`,
            reminder: 60, // Default 1 hour reminder
            highlighted: false,
            pinned: false
          });
          imported++;
        } catch (error) {
          console.error('Failed to import event:', evt.name, error);
        }
      }
      
      showCalendarStatus(`âœ… Successfully imported ${imported} events!`, 'success');
      
      setTimeout(() => {
        calendarSyncModal.classList.remove('open');
      }, 2000);
    };
  }

  // ========================================
  // END CALENDAR SYNC FUNCTIONALITY
  // ========================================

  // ========================================
  // AI-POWERED FEATURES
  // ========================================
  
  // AI Configuration - Replace with your API keys
  const AI_CONFIG = {
    provider: 'gemini', // 'gemini', 'openai', or 'local'
    gemini: {
      apiKey: 'AIzaSyAkXcOWS3VDbWVKmQvnkRi750a7tJ_U3us',
      // Gemini 2.5 Flash - best available model, up to 1M tokens
      endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent'
    },
    openai: {
      apiKey: 'YOUR_OPENAI_API_KEY',
      endpoint: 'https://api.openai.com/v1/chat/completions',
      model: 'gpt-3.5-turbo'
    }
  };

  // Helper function to call Gemini API with proper error handling
  async function callGeminiAPI(prompt) {
    const response = await fetch(`${AI_CONFIG.gemini.endpoint}?key=${AI_CONFIG.gemini.apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{
          parts: [{ text: prompt }]
        }],
        generationConfig: {
          temperature: 0.7,
          maxOutputTokens: 8192,
        },
        safetySettings: [
          { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
          { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
          { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
          { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
        ]
      })
    });
    
    const data = await response.json();
    
    // Check for API errors
    if (data.error) {
      console.error('Gemini API Error:', data.error);
      throw new Error(data.error.message || 'Gemini API returned an error');
    }
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${data.error?.message || 'Request failed'}`);
    }
    
    // Check if blocked by safety filters
    if (data.candidates?.[0]?.finishReason === 'SAFETY') {
      throw new Error('Content was blocked by safety filters');
    }
    
    // Check if response was truncated
    const finishReason = data.candidates?.[0]?.finishReason;
    if (finishReason === 'MAX_TOKENS' || finishReason === 'LENGTH') {
      throw new Error('AI response was truncated. Try reducing the number of tasks.');
    }
    
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
    if (!text) {
      console.error('Empty response from Gemini:', data);
      throw new Error('Empty response from AI');
    }
    
    return text;
  }

  // Helper function to call OpenAI API
  async function callOpenAIAPI(prompt) {
    const response = await fetch(AI_CONFIG.openai.endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${AI_CONFIG.openai.apiKey}`
      },
      body: JSON.stringify({
        model: AI_CONFIG.openai.model,
        messages: [{ role: 'user', content: prompt }],
        temperature: 0.7,
        max_tokens: 1024
      })
    });
    
    const data = await response.json();
    
    if (data.error) {
      throw new Error(data.error.message || 'OpenAI API error');
    }
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: Request failed`);
    }
    
    const text = data.choices?.[0]?.message?.content;
    if (!text) {
      throw new Error('Empty response from AI');
    }
    
    return text;
  }

  // Parse JSON from AI response (handles markdown code blocks and various formats)
  function parseAIJsonResponse(text) {
    console.log('Raw AI response:', text); // Debug log
    
    // Check for truncation indicators
    if (text.length > 0 && !text.includes(']') && !text.includes('}')) {
      throw new Error('AI response appears truncated (no closing brackets). Try reducing task count or simplifying.');
    }
    
    // Remove markdown code blocks if present
    let cleaned = text.trim();
    
    // Handle ```json ... ``` or ``` ... ```
    cleaned = cleaned.replace(/^```(?:json|JSON)?\s*\n?/i, '');
    cleaned = cleaned.replace(/\n?```\s*$/i, '');
    cleaned = cleaned.trim();
    
    // Handle cases where AI adds explanation before/after JSON
    // Try to find JSON array first
    const arrayMatch = cleaned.match(/\[[\s\S]*?\]/);
    if (arrayMatch) {
      try {
        const parsed = JSON.parse(arrayMatch[0]);
        if (Array.isArray(parsed)) {
          console.log('Parsed JSON array:', parsed);
          return parsed;
        }
      } catch (e) {
        // Continue to other methods
      }
    }
    
    // Try to find JSON object
    const objectMatch = cleaned.match(/\{[\s\S]*?\}/);
    if (objectMatch) {
      try {
        const parsed = JSON.parse(objectMatch[0]);
        console.log('Parsed JSON object:', parsed);
        return parsed;
      } catch (e) {
        // Continue to other methods
      }
    }
    
    // Try direct parse
    try {
      const parsed = JSON.parse(cleaned);
      console.log('Parsed JSON directly:', parsed);
      return parsed;
    } catch (e) {
      // Try to extract nested JSON array (greedy match)
      const greedyArrayMatch = cleaned.match(/\[[\s\S]*\]/);
      if (greedyArrayMatch) {
        try {
          const parsed = JSON.parse(greedyArrayMatch[0]);
          console.log('Parsed JSON (greedy array):', parsed);
          return parsed;
        } catch (e2) {
          // Last resort: try to fix common issues
        }
      }
      
      console.error('Failed to parse AI response as JSON:', cleaned);
      throw new Error('Could not parse AI response as JSON');
    }
  }

  // Call AI API with automatic provider selection
  async function callAI(prompt) {
    const provider = AI_CONFIG.provider;
    
    if (provider === 'gemini') {
      return await callGeminiAPI(prompt);
    } else if (provider === 'openai') {
      return await callOpenAIAPI(prompt);
    } else {
      throw new Error('No AI provider configured');
    }
  }

  // Call AI API to break down a task into subtasks
  async function breakDownTaskWithAI(taskTitle, taskNotes = '') {
    const prompt = `You are a productivity assistant. Break down this task into 3-7 actionable, specific subtasks.

Task: "${taskTitle}"
${taskNotes ? `Context: ${taskNotes}` : ''}

Rules:
- Each subtask should be clear and actionable
- Use Hebrew if the task title is in Hebrew, otherwise use English
- Return ONLY a JSON array of strings, nothing else

Example output format:
["Research topic thoroughly", "Create outline", "Write first draft", "Edit and revise", "Final review"]

Your response (JSON array only):`;

    try {
      const text = await callAI(prompt);
      const subtasks = parseAIJsonResponse(text);
      
      if (!Array.isArray(subtasks) || subtasks.length === 0) {
        throw new Error('Invalid response format');
      }
      
      // Ensure all items are strings
      return subtasks.map(s => String(s).trim()).filter(s => s.length > 0);
      
    } catch (error) {
      console.error('AI breakdown error:', error);
      
      // Fallback to local breakdown
      console.log('Falling back to local task breakdown...');
      return generateLocalSubtasks(taskTitle);
    }
  }

  // Local fallback for task breakdown (no API needed)
  function generateLocalSubtasks(taskTitle) {
    const title = taskTitle.toLowerCase();
    
    // Common task patterns with Hebrew support
    if (title.includes('×›×ª×•×‘') || title.includes('write') || title.includes('essay') || title.includes('paper') || title.includes('×ž××ž×¨')) {
      return ['×ž×—×§×¨ ×•×—×§×™×¨×”', '×™×¦×™×¨×ª ×ž×ª××¨', '×›×ª×™×‘×ª ×˜×™×•×˜×” ×¨××©×•× ×”', '×¢×¨×™×›×” ×•×©×™×¤×•×¨', '×”×’×”×” ×¡×•×¤×™×ª'];
    }
    if (title.includes('×œ×ž×“') || title.includes('learn') || title.includes('study') || title.includes('×œ×™×ž×•×“')) {
      return ['××™×¡×•×£ ×—×•×ž×¨×™ ×œ×™×ž×•×“', '×§×¨×™××” ×¨××©×•× ×™×ª', '×¨×™×©×•× ×”×¢×¨×•×ª', '×ª×¨×’×•×œ ×•×‘×—×™× ×” ×¢×¦×ž×™×ª', '×¡×™×›×•×'];
    }
    if (title.includes('project') || title.includes('×¤×¨×•×™×§×˜')) {
      return ['×”×’×“×¨×ª ×™×¢×“×™×', '×ª×›× ×•×Ÿ ×ž×©×™×ž×•×ª', '×‘×™×¦×•×¢ ×©×œ×‘ 1', '×‘×™×¦×•×¢ ×©×œ×‘ 2', '×‘×“×™×§×•×ª', '×¡×™×›×•×'];
    }
    if (title.includes('meeting') || title.includes('×¤×’×™×©×”')) {
      return ['×”×›× ×ª ×¡×“×¨ ×™×•×', '××™×¡×•×£ ×—×•×ž×¨×™×', '×©×œ×™×—×ª ×”×–×ž× ×•×ª', '×”×›× ×ª ×ž×¦×’×ª', '×¡×™×›×•× ×¤×’×™×©×”'];
    }
    if (title.includes('event') || title.includes('××™×¨×•×¢') || title.includes('party') || title.includes('×ž×¡×™×‘×”')) {
      return ['×ª×›× ×•×Ÿ ×•×ª×§×¦×™×‘', '×”×–×ž× ×ª ×ž×§×•×', '×©×œ×™×—×ª ×”×–×ž× ×•×ª', '×”×–×ž× ×ª ××•×›×œ', '×”×›× ×•×ª ××—×¨×•× ×•×ª'];
    }
    
    // Generic breakdown
    return ['×ª×›× ×•×Ÿ ×•×ž×—×§×¨', '×”×›× ×”', '×‘×™×¦×•×¢ ×¢×™×§×¨×™', '×‘×“×™×§×” ×•×¡×§×™×¨×”', '×¡×™×•×'];
  }

  // Persistent storage for heuristic auto-schedule (separate from planner module)
  const DAILY_PLAN_STORAGE_KEY = 'dailyPlanData';
  let dailyPlanData = {};

  (function initDailyPlanData() {
    try {
      const saved = localStorage.getItem(DAILY_PLAN_STORAGE_KEY);
      dailyPlanData = saved ? JSON.parse(saved) : {};
    } catch (e) {
      console.error('Error loading daily plan data:', e);
      dailyPlanData = {};
    }
  })();

  function saveDailyPlanData() {
    try {
      localStorage.setItem(DAILY_PLAN_STORAGE_KEY, JSON.stringify(dailyPlanData));
    } catch (e) {
      console.error('Error saving daily plan data:', e);
    }
  }

  // ========================================
  // AI CHAT ASSISTANT
  // ========================================
  
  const AIChat = (() => {
    const modal = document.getElementById('aiChatModal');
    const messagesContainer = document.getElementById('aiChatMessages');
    const input = document.getElementById('aiChatInput');
    const sendBtn = document.getElementById('aiChatSend');
    const closeBtn = document.getElementById('aiChatClose');
    
    function addMessage(text, isUser = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `ai-chat-message ${isUser ? 'user' : 'ai'}`;
      messageDiv.innerHTML = `
        <div class="ai-chat-avatar">${isUser ? 'ðŸ‘¤' : 'ðŸ¤–'}</div>
        <div class="ai-chat-bubble">${escapeHtml(text).replace(/\n/g, '<br>')}</div>
      `;
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    async function processUserMessage(message) {
      addMessage(message, true);
      sendBtn.disabled = true;
      
      try {
        const prompt = `You are a task management AI assistant. Parse this user request and return actions as JSON.

User: "${message}"

Current tasks context: ${tasks.length} tasks exist.

Available actions:
- addTask: {action: "addTask", title: "...", dueDate: "YYYY-MM-DD", dueTime: "HH:MM", priority: "urgent|high|medium|low", estimatedMinutes: 60}
- editTask: {action: "editTask", taskId: "...", updates: {title, priority, etc}}
- scheduleTask: {action: "scheduleTask", taskId: "...", date: "YYYY-MM-DD", time: "HH:MM"}
- planDay: {action: "planDay", date: "YYYY-MM-DD"}
- reply: {action: "reply", message: "..."}

Return JSON with: {actions: [...], reply: "confirmation message"}

Examples:
- "Add task: Buy milk tomorrow at 5pm" â†’ addTask with title, due date
- "Schedule my tasks" â†’ planDay for today
- "Change first task to urgent" â†’ Need task list, ask for clarification

JSON:`;

        const aiResponse = await callAI(prompt);
        const parsed = parseAIJsonResponse(aiResponse);
        
        if (!parsed.actions || !Array.isArray(parsed.actions)) {
          throw new Error('Invalid AI response format');
        }
        
        // Execute actions
        for (const action of parsed.actions) {
          await executeAction(action);
        }
        
        // Show reply
        addMessage(parsed.reply || 'Done!');
        
      } catch (error) {
        console.error('AI Chat error:', error);
        addMessage(`Error: ${error.message}\n\nTry simpler commands like:\n- "Add task: Task name"\n- "Schedule tasks for today"`);
      } finally {
        sendBtn.disabled = false;
      }
    }
    
    async function executeAction(action) {
      switch (action.action) {
        case 'addTask':
          const newTask = {
            title: action.title || 'New Task',
            completed: false,
            priority: action.priority || 'medium',
            estimatedMinutes: action.estimatedMinutes || 60,
            notes: action.notes || ''
          };
          
          if (action.dueDate) {
            const dueDateTime = action.dueTime 
              ? new Date(`${action.dueDate}T${action.dueTime}`)
              : new Date(`${action.dueDate}T09:00`);
            newTask.dueDate = dueDateTime.toISOString();
          }
          
          await saveTask(null, newTask, null);
          if (typeof renderTasks === 'function') renderTasks();
          break;
          
        case 'planDay':
          if (typeof DailyPlanner !== 'undefined') {
            // Trigger plan day for specified date
            addMessage('Planning your day...');
          }
          break;
          
        case 'reply':
          // Just a reply, no action needed
          break;
      }
    }
    
    function init() {
      if (!modal) return;
      
      // Open modal
      document.getElementById('aiChatBtn')?.addEventListener('click', () => {
        modal.classList.add('open');
        input?.focus();
      });
      
      // Close modal
      closeBtn?.addEventListener('click', () => modal.classList.remove('open'));
      modal?.addEventListener('click', (e) => {
        if (e.target === modal) modal.classList.remove('open');
      });
      
      // Send message
      const sendMessage = () => {
        const message = input?.value.trim();
        if (!message) return;
        input.value = '';
        processUserMessage(message);
      };
      
      sendBtn?.addEventListener('click', sendMessage);
      input?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
      });
      
      // Example clicks
      document.querySelectorAll('.ai-chat-example').forEach(ex => {
        ex.addEventListener('click', () => {
          const example = ex.dataset.example;
          if (input) input.value = example;
          input?.focus();
        });
      });
    }
    
    return { init };
  })();
  
  // Initialize AI Chat after DOM loads
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => AIChat.init());
  } else {
    AIChat.init();
  }

  // ========================================
  // END AI CHAT ASSISTANT
  // ========================================

  // Auto-schedule tasks in daily planner using smart heuristics
  async function autoScheduleTasks() {
    const unscheduledTasks = tasks.filter(t => !t.completed && t.dueDate && !t.plannedDate);
    if (unscheduledTasks.length === 0) {
      alert('××™×Ÿ ×ž×©×™×ž×•×ª ×œ×ª×–×ž×•×Ÿ / No tasks to schedule');
      return;
    }

    // Sort by priority and due date
    const sortedTasks = [...unscheduledTasks].sort((a, b) => {
      const priorityOrder = { urgent: 0, high: 1, medium: 2, low: 3, none: 4 };
      const aPri = priorityOrder[a.priority || 'none'];
      const bPri = priorityOrder[b.priority || 'none'];
      if (aPri !== bPri) return aPri - bPri;
      
      const aDate = new Date(a.dueDate).getTime();
      const bDate = new Date(b.dueDate).getTime();
      return aDate - bDate;
    });

    // Find available time slots in the next 7 days
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    let scheduled = 0;
    const workHours = { start: 9, end: 21 }; // 9 AM to 9 PM
    
    for (const task of sortedTasks) {
      const dueDate = new Date(task.dueDate);
      dueDate.setHours(0, 0, 0, 0);
      
      // Try to schedule task in the next 7 days or before due date
      const maxDays = Math.min(7, Math.max(1, Math.ceil((dueDate - today) / (24 * 60 * 60 * 1000))));
      
      let scheduledSlot = false;
      for (let dayOffset = 0; dayOffset < maxDays && !scheduledSlot; dayOffset++) {
        const checkDate = new Date(today);
        checkDate.setDate(checkDate.getDate() + dayOffset);
        const dateKey = toDateKey(checkDate);
        
        // Get existing blocks for this day
        const dayBlocks = (dailyPlanData[dateKey] || []);
        
        // Find available slots (simple heuristic)
        const duration = task.estimatedMinutes || 60;
        
        for (let hour = workHours.start; hour < workHours.end && !scheduledSlot; hour++) {
          const slotTime = `${String(hour).padStart(2, '0')}:00`;
          const slotStart = new Date(`${dateKey}T${slotTime}`);
          const slotEnd = new Date(slotStart.getTime() + duration * 60000);
          
          // Check if slot is free
          const hasConflict = dayBlocks.some(block => {
            const blockStart = new Date(`${dateKey}T${block.time}`);
            const blockEnd = new Date(blockStart.getTime() + (block.duration || 60) * 60000);
            return (slotStart < blockEnd && slotEnd > blockStart);
          });
          
          if (!hasConflict) {
            const block = {
              id: `auto-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
              time: slotTime,
              duration: duration,
              type: 'task',
              taskId: task.id,
              title: task.title,
              color: task.color || (task.subject ? subjects.find(s => s.id === task.subject)?.color : null) || '#667eea'
            };
            
            if (!dailyPlanData[dateKey]) dailyPlanData[dateKey] = [];
            dailyPlanData[dateKey].push(block);
            
            // Update task with planned date
            const { id, isOwn, isShared, ...clean } = task;
            saveTask(task.id, { ...clean, plannedDate: dateKey, plannedTime: slotTime }, task.subject);
            
            scheduled++;
            scheduledSlot = true;
          }
        }
      }
    }
    
    saveDailyPlanData();
    if (typeof renderDailyPlanner === 'function') renderDailyPlanner();
    if (typeof renderTasks === 'function') renderTasks();
    
    alert(`âœ… ×ª×•×–×ž× ×• ${scheduled} ×ž×©×™×ž×•×ª ××•×˜×•×ž×˜×™×ª / Scheduled ${scheduled} tasks automatically`);
  }

  // Get AI suggestions for task prioritization
  async function getAISuggestionsForTasks() {
    const activeTasks = tasks.filter(t => !t.completed && t.title);
    if (activeTasks.length === 0) {
      alert('××™×Ÿ ×ž×©×™×ž×•×ª ×œ× ×™×ª×•×— / No tasks to analyze');
      return;
    }

    try {
      const taskList = activeTasks.slice(0, 20).map(t => ({ // Limit to 20 tasks
        title: t.title,
        due: t.dueDate ? new Date(t.dueDate).toLocaleDateString('he-IL') : 'no due date',
        currentPriority: t.priority || 'none'
      }));

      const prompt = `You are a productivity expert. Analyze these tasks and suggest priority levels.

Tasks:
${taskList.map((t, i) => `${i + 1}. "${t.title}" - Due: ${t.due} - Current: ${t.currentPriority}`).join('\n')}

For each task, assign one of: urgent, high, medium, low
Consider:
- Tasks due soon should be urgent/high
- Complex tasks need more time
- Simple tasks can be lower priority

Return ONLY a JSON array with objects in the SAME ORDER as the tasks above.
Each object must have: {"priority": "urgent|high|medium|low", "reason": "brief 3-5 word reason"}

Example: [{"priority": "urgent", "reason": "Due tomorrow"}, {"priority": "medium", "reason": "Week away"}]

Your response (JSON array only):`;

      const text = await callAI(prompt);
      const suggestions = parseAIJsonResponse(text);
      
      if (!Array.isArray(suggestions)) {
        throw new Error('Invalid response format');
      }

      // Apply suggestions
      let applied = 0;
      const validPriorities = ['urgent', 'high', 'medium', 'low'];
      
      suggestions.forEach((sug, idx) => {
        if (idx < activeTasks.length && sug && validPriorities.includes(sug.priority)) {
          const task = activeTasks[idx];
          const { id, isOwn, isShared, ...clean } = task;
          saveTask(task.id, { ...clean, priority: sug.priority }, task.subject);
          applied++;
        }
      });

      if (typeof renderTasks === 'function') renderTasks();
      alert(`âœ… ×¢×•×“×›× ×• ${applied} ×ž×©×™×ž×•×ª ×¢× ×¢×“×™×¤×•×™×•×ª ×ž×•×¦×¢×•×ª / Updated ${applied} tasks with AI suggestions`);

    } catch (error) {
      console.error('AI suggestions error:', error);
      
      // Offer to use local prioritization
      const useLocal = confirm(`âŒ ×©×’×™××ª AI: ${error.message}\n\n×”×× ×œ×”×©×ª×ž×© ×‘×ª×™×¢×“×•×£ ××•×˜×•×ž×˜×™ ×œ×¤×™ ×ª××¨×™×›×™×?\nUse automatic prioritization based on due dates?`);
      
      if (useLocal) {
        applyLocalPrioritySuggestions();
      }
    }
  }

  // Local fallback for priority suggestions (no API needed)
  function applyLocalPrioritySuggestions() {
    const activeTasks = tasks.filter(t => !t.completed && t.title);
    const now = new Date();
    let applied = 0;
    
    activeTasks.forEach(task => {
      let newPriority = 'none';
      
      if (task.dueDate) {
        const dueDate = new Date(task.dueDate);
        const daysUntilDue = Math.ceil((dueDate - now) / (24 * 60 * 60 * 1000));
        
        if (daysUntilDue <= 0) {
          newPriority = 'urgent'; // Overdue
        } else if (daysUntilDue <= 1) {
          newPriority = 'urgent'; // Due today or tomorrow
        } else if (daysUntilDue <= 3) {
          newPriority = 'high'; // Due in 2-3 days
        } else if (daysUntilDue <= 7) {
          newPriority = 'medium'; // Due this week
        } else {
          newPriority = 'low'; // Due later
        }
      }
      
      if (newPriority !== (task.priority || 'none')) {
        const { id, isOwn, isShared, ...clean } = task;
        saveTask(task.id, { ...clean, priority: newPriority }, task.subject);
        applied++;
      }
    });
    
    if (typeof renderTasks === 'function') renderTasks();
    alert(`âœ… ×¢×•×“×›× ×• ${applied} ×ž×©×™×ž×•×ª ×œ×¤×™ ×ª××¨×™×›×™ ×™×¢×“ / Updated ${applied} tasks based on due dates`);
  }

  // Quick AI breakdown from task list (without opening edit modal)
  async function handleQuickAIBreakdown(task) {
    if (!task || !task.title) {
      alert('××™×Ÿ ×›×•×ª×¨×ª ×œ×ž×©×™×ž×” / No task title');
      return;
    }
    
    // Show loading indicator
    const loadingToast = document.createElement('div');
    loadingToast.className = 'ai-loading-toast';
    loadingToast.innerHTML = `
      <div class="ai-loading-spinner"></div>
      <span>AI ×ž×¤×¨×§ ××ª ×”×ž×©×™×ž×”... / Breaking down task...</span>
    `;
    document.body.appendChild(loadingToast);
    
    try {
      const subtasks = await breakDownTaskWithAI(task.title, task.notes || '');
      
      // Convert to checklist format
      const checklist = subtasks.map(text => ({
        text: text,
        checked: false
      }));
      
      // Merge with existing checklist if any
      const existingChecklist = task.checklist || [];
      const mergedChecklist = [...existingChecklist, ...checklist];
      
      // Save the task with new subtasks
      const { id, isOwn, isShared, ...clean } = task;
      saveTask(task.id, { ...clean, checklist: mergedChecklist }, task.subject);
      
      // Remove loading toast
      loadingToast.remove();
      
      // Refresh UI
      if (typeof renderTasks === 'function') renderTasks();
      
      // Success message
      alert(`âœ… × ×•×¡×¤×• ${checklist.length} ×ž×©×™×ž×•×ª ×ž×©× ×” / Added ${checklist.length} subtasks`);
      
    } catch (error) {
      console.error('Quick AI breakdown error:', error);
      loadingToast.remove();
      alert(`âŒ ×©×’×™××”: ${error.message}`);
    }
  }

  // ========================================
  // END AI-POWERED FEATURES
  // ========================================

  // Persist sidebar width
  const savedWidth = localStorage.getItem(STORAGE_KEYS.SIDEBAR_WIDTH);
  if (savedWidth) sidebar.style.width = savedWidth;

  const resizeObserver = new ResizeObserver(() => {
    localStorage.setItem(STORAGE_KEYS.SIDEBAR_WIDTH, sidebar.style.width || sidebar.offsetWidth + 'px');
  });
  resizeObserver.observe(sidebar);

  function parseLocal(value) {
    const match = String(value || "").match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})$/);
    if (!match) return null;
    const [, Y, Mo, D, H, Mi] = match;
    return new Date(+Y, +Mo - 1, +D, +H, +Mi, 0, 0);
  }

  function toLocalDatetime(isoString) {
    const d = new Date(isoString);
    const pad = n => String(n).padStart(2, '0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function toDateKey(date) {
    const d = new Date(date);
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }

  const cachedEvents = readCache(CACHE_KEYS.EVENTS);
  if (cachedEvents && cachedEvents.length) {
    events = cachedEvents;
    eventsById.clear();
    events.forEach(e => eventsById.set(e.id, e));
    hasEventsCache = true;
    syncCacheUsed.events = true;
    eventsLoaded = true;
    setEventsLoading(false);
    updateSyncBadge();
    render();
    scheduleCalendarRender();
    startTicker();
  } else {
    setEventsLoading(true);
  }

  function getMonthEvents() {
    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth();
    return getActiveEvents().filter(evt => {
      const d = new Date(evt.date);
      return d.getFullYear() === year && d.getMonth() === month;
    }).sort((a, b) => new Date(a.date) - new Date(b.date));
  }

  function renderMonthEventsList() {
    const monthEvents = getMonthEvents();
    monthEventsTitle.textContent = `××™×¨×•×¢×™ ${HEBREW_MONTHS[currentMonth.getMonth()]}`;

    if (monthEvents.length === 0) {
      monthEventsEl.innerHTML = '<div class="no-events-msg">××™×Ÿ ××™×¨×•×¢×™× ×”×—×•×“×©</div>';
      return;
    }

    monthEventsEl.innerHTML = monthEvents.map(evt => {
      const color = getEventColor(evt.id);
      const d = new Date(evt.date);
      const dateStr = `${d.getDate()}/${d.getMonth()+1} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
      return `
        <div class="month-event-item" style="border-right-color: ${color}">
          <div class="month-event-color" style="background: ${color}"></div>
          <div class="month-event-info">
            <div class="month-event-name">${escapeHtml(evt.name)}</div>
            <div class="month-event-date">${dateStr}</div>
          </div>
        </div>
      `;
    }).join('');
  }

  function renderCalendar() {
    const today = new Date();
    const todayKey = toDateKey(today);
    
    // Build event map by date
    const eventsByDate = {};
    getActiveEvents().forEach(evt => {
      const key = toDateKey(evt.date);
      if (!eventsByDate[key]) eventsByDate[key] = [];
      eventsByDate[key].push(evt);
    });

    let html = '';
    const sidebar = $("sidebar");
    
    // Update view classes on sidebar
    if (sidebar) {
      sidebar.classList.toggle('calendar-view-week', eventCalendarView === 'week');
      sidebar.classList.toggle('calendar-view-day', eventCalendarView === 'day');
    }

    if (eventCalendarView === 'month') {
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();
      calendarTitle.textContent = `${HEBREW_MONTHS[month]} ${year}`;

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDay = firstDay.getDay();
      const daysInMonth = lastDay.getDate();

      // Day names
      for (let i = 0; i < 7; i++) {
        html += `<div class="calendar-day-name">${HEBREW_DAYS[i]}</div>`;
      }

      // Previous month days
      const prevMonth = new Date(year, month, 0);
      const prevDays = prevMonth.getDate();
      for (let i = startDay - 1; i >= 0; i--) {
        const day = prevDays - i;
        html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
      }

      // Current month days
      for (let day = 1; day <= daysInMonth; day++) {
        const dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const isToday = dateKey === todayKey;
        const dayEvents = eventsByDate[dateKey] || [];

        let classes = 'calendar-day';
        if (isToday) classes += ' today';

        let eventsHtml = '<div class="calendar-day-events">';
        const maxShow = 2;
        const showTime = dayEvents.length > 1;
        dayEvents.slice(0, maxShow).forEach(evt => {
          const color = getEventColor(evt.id);
          const safeName = escapeHtml(evt.name);
          const evtDate = new Date(evt.date);
          const timeStr = showTime ? `${String(evtDate.getHours()).padStart(2,'0')}:${String(evtDate.getMinutes()).padStart(2,'0')} ` : '';
          const displayText = timeStr + safeName;
          eventsHtml += `<div class="calendar-event-chip" style="background: ${color}" title="${safeName}" aria-label="${safeName}" data-event-id="${evt.id}">${displayText}</div>`;
        });
        if (dayEvents.length > maxShow) {
          eventsHtml += `<div class="calendar-more">+${dayEvents.length - maxShow} ×¢×•×“</div>`;
        }
        eventsHtml += '</div>';

        html += `<div class="${classes}" data-date="${dateKey}">
          <div class="calendar-day-number">${day}</div>
          ${eventsHtml}
        </div>`;
      }

      // Next month days
      const totalCells = startDay + daysInMonth;
      const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
      for (let i = 1; i <= remainingCells; i++) {
        html += `<div class="calendar-day other-month"><div class="calendar-day-number">${i}</div></div>`;
      }
    } else if (eventCalendarView === 'week') {
      const focus = eventCalendarFocusDate || new Date();
      const start = getStartOfWeek(focus);
      const end = new Date(start);
      end.setDate(start.getDate() + 6);
      calendarTitle.textContent = `×©×‘×•×¢ ${formatHebrewShortDate(start)} - ${formatHebrewShortDate(end)}`;

      for (let i = 0; i < 7; i++) {
        const dayDate = new Date(start);
        dayDate.setDate(start.getDate() + i);
        html += `<div class="calendar-day-name">${HEBREW_DAYS[dayDate.getDay()]}</div>`;
      }

      for (let i = 0; i < 7; i++) {
        const dayDate = new Date(start);
        dayDate.setDate(start.getDate() + i);
        const dateKey = toDateKey(dayDate);
        const dayEvents = eventsByDate[dateKey] || [];
        const isToday = dateKey === todayKey;
        let classes = 'calendar-day';
        if (isToday) classes += ' today';

        let eventsHtml = '<div class="calendar-day-events">';
        const maxShow = 4;
        dayEvents.slice(0, maxShow).forEach(evt => {
          const color = getEventColor(evt.id);
          const safeName = escapeHtml(evt.name);
          const evtDate = new Date(evt.date);
          const timeStr = `${String(evtDate.getHours()).padStart(2,'0')}:${String(evtDate.getMinutes()).padStart(2,'0')} `;
          eventsHtml += `<div class="calendar-event-chip" style="background: ${color}" title="${safeName}" data-event-id="${evt.id}">${timeStr}${safeName}</div>`;
        });
        if (dayEvents.length > maxShow) {
          eventsHtml += `<div class="calendar-more">+${dayEvents.length - maxShow} ×¢×•×“</div>`;
        }
        eventsHtml += '</div>';

        html += `<div class="${classes}" data-date="${dateKey}">
          <div class="calendar-day-number">${dayDate.getDate()}</div>
          ${eventsHtml}
        </div>`;
      }
    } else if (eventCalendarView === 'day') {
      const focus = eventCalendarFocusDate || new Date();
      const dateKey = toDateKey(focus);
      const dayEvents = eventsByDate[dateKey] || [];
      const dayOfWeek = focus.getDay();
      const hebrewDayNames = ['×™×•× ×¨××©×•×Ÿ', '×™×•× ×©× ×™', '×™×•× ×©×œ×™×©×™', '×™×•× ×¨×‘×™×¢×™', '×™×•× ×—×ž×™×©×™', '×™×•× ×©×™×©×™', '×©×‘×ª'];
      calendarTitle.textContent = `${hebrewDayNames[dayOfWeek]}, ${formatHebrewShortDate(focus)}`;

      html += `<div class="calendar-day-name">${hebrewDayNames[dayOfWeek]}</div>`;

      const isToday = dateKey === todayKey;
      let classes = 'calendar-day';
      if (isToday) classes += ' today';

      let eventsHtml = '<div class="calendar-day-events">';
      dayEvents.forEach(evt => {
        const color = getEventColor(evt.id);
        const safeName = escapeHtml(evt.name);
        const evtDate = new Date(evt.date);
        const timeStr = `${String(evtDate.getHours()).padStart(2,'0')}:${String(evtDate.getMinutes()).padStart(2,'0')} `;
        eventsHtml += `<div class="calendar-event-chip" style="background: ${color}" title="${safeName}" data-event-id="${evt.id}">${timeStr}${safeName}</div>`;
      });
      if (dayEvents.length === 0) {
        eventsHtml += `<div class="no-events-msg" style="padding: 20px; text-align: center;">××™×Ÿ ××™×¨×•×¢×™× ×‘×™×•× ×–×”</div>`;
      }
      eventsHtml += '</div>';

      html += `<div class="${classes}" data-date="${dateKey}">
        <div class="calendar-day-number">${focus.getDate()}</div>
        ${eventsHtml}
      </div>`;
    }

    calendarGrid.innerHTML = html;
    renderMonthEventsList();
  }
  
  // Day Drawer functionality
  const dayDrawer = $("dayDrawer");
  const dayDrawerTitle = $("dayDrawerTitle");
  const dayDrawerSubtitle = $("dayDrawerSubtitle");
  const dayEventsList = $("dayEventsList");
  const dayTasksList = $("dayTasksList");
  const dayEventsCount = $("dayEventsCount");
  const dayTasksCount = $("dayTasksCount");
  const closeDayDrawerBtn = $("closeDayDrawer");
  const addEventToDay = $("addEventToDay");
  const addTaskToDay = $("addTaskToDay");
  
  let selectedDayKey = null;
  
  function openDayDrawer(dateKey) {
    selectedDayKey = dateKey;
    const [year, month, day] = dateKey.split('-').map(Number);
    const date = new Date(year, month - 1, day);
    
    // Format title (Hebrew day + date)
    const dayOfWeek = date.getDay();
    const hebrewDayNames = ['×™×•× ×¨××©×•×Ÿ', '×™×•× ×©× ×™', '×™×•× ×©×œ×™×©×™', '×™×•× ×¨×‘×™×¢×™', '×™×•× ×—×ž×™×©×™', '×™×•× ×©×™×©×™', '×©×‘×ª'];
    dayDrawerTitle.textContent = hebrewDayNames[dayOfWeek];
    dayDrawerSubtitle.textContent = `${day} ×‘${HEBREW_MONTHS[month - 1]} ${year}`;
    
    // Get events for this day
    const dayEvents = getActiveEvents().filter(evt => toDateKey(evt.date) === dateKey)
      .sort((a, b) => new Date(a.date) - new Date(b.date));
    
    // Get tasks due this day (need to access tasks array from task manager scope)
    const allTasks = (typeof tasks !== 'undefined' && Array.isArray(tasks)) ? tasks : [];
    const dayTasks = allTasks.filter(task => {
      if (!task.dueDate) return false;
      return toDateKey(task.dueDate) === dateKey;
    }).sort((a, b) => {
      // Sort by completed, then priority
      if (a.completed !== b.completed) return a.completed ? 1 : -1;
      const PRIORITY_ORDER = { urgent: 0, high: 1, medium: 2, low: 3, none: 4 };
      return (PRIORITY_ORDER[a.priority] || 4) - (PRIORITY_ORDER[b.priority] || 4);
    });
    
    // Update counts
    dayEventsCount.textContent = dayEvents.length;
    dayTasksCount.textContent = dayTasks.length;
    
    // Render events
    if (dayEvents.length === 0) {
      dayEventsList.innerHTML = '<div class="day-drawer-empty">××™×Ÿ ××™×¨×•×¢×™× ×‘×™×•× ×–×”</div>';
    } else {
      dayEventsList.innerHTML = dayEvents.map(evt => {
        const color = getEventColor(evt.id);
        const evtDate = new Date(evt.date);
        const timeStr = `${String(evtDate.getHours()).padStart(2,'0')}:${String(evtDate.getMinutes()).padStart(2,'0')}`;
        return `
          <div class="day-drawer-item" data-event-id="${evt.id}">
            <div class="day-drawer-item-color" style="background: ${color}"></div>
            <div class="day-drawer-item-info">
              <div class="day-drawer-item-name">${escapeHtml(evt.name)}</div>
              <div class="day-drawer-item-time">ðŸ• ${timeStr}</div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // Render tasks
    if (dayTasks.length === 0) {
      dayTasksList.innerHTML = '<div class="day-drawer-empty">××™×Ÿ ×ž×©×™×ž×•×ª ×‘×™×•× ×–×”</div>';
    } else {
      const PRIORITY_COLORS = { urgent: '#ef4444', high: '#f97316', medium: '#eab308', low: '#22c55e', none: '#6b7280' };
      const PRIORITY_BG = { urgent: 'rgba(239,68,68,0.15)', high: 'rgba(249,115,22,0.15)', medium: 'rgba(234,179,8,0.15)', low: 'rgba(34,197,94,0.15)', none: 'var(--day-other)' };
      const PRIORITY_LABELS_HE = { urgent: '×“×—×•×£', high: '×’×‘×•×”', medium: '×‘×™× ×•× ×™', low: '× ×ž×•×š', none: '' };
      
      dayTasksList.innerHTML = dayTasks.map(task => {
        const priority = task.priority || 'none';
        const priorityLabel = PRIORITY_LABELS_HE[priority];
        const completedClass = task.completed ? 'task-completed' : '';
        const due = task.dueDate ? new Date(task.dueDate) : null;
        const timeStr = due ? `${String(due.getHours()).padStart(2,'0')}:${String(due.getMinutes()).padStart(2,'0')}` : '';
        
        return `
          <div class="day-drawer-item ${completedClass}" data-task-id="${task.id}">
            <div class="day-drawer-item-color" style="background: ${PRIORITY_COLORS[priority]}"></div>
            <div class="day-drawer-item-info">
              <div class="day-drawer-item-name">${escapeHtml(task.title)}</div>
              ${timeStr ? `<div class="day-drawer-item-time">ðŸ• ${timeStr}</div>` : ''}
            </div>
            ${priorityLabel ? `<div class="day-drawer-item-priority" style="background: ${PRIORITY_BG[priority]}; color: ${PRIORITY_COLORS[priority]}">${priorityLabel}</div>` : ''}
          </div>
        `;
      }).join('');
    }
    
    // Add click handlers for items
    dayEventsList.querySelectorAll('.day-drawer-item').forEach(item => {
      item.addEventListener('click', () => {
        const eventId = item.dataset.eventId;
        if (eventId) {
          closeDayDrawer();
          // Scroll to event in main list
          setTimeout(() => {
            const eventRow = document.querySelector(`.event-row[data-id="${eventId}"]`);
            if (eventRow) {
              eventRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
              eventRow.style.transition = 'background 0.3s';
              eventRow.style.background = 'var(--accent)';
              setTimeout(() => { eventRow.style.background = ''; }, 800);
            }
          }, 200);
        }
      });
    });
    
    dayTasksList.querySelectorAll('.day-drawer-item').forEach(item => {
      item.addEventListener('click', () => {
        const taskId = item.dataset.taskId;
        if (taskId) {
          closeDayDrawer();
          // Open task manager and highlight task
          setTimeout(() => {
            if (typeof showView === 'function' && currentView !== 'tasks') {
              showView('tasks');
            } else {
              const tmOverlay = $("taskManagerOverlay");
              if (tmOverlay && !tmOverlay.classList.contains('open')) {
                tmOverlay.classList.add('open');
                if (typeof renderSubjectsSidebar === 'function') renderSubjectsSidebar();
                if (typeof renderTasks === 'function') renderTasks();
                if (typeof startTaskTicker === 'function') startTaskTicker();
              }
            }
            setTimeout(() => {
              const taskItem = document.querySelector(`.task-item[data-id="${taskId}"]`);
              if (taskItem) {
                taskItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                taskItem.style.transition = 'box-shadow 0.3s';
                taskItem.style.boxShadow = '0 0 0 3px var(--accent)';
                setTimeout(() => { taskItem.style.boxShadow = ''; }, 1000);
              }
            }, 300);
          }, 200);
        }
      });
    });
    
    dayDrawer.classList.add('open');
  }
  
  function closeDayDrawer() {
    dayDrawer.classList.remove('open');
    selectedDayKey = null;
  }
  
  closeDayDrawerBtn.onclick = closeDayDrawer;
  
  // Close on backdrop click
  dayDrawer.addEventListener('click', (e) => {
    if (e.target === dayDrawer) closeDayDrawer();
  });
  
  // Add event to selected day
  addEventToDay.onclick = () => {
    if (!selectedDayKey) return;
    const dateToUse = selectedDayKey; // Save before closing
    closeDayDrawer();
    eventDate.value = dateToUse + 'T12:00';
    eventName.focus();
    inputPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  };
  
  // Add task to selected day
  addTaskToDay.onclick = () => {
    if (!selectedDayKey) return;
    const dateToUse = selectedDayKey; // Save before closing
    closeDayDrawer();
    // Open task manager
    if (typeof showView === 'function' && currentView !== 'tasks') {
      showView('tasks');
    } else {
      const tmOverlay = $("taskManagerOverlay");
      if (tmOverlay) {
        tmOverlay.classList.add('open');
        if (typeof renderSubjectsSidebar === 'function') renderSubjectsSidebar();
        if (typeof renderTasks === 'function') renderTasks();
        if (typeof startTaskTicker === 'function') startTaskTicker();
      }
    }
    // Pre-fill the due date
    setTimeout(() => {
      const taskDueInput = $("newTaskDue");
      const taskTitleInput = $("newTaskTitle");
      const quickRow = $("quickAddRow");
      if (taskDueInput) taskDueInput.value = dateToUse + 'T23:59';
      if (taskTitleInput) taskTitleInput.focus();
      if (quickRow) quickRow.style.display = 'flex';
    }, 200);
  };

  $("prevMonth").onclick = () => {
    if (eventCalendarView === 'month') {
      currentMonth.setMonth(currentMonth.getMonth() - 1);
    } else if (eventCalendarView === 'week') {
      eventCalendarFocusDate.setDate(eventCalendarFocusDate.getDate() - 7);
    } else if (eventCalendarView === 'day') {
      eventCalendarFocusDate.setDate(eventCalendarFocusDate.getDate() - 1);
    }
    renderCalendar();
  };

  $("nextMonth").onclick = () => {
    if (eventCalendarView === 'month') {
      currentMonth.setMonth(currentMonth.getMonth() + 1);
    } else if (eventCalendarView === 'week') {
      eventCalendarFocusDate.setDate(eventCalendarFocusDate.getDate() + 7);
    } else if (eventCalendarView === 'day') {
      eventCalendarFocusDate.setDate(eventCalendarFocusDate.getDate() + 1);
    }
    renderCalendar();
  };
  
  // Today button - jump to current date
  const todayBtn = $("todayBtn");
  if (todayBtn) {
    todayBtn.onclick = () => {
      currentMonth = new Date();
      eventCalendarFocusDate = new Date();
      renderCalendar();
    };
  }
  
  // Event calendar view toggle
  const eventCalendarViewToggle = $("eventCalendarViewToggle");
  if (eventCalendarViewToggle) {
    eventCalendarViewToggle.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-view]');
      if (!btn) return;
      eventCalendarView = btn.dataset.view;
      eventCalendarFocusDate = new Date();
      eventCalendarViewToggle.querySelectorAll('button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      renderCalendar();
    });
  }

  startSyncTimeout('events', SYNC_TIMEOUT_MS, 'firebase', () => {
    eventsLoaded = true;
    setEventsLoading(false);
    render();
    scheduleCalendarRender();
    startTicker();
  });
  onValue(eventsRef, (snapshot) => {
    clearSyncTimeouts('events');
    const data = snapshot.val();
    eventsById.clear();
    if (data) {
      events = Object.keys(data).map(key => ({ id: key, ...data[key] }));
      events.forEach(e => eventsById.set(e.id, e));
    } else {
      events = [];
    }
    eventsLoaded = true;
    markSyncReady('events', 'firebase');
    writeCache(CACHE_KEYS.EVENTS, events, 300);
    setEventsLoading(false);
    render();
    // Defer heavy calendar render so list paints first
    scheduleCalendarRender();
    startTicker();
  }, (error) => {
    console.error('Events sync error:', error);
    clearSyncTimeouts('events');
    eventsLoaded = true;
    markSyncReady('events', 'error');
    setEventsLoading(false);
    updateSyncBadge();
  });

  const saveToCloud = async (eventData) => {
    const newEventRef = push(eventsRef);
    const id = newEventRef.key;

    // Optimistic UI
    upsertLocalEvent(id, eventData);
    render();
    scheduleCalendarRender();
    startTicker();
    writeCache(CACHE_KEYS.EVENTS, events, 300);

    try {
      await set(newEventRef, eventData);
    } catch (err) {
      // Rollback on failure
      events = events.filter(e => e.id !== id);
      eventsById.delete(id);
      render();
      scheduleCalendarRender();
      console.error(err);
      alert("Save failed (check connection).");
    }
  };

  const updateInCloud = async (id, data) => {
    const { id: _ignore, ...payload } = data;
    const prev = eventsById.get(id) ? { ...eventsById.get(id) } : null;

    // Optimistic UI
    upsertLocalEvent(id, payload);
    render();
    scheduleCalendarRender();
    writeCache(CACHE_KEYS.EVENTS, events, 300);

    try {
      await set(ref(db, 'events/' + id), payload);
    } catch (err) {
      // Rollback
      if (prev) upsertLocalEvent(id, prev);
      render();
      scheduleCalendarRender();
      console.error(err);
      alert("Update failed (check connection).");
    }
  };

  const deleteFromCloud = (id) => {
    remove(ref(db, 'events/' + id));
  };

  const clearAllCloud = () => {
    set(eventsRef, null);
  };

  function formatDate(iso) {
    const d = new Date(iso);
    const day = d.getDate();
    const month = d.toLocaleString('he-IL', { month: 'short' });
    const weekday = d.toLocaleString('he-IL', { weekday: 'short' });
    const time = d.toLocaleString('he-IL', { hour: '2-digit', minute: '2-digit' });
    return `${weekday}, ${day} ${month}, ${time}`;
  }
  
  function formatReminderOffset(minutes) {
    if (minutes >= 1440) {
      const days = Math.round(minutes / 1440);
      return days === 1 ? '1 day' : `${days} days`;
    }
    if (minutes >= 60) {
      const hours = Math.round(minutes / 60);
      return hours === 1 ? '1 hour' : `${hours} hours`;
    }
    return minutes === 1 ? '1 minute' : `${minutes} minutes`;
  }
  
  function playReminderSound() {
    if (!reminderAudio) return;
    reminderAudio.currentTime = 0;
    reminderAudio.play().catch(() => {
      console.log("Audio play failed (interaction needed)");
    });
  }
  
  function showEventAlert(title, message, playSound = false) {
    if (!eventAlertModal) return;
    if (alertTitle) alertTitle.textContent = title;
    if (alertMessage) alertMessage.textContent = message;
    eventAlertModal.classList.add('open');
    if (playSound) playReminderSound();
  }
  
	  function triggerAlert(evt) {
	    const reminderMinutes = parseInt(evt.reminder, 10) || 0;
	    const timeString = formatReminderOffset(reminderMinutes);
	    const msg = `${evt.name} starts in ${timeString}!`;
	    
	    if (document.hidden) {
	      if ("Notification" in window && Notification.permission === "granted") {
	        new Notification("Event Reminder â°", {
	          body: msg,
	          tag: `event-${evt.id || evt.name || 'reminder'}`
	        });
	      }
	      pendingEventAlert = { title: evt.name, message: `Starting in ${timeString}` };
	      return;
	    }
    
    showEventAlert(evt.name, `Starting in ${timeString}`, true);
  }

  function calcTime(target) {
    const diff = Math.max(0, new Date(target).getTime() - Date.now());
    return {
      ended: diff === 0,
      d: Math.floor(diff / 86400000),
      h: Math.floor((diff % 86400000) / 3600000),
      m: Math.floor((diff % 3600000) / 60000),
      s: Math.floor((diff % 60000) / 1000)
    };
  }

  function startEdit(id) {
    const evt = events.find(e => e.id === id);
    if (!evt) return;

    editingId = id;
    eventName.value = evt.name;
    eventDate.value = toLocalDatetime(evt.date);
    eventNotes.value = evt.notes || '';
    setReminderUIFromMinutes(evt.reminder || 0);
    addBtn.textContent = "Save";
    cancelBtn.style.display = "block";
    clearBtn.style.display = "none";
    inputPanel.classList.add("editing");
    eventName.focus();
  }

  function cancelEdit() {
    editingId = null;
    eventName.value = "";
    eventDate.value = "";
    eventNotes.value = "";
    setReminderUIFromMinutes(0);
    addBtn.textContent = "Add Event";
    cancelBtn.style.display = "none";
    clearBtn.style.display = "block";
    inputPanel.classList.remove("editing");
  }

  function setEventReminder(id, minutes) {
    const evt = events.find(e => e.id === id);
    if (!evt) return;
    
    const eventRef = ref(db, `events/${id}`);
    set(eventRef, { ...evt, reminder: minutes || null });
  }

  // Close reminder dropdowns when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.event-reminder-wrap')) {
      document.querySelectorAll('.event-reminder-dropdown.open').forEach(d => d.classList.remove('open'));
    }
  });

  function render() {
    refs.clear();
    const frag = document.createDocumentFragment();
    // Use getActiveEvents() to account for pending deletes
    emptyState.style.display = getActiveEvents().length ? "none" : "block";

    const now = Date.now();

    const sorted = [...events].filter(e => !pendingDeletes.has(e.id)).sort((a, b) => {
      // First sort by pinned status
      if (a.pinned && !b.pinned) return -1;
      if (!a.pinned && b.pinned) return 1;
      
      // Then by time
      const aTime = new Date(a.date).getTime();
      const bTime = new Date(b.date).getTime();
      const aEnded = aTime <= now;
      const bEnded = bTime <= now;

      if (!aEnded && bEnded) return -1;
      if (aEnded && !bEnded) return 1;
      return aTime - bTime;
    });

    const conflicts = findConflictingEvents(sorted);

    sorted.forEach((evt) => {
      const color = getEventColor(evt.id);
      const t = calcTime(evt.date);
      const hasConflict = conflicts.has(evt.id);

      const row = document.createElement("div");
      row.className = `event-row ${evt.highlighted ? 'highlighted' : ''}`;
      row.dataset.id = evt.id;

      if (evt.highlighted) {
        row.style.background = color + '12';
        row.style.borderColor = color;
      }

      const dot = document.createElement("span");
      dot.className = "color-dot";
      dot.style.background = color;

      const info = document.createElement("div");
      info.className = "event-info";

      const name = document.createElement("div");
      name.className = "event-name";
      name.textContent = evt.name;

      const date = document.createElement("div");
      date.className = "event-date";
      date.dataset.iso = evt.date;
      date.textContent = formatDate(evt.date);

      info.appendChild(name);
      info.appendChild(date);

      if (hasConflict) {
        const conflict = document.createElement("div");
        conflict.className = "conflict-badge";
        conflict.innerHTML = `<span class="conflict-dot"></span><span>×—×¤×™×¤×” ×¢× ××™×¨×•×¢ ×§×¨×•×‘</span>`;
        info.appendChild(conflict);
      }

      if (evt.notes) {
        const notes = document.createElement("div");
        notes.className = "event-notes";
        notes.textContent = evt.notes;
        info.appendChild(notes);
        if (evt.notes.length > 60 || evt.notes.includes('\n')) {
          const toggle = document.createElement("span");
          toggle.className = "notes-toggle";
          toggle.textContent = "×”×¦×’ ×¢×•×“";
          toggle.onclick = (e) => {
            e.stopPropagation();
            notes.classList.toggle('expanded');
            toggle.textContent = notes.classList.contains('expanded') ? "×”×¡×ª×¨" : "×”×¦×’ ×¢×•×“";
          };
          info.appendChild(toggle);
        }
      }

      const timer = document.createElement("div");
      timer.className = "timer";

      const units = [
        { key: 's', label: 'Sec' },
        { key: 'm', label: 'Min' },
        { key: 'h', label: 'Hrs' },
        { key: 'd', label: 'Days' }
      ];

      units.forEach(({ key, label }) => {
        const unit = document.createElement("div");
        unit.className = "time-unit";

        const val = document.createElement("span");
        val.className = `time-val time-${key}`;
        val.style.color = color;
        val.textContent = key === 'd' ? t[key] : String(t[key]).padStart(2, '0');

        const lbl = document.createElement("div");
        lbl.className = "time-label";
        lbl.textContent = label;

        unit.appendChild(val);
        unit.appendChild(lbl);
        timer.appendChild(unit);
      });

      const badge = document.createElement("span");
      badge.className = `badge ${t.ended ? 'badge-ended' : 'badge-upcoming'}`;
      badge.textContent = t.ended ? 'Ended' : 'Upcoming';

      const starBtn = document.createElement("button");
      starBtn.className = `star-btn ${evt.highlighted ? 'active' : ''}`;
      starBtn.textContent = "â˜†";

      const pinBtn = document.createElement("button");
      pinBtn.className = `pin-btn ${evt.pinned ? 'pinned' : ''}`;
      pinBtn.textContent = "ðŸ“Œ";
      pinBtn.title = evt.pinned ? "Unpin" : "Pin to top";

      const editBtn = document.createElement("button");
      editBtn.className = "edit-btn";
      editBtn.textContent = "âœŽ";
      editBtn.title = "Edit";

      // Reminder button with dropdown
      const reminderWrap = document.createElement("div");
      reminderWrap.className = "event-reminder-wrap";
      
      const reminderBtn = document.createElement("button");
      reminderBtn.className = `reminder-btn ${evt.reminder ? 'has-reminder' : ''}`;
      reminderBtn.textContent = "ðŸ””";
      reminderBtn.title = evt.reminder ? `×ª×–×›×•×¨×ª ${evt.reminder} ×“×§×•×ª ×œ×¤× ×™` : "×”×’×“×¨ ×ª×–×›×•×¨×ª";
      
      const reminderDropdown = document.createElement("div");
      reminderDropdown.className = "event-reminder-dropdown";
      const reminderOptions = [
        { label: '×“×§×” ××—×ª', value: 1 },
        { label: '5 ×“×§×•×ª', value: 5 },
        { label: '15 ×“×§×•×ª', value: 15 },
        { label: '×©×¢×”', value: 60 },
        { label: '×™×•×', value: 1440 },
        { label: '×”×¡×¨ ×ª×–×›×•×¨×ª', value: 0, remove: true }
      ];
      reminderOptions.forEach(opt => {
        if (opt.remove && !evt.reminder) return; // Only show remove if there's a reminder
        const optEl = document.createElement("div");
        optEl.className = `event-reminder-option ${opt.remove ? 'remove' : ''} ${evt.reminder === opt.value ? 'active' : ''}`;
        optEl.textContent = opt.label;
        optEl.onclick = (e) => {
          e.stopPropagation();
          setEventReminder(evt.id, opt.value);
          reminderDropdown.classList.remove('open');
        };
        reminderDropdown.appendChild(optEl);
      });
      
      reminderBtn.onclick = (e) => {
        e.stopPropagation();
        // Close other dropdowns
        document.querySelectorAll('.event-reminder-dropdown.open').forEach(d => {
          if (d !== reminderDropdown) d.classList.remove('open');
        });
        reminderDropdown.classList.toggle('open');
      };
      
      reminderWrap.appendChild(reminderBtn);
      reminderWrap.appendChild(reminderDropdown);

      const deleteBtn = document.createElement("button");
      deleteBtn.className = "delete-btn";
      deleteBtn.textContent = "Ã—";

      const actions = document.createElement("div");
      actions.className = "event-actions";
      actions.appendChild(pinBtn);
      actions.appendChild(starBtn);
      actions.appendChild(reminderWrap);
      actions.appendChild(editBtn);
      actions.appendChild(deleteBtn);

      row.appendChild(dot);
      row.appendChild(timer);
      row.appendChild(badge);
      row.appendChild(info);
      row.appendChild(actions);

      enableInlineEventTitle(name, evt.id);
      enableInlineEventDate(date, evt.id);
      
      // Right-click context menu for events
      row.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        showEventContextMenu(e.clientX, e.clientY, evt.id);
      });

      refs.set(evt.id, {
        row,
        dEl: row.querySelector(".time-d"),
        hEl: row.querySelector(".time-h"),
        mEl: row.querySelector(".time-m"),
        sEl: row.querySelector(".time-s"),
        badge: badge,
        target: new Date(evt.date).getTime()
      });

      frag.appendChild(row);
    });

    eventList.replaceChildren(frag);

    tick();
  }

  function findConflictingEvents(list, thresholdMinutes = 30) {
    if (!Array.isArray(list) || list.length < 2) return new Set();
    const thresholdMs = thresholdMinutes * 60000;
    // Assume `list` is already sorted by date (render() prepares a sorted list)
    const conflicts = new Set();
    for (let i = 0; i < list.length - 1; i++) {
      const current = list[i];
      const next = list[i + 1];
      const diff = Math.abs(new Date(next.date) - new Date(current.date));
      if (diff < thresholdMs) {
        conflicts.add(current.id);
        conflicts.add(next.id);
      }
    }
    return conflicts;
  }

  function inlineEdit(el, { type = 'text', value = '', className = 'inline-edit-input', step, onSave }) {
    el.style.cursor = 'text';
    el.addEventListener('click', (e) => {
      e.stopPropagation();
      if (el.dataset.editing === '1') return;
      el.dataset.editing = '1';

      const input = document.createElement('input');
      input.type = type;
      input.value = value;
      input.className = className;
      if (step) input.step = step;

      const original = el.textContent;
      el.replaceWith(input);
      input.focus();
      input.select();

      let cancelled = false;
      const finish = (commit) => {
        if (input.parentElement) input.replaceWith(el);
        delete el.dataset.editing;
        if (commit && typeof onSave === 'function') onSave(input.value, original, el);
      };

      input.addEventListener('keydown', (ev) => {
        if (ev.key === 'Enter') finish(true);
        else if (ev.key === 'Escape') {
          cancelled = true;
          finish(false);
        }
      });
      input.addEventListener('blur', () => finish(!cancelled));
    });
  }

  function enableInlineEventTitle(el, eventId) {
    inlineEdit(el, {
      value: el.textContent.trim(),
      onSave: (val, original) => {
        const newName = val.trim();
        const evt = events.find(e => e.id === eventId);
        if (!evt || !newName) {
          el.textContent = original;
          return;
        }
        el.textContent = newName;
        updateInCloud(eventId, { ...evt, name: newName });
      }
    });
  }

  function enableInlineEventDate(el, eventId) {
    inlineEdit(el, {
      type: 'datetime-local',
      value: toLocalDatetime(el.dataset.iso || events.find(e => e.id === eventId)?.date || new Date().toISOString()),
      className: 'inline-edit-input small',
      step: 60,
      onSave: (val, original) => {
        const parsed = parseLocal(val);
        const evt = events.find(e => e.id === eventId);
        if (!evt || !parsed || isNaN(parsed.getTime())) {
          el.textContent = original;
          return;
        }
        const iso = parsed.toISOString();
        el.textContent = formatDate(iso);
        el.dataset.iso = iso;
        updateInCloud(eventId, { ...evt, date: iso });
      }
    });
  }

  function tick() {
    const now = Date.now();

    refs.forEach((ref) => {
      const diff = Math.max(0, ref.target - now);
      const ended = diff === 0;

      const d = Math.floor(diff / 86400000);
      const h = Math.floor((diff % 86400000) / 3600000);
      const m = Math.floor((diff % 3600000) / 60000);
      const s = Math.floor((diff % 60000) / 1000);

      ref.dEl.textContent = d;
      ref.hEl.textContent = String(h).padStart(2, '0');
      ref.mEl.textContent = String(m).padStart(2, '0');
      ref.sEl.textContent = String(s).padStart(2, '0');

      ref.badge.className = `badge ${ended ? 'badge-ended' : 'badge-upcoming'}`;
      ref.badge.textContent = ended ? 'Ended' : 'Upcoming';
    });

    const nowMs = now;
    getActiveEvents().forEach(evt => {
      const reminderMinutes = parseInt(evt.reminder, 10) || 0;
      if (!reminderMinutes) return;
      const reminderKey = `${evt.date || ''}|${reminderMinutes}`;
      if (notifiedEvents.get(evt.id) === reminderKey) return;
      const eventTime = new Date(evt.date).getTime();
      if (!Number.isFinite(eventTime)) return;
      const triggerTime = eventTime - (reminderMinutes * 60000);
      if (nowMs >= triggerTime && nowMs < triggerTime + 60000) {
        triggerAlert(evt);
        notifiedEvents.set(evt.id, reminderKey);
      }
    });
  }

  function startTicker() {
    if (tickerHandle) return; // already running
    const loop = () => {
      tick();
      const msToNext = 1000 - (Date.now() % 1000);
      tickerHandle = setTimeout(loop, msToNext);
    };
    loop();
  }

  addBtn.onclick = () => {
    const name = eventName.value.trim();
    const dateValue = eventDate.value;
    const notes = eventNotes.value.trim();
    const reminderVal = getReminderMinutesFromUI();

    if (!name || !dateValue) {
      alert("Please enter both event name and date");
      return;
    }
    if (reminderVal === null) {
      alert("Please enter a valid custom reminder (positive number).");
      return;
    }

    const parsedDate = parseLocal(dateValue);
    if (!parsedDate || isNaN(parsedDate.getTime())) {
      alert("Invalid date");
      return;
    }

    if (editingId) {
      const evt = events.find(e => e.id === editingId);
      updateInCloud(editingId, {
        name,
        date: parsedDate.toISOString(),
        notes: notes || null,
        reminder: reminderVal,
        highlighted: evt ? evt.highlighted : false,
        pinned: evt ? evt.pinned : false
      });
      cancelEdit();
    } else {
      saveToCloud({
        name,
        date: parsedDate.toISOString(),
        notes: notes || null,
        reminder: reminderVal,
        highlighted: false,
        pinned: false
      });
      eventName.value = "";
      eventDate.value = "";
      eventNotes.value = "";
      setReminderUIFromMinutes(0);
      eventName.focus();
    }
  };

  cancelBtn.onclick = cancelEdit;

  eventName.onkeypress = e => {
    if (e.key === 'Enter') addBtn.click();
  };

  eventDate.onkeypress = e => {
    if (e.key === 'Enter') addBtn.click();
  };

  // Auto-advance: when datetime-local value is complete, focus stays for time editing
  eventDate.addEventListener('input', () => {
    const val = eventDate.value;
    // datetime-local format: YYYY-MM-DDTHH:MM
    if (val && val.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/)) {
      // Value is complete - user can now adjust time or press Enter
      // No action needed, browser handles focus within datetime-local
    }
  });

  const openClearModal = () => {
    if (!events.length) return;
    clearModal.classList.add("open");
  };

  const closeClearModal = () => {
    clearModal.classList.remove("open");
  };

  clearBtn.onclick = openClearModal;
  cancelClearModalBtn.onclick = closeClearModal;
  confirmClearBtn.onclick = () => {
    clearAllCloud();
    closeClearModal();
  };

  clearModal.addEventListener("click", (e) => {
    if (e.target === clearModal) closeClearModal();
  });

  const isEditableTarget = (el) => {
    if (!el) return false;
    const tag = el.tagName;
    return el.isContentEditable || tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT';
  };

  const openShortcuts = () => {
    if (!shortcutsModal) return;
    shortcutsLastFocus = document.activeElement;
    shortcutsModal.classList.add('open');
  };

  const closeShortcuts = () => {
    if (!shortcutsModal) return;
    shortcutsModal.classList.remove('open');
    if (shortcutsLastFocus && typeof shortcutsLastFocus.focus === 'function') {
      shortcutsLastFocus.focus();
    }
    shortcutsLastFocus = null;
  };

  const toggleShortcuts = () => {
    if (!shortcutsModal) return;
    shortcutsModal.classList.contains('open') ? closeShortcuts() : openShortcuts();
  };

  if (shortcutsClose) shortcutsClose.onclick = closeShortcuts;
  if (shortcutsModal) {
    shortcutsModal.addEventListener('click', (e) => {
      if (e.target === shortcutsModal) closeShortcuts();
    });
  }
  if (helpShortcuts) helpShortcuts.onclick = openShortcuts;

  const focusQuickAdd = () => {
    if (currentView === 'tasks') {
      if (quickAddRow) quickAddRow.style.display = 'flex';
      if (newTaskTitle) {
        newTaskTitle.focus();
        if (typeof newTaskTitle.select === 'function') newTaskTitle.select();
      }
      return;
    }
    if (typeof showView === 'function' && currentView !== 'countdown') showView('countdown');
    if (eventName) {
      eventName.focus();
      if (typeof eventName.select === 'function') eventName.select();
    }
    if (inputPanel) inputPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  };

  const goToToday = () => {
    if (currentView === 'tasks') {
      currentTaskMonth = new Date();
      if (typeof renderTaskCalendar === 'function') renderTaskCalendar();
      return;
    }
    if (typeof showView === 'function' && currentView !== 'countdown') showView('countdown');
    currentMonth = new Date();
    renderCalendar();
  };

  const openPomodoro = () => {
    if (typeof showView === 'function') showView('pomodoro');
  };

  const toggleCalendarSidebar = () => {
    if (typeof showView === 'function' && currentView !== 'countdown') showView('countdown');
    const toggleBtn = $("toggleSidebar");
    if (toggleBtn) toggleBtn.click();
  };

  const openTasksView = () => {
    if (typeof showView === 'function') showView('tasks');
  };

  const openCountdownView = () => {
    if (typeof showView === 'function') showView('countdown');
  };

  const focusTaskSearch = () => {
    if (typeof showView === 'function' && currentView !== 'tasks') showView('tasks');
    if (taskSearch) {
      taskSearch.focus();
      if (typeof taskSearch.select === 'function') taskSearch.select();
    }
  };

  const toggleTheme = () => {
    if (themeToggle) themeToggle.click();
  };

  document.addEventListener('keydown', (e) => {
    if (e.key.toLowerCase() === 'h' && !isEditableTarget(e.target)) {
      e.preventDefault();
      toggleShortcuts();
      return;
    }
    if (e.metaKey || e.ctrlKey || e.altKey) return;
    if (isEditableTarget(e.target)) return;
    const key = e.key.toLowerCase();
    if (key === 'n') {
      e.preventDefault();
      focusQuickAdd();
    } else if (key === 't') {
      e.preventDefault();
      goToToday();
    } else if (key === 'p') {
      e.preventDefault();
      openPomodoro();
    } else if (key === 'c') {
      e.preventDefault();
      toggleCalendarSidebar();
    } else if (key === 'm') {
      e.preventDefault();
      openTasksView();
    } else if (key === 'g') {
      e.preventDefault();
      openCountdownView();
    } else if (key === '/') {
      e.preventDefault();
      focusTaskSearch();
    } else if (key === 'd') {
      e.preventDefault();
      toggleTheme();
    }
  });

  // Escape key handler (consolidated)
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (shortcutsModal && shortcutsModal.classList.contains('open')) {
        closeShortcuts();
        return;
      }
      // Close context menus first (highest priority)
      if (typeof hideContextMenu === 'function') hideContextMenu();
      if (typeof hideAddEventContextMenu === 'function') hideAddEventContextMenu();
      if (typeof hideEventContextMenu === 'function') hideEventContextMenu();
      
      // Task edit modal (check first since it's on top)
      const tEditModal = $("taskEditModal");
      if (tEditModal && tEditModal.classList.contains('open')) {
        if (typeof closeTaskEditModal === 'function') closeTaskEditModal();
        return;
      }
      // Task manager overlay - go back to countdown
      const tmOverlay = $("taskManagerOverlay");
      if (tmOverlay && tmOverlay.classList.contains('open')) {
        if (typeof showView === 'function') showView('countdown');
        return;
      }
      // Pomodoro overlay - go back to countdown
      const pOverlay = $("pomodoroOverlay");
      if (pOverlay && pOverlay.classList.contains('open')) {
        if (typeof showView === 'function') showView('countdown');
        return;
      }
      if (eventAlertModal && eventAlertModal.classList.contains('open')) {
        closeEventAlert();
        return;
      }
      // Day drawer
      if (dayDrawer.classList.contains('open')) {
        closeDayDrawer();
        return;
      }
      // Clear modal
      if (clearModal.classList.contains('open')) {
        closeClearModal();
        return;
      }
      // Event editing
      if (editingId) {
        cancelEdit();
        return;
      }
    }
  });

  eventList.onclick = e => {
    const row = e.target.closest(".event-row");
    if (!row) return;
    const id = row.dataset.id;
    
    // Don't handle clicks on inline edit targets or inputs
    if (e.target.closest('.event-name') || e.target.closest('.event-date') || e.target.tagName === 'INPUT') {
      return;
    }

    if (e.target.classList.contains("delete-btn")) {
      if (editingId === id) cancelEdit();
      const existing = pendingDeletes.get(id);
      if (existing) clearTimeout(existing.timer);
      const evt = events.find(evt => evt.id === id);
      const timer = setTimeout(() => {
        deleteFromCloud(id);
        pendingDeletes.delete(id);
        if (lastDeletedId === id) hideUndoToast();
      }, DELETE_TIMEOUT_MS);
      pendingDeletes.set(id, { timer });
      render();
      showUndoToast(evt ? evt.name : 'Event', id);
    } else if (e.target.classList.contains("edit-btn")) {
      startEdit(id);
    } else if (e.target.classList.contains("star-btn")) {
      const evt = events.find(evt => evt.id === id);
      if (evt) {
        updateInCloud(id, { ...evt, highlighted: !evt.highlighted });
      }
    } else if (e.target.classList.contains("pin-btn")) {
      const evt = events.find(evt => evt.id === id);
      if (evt) {
        updateInCloud(id, { ...evt, pinned: !evt.pinned });
      }
    }
  };

  renderCalendar();
  startTicker();

  // ============ TASK MANAGER ============
  
  const taskManagerOverlay = $("taskManagerOverlay");
  
    const closeTaskManager = $("closeTaskManager");
  
    const toggleTasks = $("toggleTasks");
  const taskSearch = $("taskSearch");
  const quickAddTask = $("quickAddTask");
  const quickAddRow = $("quickAddRow");
  const newTaskTitle = $("newTaskTitle");
  const newTaskDue = $("newTaskDue");
  const newTaskRecurrence = $("newTaskRecurrence");
  const newTaskReminder = $("newTaskReminder");
  const addTaskBtn = $("addTaskBtn");
  const taskPriorityPicker = $("taskPriorityPicker");
  const activeTasks = $("activeTasks");
  const completedTasks = $("completedTasks");
  const activeSection = $("activeSection");
  const completedSection = $("completedSection");
  const tasksEmpty = $("tasksEmpty");
  const taskEditModal = $("taskEditModal");
  const editTaskTitle = $("editTaskTitle");
  const editTaskContent = $("editTaskContent");
  const editTaskChecklist = $("editTaskChecklist");
  const newChecklistItem = $("newChecklistItem");
  const addChecklistItem = $("addChecklistItem");
  const editTaskPriority = $("editTaskPriority");
  const editTaskDue = $("editTaskDue");
  const editTaskRecurrence = $("editTaskRecurrence");
  const editTaskReminder = $("editTaskReminder");
  const clearDueBtn = $("clearDueBtn");
  const duplicateTaskBtn = $("duplicateTaskBtn");
  const deleteTaskBtn = $("deleteTaskBtn");
  const saveTaskBtn = $("saveTaskBtn");
  const quickTaskColorPicker = $("quickTaskColorPicker");
  const taskColorPicker = $("taskColorPicker");
  const addSubjectBtn = $("addSubjectBtn");
  const addSubjectSidebarBtn = $("addSubjectSidebarBtn");
  const smartViewsList = $("smartViewsList");
  const subjectModal = $("subjectModal");
  const subjectModalTitle = $("subjectModalTitle");
  const subjectNameInput = $("subjectNameInput");
  const subjectColorPicker = $("subjectColorPicker");
  const cancelSubjectBtn = $("cancelSubjectBtn");
  const deleteSubjectBtn = $("deleteSubjectBtn");
  const saveSubjectBtn = $("saveSubjectBtn");
  const newTaskSubject = $("newTaskSubject");
  const editTaskSubject = $("editTaskSubject");
  const parentSubjectSelect = $("parentSubjectSelect");
  const contextMenu = $("contextMenu");
  const eventContextMenu = $("eventContextMenu");
  const reminderModal = $("reminderModal");
  const subjectsList = $("subjectsList");
  
  // Limit year input to 4 digits for all datetime-local inputs
  const dateInputs = [eventDate, newTaskDue, editTaskDue];
  dateInputs.forEach(input => {
    if (!input) return;
    
    input.addEventListener('input', (e) => {
      const value = e.target.value;
      if (!value) return;
      
      // Check if year exceeds 4 digits
      const yearMatch = value.match(/^(\d+)-/);
      if (yearMatch && yearMatch[1].length > 4) {
        // Truncate to 4 digits
        const truncatedYear = yearMatch[1].substring(0, 4);
        e.target.value = value.replace(/^\d+-/, truncatedYear + '-');
      }
    });
    
    // Also set max attribute
    input.setAttribute('max', '9999-12-31T23:59');
  });
  
  let tasks = [];
  let tasksLoaded = false;
  let hasTasksCache = false;
  let editingTaskId = null;
  let editingTask = null;
  let selectedTaskPriority = 'medium';
  let selectedTaskColor = '';
  let currentFilter = 'all';
  let taskTickerHandle = null;
  // Shared subject state (used by Task Manager + Subjects sidebar)
  let subjects = [];
  let currentSubject = 'all';
  let currentSmartView = null; // 'today', 'week', 'overdue', 'nodate'
  let editingSubjectId = null;
  let selectedSubjectColor = '#667eea';
  let contextMenuTarget = null;
  let eventContextMenuTarget = null;
  let expandedSubjects = new Set(); // Track which subjects are expanded

  
  const PRIORITY_ORDER = { urgent: 0, high: 1, medium: 2, low: 3, none: 4 };
  const PRIORITY_LABELS = { urgent: 'Urgent', high: 'High', medium: 'Medium', low: 'Low', none: '' };
  const RECURRENCE_LABELS = { daily: '×™×•×ž×™', weekly: '×©×‘×•×¢×™', monthly: '×—×•×“×©×™' };
  
  // Task Reminder Custom Handling
  const newTaskReminderCustomWrap = $("newTaskReminderCustomWrap");
  const newTaskReminderCustomValue = $("newTaskReminderCustomValue");
  const newTaskReminderCustomUnit = $("newTaskReminderCustomUnit");
  const editTaskReminderCustomWrap = $("editTaskReminderCustomWrap");
  const editTaskReminderCustomValue = $("editTaskReminderCustomValue");
  const editTaskReminderCustomUnit = $("editTaskReminderCustomUnit");
  
  // Get reminder value in minutes from custom inputs
  function getTaskReminderMinutes(selectEl, customValueEl, customUnitEl) {
    if (!selectEl) return 0;
    if (selectEl.value === 'custom') {
      const val = parseInt(customValueEl?.value, 10) || 0;
      const unit = customUnitEl?.value || 'minutes';
      if (unit === 'hours') return val * 60;
      if (unit === 'days') return val * 1440;
      return val;
    }
    return parseInt(selectEl.value, 10) || 0;
  }
  
  // Set reminder UI from minutes value
  function setTaskReminderUI(selectEl, customWrapEl, customValueEl, customUnitEl, minutes) {
    if (!selectEl) return;
    const min = parseInt(minutes, 10) || 0;
    const optionExists = Array.from(selectEl.options).some(o => o.value === String(min) && o.value !== 'custom');
    
    if (min > 0 && !optionExists) {
      selectEl.value = 'custom';
      if (customWrapEl) customWrapEl.classList.remove('hidden');
      
      let unit = 'minutes';
      let value = min;
      if (min % 1440 === 0) {
        unit = 'days';
        value = Math.round(min / 1440);
      } else if (min % 60 === 0) {
        unit = 'hours';
        value = Math.round(min / 60);
      }
      if (customUnitEl) customUnitEl.value = unit;
      if (customValueEl) customValueEl.value = String(value);
      return;
    }
    
    selectEl.value = String(min);
    if (customWrapEl) customWrapEl.classList.add('hidden');
    if (customValueEl) customValueEl.value = '';
    if (customUnitEl) customUnitEl.value = 'minutes';
  }
  
  // New task reminder change handler
  if (newTaskReminder) {
    newTaskReminder.addEventListener('change', () => {
      const isCustom = newTaskReminder.value === 'custom';
      if (newTaskReminderCustomWrap) newTaskReminderCustomWrap.classList.toggle('hidden', !isCustom);
      if (isCustom) {
        if (newTaskReminderCustomUnit && !newTaskReminderCustomUnit.value) newTaskReminderCustomUnit.value = 'minutes';
        if (newTaskReminderCustomValue && !newTaskReminderCustomValue.value) newTaskReminderCustomValue.value = '10';
        if (newTaskReminderCustomValue) newTaskReminderCustomValue.focus();
      }
    });
  }
  
  // Edit task reminder change handler
  if (editTaskReminder) {
    editTaskReminder.addEventListener('change', () => {
      const isCustom = editTaskReminder.value === 'custom';
      if (editTaskReminderCustomWrap) editTaskReminderCustomWrap.classList.toggle('hidden', !isCustom);
      if (isCustom) {
        if (editTaskReminderCustomUnit && !editTaskReminderCustomUnit.value) editTaskReminderCustomUnit.value = 'minutes';
        if (editTaskReminderCustomValue && !editTaskReminderCustomValue.value) editTaskReminderCustomValue.value = '10';
        if (editTaskReminderCustomValue) editTaskReminderCustomValue.focus();
      }
    });
  }
  
  // Quick reminder button handlers
  document.querySelectorAll('.quick-reminder-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const minutes = parseInt(btn.dataset.minutes, 10) || 0;
      if (editTaskReminder) {
        setTaskReminderUI(editTaskReminder, editTaskReminderCustomWrap, editTaskReminderCustomValue, editTaskReminderCustomUnit, minutes);
      }
    });
  });
  
  function getDefaultSubjectId() {
    if (currentSmartView) return '';
    if (currentSubject && currentSubject !== 'all') return currentSubject;
    return '';
  }
  
  function syncQuickAddSubject() {
    if (!newTaskSubject) return;
    const defaultSubject = getDefaultSubjectId();
    if (defaultSubject) {
      newTaskSubject.value = defaultSubject;
    } else if (!newTaskSubject.value) {
      newTaskSubject.value = '';
    }
    updateQuickAddSubjectColorOption();
  }

  function getSubjectColorById(subjectId) {
    if (!subjectId) return '';
    return subjects.find(s => s.id === subjectId)?.color || '';
  }

  function updateQuickAddSubjectColorOption() {
    if (!newTaskSubject || !quickTaskColorPicker) return;
    const subjectColor = getSubjectColorById(newTaskSubject.value);
    updateSubjectColorOption(quickTaskColorPicker, subjectColor);
    if (!subjectColor && selectedTaskColor === 'subject') {
      selectedTaskColor = '';
      setTaskColorSelection(quickTaskColorPicker, selectedTaskColor);
    }
  }

  function setTaskColorSelection(picker, color) {
    if (!picker) return;
    const target = color || '';
    picker.querySelectorAll('.task-color-option').forEach(opt => {
      const optColor = opt.dataset.color || '';
      opt.classList.toggle('selected', optColor === target);
    });
  }

  function getTaskColorFromPicker(picker) {
    if (!picker) return '';
    const selected = picker.querySelector('.task-color-option.selected');
    return selected ? (selected.dataset.color || '') : '';
  }

  function bindTaskColorPicker(picker, onChange) {
    if (!picker) return;
    picker.addEventListener('click', (e) => {
      const option = e.target.closest('.task-color-option');
      if (!option) return;
      if (option.classList.contains('disabled')) return;
      const color = option.dataset.color || '';
      setTaskColorSelection(picker, color);
      if (typeof onChange === 'function') onChange(color);
    });
  }
  
  function updateSubjectColorOption(picker, subjectColor) {
    if (!picker) return;
    const option = picker.querySelector('.task-color-option.subject');
    if (!option) return;
    if (subjectColor) {
      option.style.background = subjectColor;
      option.classList.remove('disabled');
      option.title = 'Use subject color';
    } else {
      option.style.background = '';
      option.classList.add('disabled');
      option.title = 'Select a subject to use its color';
    }
  }
  
  function resolveTaskColor(task, subjectColor) {
    if (!task?.color) return '';
    if (task.color === 'subject') return subjectColor || '';
    return task.color;
  }
  
  function hasManualOrder(taskList = tasks) {
    return taskList.every(t => Number.isFinite(t.order));
  }
  
  function getNextTaskOrder(isCompleted = false) {
    const list = tasks.filter(t => !!t.completed === !!isCompleted);
    const maxOrder = list.reduce((max, t) => Number.isFinite(t.order) ? Math.max(max, t.order) : max, -1);
    return maxOrder + 1;
  }
  
  function normalizeRecurrence(value) {
    return value && value !== 'none' ? value : 'none';
  }
  
  function getNextRecurrenceDate(baseIso, recurrence) {
    const type = normalizeRecurrence(recurrence);
    if (type === 'none') return null;
    const now = new Date();
    let base = baseIso ? new Date(baseIso) : new Date();
    if (Number.isNaN(base.getTime())) return null;
    if (base < now) base = now;
    const next = new Date(base);
    if (type === 'daily') next.setDate(next.getDate() + 1);
    if (type === 'weekly') next.setDate(next.getDate() + 7);
    if (type === 'monthly') next.setMonth(next.getMonth() + 1);
    return next;
  }
  
  function buildTaskClone(task, overrides = {}) {
    const { id, ...clean } = task;
    const orderValue = hasManualOrder() ? getNextTaskOrder(false) : null;
    const clone = {
      ...clean,
      completed: false,
      createdAt: new Date().toISOString(),
      ...(Number.isFinite(orderValue) ? { order: orderValue } : {})
    };
    return { ...clone, ...overrides };
  }
  
  function pushTaskClone(task, overrides = {}) {
    if (!task) return;
    const taskData = buildTaskClone(task, overrides);
    createTask(taskData);
  }
  
  function maybeCreateRecurringTask(task) {
    const recurrence = normalizeRecurrence(task?.recurrence);
    if (recurrence === 'none') return;
    const nextDate = getNextRecurrenceDate(task?.dueDate, recurrence);
    if (!nextDate) return;
    pushTaskClone(task, { dueDate: nextDate.toISOString(), completed: false });
  }

  // ============ POMODORO MODULE (self-contained) ============
  const Pomodoro = (() => {
    const refs = {
      card: document.getElementById('pomodoroCard'),
      taskSelect: document.getElementById('pomodoroTaskSelect'),
      presets: Array.from(document.querySelectorAll('.pomodoro-preset')),
      focusInput: document.getElementById('pomodoroFocus'),
      breakInput: document.getElementById('pomodoroBreak'),
      longInput: document.getElementById('pomodoroLong'),
      longEveryInput: document.getElementById('pomodoroLongEvery'),
      autoContinue: document.getElementById('pomodoroAutoContinue'),
      soundEnabled: document.getElementById('pomodoroSoundEnabled'),
      soundSelect: document.getElementById('pomodoroSound'),
      previewBtn: document.getElementById('pomodoroPreviewSound'),
      display: document.getElementById('pomodoroDisplay'),
      mode: document.getElementById('pomodoroMode'),
      next: document.getElementById('pomodoroNext'),
      progress: document.getElementById('pomodoroRing'),
      startBtn: document.getElementById('pomodoroStart'),
      skipBtn: document.getElementById('pomodoroSkip'),
      resetBtn: document.getElementById('pomodoroReset'),
      sessionCount: document.getElementById('pomodoroSessionCount'),
      focusMinutes: document.getElementById('pomodoroFocusMinutes'),
      streak: document.getElementById('pomodoroStreak'),
      dayProgress: document.getElementById('pomodoroDayProgress'),
      dayLabel: document.getElementById('pomodoroDayLabel'),
      badDayTip: document.getElementById('pomodoroBadDayTip'),
      // Mini player refs
      mini: document.getElementById('pomodoroMini'),
      miniTime: document.getElementById('pomodoroMiniTime'),
      miniMode: document.getElementById('pomodoroMiniMode'),
      miniToggle: document.getElementById('pomodoroMiniToggle'),
      miniClose: document.getElementById('pomodoroMiniClose')
    };

    const KEYS = {
      STATS: 'pomodoro-stats-v1',
      PRESET: 'pomodoro-preset-v1',
      CUSTOM: 'pomodoro-custom-v1',
      SETTINGS: 'pomodoro-settings-v1'
    };

    const presets = {
      classic: { focus: 25, shortBreak: 5, longBreak: 15, longEvery: 4, label: '25/5 ×§×œ××¡×™' },
      flow: { focus: 50, shortBreak: 10, longBreak: 20, longEvery: 3, label: '50/10 ×–×¨×™×ž×”' },
      ultradian: { focus: 90, shortBreak: 20, longBreak: 25, longEvery: 1, label: '90/20 ××•×œ×˜×¨×”' },
      perfect: { focus: 52, shortBreak: 17, longBreak: 20, longEvery: 3, label: '52/17 ×§×¦×‘ ×™×¢×™×œ' },
      // Bad day presets - based on research showing even short focus sessions help
      badday10: { focus: 10, shortBreak: 3, longBreak: 5, longEvery: 4, label: 'ðŸ˜” 10 ×“×§×³', isBadDay: true },
      badday5: { focus: 5, shortBreak: 2, longBreak: 5, longEvery: 6, label: 'ðŸ’« 5 ×“×§×³', isBadDay: true }
    };

    const clampNum = (val, min, max, fallback) => {
      const n = Number(val);
      if (Number.isFinite(n)) return Math.min(max, Math.max(min, n));
      return fallback;
    };

    const getTodayKey = () => new Date().toISOString().slice(0, 10);
    const daysBetween = (a, b) => Math.round((new Date(b) - new Date(a)) / 86400000);

    const loadCustom = () => {
      try {
        const raw = localStorage.getItem(KEYS.CUSTOM);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== 'object') return null;
        return {
          focus: clampNum(parsed.focus, 5, 240, 25),
          shortBreak: clampNum(parsed.shortBreak, 3, 60, 5),
          longBreak: clampNum(parsed.longBreak, 5, 90, 15),
          longEvery: clampNum(parsed.longEvery, 1, 8, 4)
        };
      } catch (e) { return null; }
    };

    const saveCustom = (config) => {
      try { localStorage.setItem(KEYS.CUSTOM, JSON.stringify(config)); } catch (e) {}
    };

    const loadStats = () => {
      const today = getTodayKey();
      try {
        const raw = localStorage.getItem(KEYS.STATS);
        if (!raw) return { date: today, sessions: 0, focusMinutes: 0, streak: 0, lastActiveDate: null };
        const parsed = JSON.parse(raw);
        if (!parsed) return { date: today, sessions: 0, focusMinutes: 0, streak: 0, lastActiveDate: null };
        if (parsed.date !== today) {
          const carry = parsed.focusMinutes > 0 && daysBetween(parsed.date, today) === 1;
          const streak = carry ? (parsed.streak || 0) + 1 : (parsed.focusMinutes > 0 ? 1 : 0);
          return { date: today, sessions: 0, focusMinutes: 0, streak, lastActiveDate: parsed.lastActiveDate };
        }
        return parsed;
      } catch (e) {
        return { date: today, sessions: 0, focusMinutes: 0, streak: 0, lastActiveDate: null };
      }
    };

    const loadSettings = () => {
      try {
        const raw = localStorage.getItem(KEYS.SETTINGS);
        if (!raw) return { autoContinue: false, sound: 'chime', soundEnabled: true };
        const parsed = JSON.parse(raw);
        return { 
          autoContinue: !!parsed.autoContinue, 
          sound: parsed.sound || 'chime',
          soundEnabled: parsed.soundEnabled !== false // default true
        };
      } catch (e) {
        return { autoContinue: false, sound: 'chime', soundEnabled: true };
      }
    };

    const saveSettings = () => {
      try { localStorage.setItem(KEYS.SETTINGS, JSON.stringify(settings)); } catch (e) {}
    };
    const saveStats = () => {
      try { localStorage.setItem(KEYS.STATS, JSON.stringify(stats)); } catch (e) {}
    };

    let config = loadCustom() || { ...presets.classic };
    let state = {
      mode: 'focus',
      remainingMs: (config.focus || 25) * 60000,
      running: false,
      cycle: 0,
      preset: localStorage.getItem(KEYS.PRESET) || 'classic',
      timerId: null
    };
    let stats = loadStats();
    let settings = loadSettings();
    let tasksCache = [];

    const getDuration = (mode) => {
      if (mode === 'focus') return config.focus;
      if (mode === 'long') return config.longBreak;
      return config.shortBreak;
    };

    const formatTime = (ms) => {
      const total = Math.max(0, Math.round(ms / 1000));
      const m = Math.floor(total / 60);
      const s = total % 60;
      return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    };

    const updatePresetButtons = () => {
      refs.presets.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.preset === state.preset);
      });
      
      // Show/hide bad day tip based on selected preset
      const currentPreset = presets[state.preset];
      const isBadDay = currentPreset?.isBadDay || false;
      if (refs.badDayTip) {
        refs.badDayTip.style.display = isBadDay ? 'flex' : 'none';
      }
    };

    const renderStats = () => {
      if (!refs.sessionCount || !refs.focusMinutes || !refs.streak) return;
      refs.sessionCount.textContent = stats.sessions;
      refs.focusMinutes.textContent = stats.focusMinutes;
      refs.streak.textContent = stats.streak;
      const goal = 8;
      if (refs.dayProgress) {
        const pct = Math.min(100, Math.round((stats.sessions / goal) * 100));
        refs.dayProgress.style.width = pct + '%';
      }
      if (refs.dayLabel) {
        refs.dayLabel.textContent = `${Math.min(stats.sessions, goal)}/${goal} ×ž×—×–×•×¨×™ ×ž×™×§×•×“ ×”×™×•×`;
      }
    };

    const render = () => {
      if (!refs.display) return;
      refs.display.textContent = formatTime(state.remainingMs);
      const modeLabel = state.mode === 'focus' ? '×ž×™×§×•×“' : (state.mode === 'long' ? '×”×¤×¡×§×” ××¨×•×›×”' : '×”×¤×¡×§×” ×§×¦×¨×”');
      refs.mode.textContent = modeLabel;
      refs.next.textContent = `×”×‘×: ${getNextLabel()}`;
      const totalMs = getDuration(state.mode) * 60000;
      const pct = Math.max(0, Math.min(100, 100 - (state.remainingMs / totalMs) * 100));
      if (refs.progress) refs.progress.style.setProperty('--progress', pct + '%');
      if (refs.startBtn) refs.startBtn.textContent = state.running ? 'â¸ï¸' : 'â–¶ï¸';
      // Update mini player
      if (refs.miniTime) refs.miniTime.textContent = formatTime(state.remainingMs);
      if (refs.miniMode) refs.miniMode.textContent = state.mode === 'focus' ? '×ž×™×§×•×“' : (state.mode === 'long' ? '×”×¤×¡×§×” ××¨×•×›×”' : '×”×¤×¡×§×” ×§×¦×¨×”');
    };

    const setMode = (mode) => {
      state.mode = mode;
      state.remainingMs = getDuration(mode) * 60000;
      render();
    };

    const getNextLabel = () => {
      if (state.mode === 'focus') {
        const nextIsLong = ((state.cycle + 1) % config.longEvery === 0);
        return nextIsLong ? '×”×¤×¡×§×” ××¨×•×›×”' : '×”×¤×¡×§×” ×§×¦×¨×”';
      }
      return '×ž×™×§×•×“';
    };

    const clearTimer = () => {
      if (state.timerId) {
        clearInterval(state.timerId);
        state.timerId = null;
      }
    };

    const tick = () => {
      state.remainingMs -= 1000;
      if (state.remainingMs <= 0) advance(true);
      render();
    };

    const start = () => {
      if (state.running) return;
      state.running = true;
      clearTimer();
      state.timerId = setInterval(tick, 1000);
      render();
    };

    const pause = () => {
      state.running = false;
      clearTimer();
      render();
    };

    const reset = () => {
      state.running = false;
      clearTimer();
      state.mode = 'focus';
      state.remainingMs = config.focus * 60000;
      state.cycle = 0;
      render();
    };

    const recordFocus = () => {
      const today = getTodayKey();
      if (stats.date !== today) {
        const carry = stats.focusMinutes > 0 && daysBetween(stats.date, today) === 1;
        stats.streak = carry ? stats.streak + 1 : (stats.focusMinutes > 0 ? 1 : stats.streak || 0);
        stats.date = today;
        stats.sessions = 0;
        stats.focusMinutes = 0;
      }
      stats.sessions += 1;
      stats.focusMinutes += config.focus;
      stats.lastActiveDate = today;
      saveStats();
      renderStats();
    };

    // Enhanced sound patterns with distinct tones
    const tonePatterns = {
      // Gentle ascending chime - pleasant completion sound
      chime: [
        { f: 523, d: 0.15, type: 'sine', vol: 0.12 },
        { f: 659, d: 0.15, type: 'sine', vol: 0.14 },
        { f: 784, d: 0.25, type: 'sine', vol: 0.16 }
      ],
      // Soft meditation bowl - calming
      soft: [
        { f: 396, d: 0.4, type: 'sine', vol: 0.1 },
        { f: 528, d: 0.5, type: 'sine', vol: 0.08 }
      ],
      // Classic bell - clear and bright
      bell: [
        { f: 1047, d: 0.08, type: 'sine', vol: 0.18 },
        { f: 1319, d: 0.12, type: 'sine', vol: 0.14 },
        { f: 1568, d: 0.3, type: 'triangle', vol: 0.1 }
      ],
      // Digital beep - modern alert
      digital: [
        { f: 880, d: 0.1, type: 'square', vol: 0.06 },
        { f: 0, d: 0.05, type: 'sine', vol: 0 },
        { f: 880, d: 0.1, type: 'square', vol: 0.06 },
        { f: 0, d: 0.05, type: 'sine', vol: 0 },
        { f: 1175, d: 0.2, type: 'square', vol: 0.08 }
      ],
      // Crystal glass - high clarity
      glass: [
        { f: 2093, d: 0.15, type: 'sine', vol: 0.08 },
        { f: 2637, d: 0.2, type: 'sine', vol: 0.06 },
        { f: 3136, d: 0.35, type: 'sine', vol: 0.04 }
      ],
      // Success fanfare - celebratory
      success: [
        { f: 523, d: 0.12, type: 'triangle', vol: 0.12 },
        { f: 659, d: 0.12, type: 'triangle', vol: 0.14 },
        { f: 784, d: 0.12, type: 'triangle', vol: 0.16 },
        { f: 1047, d: 0.3, type: 'triangle', vol: 0.18 }
      ]
    };

    let audioCtx = null;
    const playTonePattern = (pattern, startTime = null) => {
      if (!pattern) return 0;
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === 'suspended') audioCtx.resume();
      let t = startTime !== null ? startTime : audioCtx.currentTime;
      pattern.forEach(step => {
        if (step.f === 0) { t += step.d; return; } // silence gap
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = step.type || 'sine';
        osc.frequency.value = step.f;
        const vol = step.vol || 0.15;
        gain.gain.setValueAtTime(0.001, t);
        gain.gain.linearRampToValueAtTime(vol, t + 0.015);
        gain.gain.exponentialRampToValueAtTime(0.001, t + step.d);
        osc.connect(gain).connect(audioCtx.destination);
        osc.start(t);
        osc.stop(t + step.d + 0.02);
        t += step.d + 0.02;
      });
      return t; // return end time
    };

    // Extended alarm - plays pattern 3 times with pauses for better notification
    const playExtendedAlarm = (pattern) => {
      if (!pattern || !audioCtx) return;
      const patternDuration = pattern.reduce((sum, step) => sum + step.d + 0.02, 0);
      const gap = 0.4; // pause between repetitions
      let t = audioCtx.currentTime;
      
      for (let i = 0; i < 3; i++) {
        t = playTonePattern(pattern, t);
        t += gap;
      }
    };

    const alert = () => {
      if (!settings.soundEnabled) {
        // Still vibrate even if sound is off
        if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 200]);
        return;
      }
      const pattern = tonePatterns[settings.sound] || tonePatterns.chime;
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === 'suspended') audioCtx.resume();
      playExtendedAlarm(pattern);
      if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 200]);
    };

    const advance = (countFocus = false) => {
      const wasRunning = state.running;
      clearTimer();
      state.running = false;
      if (state.mode === 'focus') {
        if (countFocus) recordFocus();
        state.cycle += 1;
        const useLong = config.longEvery > 0 && (state.cycle % config.longEvery === 0);
        setMode(useLong ? 'long' : 'short');
      } else {
        setMode('focus');
      }
      render();
      alert();
      if (settings.autoContinue || wasRunning) start();
    };

    const applyConfig = (cfg, presetKey) => {
      config = { ...cfg };
      state.preset = presetKey;
      refs.focusInput.value = config.focus;
      refs.breakInput.value = config.shortBreak;
      refs.longInput.value = config.longBreak;
      refs.longEveryInput.value = config.longEvery;
      state.mode = 'focus';
      state.remainingMs = config.focus * 60000;
      state.cycle = 0;
      updatePresetButtons();
      render();
    };

    const selectPreset = (key) => {
      const base = key === 'custom' ? (loadCustom() || config) : presets[key];
      if (!base) return;
      localStorage.setItem(KEYS.PRESET, key);
      if (key === 'custom') saveCustom(base);
      applyConfig(base, key);
    };

    const handleCustomChange = () => {
      const cfg = {
        focus: clampNum(refs.focusInput.value, 5, 240, config.focus),
        shortBreak: clampNum(refs.breakInput.value, 3, 60, config.shortBreak),
        longBreak: clampNum(refs.longInput.value, 5, 90, config.longBreak),
        longEvery: clampNum(refs.longEveryInput.value, 1, 8, config.longEvery)
      };
      saveCustom(cfg);
      selectPreset('custom');
    };

    const updateTaskOptions = () => {
      if (!refs.taskSelect) return;
      const prev = refs.taskSelect.value;
      refs.taskSelect.innerHTML = '<option value="">×‘×—×¨ ×ž×©×™×ž×ª ×ž×™×§×•×“ (×œ× ×—×•×‘×”)</option>';
      const active = (tasksCache || []).filter(t => !t.completed).slice(0, 50);
      active.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.id;
        opt.textContent = t.title || '×œ×œ× ×©×';
        refs.taskSelect.appendChild(opt);
      });
      if (prev && active.some(t => t.id === prev)) refs.taskSelect.value = prev;
    };

    const init = () => {
      if (!refs.card) return;
      const savedPreset = localStorage.getItem(KEYS.PRESET) || 'classic';
      const baseConfig = savedPreset === 'custom' ? (loadCustom() || presets.classic) : (presets[savedPreset] || presets.classic);
      applyConfig(baseConfig, savedPreset);
      renderStats();

      if (refs.autoContinue) {
        refs.autoContinue.checked = settings.autoContinue;
        refs.autoContinue.addEventListener('change', () => {
          settings.autoContinue = refs.autoContinue.checked;
          saveSettings();
        });
      }

      if (refs.soundSelect) {
        refs.soundSelect.value = settings.sound;
        refs.soundSelect.addEventListener('change', () => {
          settings.sound = refs.soundSelect.value;
          saveSettings();
        });
      }

      // Sound enabled toggle
      if (refs.soundEnabled) {
        refs.soundEnabled.checked = settings.soundEnabled;
        refs.soundEnabled.addEventListener('change', () => {
          settings.soundEnabled = refs.soundEnabled.checked;
          saveSettings();
          // Update sound select visibility
          if (refs.soundSelect) {
            refs.soundSelect.style.opacity = settings.soundEnabled ? '1' : '0.5';
          }
          if (refs.previewBtn) {
            refs.previewBtn.style.opacity = settings.soundEnabled ? '1' : '0.5';
          }
        });
        // Initial state
        if (refs.soundSelect) refs.soundSelect.style.opacity = settings.soundEnabled ? '1' : '0.5';
        if (refs.previewBtn) refs.previewBtn.style.opacity = settings.soundEnabled ? '1' : '0.5';
      }

      if (refs.previewBtn) {
        refs.previewBtn.addEventListener('click', () => {
          const key = (refs.soundSelect && refs.soundSelect.value) || settings.sound || 'chime';
          if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
          playTonePattern(tonePatterns[key] || tonePatterns.chime);
        });
      }

      refs.presets.forEach(btn => btn.addEventListener('click', () => selectPreset(btn.dataset.preset)));

      [refs.focusInput, refs.breakInput, refs.longInput, refs.longEveryInput].forEach(input => {
        if (!input) return;
        input.addEventListener('change', handleCustomChange);
        input.addEventListener('input', () => state.preset = 'custom');
      });

      if (refs.startBtn) refs.startBtn.onclick = () => { state.running ? pause() : start(); };
      if (refs.skipBtn) refs.skipBtn.onclick = () => advance(false);
      if (refs.resetBtn) refs.resetBtn.onclick = reset;

      // Mini player setup
      const MINI_KEY = 'pomodoro-mini-enabled';
      const miniEnabled = localStorage.getItem(MINI_KEY) === 'true';
      if (refs.miniToggle) {
        refs.miniToggle.checked = miniEnabled;
        if (refs.mini) refs.mini.classList.toggle('visible', miniEnabled);
      }
      if (refs.miniToggle) {
        refs.miniToggle.addEventListener('change', () => {
          const enabled = refs.miniToggle.checked;
          localStorage.setItem(MINI_KEY, enabled ? 'true' : 'false');
          if (refs.mini) refs.mini.classList.toggle('visible', enabled);
        });
      }
      if (refs.miniClose) {
        refs.miniClose.addEventListener('click', () => {
          if (refs.miniToggle) refs.miniToggle.checked = false;
          localStorage.setItem(MINI_KEY, 'false');
          if (refs.mini) refs.mini.classList.remove('visible');
        });
      }
      // Click on mini player opens Pomodoro overlay
      if (refs.mini) {
        refs.mini.addEventListener('click', (e) => {
          if (e.target === refs.miniClose) return;
          const overlay = document.getElementById('pomodoroOverlay');
          if (overlay) overlay.classList.add('open');
        });
      }

      updatePresetButtons();
      render();
      updateTaskOptions();
    };

    const updateTasks = (tasks = []) => {
      tasksCache = tasks;
      updateTaskOptions();
    };

    return { init, updateTasks };
  })();

  // Toggle overlays - menu buttons switch between views
  // Four main views: Countdown (app-layout), Tasks (taskManagerOverlay), Pomodoro (pomodoroOverlay), Planner (plannerOverlay)
  const toggleCountdown = document.getElementById('toggleCountdown');
  const togglePlanner = document.getElementById('togglePlanner');
  const plannerOverlay = document.getElementById('plannerOverlay');
  const appLayout = document.querySelector('.app-layout');
  // Ensure current view state and commonly used DOM refs exist before showView
  let currentView = 'countdown';

  function updateHeaderButtons() {
    try {
      ['toggleCountdown','toggleTasks','togglePomodoro','togglePlanner'].forEach(id => {
        const el = $(id);
        if (el) el.classList.remove('active');
      });
      if (currentView === 'countdown') {
        const el = $('toggleCountdown'); if (el) el.classList.add('active');
      } else if (currentView === 'tasks') {
        const el = $('toggleTasks'); if (el) el.classList.add('active');
      } else if (currentView === 'pomodoro') {
        const el = $('togglePomodoro'); if (el) el.classList.add('active');
      } else if (currentView === 'planner') {
        const el = $('togglePlanner'); if (el) el.classList.add('active');
      }
    } catch (e) {
      console.warn('updateHeaderButtons error', e);
    }
  }
  
  
  
  
  
  
  const showView = (view) => {
    // Hide all views
    appLayout.style.display = 'none';
    taskManagerOverlay.classList.remove('open');
    pomodoroOverlay.classList.remove('open');
    if (plannerOverlay) plannerOverlay.classList.remove('open');
    stopTaskTicker();
    
    // Show calendar button only for countdown view
    toggleSidebar.style.display = view === 'countdown' ? '' : 'none';
    
    // Show selected view
    if (view === 'countdown') {
      appLayout.style.display = '';
    } else if (view === 'tasks') {
      taskManagerOverlay.classList.add('open');
      renderSubjectsSidebar();
      renderTasks();
      startTaskTicker();
      if (typeof setupTaskCalendar === 'function') setupTaskCalendar();
      if (typeof renderTaskCalendar === 'function') renderTaskCalendar();
    } else if (view === 'pomodoro') {
      pomodoroOverlay.classList.add('open');
    } else if (view === 'planner') {
      if (plannerOverlay) {
        plannerOverlay.classList.add('open');
        if (typeof DailyPlanner !== 'undefined' && DailyPlanner.init) {
          DailyPlanner.init();
        }
      }
    }
    
    currentView = view;
    updateHeaderButtons();
  };
  
  toggleCountdown.onclick = () => showView('countdown');
  toggleTasks.onclick = () => showView('tasks');
  togglePomodoro.onclick = () => showView('pomodoro');
  if (togglePlanner) togglePlanner.onclick = () => showView('planner');

  // Close task manager button
  if (closeTaskManager) {
    closeTaskManager.onclick = () => {
      taskManagerOverlay.classList.remove('open');
      stopTaskTicker();
      showView('countdown');
    };
  }
  
  // Initialize header button states
  updateHeaderButtons();
  newTaskTitle.addEventListener('focus', () => {
    quickAddRow.style.display = 'flex';
    syncQuickAddSubject();
  });
  
  // Collapse quick add when clicking outside
  taskManagerOverlay.addEventListener('click', (e) => {
    if (!quickAddTask.contains(e.target) && !newTaskTitle.value.trim()) {
      quickAddRow.style.display = 'none';
    }
  });
  
  // Priority picker in quick add
  taskPriorityPicker.addEventListener('click', (e) => {
    const option = e.target.closest('.priority-option');
    if (!option) return;
    taskPriorityPicker.querySelectorAll('.priority-option').forEach(o => o.classList.remove('selected'));
    option.classList.add('selected');
    selectedTaskPriority = option.dataset.priority;
  });

  bindTaskColorPicker(quickTaskColorPicker, (color) => {
    selectedTaskColor = color;
  });
  setTaskColorSelection(quickTaskColorPicker, selectedTaskColor);
  updateQuickAddSubjectColorOption();
  if (newTaskSubject) {
    newTaskSubject.addEventListener('change', () => {
      updateQuickAddSubjectColorOption();
    });
  }
  if (editTaskSubject) {
    editTaskSubject.addEventListener('change', () => {
      const subjectColor = getSubjectColorById(editTaskSubject.value);
      updateSubjectColorOption(taskColorPicker, subjectColor);
      if (!subjectColor && getTaskColorFromPicker(taskColorPicker) === 'subject') {
        setTaskColorSelection(taskColorPicker, '');
        if (editingTask) editingTask.color = '';
      }
    });
  }
  
  // ============ UNIFIED ADD TASK FUNCTION ============
  function addTask() {
    const title = newTaskTitle.value.trim();
    if (!title) return;
    
    const dueValue = newTaskDue.value;
    const dueDate = dueValue ? parseLocal(dueValue) : null;
    const recurrence = newTaskRecurrence ? newTaskRecurrence.value : 'none';
    const reminder = getTaskReminderMinutes(newTaskReminder, newTaskReminderCustomValue, newTaskReminderCustomUnit);
    const durationEl = document.getElementById('newTaskDuration');
    const duration = durationEl ? parseInt(durationEl.value, 10) || 0 : 0;
    
    const defaultSubjectId = getDefaultSubjectId();
    const selectedSubjectId = newTaskSubject ? (newTaskSubject.value || defaultSubjectId) : defaultSubjectId;
    const orderValue = hasManualOrder() ? getNextTaskOrder(false) : null;
    
    const taskData = {
      title,
      content: '',
      priority: selectedTaskPriority,
      dueDate: dueDate ? dueDate.toISOString() : null,
      subject: selectedSubjectId || '',
      checklist: [],
      completed: false,
      createdAt: new Date().toISOString(),
      ...(Number.isFinite(orderValue) ? { order: orderValue } : {}),
      ...(selectedTaskColor ? { color: selectedTaskColor } : {}),
      ...(recurrence && recurrence !== 'none' ? { recurrence } : {}),
      ...(reminder > 0 ? { reminder } : {}),
      ...(duration > 0 ? { duration } : {})
    };
    
    createTask(taskData);
    
    // Reset form
    newTaskTitle.value = '';
    newTaskDue.value = '';
    if (newTaskRecurrence) newTaskRecurrence.value = 'none';
    if (newTaskReminder) newTaskReminder.value = '0';
    if (newTaskReminderCustomWrap) newTaskReminderCustomWrap.classList.add('hidden');
    if (newTaskReminderCustomValue) newTaskReminderCustomValue.value = '';
    if (newTaskReminderCustomUnit) newTaskReminderCustomUnit.value = 'minutes';
    if (durationEl) durationEl.value = '0';
    if (newTaskSubject) newTaskSubject.value = '';
    if (quickAddRow) quickAddRow.style.display = 'none';
    selectedTaskPriority = 'medium';
    taskPriorityPicker.querySelectorAll('.priority-option').forEach(o => o.classList.remove('selected'));
    taskPriorityPicker.querySelector('[data-priority="medium"]').classList.add('selected');
    selectedTaskColor = '';
    setTaskColorSelection(quickTaskColorPicker, selectedTaskColor);
    syncQuickAddSubject();
    const taskSections = $("taskSections");
    if (taskSections) {
      taskSections.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }
  
  // Hook button to unified function
  addTaskBtn.onclick = addTask;
  
  // Filter pills
  document.querySelectorAll('.filter-pill').forEach(pill => {
    pill.addEventListener('click', () => {
      document.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('active'));
      pill.classList.add('active');
      currentFilter = pill.dataset.filter;
      renderTasks();
    });
  });
  
  // Search
  taskSearch.addEventListener('input', () => {
    renderTasks();
  });

  const tasksEmptyDefaults = tasksEmpty ? {
    icon: tasksEmpty.querySelector('.tasks-empty-icon')?.textContent || 'ðŸ“',
    title: tasksEmpty.querySelector('h3')?.textContent || '××™×Ÿ ×ž×©×™×ž×•×ª ×¢×“×™×™×Ÿ',
    desc: tasksEmpty.querySelector('p')?.textContent || '×”×•×¡×£ ×ž×©×™×ž×” ×¨××©×•× ×” ×œ×ž×¢×œ×” ×›×“×™ ×œ×”×ª×—×™×œ!'
  } : null;

  const setTasksEmptyMessage = (icon, title, desc) => {
    if (!tasksEmpty) return;
    const iconEl = tasksEmpty.querySelector('.tasks-empty-icon');
    const titleEl = tasksEmpty.querySelector('h3');
    const descEl = tasksEmpty.querySelector('p');
    if (iconEl) iconEl.textContent = icon;
    if (titleEl) titleEl.textContent = title;
    if (descEl) descEl.textContent = desc;
  };

  const showTasksLoading = () => {
    activeSection.style.display = 'none';
    completedSection.style.display = 'none';
    tasksEmpty.style.display = 'block';
    setTasksEmptyMessage('â³', '×˜×•×¢×Ÿ ×ž×©×™×ž×•×ª...', '×ž×¡× ×›×¨×Ÿ ×ž×©×™×ž×•×ª ×ž×”×¢× ×Ÿ');
  };

  const resetTasksEmptyMessage = () => {
    if (!tasksEmptyDefaults) return;
    setTasksEmptyMessage(tasksEmptyDefaults.icon, tasksEmptyDefaults.title, tasksEmptyDefaults.desc);
  };

  const cachedTasksKey = `${CACHE_KEYS.TASKS_PREFIX}${currentUser}`;
  const cachedTasks = readCache(cachedTasksKey);
  if (cachedTasks && cachedTasks.length) {
    tasks = cachedTasks;
    hasTasksCache = true;
    syncCacheUsed.tasks = true;
    updateSyncBadge();
    Pomodoro.updateTasks(tasks);
    if (taskManagerOverlay.classList.contains('open')) {
      renderTasks();
      renderSubjectsSidebar();
    }
  } else {
    showTasksLoading();
  }

  // Listen to tasks from Firebase
  startSyncTimeout('tasks', SYNC_TIMEOUT_MS, 'firebase', () => {
    tasksLoaded = true;
    resetTasksEmptyMessage();
    if (taskManagerOverlay.classList.contains('open')) {
      renderTasks();
      renderSubjectsSidebar();
    }
  });
  onValue(tasksRef, (snapshot) => {
    clearSyncTimeouts('tasks');
    const data = snapshot.val();
    if (data) {
      ownTasks = Object.keys(data).map(key => ({ id: key, ...data[key], isOwn: true }));
    } else {
      ownTasks = [];
    }
    tasksLoaded = true;
    markSyncReady('tasks', 'firebase');
    writeCache(cachedTasksKey, ownTasks, 500);
    resetTasksEmptyMessage();
    mergeTasks();
    Pomodoro.updateTasks(tasks);
    // Update task calendar if visible
    const trSidebar = $("taskRightSidebar");
    if (trSidebar && !trSidebar.classList.contains('hidden')) {
      renderTaskCalendar();
    }
  }, (error) => {
    console.error('Tasks sync error:', error);
    clearSyncTimeouts('tasks');
    tasksLoaded = true;
    markSyncReady('tasks', 'error');
    resetTasksEmptyMessage();
    updateSyncBadge();
  });
  
  function getFilteredTasks() {
    let filtered = [...tasks];
    
    // Apply search filter
    const searchTerm = taskSearch.value.trim().toLowerCase();
    if (searchTerm) {
      filtered = filtered.filter(t => 
        t.title.toLowerCase().includes(searchTerm) ||
        (t.content && t.content.toLowerCase().includes(searchTerm))
      );
    }
    
    // Apply status filter
    if (currentFilter === 'active') {
      filtered = filtered.filter(t => !t.completed);
    } else if (currentFilter === 'completed') {
      filtered = filtered.filter(t => t.completed);
    }
    
    // Apply date filter for calendar selection
    if (currentSmartView === 'date-filter' && window.taskFilterDate) {
      const dateStr = window.taskFilterDate.toDateString();
      filtered = filtered.filter(t => {
        if (!t.dueDate) return false;
        return new Date(t.dueDate).toDateString() === dateStr;
      });
    }
    
    return filtered;
  }
  
  function sortTasksDefault(taskList) {
    // Sort by: due date (soonest first), then by priority, then by created date (newest first)
    return taskList.sort((a, b) => {
      // Due date comparison (tasks with due dates come first, soonest first)
      if (a.dueDate && !b.dueDate) return -1;
      if (!a.dueDate && b.dueDate) return 1;
      if (a.dueDate && b.dueDate) {
        const dueDiff = new Date(a.dueDate) - new Date(b.dueDate);
        if (dueDiff !== 0) return dueDiff;
      }
      
      // Priority comparison (higher priority first)
      const priorityA = PRIORITY_ORDER[a.priority || 'none'];
      const priorityB = PRIORITY_ORDER[b.priority || 'none'];
      if (priorityA !== priorityB) return priorityA - priorityB;
      
      // Created date (newest first)
      return new Date(b.createdAt) - new Date(a.createdAt);
    });
  }
  
  function sortTasks(taskList) {
    // Check if any tasks have been manually reordered (have manualOrder flag)
    const manuallyOrdered = taskList.filter(t => t.manualOrder === true);
    const autoOrdered = taskList.filter(t => t.manualOrder !== true);
    
    // Sort auto-ordered tasks by due date (soonest first)
    sortTasksDefault(autoOrdered);
    
    // Sort manually ordered tasks by their order value
    manuallyOrdered.sort((a, b) => {
      const aOrder = Number.isFinite(a.order) ? a.order : Number.MAX_SAFE_INTEGER;
      const bOrder = Number.isFinite(b.order) ? b.order : Number.MAX_SAFE_INTEGER;
      return aOrder - bOrder;
    });
    
    // Merge: manually ordered tasks stay at their positions, auto-ordered fill the rest
    // For simplicity, put manually ordered first, then auto-ordered
    // But we need to respect the order values properly
    
    // If there are manual orders, integrate them at their specified positions
    if (manuallyOrdered.length > 0) {
      const result = [];
      let autoIndex = 0;
      
      // Create a combined list respecting order values
      const allTasks = [...taskList];
      allTasks.sort((a, b) => {
        // If both have manual order, sort by order
        if (a.manualOrder && b.manualOrder) {
          return (a.order || 0) - (b.order || 0);
        }
        // If only a has manual order, a comes at its position
        if (a.manualOrder) {
          // Compare a's order with b's due date position
          return -1; // Manual ordered items maintain position
        }
        if (b.manualOrder) {
          return 1;
        }
        // Both are auto - sort by due date
        if (a.dueDate && !b.dueDate) return -1;
        if (!a.dueDate && b.dueDate) return 1;
        if (a.dueDate && b.dueDate) {
          const dueDiff = new Date(a.dueDate) - new Date(b.dueDate);
          if (dueDiff !== 0) return dueDiff;
        }
        const priorityA = PRIORITY_ORDER[a.priority || 'none'];
        const priorityB = PRIORITY_ORDER[b.priority || 'none'];
        if (priorityA !== priorityB) return priorityA - priorityB;
        return new Date(b.createdAt) - new Date(a.createdAt);
      });
      return allTasks;
    }
    
    return sortTasksDefault(taskList);
  }
  
  function calcTaskCountdown(dueDate) {
    if (!dueDate) return null;
    const now = Date.now();
    const due = new Date(dueDate).getTime();
    const diff = due - now;
    
    if (diff <= 0) {
      return { overdue: true, text: 'Overdue', urgency: 'overdue' };
    }
    
    const days = Math.floor(diff / 86400000);
    const hours = Math.floor((diff % 86400000) / 3600000);
    const mins = Math.floor((diff % 3600000) / 60000);
    
    let text = '';
    let urgency = '';
    
    if (days > 0) {
      text = `${days}d ${hours}h`;
    } else if (hours > 0) {
      text = `${hours}h ${mins}m`;
    } else {
      text = `${mins}m`;
    }
    
    // Urgency levels for styling
    if (days === 0 && hours < 6) {
      urgency = 'soon';
    } else if (days === 0) {
      urgency = 'today';
    }
    
    return { overdue: false, text, urgency, days, hours, mins };
  }
  
  function renderTasks() {
    if (!tasksLoaded && !hasTasksCache) {
      showTasksLoading();
      return;
    }
    const filtered = getFilteredTasks();
    const active = filtered.filter(t => !t.completed);
    const completed = filtered.filter(t => t.completed);
    
    // Update sidebar counts
    updateSmartViewCounts();
    renderSubjectsSidebar();
    
    // Update title for date filter
    const viewNameDisplay = document.querySelector('.task-manager-title');
    if (currentSmartView === 'date-filter' && window.taskFilterDate && viewNameDisplay) {
      const options = { weekday: 'long', day: 'numeric', month: 'long' };
      viewNameDisplay.textContent = `ðŸ“… ${window.taskFilterDate.toLocaleDateString('he-IL', options)}`;
    } else if (viewNameDisplay && !currentSmartView) {
      // Reset to default title if not in a smart view
      const subjectName = currentSubject ? subjects.find(s => s.id === currentSubject)?.name : null;
      viewNameDisplay.textContent = subjectName || '×›×œ ×”×ž×©×™×ž×•×ª';
    }
    
    // Sort tasks
    sortTasks(active);
    sortTasks(completed);
    
    // Check if showing suggested tasks for empty sub-subject
    const showingSuggested = window.showingSuggestedTasks;
    
    // Active tasks section
    if (active.length > 0 || currentFilter === 'all' || currentFilter === 'active') {
      activeSection.style.display = 'block';
      let suggestedBanner = '';
      if (showingSuggested && active.length > 0) {
        suggestedBanner = `
          <div class="suggested-tasks-banner">
            <span class="suggested-icon">ðŸ’¡</span>
            <span>××™×Ÿ ×ž×©×™×ž×•×ª ×‘×ª×ª-× ×•×©× ×–×”. ×ž×•×¦×’×•×ª ×ž×©×™×ž×•×ª ×“×—×•×¤×•×ª ×ž×›×œ ×”× ×•×©××™×:</span>
          </div>
        `;
      }
      activeTasks.innerHTML = suggestedBanner + active.map(t => renderTaskItem(t, showingSuggested)).join('');
    } else {
      activeSection.style.display = 'none';
    }
    
    // Completed tasks section
    if (completed.length > 0 && (currentFilter === 'all' || currentFilter === 'completed') && !showingSuggested) {
      completedSection.style.display = 'block';
      completedTasks.innerHTML = completed.map(t => renderTaskItem(t)).join('');
    } else {
      completedSection.style.display = 'none';
    }
    
    // Empty state
    if (filtered.length === 0 && !showingSuggested) {
      tasksEmpty.style.display = 'block';
      activeSection.style.display = 'none';
    } else {
      tasksEmpty.style.display = 'none';
    }

    Pomodoro.updateTasks(tasks);
    
    // Event delegation is set up once below, no need to call attachTaskEventHandlers
  }
  
  function renderTaskItem(task, showSubjectTag = false) {
    const priority = task.priority || 'none';
    const countdown = calcTaskCountdown(task.dueDate);
    
    let dueDateHtml = `<span class="task-due add" data-due-iso="">+ ×ª××¨×™×š</span>`;
    if (task.dueDate) {
      const dueDate = new Date(task.dueDate);
      const day = dueDate.getDate();
      const month = dueDate.toLocaleString('he-IL', { month: 'short' });
      const weekday = dueDate.toLocaleString('he-IL', { weekday: 'short' });
      const time = dueDate.toLocaleString('he-IL', { hour: '2-digit', minute: '2-digit' });
      const dateStr = `${weekday}, ${day} ${month}, ${time}`;
      const urgencyClass = countdown?.overdue ? 'overdue' : (countdown?.urgency === 'soon' ? 'soon' : '');
      dueDateHtml = `<span class="task-due ${urgencyClass}" data-due-iso="${task.dueDate}">ðŸ“… ${dateStr}</span>`;
    }
    
    let countdownHtml = '';
    if (countdown) {
      const countdownClass = countdown.overdue ? 'overdue' : (countdown.urgency === 'soon' ? 'soon' : '');
      countdownHtml = `<span class="task-countdown ${countdownClass}" data-due="${task.dueDate}">${countdown.text}</span>`;
    }
    
    let recurrenceHtml = '';
    const recurrence = normalizeRecurrence(task.recurrence);
    if (recurrence !== 'none') {
      const label = RECURRENCE_LABELS[recurrence] || recurrence;
      // Clear two-arrow repeat icon for better small-size rendering
      const icon = `<svg viewBox="0 0 24 24" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" style="width:13px;height:13px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></svg>`;
      recurrenceHtml = `<span class="task-recurrence">${icon}${label}</span>`;
    }
    
    let reminderHtml = '';
    const reminderMinutes = parseInt(task.reminder, 10) || 0;
    if (reminderMinutes > 0) {
      const reminderLabel = formatReminderOffset(reminderMinutes);
      reminderHtml = `<span class="task-reminder">ðŸ”” ${reminderLabel}</span>`;
    }
    
    const subjectData = task.subject ? subjects.find(s => s.id === task.subject) : null;
    const subjectColor = subjectData ? subjectData.color : '';
    const resolvedTaskColor = resolveTaskColor(task, subjectColor);
    const styleParts = [];
    if (subjectColor) {
      styleParts.push(`--subject-color: ${subjectColor};`);
      styleParts.push(`--subject-tint: ${subjectColor}26;`);
    }
    if (resolvedTaskColor) {
      styleParts.push(`--task-color: ${resolvedTaskColor};`);
      styleParts.push(`--task-tint: ${resolvedTaskColor}22;`);
    }
    const taskStyle = styleParts.length ? ` style="${styleParts.join(' ')}"` : '';
    const taskColorDot = resolvedTaskColor ? `<span class="task-color-dot" style="background: ${resolvedTaskColor};"></span>` : '';

    // Subject badge - show when viewing "all" OR when explicitly requested (suggested tasks)
    let subjectHtml = '';
    if (subjectData) {
      const shouldShow = (currentSubject === 'all') || showSubjectTag;
      if (shouldShow) {
        // If it's a sub-subject and showing tag, show parent > child
        let displayName = subjectData.name;
        if (showSubjectTag && subjectData.parentId) {
          const parent = subjects.find(s => s.id === subjectData.parentId);
          if (parent) {
            displayName = `${parent.name} â€º ${subjectData.name}`;
          }
        }
        subjectHtml = `<span class="task-subject-badge" style="--subject-color: ${subjectData.color};">${escapeHtml(displayName)}</span>`;
      }
    }
    
    let subtasksHtml = '';
    if (task.checklist && task.checklist.length > 0) {
      const checked = task.checklist.filter(c => c.checked).length;
      const total = task.checklist.length;
      const maxShow = 3;
      const items = task.checklist.slice(0, maxShow);
      
      subtasksHtml = `
        <div class="task-subtasks">
          <div class="task-subtask-progress">${checked}/${total} completed</div>
          ${items.map((item, i) => `
            <div class="task-subtask ${item.checked ? 'checked' : ''}">
              <input type="checkbox" ${item.checked ? 'checked' : ''} data-index="${i}" />
              <span>${escapeHtml(item.text)}</span>
            </div>
          `).join('')}
          ${task.checklist.length > maxShow ? `<div style="font-size: 12px; color: var(--muted);">+${task.checklist.length - maxShow} more</div>` : ''}
        </div>
      `;
    }
    
    const priorityBadge = `<span class="task-priority-badge ${priority === 'none' ? 'muted' : ''}" data-priority="${priority}">${priority === 'none' ? '×§×‘×¢ ×¢×“×™×¤×•×ª' : PRIORITY_LABELS[priority]}</span>`;
    
    return `
      <div class="task-item priority-${priority} ${task.completed ? 'completed' : ''}" data-id="${task.id}" draggable="true"${taskStyle}>
        <div class="task-checkbox" data-action="toggle">${task.completed ? 'âœ“' : ''}</div>
        <div class="task-main">
          <div class="task-title-row">
            <span class="task-title">${escapeHtml(task.title)}</span>
            ${taskColorDot}
            ${subjectHtml}
            ${priorityBadge}
          </div>
          <div class="task-meta">
            ${dueDateHtml}
            ${countdownHtml}
            ${recurrenceHtml}
            ${reminderHtml}
          </div>
          ${subtasksHtml}
        </div>
        <div class="task-actions">
          <button class="task-action-btn ai-btn" data-action="ai-breakdown" title="×¤×™×¨×•×§ ×ž×©×™×ž×” ×¢× AI / AI Break Down" aria-label="AI Break Down">âœ¨</button>
          <div class="task-reminder-wrap">
            <button class="task-reminder-btn ${task.reminder ? 'has-reminder' : ''}" data-action="reminder" title="${task.reminder ? `×ª×–×›×•×¨×ª ${task.reminder} ×“×§×•×ª ×œ×¤× ×™` : '×”×’×“×¨ ×ª×–×›×•×¨×ª'}">ðŸ””</button>
            <div class="task-reminder-dropdown" data-task-id="${task.id}">
              <div class="task-reminder-option" data-minutes="1">×“×§×” ××—×ª</div>
              <div class="task-reminder-option" data-minutes="5">5 ×“×§×•×ª</div>
              <div class="task-reminder-option" data-minutes="15">15 ×“×§×•×ª</div>
              <div class="task-reminder-option" data-minutes="60">×©×¢×”</div>
              <div class="task-reminder-option" data-minutes="1440">×™×•×</div>
              ${task.reminder ? '<div class="task-reminder-option remove" data-minutes="0">×”×¡×¨ ×ª×–×›×•×¨×ª</div>' : ''}
            </div>
          </div>
          <button class="task-action-btn" data-action="edit" title="Edit" aria-label="×¢×¨×™×›×”">âœï¸</button>
          <button class="task-action-btn" data-action="duplicate" title="Duplicate" aria-label="×©×›×¤×œ">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
          </button>
          <button class="task-action-btn delete" data-action="delete" title="Delete" aria-label="×ž×—×§">ðŸ—‘ï¸</button>
        </div>
      </div>
    `;
  }

  function formatTaskDueDisplay(dueIso) {
    if (!dueIso) return '+ ×ª××¨×™×š';
    const dueDate = new Date(dueIso);
    const day = dueDate.getDate();
    const month = dueDate.toLocaleDateString('he-IL', { month: 'short' });
    const time = dueDate.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
    return `${day} ${month}, ${time}`;
  }

  function startInlineTaskTitleEdit(titleEl, task) {
    if (titleEl.dataset.editing === '1') return;
    titleEl.dataset.editing = '1';

    const input = document.createElement('input');
    input.type = 'text';
    input.value = task.title || '';
    input.className = 'inline-edit-input';
    titleEl.replaceWith(input);
    input.focus();
    input.select();

    const finish = (commit) => {
      input.replaceWith(titleEl);
      delete titleEl.dataset.editing;
      if (commit) {
        const newTitle = input.value.trim() || task.title;
        titleEl.textContent = newTitle;
        const { id, isOwn, isShared, ...clean } = task;
        saveTask(task.id, { ...clean, title: newTitle }, task.subject);
      }
    };

    input.addEventListener('keydown', (ev) => {
      if (ev.key === 'Enter') finish(true);
      else if (ev.key === 'Escape') finish(false);
    });
    input.addEventListener('blur', () => finish(true));
  }

  function startInlineTaskDueEdit(dueEl, task) {
    if (dueEl.dataset.editing === '1') return;
    dueEl.dataset.editing = '1';

    const input = document.createElement('input');
    input.type = 'datetime-local';
    input.value = task.dueDate ? toLocalDatetime(task.dueDate) : '';
    input.className = 'inline-edit-input small';
    dueEl.replaceWith(input);
    input.focus();

    const finish = (commit) => {
      input.replaceWith(dueEl);
      delete dueEl.dataset.editing;
      if (commit) {
        let newDue = null;
        if (input.value) {
          const parsed = parseLocal(input.value);
          if (parsed && !isNaN(parsed.getTime())) {
            newDue = parsed.toISOString();
          } else {
            // invalid -> keep original display
            dueEl.textContent = dueEl.textContent || '+ ×ª××¨×™×š';
            return;
          }
        }
        const { id, isOwn, isShared, ...clean } = task;
        saveTask(task.id, { ...clean, dueDate: newDue }, task.subject);
        dueEl.dataset.dueIso = newDue || '';
        dueEl.textContent = newDue ? `ðŸ“… ${formatTaskDueDisplay(newDue)}` : '+ ×ª××¨×™×š';
        dueEl.classList.toggle('add', !newDue);
      }
    };

    input.addEventListener('keydown', (ev) => {
      if (ev.key === 'Enter') finish(true);
      else if (ev.key === 'Escape') finish(false);
    });
    input.addEventListener('blur', () => finish(true));
  }

  let activePriorityPopover = null;

  function closePriorityPopover() {
    if (activePriorityPopover) {
      activePriorityPopover.remove();
      activePriorityPopover = null;
    }
  }

  function startInlineTaskPriorityEdit(badgeEl, task) {
    closePriorityPopover();

    const pop = document.createElement('div');
    pop.className = 'priority-popover';

    ['urgent', 'high', 'medium', 'low', 'none'].forEach(key => {
      const btn = document.createElement('button');
      btn.textContent = key === 'none' ? '×œ×œ× ×¢×“×™×¤×•×ª' : (PRIORITY_LABELS[key] || key);
      btn.dataset.priority = key;
      btn.onclick = (ev) => {
        ev.stopPropagation();
        const { id, isOwn, isShared, ...clean } = task;
        saveTask(task.id, { ...clean, priority: key }, task.subject);
        badgeEl.textContent = key === 'none' ? '×§×‘×¢ ×¢×“×™×¤×•×ª' : (PRIORITY_LABELS[key] || key);
        badgeEl.dataset.priority = key;
        badgeEl.classList.toggle('muted', key === 'none');
        closePriorityPopover();
      };
      pop.appendChild(btn);
    });

    const rect = badgeEl.getBoundingClientRect();
    pop.style.top = `${rect.bottom + 8}px`;
    pop.style.left = `${Math.max(8, rect.left - 60)}px`;

    document.body.appendChild(pop);
    activePriorityPopover = pop;

    setTimeout(() => {
      const outsideHandler = (ev) => {
        if (!pop.contains(ev.target)) {
          closePriorityPopover();
          document.removeEventListener('click', outsideHandler);
        }
      };
      document.addEventListener('click', outsideHandler);
    }, 0);
  }
  
  // ============ EVENT DELEGATION FOR TASK LIST ============
  // Single click handler for all task interactions - much more efficient than per-item listeners
  function setupTaskEventDelegation() {
    const containers = [activeTasks, completedTasks];
    
    containers.forEach(container => {
      if (!container) return;
      
      container.addEventListener('click', (e) => {
        const taskItem = e.target.closest('.task-item');
        if (!taskItem) return;
        
        const taskId = taskItem.dataset.id;
        const task = tasks.find(t => t.id === taskId);
        if (!task) return;

        const titleEl = e.target.closest('.task-title');
        if (titleEl) {
          e.stopPropagation();
          startInlineTaskTitleEdit(titleEl, task);
          return;
        }

        const dueEl = e.target.closest('.task-due');
        if (dueEl) {
          e.stopPropagation();
          startInlineTaskDueEdit(dueEl, task);
          return;
        }

        const priorityEl = e.target.closest('.task-priority-badge');
        if (priorityEl) {
          e.stopPropagation();
          startInlineTaskPriorityEdit(priorityEl, task);
          return;
        }
        
        // Reminder button and dropdown
        const reminderBtn = e.target.closest('.task-reminder-btn');
        const reminderOption = e.target.closest('.task-reminder-option');
        
        if (reminderBtn) {
          e.stopPropagation();
          const dropdown = reminderBtn.nextElementSibling;
          // Close other dropdowns
          document.querySelectorAll('.task-reminder-dropdown.open').forEach(d => {
            if (d !== dropdown) d.classList.remove('open');
          });
          dropdown.classList.toggle('open');
          return;
        }
        
        if (reminderOption) {
          e.stopPropagation();
          const minutes = parseInt(reminderOption.dataset.minutes, 10);
          const { id, isOwn, isShared, ...cleanTask } = task;
          saveTask(taskId, { ...cleanTask, reminder: minutes || null }, task.subject);
          // Close dropdown
          e.target.closest('.task-reminder-dropdown').classList.remove('open');
          return;
        }
        
        // Check what was clicked
        const action = e.target.closest('[data-action]')?.dataset.action;
        const isSubtaskCheckbox = e.target.closest('.task-subtask input[type="checkbox"]');
        const isInlineInput = e.target.tagName === 'INPUT' && e.target.classList.contains('inline-edit-input');
        const isMainArea = e.target.closest('.task-main') && !isSubtaskCheckbox && !isInlineInput;
        
        if (action === 'toggle' || e.target.closest('.task-checkbox')) {
          // Toggle complete
          e.stopPropagation();
          const nextCompleted = !task.completed;
          if (nextCompleted) {
            maybeCreateRecurringTask(task);
          }
          const { id, isOwn, isShared, ...cleanTask } = task;
          saveTask(taskId, { ...cleanTask, completed: nextCompleted }, task.subject);
        } else if (action === 'edit') {
          // Edit button
          e.stopPropagation();
          openTaskEditModal(taskId);
        } else if (action === 'ai-breakdown') {
          // AI breakdown quick action
          e.stopPropagation();
          handleQuickAIBreakdown(task);
        } else if (action === 'duplicate') {
          // Duplicate button
          e.stopPropagation();
          pushTaskClone(task);
        } else if (action === 'delete') {
          // Delete button
          e.stopPropagation();
          removeTask(task);
        } else if (isSubtaskCheckbox) {
          // Subtask checkbox
          e.stopPropagation();
          const idx = parseInt(isSubtaskCheckbox.dataset.index);
          if (task.checklist && task.checklist[idx] !== undefined) {
            task.checklist[idx].checked = isSubtaskCheckbox.checked;
            const { id, isOwn, isShared, ...cleanTask } = task;
            saveTask(taskId, cleanTask, task.subject);
          }
        } else if (isMainArea) {
          // Click on main area to edit
          openTaskEditModal(taskId);
        }
      });
    });
  }
  
  // Initialize event delegation once
  setupTaskEventDelegation();
  
  // Close task reminder dropdowns when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.task-reminder-wrap')) {
      document.querySelectorAll('.task-reminder-dropdown.open').forEach(d => d.classList.remove('open'));
    }
  });
  
  let draggingTaskId = null;
  let dragSourceContainer = null;
  
  function ensureTaskOrderInitialized() {
    // Don't initialize order for tasks - let sortTasks handle the default sorting
    // Only tasks that have been manually dragged will have manualOrder: true
    return;
  }
  
  function updateTaskOrderFromContainer(container) {
    const items = Array.from(container.querySelectorAll('.task-item'));
    const updates = [];
    
    items.forEach((item, index) => {
      const taskId = item.dataset.id;
      const task = tasks.find(t => t.id === taskId);
      if (!task) return;
      if (task.order !== index || !task.manualOrder) {
        task.order = index;
        task.manualOrder = true; // Mark as manually ordered when dragged
        updates.push(task);
      }
    });
    
    updates.forEach((task) => {
      const { id, ...cleanTask } = task;
      saveTask(task.id, cleanTask, task.subject);
    });
  }
  
  function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.task-item:not(.dragging)')];
    let closest = { offset: Number.NEGATIVE_INFINITY, element: null };
    
    draggableElements.forEach(child => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height / 2;
      if (offset < 0 && offset > closest.offset) {
        closest = { offset, element: child };
      }
    });
    
    return closest.element;
  }

  function clearTaskDragState() {
    document.querySelectorAll('.task-item.dragging').forEach(el => el.classList.remove('dragging'));
    document.querySelectorAll('.subject-list-header.drag-over, .subject-child-item.drag-over').forEach(el => {
      el.classList.remove('drag-over');
    });
    draggingTaskId = null;
    dragSourceContainer = null;
  }

  function assignTaskToSubject(taskId, subjectId) {
    const task = tasks.find(t => t.id === taskId);
    if (!task || task.subject === subjectId) {
      clearTaskDragState();
      return;
    }
    
    // When moving tasks between own/shared, need to delete from old location and create in new
    const oldSubject = subjects.find(s => s.id === task.subject);
    const newSubject = subjects.find(s => s.id === subjectId);
    const wasShared = oldSubject?.isShared;
    const willBeShared = newSubject?.isShared;
    
    if (wasShared !== willBeShared) {
      // Moving between own and shared - need to delete from old and create in new
      const { id, isShared, ...cleanTask } = task;
      cleanTask.subject = subjectId || '';
      
      // Remove from old location
      removeTask(task);
      
      // Create in new location
      if (willBeShared) {
        const newTaskRef = push(ref(db, `sharedSubjects/${subjectId}/tasks`));
        set(newTaskRef, cleanTask);
      } else {
        const newTaskRef = push(tasksRef);
        set(newTaskRef, cleanTask);
      }
    } else {
      // Same type - just update the subject field
      const { id, ...cleanTask } = task;
      saveTask(taskId, { ...cleanTask, subject: subjectId || '' }, subjectId || task.subject);
    }
    clearTaskDragState();
  }
  
  function setupTaskDragAndDrop() {
    const containers = [activeTasks, completedTasks];
    
    containers.forEach(container => {
      if (!container) return;
      
      container.addEventListener('dragstart', (e) => {
        const item = e.target.closest('.task-item');
        if (!item) return;
        if (e.target.closest('input, textarea, select, button, a')) {
          e.preventDefault();
          return;
        }
        draggingTaskId = item.dataset.id;
        dragSourceContainer = container;
        item.classList.add('dragging');
        ensureTaskOrderInitialized();
        if (e.dataTransfer) {
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', draggingTaskId);
        }
      });
      
      container.addEventListener('dragover', (e) => {
        if (!draggingTaskId || dragSourceContainer !== container) return;
        e.preventDefault();
        const draggingEl = container.querySelector('.task-item.dragging');
        if (!draggingEl) return;
        const afterElement = getDragAfterElement(container, e.clientY);
        if (afterElement == null) {
          container.appendChild(draggingEl);
        } else if (afterElement !== draggingEl) {
          container.insertBefore(draggingEl, afterElement);
        }
      });
      
      container.addEventListener('drop', (e) => {
        if (!draggingTaskId || dragSourceContainer !== container) return;
        e.preventDefault();
        updateTaskOrderFromContainer(container);
        clearTaskDragState();
      });
      
      container.addEventListener('dragend', () => {
        clearTaskDragState();
      });
    });
  }
  
  setupTaskDragAndDrop();
  
  // Task countdown ticker
  function startTaskTicker() {
    if (taskTickerHandle) return;
    const tick = () => {
      document.querySelectorAll('.task-countdown[data-due]').forEach(el => {
        const dueDate = el.dataset.due;
        const countdown = calcTaskCountdown(dueDate);
        if (countdown) {
          el.textContent = countdown.text;
          el.className = 'task-countdown ' + (countdown.overdue ? 'overdue' : (countdown.urgency === 'soon' ? 'soon' : ''));
        }
      });
      
      // Check task reminders
      const nowMs = Date.now();
      tasks.forEach(task => {
        if (task.completed) return;
        const reminderMinutes = parseInt(task.reminder, 10) || 0;
        if (!reminderMinutes) return;
        if (!task.dueDate) return;
        const reminderKey = `${task.dueDate}|${reminderMinutes}`;
        if (notifiedTasks.get(task.id) === reminderKey) return;
        const taskTime = new Date(task.dueDate).getTime();
        if (!Number.isFinite(taskTime)) return;
        const triggerTime = taskTime - (reminderMinutes * 60000);
        if (nowMs >= triggerTime && nowMs < triggerTime + 60000) {
          triggerTaskAlert(task);
          notifiedTasks.set(task.id, reminderKey);
        }
      });
    };
    tick();
    taskTickerHandle = setInterval(tick, 60000); // Update every minute
  }
  
	  function triggerTaskAlert(task) {
	    const dueDate = new Date(task.dueDate);
	    const dateStr = dueDate.toLocaleDateString('he-IL', { weekday: 'long', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
	    const title = `ðŸ“‹ ×ª×–×›×•×¨×ª ×ž×©×™×ž×”: ${task.title}`;
	    const message = `×ž×•×¢×“ ×™×¢×“: ${dateStr}`;
    
    // Play sound
    if (reminderAudio) {
      reminderAudio.currentTime = 0;
      reminderAudio.play().catch(() => {});
	    }
	    
	    // Show browser notification if permitted
	    if ("Notification" in window && Notification.permission === 'granted') {
	      new Notification(title, { body: message, tag: `task-${task.id}` });
	    }
    
    // Show in-app alert
    showEventAlert(title, message, true);
  }
  
  function stopTaskTicker() {
    if (taskTickerHandle) {
      clearInterval(taskTickerHandle);
      taskTickerHandle = null;
    }
  }
  
  // Task Edit Modal
  function openTaskEditModal(taskId) {
    editingTaskId = taskId;
    editingTask = JSON.parse(JSON.stringify(tasks.find(t => t.id === taskId)));
    if (!editingTask) return;
    
    editTaskTitle.value = editingTask.title || '';
    editTaskContent.value = editingTask.content || '';
    
    // Set priority
    editTaskPriority.querySelectorAll('.priority-option').forEach(o => {
      o.classList.toggle('selected', o.dataset.priority === (editingTask.priority || 'none'));
    });

    setTaskColorSelection(taskColorPicker, editingTask.color || '');
    updateSubjectColorOption(taskColorPicker, getSubjectColorById(editingTask.subject || ''));
    
    // Set due date
    if (editingTask.dueDate) {
      editTaskDue.value = toLocalDatetime(editingTask.dueDate);
    } else {
      editTaskDue.value = '';
    }
    
    if (editTaskRecurrence) {
      editTaskRecurrence.value = normalizeRecurrence(editingTask.recurrence);
    }
    
    // Set reminder with custom support
    if (editTaskReminder) {
      setTaskReminderUI(editTaskReminder, editTaskReminderCustomWrap, editTaskReminderCustomValue, editTaskReminderCustomUnit, editingTask.reminder || 0);
    }
    
    // Render checklist
    renderEditChecklist();
    
    taskEditModal.classList.add('open');
  }
  
  function closeTaskEditModal() {
    taskEditModal.classList.remove('open');
    editingTaskId = null;
    editingTask = null;
  }
  
  taskEditModal.addEventListener('click', (e) => {
    if (e.target === taskEditModal) closeTaskEditModal();
  });
  
  // Edit modal priority picker
  editTaskPriority.addEventListener('click', (e) => {
    const option = e.target.closest('.priority-option');
    if (!option || !editingTask) return;
    editTaskPriority.querySelectorAll('.priority-option').forEach(o => o.classList.remove('selected'));
    option.classList.add('selected');
    editingTask.priority = option.dataset.priority;
  });

  bindTaskColorPicker(taskColorPicker, (color) => {
    if (editingTask) {
      editingTask.color = color || '';
    }
  });
  
  // Clear due date
  clearDueBtn.onclick = () => {
    editTaskDue.value = '';
    if (editingTask) editingTask.dueDate = null;
  };
  
  function renderEditChecklist() {
    if (!editingTask.checklist) editingTask.checklist = [];
    editTaskChecklist.innerHTML = editingTask.checklist.map((item, i) => `
      <div class="task-checklist-item ${item.checked ? 'checked' : ''}">
        <input type="checkbox" ${item.checked ? 'checked' : ''} data-index="${i}" />
        <span>${escapeHtml(item.text)}</span>
        <button class="task-action-btn delete" data-index="${i}" style="margin-left: auto;">Ã—</button>
      </div>
    `).join('');
    
    // Add handlers
    editTaskChecklist.querySelectorAll('input[type="checkbox"]').forEach(cb => {
      cb.addEventListener('change', () => {
        const idx = parseInt(cb.dataset.index);
        editingTask.checklist[idx].checked = cb.checked;
        renderEditChecklist();
      });
    });
    
    editTaskChecklist.querySelectorAll('.task-action-btn.delete').forEach(btn => {
      btn.addEventListener('click', () => {
        const idx = parseInt(btn.dataset.index);
        editingTask.checklist.splice(idx, 1);
        renderEditChecklist();
      });
    });
  }
  
  addChecklistItem.onclick = () => {
    const text = newChecklistItem.value.trim();
    if (!text || !editingTask) return;
    editingTask.checklist.push({ text, checked: false });
    newChecklistItem.value = '';
    renderEditChecklist();
  };
  
  newChecklistItem.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') addChecklistItem.click();
  });

  // AI Break Down Task
  const aiBreakDownBtn = $('aiBreakDownBtn');
  if (aiBreakDownBtn) {
    aiBreakDownBtn.onclick = async () => {
      if (!editingTask || !editingTask.title) {
        alert('× × ×œ×”×–×™×Ÿ ×›×•×ª×¨×ª ×ž×©×™×ž×” / Please enter a task title first');
        return;
      }

      // Check API key configuration
      if (AI_CONFIG.gemini.apiKey === 'YOUR_GEMINI_API_KEY' && AI_CONFIG.openai.apiKey === 'YOUR_OPENAI_API_KEY') {
        alert('âš ï¸ Please configure AI API keys in the code!\n\nEdit index.html and search for "AI_CONFIG" to add your Gemini or OpenAI API key.\n\nGet Gemini key: https://makersuite.google.com/app/apikey\nGet OpenAI key: https://platform.openai.com/api-keys');
        return;
      }

      aiBreakDownBtn.disabled = true;
      aiBreakDownBtn.textContent = 'â³ ×ž×¤×¨×§...';
      
      try {
        const subtasks = await breakDownTaskWithAI(editingTask.title, editingTask.content);
        
        // Add subtasks to checklist
        if (!editingTask.checklist) editingTask.checklist = [];
        subtasks.forEach(text => {
          editingTask.checklist.push({ text, checked: false });
        });
        
        renderEditChecklist();
        alert(`âœ… × ×•×¡×¤×• ${subtasks.length} ×ª×ª-×ž×©×™×ž×•×ª / Added ${subtasks.length} subtasks`);
        
      } catch (error) {
        console.error('AI breakdown error:', error);
        alert(`âŒ ×©×’×™××”: ${error.message}\n\nMake sure:\n1. API key is configured correctly\n2. You have internet connection\n3. API has sufficient quota`);
      } finally {
        aiBreakDownBtn.disabled = false;
        aiBreakDownBtn.innerHTML = 'âœ¨ AI Break Down';
      }
    };
  }
  
  // Delete task
  deleteTaskBtn.onclick = () => {
    if (!editingTaskId) return;
    remove(ref(db, `users/${currentUser}/tasks/${editingTaskId}`));
    closeTaskEditModal();
  };
  
  if (duplicateTaskBtn) {
    duplicateTaskBtn.onclick = () => {
      if (!editingTask) return;
      pushTaskClone(editingTask);
      closeTaskEditModal();
    };
  }
  
  // Save task
  saveTaskBtn.onclick = () => {
    if (!editingTaskId || !editingTask) return;
    
    const oldSubjectId = editingTask.subject;
    const newSubjectId = editTaskSubject.value || '';
    
    editingTask.title = editTaskTitle.value.trim() || 'Untitled';
    editingTask.content = editTaskContent.value.trim();
    editingTask.subject = newSubjectId;
    editingTask.color = getTaskColorFromPicker(taskColorPicker) || '';
    const recurrenceValue = editTaskRecurrence ? editTaskRecurrence.value : 'none';
    if (recurrenceValue && recurrenceValue !== 'none') {
      editingTask.recurrence = recurrenceValue;
    } else {
      delete editingTask.recurrence;
    }
    
    // Update reminder (with custom support)
    const reminderValue = getTaskReminderMinutes(editTaskReminder, editTaskReminderCustomValue, editTaskReminderCustomUnit);
    if (reminderValue > 0) {
      editingTask.reminder = reminderValue;
    } else {
      delete editingTask.reminder;
    }
    
    // Update due date
    const dueValue = editTaskDue.value;
    if (dueValue) {
      const parsedDue = parseLocal(dueValue);
      editingTask.dueDate = parsedDue ? parsedDue.toISOString() : null;
    } else {
      editingTask.dueDate = null;
    }
    
    // Check if moving between own/shared subjects
    const oldSubject = subjects.find(s => s.id === oldSubjectId);
    const newSubject = subjects.find(s => s.id === newSubjectId);
    const wasShared = oldSubject?.isShared || editingTask.isShared;
    const willBeShared = newSubject?.isShared;
    
    // Remove id and isShared before saving to Firebase
    const { id, isShared, ...cleanTask } = editingTask;
    
    if (wasShared !== willBeShared && oldSubjectId !== newSubjectId) {
      // Moving between own and shared - delete from old, create in new
      if (wasShared) {
        remove(ref(db, `sharedSubjects/${oldSubjectId}/tasks/${editingTaskId}`));
      } else {
        remove(ref(db, `users/${currentUser}/tasks/${editingTaskId}`));
      }
      
      if (willBeShared) {
        const newTaskRef = push(ref(db, `sharedSubjects/${newSubjectId}/tasks`));
        set(newTaskRef, cleanTask);
      } else {
        const newTaskRef = push(tasksRef);
        set(newTaskRef, cleanTask);
      }
    } else {
      // Same type - just update in place
      saveTask(editingTaskId, cleanTask, newSubjectId || oldSubjectId);
    }
    closeTaskEditModal();
  };

  // Enter key support for task edit modal
  [editTaskTitle, editTaskContent, editTaskDue].forEach(el => {
    if (el) {
      el.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey && e.target.tagName !== 'TEXTAREA') {
          e.preventDefault();
          saveTaskBtn.click();
        }
      });
    }
  });

  // ============ SUBJECTS / CATEGORIES ============

  const cachedSubjectsKey = `${CACHE_KEYS.SUBJECTS_PREFIX}${currentUser}`;
  const cachedSubjects = readCache(cachedSubjectsKey);
  if (cachedSubjects && cachedSubjects.length) {
    subjects = cachedSubjects;
    syncCacheUsed.subjects = true;
    updateSyncBadge();
    renderSubjectsSidebar();
    updateSubjectSelectors();
    updateParentSubjectSelector();
  } else {
    startSyncTimeout('subjects', SUBJECTS_NO_CACHE_TIMEOUT_MS, 'no-cache', () => {
      renderSubjectsSidebar();
      updateSubjectSelectors();
      updateParentSubjectSelector();
    });
  }
  
  // Listen to subjects from Firebase
  startSyncTimeout('subjects', SYNC_TIMEOUT_MS, 'firebase', () => {
    renderSubjectsSidebar();
    updateSubjectSelectors();
    updateParentSubjectSelector();
  });
  
  // Own subjects
  let ownSubjects = [];
  // Shared subjects (from sharedSubjects where current user is a member)
  let sharedSubjects = [];
  
  function mergeSubjects() {
    // Combine own subjects with shared subjects
    subjects = [...ownSubjects, ...sharedSubjects];
    renderSubjectsSidebar();
    updateSubjectSelectors();
    updateParentSubjectSelector();
  }
  
  onValue(subjectsRef, (snapshot) => {
    clearSyncTimeouts('subjects');
    const data = snapshot.val();
    if (data) {
      ownSubjects = Object.keys(data).map(key => ({ id: key, ...data[key], isOwn: true }));
    } else {
      ownSubjects = [];
    }
    writeCache(cachedSubjectsKey, ownSubjects, 200);
    markSyncReady('subjects', 'firebase');
    mergeSubjects();
  }, (error) => {
    console.error('Subjects sync error:', error);
    clearSyncTimeouts('subjects');
    markSyncReady('subjects', 'error');
    updateSyncBadge();
  });
  
  // Listen to shared subjects
  const sharedSubjectsRef = ref(db, 'sharedSubjects');
  onValue(sharedSubjectsRef, (snapshot) => {
    const data = snapshot.val();
    if (data) {
      sharedSubjects = Object.keys(data)
        .map(key => ({ id: key, ...data[key], isShared: true }))
        .filter(s => {
          // Only include subjects where current user is owner or member
          const members = s.members || {};
          return s.owner === currentUser || members[currentUser];
        });
    } else {
      sharedSubjects = [];
    }
    mergeSubjects();
    // Also sync shared tasks
    syncSharedTasks();
  });
  
  // Shared tasks storage
  let sharedTasks = [];
  let sharedTasksListeners = []; // Store unsubscribe functions
  
  function syncSharedTasks() {
    // Unsubscribe from previous listeners
    sharedTasksListeners.forEach(unsub => unsub());
    sharedTasksListeners = [];
    sharedTasks = [];
    
    // Set up listeners for each shared subject's tasks
    sharedSubjects.forEach(subject => {
      const tasksRef = ref(db, `sharedSubjects/${subject.id}/tasks`);
      const unsubscribe = onValue(tasksRef, (snap) => {
        const tasksData = snap.val();
        // Remove old tasks for this subject
        sharedTasks = sharedTasks.filter(t => t.subject !== subject.id);
        // Add new tasks
        if (tasksData) {
          Object.keys(tasksData).forEach(taskId => {
            sharedTasks.push({
              id: taskId,
              ...tasksData[taskId],
              subject: subject.id,
              isShared: true
            });
          });
        }
        mergeTasks();
      });
      sharedTasksListeners.push(unsubscribe);
    });
    
    // If no shared subjects, just merge
    if (sharedSubjects.length === 0) {
      mergeTasks();
    }
  }
  
  // Own tasks storage
  let ownTasks = [];
  
  function mergeTasks() {
    tasks = [...ownTasks, ...sharedTasks];
    if (taskManagerOverlay.classList.contains('open')) {
      renderTasks();
    }
    // Update daily planner if open
    if (typeof DailyPlanner !== 'undefined' && DailyPlanner.refreshTasks) {
      DailyPlanner.refreshTasks();
    }
  }
  
  // Get top-level subjects (no parent)
  function getTopLevelSubjects() {
    return subjects.filter(s => !s.parentId);
  }
  
  // Get children of a subject
  function getChildSubjects(parentId) {
    return subjects.filter(s => s.parentId === parentId);
  }
  
  // Count tasks for a subject including children
  function countSubjectTasks(subjectId, includeChildren = true) {
    let count = tasks.filter(t => t.subject === subjectId && !t.completed).length;
    if (includeChildren) {
      const children = getChildSubjects(subjectId);
      children.forEach(c => {
        count += tasks.filter(t => t.subject === c.id && !t.completed).length;
      });
    }
    return count;
  }
  
  // Helper function to get the correct task reference based on subject type
  function getTaskRef(task) {
    if (!task) return null;
    const subject = subjects.find(s => s.id === task.subject);
    if (subject?.isShared) {
      return ref(db, `sharedSubjects/${task.subject}/tasks/${task.id}`);
    }
    return ref(db, `users/${currentUser}/tasks/${task.id}`);
  }
  
  // Helper to save task to correct location
  function saveTask(taskId, taskData, subjectId) {
    const subject = subjects.find(s => s.id === subjectId);
    if (subject?.isShared) {
      return set(ref(db, `sharedSubjects/${subjectId}/tasks/${taskId}`), taskData);
    }
    return set(ref(db, `users/${currentUser}/tasks/${taskId}`), taskData);
  }
  
  // Helper to remove task from correct location
  function removeTask(task) {
    if (!task) return;
    const subject = subjects.find(s => s.id === task.subject);
    if (subject?.isShared || task.isShared) {
      return remove(ref(db, `sharedSubjects/${task.subject}/tasks/${task.id}`));
    }
    return remove(ref(db, `users/${currentUser}/tasks/${task.id}`));
  }
  
  // Helper to create a new task in the correct location based on subject
  function createTask(taskData) {
    const subjectId = taskData.subject;
    const subject = subjects.find(s => s.id === subjectId);
    if (subject?.isShared) {
      const newTaskRef = push(ref(db, `sharedSubjects/${subjectId}/tasks`));
      return set(newTaskRef, taskData);
    }
    const newTaskRef = push(tasksRef);
    return set(newTaskRef, taskData);
  }
  
  // ============ SMART VIEWS COUNTS ============
  function updateSmartViewCounts() {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    const weekLater = new Date(today);
    weekLater.setDate(weekLater.getDate() + 7);
    
    const activeTasks = tasks.filter(t => !t.completed);
    
    const allCount = activeTasks.length;
    const todayCount = activeTasks.filter(t => {
      if (!t.dueDate) return false;
      const due = new Date(t.dueDate);
      return due >= today && due < tomorrow;
    }).length;
    const weekCount = activeTasks.filter(t => {
      if (!t.dueDate) return false;
      const due = new Date(t.dueDate);
      return due >= today && due < weekLater;
    }).length;
    const overdueCount = activeTasks.filter(t => {
      if (!t.dueDate) return false;
      const due = new Date(t.dueDate);
      return due < now; // Use 'now' for accurate overdue detection
    }).length;
    const noDateCount = activeTasks.filter(t => !t.dueDate).length;
    
    // Update counts
    const countAll = $('countAll');
    const countToday = $('countToday');
    const countWeek = $('countWeek');
    const countOverdue = $('countOverdue');
    const countNoDate = $('countNoDate');
    
    if (countAll) countAll.textContent = allCount;
    if (countToday) countToday.textContent = todayCount;
    if (countWeek) countWeek.textContent = weekCount;
    if (countOverdue) countOverdue.textContent = overdueCount;
    if (countNoDate) countNoDate.textContent = noDateCount;
  }
  
  // ============ TASK CALENDAR ============
  let currentTaskMonth = new Date();
  let taskCalendarExpanded = false;
  let taskCalendarView = 'month';
  let taskCalendarFocusDate = new Date();
  const taskCalendarGrid = $("taskCalendarGrid");
  const taskCalendarTitle = $("taskCalendarTitle");
  const taskMonthEvents = $("taskMonthEvents");
  const taskMonthEventsTitle = $("taskMonthEventsTitle");
  const toggleTaskCalendarSize = $("toggleTaskCalendarSize");
  const taskCalendarViewToggle = $("taskCalendarViewToggle");
  const taskRightSidebar = $("taskRightSidebar");

  // Event delegation for Task calendar in Task Manager
  if (taskCalendarGrid) {
    taskCalendarGrid.addEventListener('click', (e) => {
      const chip = e.target.closest('.calendar-event-chip');
      if (chip) {
        e.stopPropagation();
        const taskId = chip.dataset.taskId;
        if (taskId) {
          const taskRow = document.querySelector(`.task-item[data-id="${taskId}"]`);
          if (taskRow) {
            taskRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            taskRow.style.transition = 'box-shadow 0.3s';
            taskRow.style.boxShadow = '0 0 0 3px var(--accent)';
            setTimeout(() => { taskRow.style.boxShadow = ''; }, 800);
          }
        }
        return;
      }

      const day = e.target.closest('.calendar-day:not(.other-month)');
      if (day) {
        const dateKey = day.dataset.date;
        if (!dateKey) return;
        const focusDate = new Date(`${dateKey}T00:00`);
        if (!Number.isNaN(focusDate.getTime())) {
          setTaskCalendarFocus(focusDate);
        }
        const taskDueInput = $("newTaskDue");
        const taskTitleInput = $("newTaskTitle");
        const quickRow = $("quickAddRow");
        if (taskDueInput) taskDueInput.value = dateKey + 'T23:59';
        if (taskTitleInput) taskTitleInput.focus();
        if (quickRow) quickRow.style.display = 'flex';
        if (quickAddTask) {
          quickAddTask.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      }
    });
  }

  function getTaskCalendarMaxShow() {
    if (taskCalendarView === 'day') return taskCalendarExpanded ? 15 : 8;
    if (taskCalendarView === 'week') return taskCalendarExpanded ? 8 : 4;
    return taskCalendarExpanded ? 5 : 3;
  }

  function updateTaskCalendarViewToggle() {
    if (!taskCalendarViewToggle) return;
    taskCalendarViewToggle.querySelectorAll('button').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.view === taskCalendarView);
    });
  }

  function updateTaskCalendarViewClasses() {
    if (!taskRightSidebar) return;
    taskRightSidebar.classList.toggle('calendar-view-week', taskCalendarView === 'week');
    taskRightSidebar.classList.toggle('calendar-view-day', taskCalendarView === 'day');
  }

  function setTaskCalendarView(view) {
    const prevView = taskCalendarView;
    taskCalendarView = view;
    if (taskCalendarView === 'month') {
      currentTaskMonth = new Date(taskCalendarFocusDate.getFullYear(), taskCalendarFocusDate.getMonth(), 1);
    } else if (prevView === 'month') {
      const base = new Date(currentTaskMonth.getFullYear(), currentTaskMonth.getMonth(), taskCalendarFocusDate.getDate() || 1);
      setTaskCalendarFocus(base);
    }
    updateTaskCalendarViewToggle();
    updateTaskCalendarViewClasses();
    renderTaskCalendar();
  }

  function setTaskCalendarFocus(date) {
    const d = new Date(date);
    if (Number.isNaN(d.getTime())) return;
    d.setHours(0, 0, 0, 0);
    taskCalendarFocusDate = d;
  }

  function getStartOfWeek(date) {
    const d = new Date(date);
    const dayIndex = d.getDay();
    d.setDate(d.getDate() - dayIndex);
    d.setHours(0, 0, 0, 0);
    return d;
  }

  function formatHebrewShortDate(date) {
    return date.toLocaleDateString('he-IL', { day: 'numeric', month: 'short' });
  }
  
  function renderTaskCalendar() {
    if (!taskCalendarGrid || !taskCalendarTitle) return;

    updateTaskCalendarViewToggle();
    updateTaskCalendarViewClasses();

    const today = new Date();
    const todayKey = toDateKey(today);

    // Build task map by date (exclude countdowns/events)
    const tasksByDate = {};
    tasks.forEach(task => {
      if (!task.dueDate) return;
      if (task.isCountdown || task.isEvent) return;
      const key = toDateKey(task.dueDate);
      if (!tasksByDate[key]) tasksByDate[key] = [];
      tasksByDate[key].push(task);
    });

    let html = '';
    const maxShow = getTaskCalendarMaxShow();

    if (taskCalendarView === 'month') {
      const year = currentTaskMonth.getFullYear();
      const month = currentTaskMonth.getMonth();
      taskCalendarTitle.textContent = `${HEBREW_MONTHS[month]} ${year}`;

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDay = firstDay.getDay();
      const daysInMonth = lastDay.getDate();

      for (let i = 0; i < 7; i++) {
        html += `<div class="calendar-day-name">${HEBREW_DAYS[i]}</div>`;
      }

      const prevMonth = new Date(year, month, 0);
      const prevDays = prevMonth.getDate();
      for (let i = startDay - 1; i >= 0; i--) {
        const day = prevDays - i;
        html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const dateKey = `${year}-${String(month + 1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const isToday = dateKey === todayKey;
        const dayTasks = tasksByDate[dateKey] || [];
        let classes = 'calendar-day';
        if (isToday) classes += ' today';

        let eventsHtml = '<div class="calendar-day-events">';
        const showTime = dayTasks.length > 1;
        dayTasks.slice(0, maxShow).forEach(task => {
          const subjectColor = subjects.find(s => s.id === task.subject)?.color;
          const resolvedColor = resolveTaskColor(task, subjectColor);
          const color = resolvedColor || subjectColor || '#667eea';
          const safeName = escapeHtml(task.title);
          const evtDate = new Date(task.dueDate);
          const timeStr = showTime ? `${String(evtDate.getHours()).padStart(2,'0')}:${String(evtDate.getMinutes()).padStart(2,'0')} ` : '';
          const displayText = timeStr + safeName;
          eventsHtml += `<div class="calendar-event-chip" style="background: ${color}" title="${safeName}" aria-label="${safeName}" data-task-id="${task.id}">${displayText}</div>`;
        });
        if (dayTasks.length > maxShow) {
          eventsHtml += `<div class="calendar-more">+${dayTasks.length - maxShow} ×¢×•×“</div>`;
        }
        eventsHtml += '</div>';

        html += `<div class="${classes}" data-date="${dateKey}">
          <div class="calendar-day-number">${day}</div>
          ${eventsHtml}
        </div>`;
      }

      const totalCells = startDay + daysInMonth;
      const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
      for (let i = 1; i <= remainingCells; i++) {
        html += `<div class="calendar-day other-month"><div class="calendar-day-number">${i}</div></div>`;
      }
    } else if (taskCalendarView === 'week') {
      const focus = taskCalendarFocusDate || new Date();
      const start = getStartOfWeek(focus);
      const end = new Date(start);
      end.setDate(start.getDate() + 6);
      taskCalendarTitle.textContent = `×©×‘×•×¢ ${formatHebrewShortDate(start)} - ${formatHebrewShortDate(end)}`;

      for (let i = 0; i < 7; i++) {
        const dayDate = new Date(start);
        dayDate.setDate(start.getDate() + i);
        html += `<div class="calendar-day-name">${HEBREW_DAYS[dayDate.getDay()]}</div>`;
      }

      for (let i = 0; i < 7; i++) {
        const dayDate = new Date(start);
        dayDate.setDate(start.getDate() + i);
        const dateKey = toDateKey(dayDate);
        const dayTasks = tasksByDate[dateKey] || [];
        const isToday = dateKey === todayKey;
        const isOtherMonth = dayDate.getMonth() !== focus.getMonth();
        let classes = 'calendar-day';
        if (isToday) classes += ' today';
        if (isOtherMonth) classes += ' other-month';

        let eventsHtml = '<div class="calendar-day-events">';
        const showTime = true;
        dayTasks.slice(0, maxShow).forEach(task => {
          const subjectColor = subjects.find(s => s.id === task.subject)?.color;
          const resolvedColor = resolveTaskColor(task, subjectColor);
          const color = resolvedColor || subjectColor || '#667eea';
          const safeName = escapeHtml(task.title);
          const evtDate = new Date(task.dueDate);
          const timeStr = showTime ? `${String(evtDate.getHours()).padStart(2,'0')}:${String(evtDate.getMinutes()).padStart(2,'0')} ` : '';
          const displayText = timeStr + safeName;
          eventsHtml += `<div class="calendar-event-chip" style="background: ${color}" title="${safeName}" aria-label="${safeName}" data-task-id="${task.id}">${displayText}</div>`;
        });
        if (dayTasks.length > maxShow) {
          eventsHtml += `<div class="calendar-more">+${dayTasks.length - maxShow} ×¢×•×“</div>`;
        }
        eventsHtml += '</div>';

        html += `<div class="${classes}" data-date="${dateKey}">
          <div class="calendar-day-number">${dayDate.getDate()}</div>
          ${eventsHtml}
        </div>`;
      }
    } else {
      const focus = taskCalendarFocusDate || new Date();
      const dateKey = toDateKey(focus);
      taskCalendarTitle.textContent = focus.toLocaleDateString('he-IL', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
      html += `<div class="calendar-day-name">${HEBREW_DAYS[focus.getDay()]}</div>`;

      const dayTasks = tasksByDate[dateKey] || [];
      const isToday = dateKey === todayKey;
      let classes = 'calendar-day';
      if (isToday) classes += ' today';

      let eventsHtml = '<div class="calendar-day-events">';
      const showTime = true;
      dayTasks.slice(0, maxShow).forEach(task => {
        const subjectColor = subjects.find(s => s.id === task.subject)?.color;
        const resolvedColor = resolveTaskColor(task, subjectColor);
        const color = resolvedColor || subjectColor || '#667eea';
        const safeName = escapeHtml(task.title);
        const evtDate = new Date(task.dueDate);
        const timeStr = showTime ? `${String(evtDate.getHours()).padStart(2,'0')}:${String(evtDate.getMinutes()).padStart(2,'0')} ` : '';
        const displayText = timeStr + safeName;
        eventsHtml += `<div class="calendar-event-chip" style="background: ${color}" title="${safeName}" aria-label="${safeName}" data-task-id="${task.id}">${displayText}</div>`;
      });
      if (dayTasks.length > maxShow) {
        eventsHtml += `<div class="calendar-more">+${dayTasks.length - maxShow} ×¢×•×“</div>`;
      }
      eventsHtml += '</div>';

      html += `<div class="${classes}" data-date="${dateKey}">
        <div class="calendar-day-number">${focus.getDate()}</div>
        ${eventsHtml}
      </div>`;
    }

    taskCalendarGrid.innerHTML = html;
    renderTaskMonthList();
  }

  function renderTaskMonthList() {
    if (!taskMonthEvents || !taskMonthEventsTitle) return;

    let rangeStart;
    let rangeEnd;
    let titleText = '';
    let emptyText = '××™×Ÿ ×ž×©×™×ž×•×ª ×‘×˜×•×•×—';

    if (taskCalendarView === 'month') {
      const year = currentTaskMonth.getFullYear();
      const month = currentTaskMonth.getMonth();
      rangeStart = new Date(year, month, 1);
      rangeEnd = new Date(year, month + 1, 0, 23, 59, 59, 999);
      titleText = `×ž×©×™×ž×•×ª (×œ×œ× ×¡×¤×™×¨×•×ª ×œ××—×•×¨) ${HEBREW_MONTHS[month]}`;
      emptyText = '××™×Ÿ ×ž×©×™×ž×•×ª ×”×—×•×“×©';
    } else if (taskCalendarView === 'week') {
      const focus = taskCalendarFocusDate || new Date();
      const start = getStartOfWeek(focus);
      const end = new Date(start);
      end.setDate(start.getDate() + 6);
      rangeStart = start;
      rangeEnd = new Date(end.getFullYear(), end.getMonth(), end.getDate(), 23, 59, 59, 999);
      titleText = `×ž×©×™×ž×•×ª ×œ×©×‘×•×¢ ${formatHebrewShortDate(start)} - ${formatHebrewShortDate(end)}`;
      emptyText = '××™×Ÿ ×ž×©×™×ž×•×ª ×”×©×‘×•×¢';
    } else {
      const focus = taskCalendarFocusDate || new Date();
      rangeStart = new Date(focus.getFullYear(), focus.getMonth(), focus.getDate());
      rangeEnd = new Date(focus.getFullYear(), focus.getMonth(), focus.getDate(), 23, 59, 59, 999);
      titleText = `×ž×©×™×ž×•×ª ×œ×™×•× ${focus.toLocaleDateString('he-IL', { day: 'numeric', month: 'long' })}`;
      emptyText = '××™×Ÿ ×ž×©×™×ž×•×ª ×”×™×•×';
    }

    taskMonthEventsTitle.textContent = titleText;

    const rangeTasks = tasks.filter(t => {
      if (!t.dueDate) return false;
      if (t.isCountdown || t.isEvent) return false;
      const d = new Date(t.dueDate);
      return d >= rangeStart && d <= rangeEnd;
    }).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

    if (rangeTasks.length === 0) {
      taskMonthEvents.innerHTML = `<div class="no-events-msg">${emptyText}</div>`;
      return;
    }

    taskMonthEvents.innerHTML = rangeTasks.map(task => {
      const subjectColor = subjects.find(s => s.id === task.subject)?.color;
      const resolvedColor = resolveTaskColor(task, subjectColor);
      const color = resolvedColor || subjectColor || '#667eea';
      const d = new Date(task.dueDate);
      const dateStr = d.toLocaleDateString('he-IL', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
      return `
        <div class="month-event-item" style="border-right-color: ${color}">
          <div class="month-event-color" style="background: ${color}"></div>
          <div class="month-event-info">
            <div class="month-event-name" style="${task.completed ? 'text-decoration: line-through; opacity: 0.7;' : ''}">${escapeHtml(task.title)}</div>
            <div class="month-event-date">${dateStr}</div>
          </div>
        </div>
      `;
    }).join('');
  }

  function shiftTaskCalendar(step) {
    if (taskCalendarView === 'month') {
      currentTaskMonth.setMonth(currentTaskMonth.getMonth() + step);
      setTaskCalendarFocus(new Date(currentTaskMonth.getFullYear(), currentTaskMonth.getMonth(), 1));
    } else if (taskCalendarView === 'week') {
      const next = new Date(taskCalendarFocusDate);
      next.setDate(next.getDate() + step * 7);
      setTaskCalendarFocus(next);
    } else {
      const next = new Date(taskCalendarFocusDate);
      next.setDate(next.getDate() + step);
      setTaskCalendarFocus(next);
    }
    renderTaskCalendar();
  }

  function jumpTaskCalendarToToday() {
    const today = new Date();
    currentTaskMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    setTaskCalendarFocus(today);
    renderTaskCalendar();
  }
  
  // Task Calendar Navigation
  $("prevTaskMonth").onclick = () => {
    shiftTaskCalendar(-1);
  };
  if (taskCalendarViewToggle) {
    taskCalendarViewToggle.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-view]');
      if (!btn) return;
      setTaskCalendarView(btn.dataset.view);
    });
  }
  
  // Toggle Task Calendar
  const toggleTaskCalendar = $("toggleTaskCalendar");
  if (toggleTaskCalendarSize && taskRightSidebar) {
    toggleTaskCalendarSize.onclick = () => {
      taskCalendarExpanded = !taskCalendarExpanded;
      taskRightSidebar.classList.toggle('calendar-expanded', taskCalendarExpanded);
      toggleTaskCalendarSize.textContent = taskCalendarExpanded ? 'â¤¡' : 'â¤¢';
      const label = taskCalendarExpanded ? '×”×§×˜×Ÿ' : '×”×’×“×œ';
      toggleTaskCalendarSize.title = label;
      toggleTaskCalendarSize.setAttribute('aria-label', label);
      renderTaskCalendar();
    };
  }
  if (toggleTaskCalendar && taskRightSidebar) {
    toggleTaskCalendar.onclick = () => {
      console.log('toggleTaskCalendar clicked');
      const wasHidden = taskRightSidebar.classList.contains("hidden") || getComputedStyle(taskRightSidebar).display === 'none';
      console.log('taskRightSidebar wasHidden=', wasHidden);
      if (wasHidden) {
        taskRightSidebar.classList.remove('hidden');
        taskRightSidebar.style.display = '';
        jumpTaskCalendarToToday();
      } else {
        taskRightSidebar.classList.add('hidden');
        taskRightSidebar.style.display = 'none';
      }
    };
  }
  // Toggle Task Manager Sidebar (subjects)
  const toggleTaskSidebarBtn = $("toggleTaskSidebar");
  const taskSidebar = $("taskSidebar");
  if (toggleTaskSidebarBtn && taskSidebar) {
    toggleTaskSidebarBtn.onclick = () => {
      console.log('toggleTaskSidebar clicked');
      const wasHidden = taskSidebar.classList.contains('hidden') || getComputedStyle(taskSidebar).display === 'none';
      console.log('taskSidebar wasHidden=', wasHidden);
      if (wasHidden) {
        taskSidebar.classList.remove('hidden');
        taskSidebar.style.display = '';
      } else {
        taskSidebar.classList.add('hidden');
        taskSidebar.style.display = 'none';
      }
    };
  }
  $("nextTaskMonth").onclick = () => {
    shiftTaskCalendar(1);
  };
  $("todayTaskBtn").onclick = () => {
    jumpTaskCalendarToToday();
  };
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  // ============ SIDEBAR SUBJECTS RENDERING ============
  function renderSubjectsSidebar() {
    if (!subjectsList) return;
    
    updateSmartViewCounts();
    
    let html = '';
    const topLevel = getTopLevelSubjects();
    
    topLevel.forEach(s => {
      const children = getChildSubjects(s.id);
      const hasChildren = children.length > 0;
      const isExpanded = expandedSubjects.has(s.id);
      const isActive = currentSubject === s.id && !currentSmartView;
      const taskCount = countSubjectTasks(s.id, true);
      const isShared = s.isShared;
      const sharedBadge = isShared ? `<span class="shared-badge" title="×ž×©×•×ª×£">ðŸ‘¥</span>` : '';
      
      html += `
        <div class="subject-list-item ${isExpanded ? 'expanded' : ''}" data-subject-id="${s.id}">
          <div class="subject-list-header ${isActive ? 'active' : ''}" data-subject="${s.id}" title="${escapeHtml(s.name)}">
            ${hasChildren ? `<span class="collapse-arrow">â–¼</span>` : ''}
            ${sharedBadge}
            ${taskCount > 0 ? `<span class="subject-count">${taskCount}</span>` : ''}
            <span class="subject-color-dot" style="background: ${s.color};"></span>
            <span class="subject-name">${escapeHtml(s.name)}</span>
            <div class="subject-actions">
              <button class="subject-action-btn" data-action="add-sub" title="×”×•×¡×£ ×ª×ª-× ×•×©×" aria-label="×”×•×¡×£ ×ª×ª-× ×•×©×">âž•</button>
              <button class="subject-action-btn" data-action="edit" title="×¢×¨×™×›×”" aria-label="×¢×¨×™×›×”">âœï¸</button>
              <button class="subject-action-btn delete" data-action="delete" title="×ž×—×§" aria-label="×ž×—×§">ðŸ—‘ï¸</button>
            </div>
          </div>
          ${hasChildren ? `
            <div class="subject-list-children">
              ${children.map(c => {
                const childCount = tasks.filter(t => t.subject === c.id && !t.completed).length;
                const childActive = currentSubject === c.id && !currentSmartView;
                const childShared = c.isShared;
                const childSharedBadge = childShared ? `<span class="shared-badge" title="×ž×©×•×ª×£">ðŸ‘¥</span>` : '';
                return `
                  <div class="subject-child-item ${childActive ? 'active' : ''}" data-subject="${c.id}" title="${escapeHtml(c.name)}">
                    ${childSharedBadge}
                    ${childCount > 0 ? `<span class="child-count">${childCount}</span>` : ''}
                    <span class="child-color" style="background: ${c.color};"></span>
                    <span class="child-name">${escapeHtml(c.name)}</span>
                    <div class="subject-actions">
                      <button class="subject-action-btn" data-action="edit" title="×¢×¨×™×›×”">âœï¸</button>
                      <button class="subject-action-btn delete" data-action="delete" title="×ž×—×§">ðŸ—‘ï¸</button>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          ` : ''}
        </div>
      `;
    });
    
    subjectsList.innerHTML = html;
    
    // Setup event handlers
    setupSubjectsSidebarHandlers();
    setupSmartViewsHandlers();
  }
  
  function setupSubjectsSidebarHandlers() {
    // Subject headers click - toggle collapse OR select subject
    subjectsList.querySelectorAll('.subject-list-header').forEach(header => {
      header.addEventListener('click', (e) => {
        // Don't do anything if clicking action buttons
        if (e.target.closest('.subject-actions')) {
          return;
        }
        
        const subjectId = header.dataset.subject;
                
        // Always select the subject
        currentSmartView = null;
        currentSubject = subjectId;
        syncQuickAddSubject();
        renderSubjectsSidebar();
        renderTasks();
      });
      
      // Right-click context menu
      header.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        showContextMenu(e.clientX, e.clientY, header.dataset.subject);
      });

      attachSubjectDropHandlers(header, header.dataset.subject);
    });
    
    // Collapse arrows - clicking arrow only toggles (doesn't select)
    subjectsList.querySelectorAll('.collapse-arrow').forEach(arrow => {
      arrow.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevent header click from also firing
        const subjectId = arrow.closest('.subject-list-item').dataset.subjectId;
        toggleSubjectExpanded(subjectId);
      });
    });
    
    // Subject action buttons (edit, delete, add-sub)
    subjectsList.querySelectorAll('.subject-action-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const action = btn.dataset.action;
        const subjectId = btn.closest('[data-subject]').dataset.subject;
        
        if (action === 'edit') {
          openSubjectModal(subjectId);
        } else if (action === 'add-sub') {
          openSubjectModal(null, subjectId);
        } else if (action === 'delete') {
          if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×ž×—×•×§ ××ª ×”× ×•×©× ×”×–×”?')) {
            deleteSubjectById(subjectId);
          }
        }
      });
    });
    
    // Child items click
    subjectsList.querySelectorAll('.subject-child-item').forEach(child => {
      child.addEventListener('click', (e) => {
        // Don't select if clicking action buttons
        if (e.target.closest('.subject-actions')) {
          return;
        }
        
        currentSmartView = null;
        currentSubject = child.dataset.subject;
        syncQuickAddSubject();
        renderSubjectsSidebar();
        renderTasks();
      });
      
      // Right-click context menu
      child.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        showContextMenu(e.clientX, e.clientY, child.dataset.subject);
      });

      attachSubjectDropHandlers(child, child.dataset.subject);
    });
  }

  function attachSubjectDropHandlers(element, subjectId) {
    if (!element) return;
    element.addEventListener('dragover', (e) => {
      if (!draggingTaskId) return;
      e.preventDefault();
      element.classList.add('drag-over');
    });
    element.addEventListener('dragleave', () => {
      element.classList.remove('drag-over');
    });
    element.addEventListener('drop', (e) => {
      if (!draggingTaskId) return;
      e.preventDefault();
      element.classList.remove('drag-over');
      assignTaskToSubject(draggingTaskId, subjectId);
    });
  }
  
  function toggleSubjectExpanded(subjectId) {
    const item = subjectsList.querySelector(`.subject-list-item[data-subject-id="${subjectId}"]`);
    
    if (expandedSubjects.has(subjectId)) {
      expandedSubjects.delete(subjectId);
      if (item) item.classList.remove('expanded');
    } else {
      expandedSubjects.add(subjectId);
      if (item) item.classList.add('expanded');
    }
  }
  
  function setupSmartViewsHandlers() {
    if (!smartViewsList) return;
    
    // Clone and replace to remove all old event listeners
    smartViewsList.querySelectorAll('.smart-view-item').forEach(item => {
      const newItem = item.cloneNode(true);
      item.parentNode.replaceChild(newItem, item);
    });
    
    smartViewsList.querySelectorAll('.smart-view-item').forEach(item => {
      item.addEventListener('click', () => {
        const view = item.dataset.view;
        if (view === 'all') {
          currentSmartView = null;
          currentSubject = 'all';
        } else {
          currentSmartView = view;
          currentSubject = 'all';
        }
        syncQuickAddSubject();
        
        // Update active states
        smartViewsList.querySelectorAll('.smart-view-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        
        renderSubjectsSidebar();
        renderTasks();
      });
    });
    
    // Set initial active state
    const activeView = currentSmartView || 'all';
    smartViewsList.querySelectorAll('.smart-view-item').forEach(item => {
      item.classList.toggle('active', item.dataset.view === activeView);
    });
  }
  
  // Add subject sidebar button handler
  if (addSubjectSidebarBtn) {
    addSubjectSidebarBtn.addEventListener('click', () => openSubjectModal());
  }
  // Add subject button in header
  if (addSubjectBtn) {
    addSubjectBtn.addEventListener('click', () => {
      console.log('addSubjectBtn clicked');
      openSubjectModal();
    });
  }
  
  // ============ CONTEXT MENU ============
  function showContextMenu(x, y, subjectId) {
    contextMenuTarget = subjectId;
    const subject = subjects.find(s => s.id === subjectId);
    
    // Update menu items based on subject type
    const addSubItem = contextMenu.querySelector('[data-action="add-sub"]');
    if (subject && subject.parentId) {
      // It's a sub-subject, hide "add sub" option
      addSubItem.style.display = 'none';
    } else {
      addSubItem.style.display = 'flex';
    }
    
    // Position and show menu
    contextMenu.style.left = x + 'px';
    contextMenu.style.top = y + 'px';
    contextMenu.classList.add('open');
  }
  
  function hideContextMenu() {
    contextMenu.classList.remove('open');
    contextMenuTarget = null;
    hideEventContextMenu();
  }
  
  // ============ EVENT CONTEXT MENU ============
  function showEventContextMenu(x, y, eventId) {
    eventContextMenuTarget = eventId;
    const evt = events.find(e => e.id === eventId);
    
    // Update menu items based on current state
    const starItem = eventContextMenu.querySelector('[data-action="star"]');
    const pinItem = eventContextMenu.querySelector('[data-action="pin"]');
    
    if (starItem && evt) {
      starItem.innerHTML = evt.highlighted ? 'â­ ×”×¡×¨ ×ž×•×¢×“×£' : 'â­ ×¡×ž×Ÿ ×›×ž×•×¢×“×£';
    }
    
    if (pinItem && evt) {
      pinItem.innerHTML = evt.pinned ? 'ðŸ“Œ ×‘×˜×œ × ×¢×™×¦×”' : 'ðŸ“Œ × ×¢×¥ ×œ×ž×¢×œ×”';
    }
    
    // Position and show menu
    eventContextMenu.style.left = x + 'px';
    eventContextMenu.style.top = y + 'px';
    eventContextMenu.classList.add('open');
  }
  
  function hideEventContextMenu() {
    if (eventContextMenu) {
      eventContextMenu.classList.remove('open');
    }
    eventContextMenuTarget = null;
    hideAddEventContextMenu();
  }
  
  // ============ ADD EVENT CONTEXT MENU ============
  const addEventContextMenu = $("addEventContextMenu");
  
  function showAddEventContextMenu(x, y) {
    if (!addEventContextMenu) return;
    
    // Position and show menu
    addEventContextMenu.style.left = x + 'px';
    addEventContextMenu.style.top = y + 'px';
    addEventContextMenu.classList.add('open');
  }
  
  function hideAddEventContextMenu() {
    if (addEventContextMenu) {
      addEventContextMenu.classList.remove('open');
    }
  }
  
  // Add event context menu item clicks
  if (addEventContextMenu) {
    addEventContextMenu.addEventListener('click', (e) => {
      const action = e.target.closest('.context-menu-item')?.dataset.action;
      if (!action) return;
      
      const now = new Date();
      let targetDate = new Date();
      
      if (action === 'add') {
        // Focus on the input panel
        eventName.focus();
        hideAddEventContextMenu();
        return;
      } else if (action === 'add-tomorrow') {
        targetDate.setDate(targetDate.getDate() + 1);
        targetDate.setHours(12, 0, 0, 0);
      } else if (action === 'add-week') {
        targetDate.setDate(targetDate.getDate() + 7);
        targetDate.setHours(12, 0, 0, 0);
      }
      
      // Pre-fill the date - format from local date directly (not via ISO/UTC)
      const pad = n => String(n).padStart(2, '0');
      const localDateStr = `${targetDate.getFullYear()}-${pad(targetDate.getMonth()+1)}-${pad(targetDate.getDate())}T${pad(targetDate.getHours())}:${pad(targetDate.getMinutes())}`;
      eventDate.value = localDateStr;
      eventName.focus();
      
      hideAddEventContextMenu();
    });
  }
  
  // Add right-click on event list area to show add event menu
  eventList.addEventListener('contextmenu', (e) => {
    // Only show add menu if not clicking on an event row
    if (!e.target.closest('.event-row')) {
      e.preventDefault();
      hideContextMenu();
      showAddEventContextMenu(e.clientX, e.clientY);
    }
  });
  
  // Also add to empty state
  emptyState.addEventListener('contextmenu', (e) => {
    e.preventDefault();
    hideContextMenu();
    showAddEventContextMenu(e.clientX, e.clientY);
  });
  
  // Event context menu item clicks
  if (eventContextMenu) {
    eventContextMenu.addEventListener('click', (e) => {
      const action = e.target.closest('.context-menu-item')?.dataset.action;
      if (!action || !eventContextMenuTarget) return;
      
      const evt = events.find(ev => ev.id === eventContextMenuTarget);
      
      if (action === 'edit') {
        startEdit(eventContextMenuTarget);
      } else if (action === 'pin') {
        if (evt) {
          updateInCloud(eventContextMenuTarget, { ...evt, pinned: !evt.pinned });
        }
      } else if (action === 'star') {
        if (evt) {
          updateInCloud(eventContextMenuTarget, { ...evt, highlighted: !evt.highlighted });
        }
      } else if (action === 'duplicate') {
        if (evt) {
          saveToCloud({
            name: evt.name + ' (×”×¢×ª×§)',
            date: evt.date,
            notes: evt.notes || null,
            reminder: evt.reminder || 0,
            highlighted: false,
            pinned: false
          });
        }
      } else if (action === 'delete') {
        const existing = pendingDeletes.get(eventContextMenuTarget);
        if (existing) clearTimeout(existing.timer);
        const timer = setTimeout(() => {
          deleteFromCloud(eventContextMenuTarget);
          pendingDeletes.delete(eventContextMenuTarget);
          if (lastDeletedId === eventContextMenuTarget) hideUndoToast();
        }, DELETE_TIMEOUT_MS);
        pendingDeletes.set(eventContextMenuTarget, { timer });
        render();
        showUndoToast(evt ? evt.name : 'Event', eventContextMenuTarget);
      }
      
      hideEventContextMenu();
    });
  }
  
  // Context menu item clicks (subjects)
  contextMenu.addEventListener('click', (e) => {
    const action = e.target.closest('.context-menu-item')?.dataset.action;
    if (!action || !contextMenuTarget) return;
    
    if (action === 'edit') {
      openSubjectModal(contextMenuTarget);
    } else if (action === 'share') {
      openShareSubjectModal(contextMenuTarget);
    } else if (action === 'add-sub') {
      openSubjectModal(null, contextMenuTarget);
    } else if (action === 'delete') {
      deleteSubjectById(contextMenuTarget);
    }
    
    hideContextMenu();
  });
  
  // Hide context menu on click outside
  document.addEventListener('click', (e) => {
    if (!contextMenu.contains(e.target) && 
        (!eventContextMenu || !eventContextMenu.contains(e.target)) &&
        (!addEventContextMenu || !addEventContextMenu.contains(e.target))) {
      hideContextMenu();
      hideAddEventContextMenu();
    }
  });
  
  document.addEventListener('contextmenu', (e) => {
    // Hide menus when right-clicking elsewhere
    if (!e.target.closest('.subject-list-header') && !e.target.closest('.subject-child-item')) {
      hideContextMenu();
    }
    if (!e.target.closest('.event-row') && !e.target.closest('.event-list') && !e.target.closest('.empty-state')) {
      hideEventContextMenu();
      hideAddEventContextMenu();
    }
  });
  
  function updateSubjectSelectors() {
    // Build hierarchical options for task subject selectors
    let options = `<option value="">×œ×œ× × ×•×©×</option>`;
    
    const topLevel = getTopLevelSubjects();
    topLevel.forEach(s => {
      options += `<option value="${s.id}">${escapeHtml(s.name)}</option>`;
      const children = getChildSubjects(s.id);
      children.forEach(c => {
        options += `<option value="${c.id}">&nbsp;&nbsp;â†³ ${escapeHtml(c.name)}</option>`;
      });
    });
    
    newTaskSubject.innerHTML = options;
    editTaskSubject.innerHTML = options;
    syncQuickAddSubject();
  }
  
  function updateParentSubjectSelector() {
    // Only top-level subjects can be parents
    let options = `<option value="">×œ×œ× (× ×•×©× ×¨××©×™)</option>`;
    const topLevel = getTopLevelSubjects();
    topLevel.forEach(s => {
      // Don't allow setting itself as parent when editing
      if (s.id !== editingSubjectId) {
        options += `<option value="${s.id}">${escapeHtml(s.name)}</option>`;
      }
    });
    parentSubjectSelect.innerHTML = options;
  }
  
  // Update getFilteredTasks to include subject filter AND smart views
  const originalGetFilteredTasks = getFilteredTasks;
  getFilteredTasks = function() {
    let filtered = originalGetFilteredTasks();
    
    // Apply smart view filter
    if (currentSmartView) {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      const weekLater = new Date(today);
      weekLater.setDate(weekLater.getDate() + 7);
      
      if (currentSmartView === 'today') {
        filtered = filtered.filter(t => {
          if (!t.dueDate) return false;
          const due = new Date(t.dueDate);
          return due >= today && due < tomorrow;
        });
      } else if (currentSmartView === 'week') {
        filtered = filtered.filter(t => {
          if (!t.dueDate) return false;
          const due = new Date(t.dueDate);
          return due >= today && due < weekLater;
        });
      } else if (currentSmartView === 'overdue') {
        filtered = filtered.filter(t => {
          if (!t.dueDate || t.completed) return false;
          return new Date(t.dueDate) < now;
        });
      } else if (currentSmartView === 'nodate') {
        filtered = filtered.filter(t => !t.dueDate && !t.completed);
      }
    }
    
    // Apply subject filter
    if (currentSubject !== 'all' && !currentSmartView) {
      const selectedSubject = subjects.find(s => s.id === currentSubject);
      const isSubSubject = selectedSubject && selectedSubject.parentId;
      
      // Get all valid subject IDs (current + children if parent)
      const validIds = [currentSubject];
      const children = getChildSubjects(currentSubject);
      children.forEach(c => validIds.push(c.id));
      
      const subjectFiltered = filtered.filter(t => validIds.includes(t.subject));
      
      // If this is a sub-subject with no tasks, show high priority tasks from all subjects due today/tomorrow
      if (isSubSubject && subjectFiltered.filter(t => !t.completed).length === 0) {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const dayAfterTomorrow = new Date(today);
        dayAfterTomorrow.setDate(dayAfterTomorrow.getDate() + 2);
        
        // Get high priority tasks (urgent, high) due today or tomorrow from all subjects
        filtered = filtered.filter(t => {
          if (t.completed) return false;
          const isHighPriority = t.priority === 'urgent' || t.priority === 'high';
          const hasDueDate = t.dueDate;
          if (!hasDueDate) return isHighPriority; // Include high priority without date
          const due = new Date(t.dueDate);
          const isDueSoon = due >= today && due < dayAfterTomorrow;
          return isHighPriority || isDueSoon;
        });
        
        // Sort by priority then by due date
        filtered.sort((a, b) => {
          const priorityOrder = { urgent: 0, high: 1, medium: 2, low: 3, none: 4 };
          const pDiff = (priorityOrder[a.priority] || 4) - (priorityOrder[b.priority] || 4);
          if (pDiff !== 0) return pDiff;
          if (!a.dueDate && !b.dueDate) return 0;
          if (!a.dueDate) return 1;
          if (!b.dueDate) return -1;
          return new Date(a.dueDate) - new Date(b.dueDate);
        });
        
        // Mark that we're showing suggested tasks
        window.showingSuggestedTasks = true;
      } else {
        filtered = subjectFiltered;
        window.showingSuggestedTasks = false;
      }
    } else {
      window.showingSuggestedTasks = false;
    }
    
    return filtered;
  };
  
  
  
  // Sharing state for subject modal
  let pendingSharedUsers = [];
  const shareWithUserInput = $("shareWithUserInput");
  const addShareUserBtn = $("addShareUserBtn");
  const sharedWithList = $("sharedWithList");
  const shareError = $("shareError");
  
  function renderSharedUsersList() {
    if (!sharedWithList) return;
    if (pendingSharedUsers.length === 0) {
      sharedWithList.innerHTML = '<div style="font-size: 12px; color: var(--muted);">×œ× ×ž×©×•×ª×£ ×¢× ××£ ××—×“</div>';
      return;
    }
    sharedWithList.innerHTML = pendingSharedUsers.map((user, idx) => `
      <span class="shared-user-pill ${user === currentUser ? 'owner' : ''}">
        ðŸ‘¤ ${escapeHtml(user)}${user === currentUser ? ' (××ª×”)' : ''}
        ${user !== currentUser ? `<span class="remove-share" data-idx="${idx}">Ã—</span>` : ''}
      </span>
    `).join('');
    
    // Add remove handlers
    sharedWithList.querySelectorAll('.remove-share').forEach(btn => {
      btn.onclick = () => {
        const idx = parseInt(btn.dataset.idx);
        pendingSharedUsers.splice(idx, 1);
        renderSharedUsersList();
      };
    });
  }
  
  if (addShareUserBtn) {
    addShareUserBtn.onclick = () => {
      const username = shareWithUserInput.value.trim().toLowerCase();
      if (!username) return;
      if (username === currentUser) {
        shareError.textContent = '×œ× × ×™×ª×Ÿ ×œ×©×ª×£ ×¢× ×¢×¦×ž×š';
        shareError.style.display = 'block';
        return;
      }
      if (pendingSharedUsers.includes(username)) {
        shareError.textContent = '×”×ž×©×ª×ž×© ×›×‘×¨ × ×ž×¦× ×‘×¨×©×™×ž×”';
        shareError.style.display = 'block';
        return;
      }
      shareError.style.display = 'none';
      pendingSharedUsers.push(username);
      shareWithUserInput.value = '';
      renderSharedUsersList();
    };
    
    shareWithUserInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        addShareUserBtn.click();
      }
    });
  }
  
  function openSubjectModal(subjectId, parentId = null) {
    console.log('openSubjectModal called', { subjectId, parentId });
    editingSubjectId = subjectId;
    updateParentSubjectSelector();
    if (shareError) shareError.style.display = 'none';
    if (shareWithUserInput) shareWithUserInput.value = '';
    
    if (subjectId) {
      const subject = subjects.find(s => s.id === subjectId);
      if (!subject) return;
      subjectModalTitle.textContent = '×¢×¨×•×š × ×•×©×';
      subjectNameInput.value = subject.name;
      selectedSubjectColor = subject.color;
      parentSubjectSelect.value = subject.parentId || '';
      deleteSubjectBtn.style.display = 'block';
      
      // Load shared users
      if (subject.isShared) {
        const members = subject.members || {};
        pendingSharedUsers = Object.keys(members);
      } else {
        pendingSharedUsers = [];
      }
      
      // If editing a parent with children, disable parent selector
      const children = getChildSubjects(subjectId);
      parentSubjectSelect.disabled = children.length > 0;
    } else {
      subjectModalTitle.textContent = parentId ? '×”×•×¡×£ ×ª×ª-× ×•×©×' : '×”×•×¡×£ × ×•×©× ×—×“×©';
      subjectNameInput.value = '';
      selectedSubjectColor = '#667eea';
      parentSubjectSelect.value = parentId || '';
      parentSubjectSelect.disabled = false;
      deleteSubjectBtn.style.display = 'none';
      pendingSharedUsers = [];
    }
    
    renderSharedUsersList();
    
    // Update color picker selection
    subjectColorPicker.querySelectorAll('.subject-color-option').forEach(opt => {
      opt.classList.toggle('selected', opt.dataset.color === selectedSubjectColor);
    });
    
    subjectModal.classList.add('open');
    subjectNameInput.focus();
  }
  
  function closeSubjectModal() {
    subjectModal.classList.remove('open');
    editingSubjectId = null;
  }
  
  // Quick share function - opens subject modal focused on sharing section
  function openShareSubjectModal(subjectId) {
    if (!subjectId) return;
    const subject = subjects.find(s => s.id === subjectId);
    if (!subject) return;
    
    // Open the regular edit modal
    openSubjectModal(subjectId);
    
    // Scroll to and focus on sharing section
    setTimeout(() => {
      const sharingSection = document.getElementById('subjectSharingSection');
      if (sharingSection) {
        sharingSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        // Highlight the sharing section briefly
        sharingSection.style.transition = 'background 0.3s, box-shadow 0.3s';
        sharingSection.style.background = 'rgba(102, 126, 234, 0.15)';
        sharingSection.style.boxShadow = '0 0 0 2px var(--accent)';
        if (shareWithUserInput) {
          shareWithUserInput.focus();
        }
        setTimeout(() => {
          sharingSection.style.background = '';
          sharingSection.style.boxShadow = '';
        }, 1500);
      }
    }, 100);
  }
  
  subjectModal.addEventListener('click', (e) => {
    if (e.target === subjectModal) closeSubjectModal();
  });
  
  // Color picker
  subjectColorPicker.addEventListener('click', (e) => {
    const option = e.target.closest('.subject-color-option');
    if (!option) return;
    subjectColorPicker.querySelectorAll('.subject-color-option').forEach(o => o.classList.remove('selected'));
    option.classList.add('selected');
    selectedSubjectColor = option.dataset.color;
  });
  
  // Cancel button
  cancelSubjectBtn.onclick = closeSubjectModal;
  
  // Save subject
  saveSubjectBtn.onclick = async () => {
    console.log('saveSubjectBtn clicked, name=', subjectNameInput.value);
    const name = subjectNameInput.value.trim();
    if (!name) return;
    
    const parentId = parentSubjectSelect.value || null;
    const hasSharing = pendingSharedUsers.length > 0;
    console.log('Saving subject:', { name, parentId, hasSharing, pendingSharedUsers, editingSubjectId });
    
    try {
      if (hasSharing) {
        // Save as shared subject
        const members = {};
        pendingSharedUsers.forEach(user => {
          if (user !== currentUser) {
            members[user] = true;
          }
        });
        // Also add owner to members for easier querying
        members[currentUser] = true;
        
        const sharedSubjectData = {
          name,
          color: selectedSubjectColor,
          parentId,
          owner: currentUser,
          members,
          createdAt: new Date().toISOString()
        };
        
        console.log('Shared subject data:', sharedSubjectData);
        
        if (editingSubjectId) {
          const existingSubject = subjects.find(s => s.id === editingSubjectId);
          
          if (existingSubject?.isShared) {
            // Update existing shared subject
            await set(ref(db, `sharedSubjects/${editingSubjectId}`), sharedSubjectData);
          } else if (existingSubject?.isOwn) {
            // Convert from own to shared - move tasks
            const subjectTasks = tasks.filter(t => t.subject === editingSubjectId);
            
            // Create in shared location
            const newSharedRef = push(ref(db, 'sharedSubjects'));
            const newSharedId = newSharedRef.key;
            await set(newSharedRef, sharedSubjectData);
            
            // Move tasks to shared location
            for (const task of subjectTasks) {
              const { id, isOwn, ...taskData } = task;
              taskData.subject = newSharedId;
              await set(ref(db, `sharedSubjects/${newSharedId}/tasks/${id}`), taskData);
              await remove(ref(db, `users/${currentUser}/tasks/${id}`));
            }
            
            // Delete from own subjects
            await remove(ref(db, `users/${currentUser}/subjects/${editingSubjectId}`));
          }
        } else {
          // Create new shared subject
          console.log('Creating new shared subject...');
          const newSharedRef = push(ref(db, 'sharedSubjects'));
          console.log('New shared ref key:', newSharedRef.key);
          await set(newSharedRef, sharedSubjectData);
          console.log('Shared subject created successfully');
        }
      } else {
        // Save as own subject (not shared)
        const subjectData = {
          name,
          color: selectedSubjectColor,
          parentId,
          createdAt: new Date().toISOString()
        };
        
        console.log('Own subject data:', subjectData);
        
        if (editingSubjectId) {
          const existingSubject = subjects.find(s => s.id === editingSubjectId);
          
          if (existingSubject?.isShared && existingSubject?.owner === currentUser) {
            // Convert from shared to own - move tasks back
            const subjectTasks = tasks.filter(t => t.subject === editingSubjectId);
            
            // Create in own location
            const newOwnRef = push(subjectsRef);
            const newOwnId = newOwnRef.key;
            await set(newOwnRef, subjectData);
            
            // Move tasks to own location
            for (const task of subjectTasks) {
              const { id, isShared, ...taskData } = task;
              taskData.subject = newOwnId;
              await set(ref(db, `users/${currentUser}/tasks/${id}`), taskData);
            }
            
            // Delete shared subject
            await remove(ref(db, `sharedSubjects/${editingSubjectId}`));
          } else {
            // Update existing own subject
            await set(ref(db, `users/${currentUser}/subjects/${editingSubjectId}`), subjectData);
          }
        } else {
          // Create new own subject
          console.log('Creating new own subject...');
          const newSubjectRef = push(subjectsRef);
          await set(newSubjectRef, subjectData);
          console.log('Own subject created successfully');
        }
      }
      
      closeSubjectModal();
    } catch (error) {
      console.error('Error saving subject:', error);
      alert('×©×’×™××” ×‘×©×ž×™×¨×ª ×”× ×•×©×: ' + error.message);
    }
  };
  
  subjectNameInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') saveSubjectBtn.click();
  });
  
  // Delete subject by ID (used from dropdown buttons)
  function deleteSubjectById(subjectId) {
    const subject = subjects.find(s => s.id === subjectId);
    if (!subject) return;
    
    // For shared subjects, handle differently based on ownership
    if (subject.isShared) {
      if (subject.owner === currentUser) {
        // Owner can delete the shared subject entirely
        if (confirm(`Delete shared subject "${subject.name}"? This will delete all tasks and remove access for all shared users.`)) {
          // Delete the shared subject (tasks are stored under it)
          remove(ref(db, `sharedSubjects/${subjectId}`));
          if (currentSubject === subjectId) {
            currentSubject = 'all';
          }
        }
      } else {
        // Non-owner can only leave the shared subject
        if (confirm(`Leave shared subject "${subject.name}"? You will no longer see tasks in this subject.`)) {
          // Remove current user from members
          remove(ref(db, `sharedSubjects/${subjectId}/members/${currentUser}`));
          if (currentSubject === subjectId) {
            currentSubject = 'all';
          }
        }
      }
      return;
    }
    
    const children = getChildSubjects(subjectId);
    let message = `Delete "${subject.name}"?`;
    if (children.length > 0) {
      message += ` This will also delete ${children.length} sub-subject(s).`;
    }
    message += ' Tasks will remain but become uncategorized.';
    
    if (confirm(message)) {
      // Delete children first
      children.forEach(child => {
        tasks.forEach(task => {
          if (task.subject === child.id) {
            // Use the proper reference based on task location
            const taskRef = getTaskRef(task);
            if (taskRef) {
              set(ref(db, taskRef.toString().replace(db._repoInternal.repoInfo_.toString(), '') + '/subject'), '');
            }
          }
        });
        remove(ref(db, `users/${currentUser}/subjects/${child.id}`));
      });
      
      // Remove subject from all tasks that have it
      tasks.forEach(task => {
        if (task.subject === subjectId) {
          // For own tasks only (shared tasks would have been handled above)
          if (!task.isShared) {
            set(ref(db, `users/${currentUser}/tasks/${task.id}/subject`), '');
          }
        }
      });
      
      // Delete the subject
      remove(ref(db, `users/${currentUser}/subjects/${subjectId}`));
      
      // Reset to all if we were viewing that subject
      if (currentSubject === subjectId || children.some(c => c.id === currentSubject)) {
        currentSubject = 'all';
      }
    }
  }
  
  // Delete subject from modal
  deleteSubjectBtn.onclick = () => {
    if (!editingSubjectId) return;
    deleteSubjectById(editingSubjectId);
    closeSubjectModal();
  };
  
  // Update openTaskEditModal to set subject
  const originalOpenTaskEditModal = openTaskEditModal;
  openTaskEditModal = function(taskId) {
    originalOpenTaskEditModal(taskId);
    if (editingTask) {
      editTaskSubject.value = editingTask.subject || '';
    }
  };

  // ============ IMPROVED NATURAL LANGUAGE PARSING (Hebrew + English RTL-Safe) ============
  function parseNaturalLanguage(input) {
    let title = input;
    let dueDate = null;
    let priority = 'medium';
    let subjectId = '';

    // Helper: Normalize text by removing ALL spaces and converting to lowercase
    const normalize = (str) => str.replace(/\s+/g, '').toLowerCase();

    // ============ STEP 1: EXTRACT & REMOVE PRIORITY ============
    const priorityPatterns = [
      { level: 'urgent', patterns: [/\b(×“×—×•×£|×ž×™×™×“×™|urgent|asap|!!!|!!)\b/gi] },
      { level: 'high', patterns: [/\b(×’×‘×•×”|×—×©×•×‘|high|important|!)\b/gi] },
      { level: 'medium', patterns: [/\b(×‘×™× ×•× ×™|×¨×’×™×œ|medium|normal)\b/gi] },
      { level: 'low', patterns: [/\b(× ×ž×•×š|×œ× ×“×—×•×£|low)\b/gi] }
    ];

    for (const { level, patterns } of priorityPatterns) {
      for (const pattern of patterns) {
        const matches = title.match(pattern);
        if (matches) {
          priority = level;
          // Remove all matches
          matches.forEach(match => {
            title = title.replace(match, ' ');
          });
          break;
        }
      }
      if (priority !== 'medium') break;
    }
    title = title.trim();

    // ============ STEP 2: EXTRACT & REMOVE TIME ============
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    let hours = 23, minutes = 59;

    // Time patterns - support multiple formats
    const timePatterns = [
      /\b(\d{1,2}):(\d{2})\b/g,                    // 14:30, 9:00
      /\b×‘×©×¢×”\s*(\d{1,2}):(\d{2})\b/gi,           // ×‘×©×¢×” 14:30
      /\bat\s*(\d{1,2}):(\d{2})\b/gi,              // at 14:30
      /\b(\d{1,2})\.(\d{2})\b/g,                   // 14.30
      /\b(\d{1,2}):(\d{2})\s*(am|pm)\b/gi,        // 2:30 PM
      /\b×‘-?(\d{1,2}):(\d{2})\b/gi                 // ×‘-14:30
    ];

    for (const pattern of timePatterns) {
      const match = title.match(pattern);
      if (match) {
        const firstMatch = match[0];
        const timeMatch = firstMatch.match(/(\d{1,2})[:.](\d{2})/);
        if (timeMatch) {
          hours = parseInt(timeMatch[1]);
          minutes = parseInt(timeMatch[2]);
          
          // Handle AM/PM
          const isPM = /pm/i.test(firstMatch);
          const isAM = /am/i.test(firstMatch);
          if (isPM && hours < 12) hours += 12;
          if (isAM && hours === 12) hours = 0;
          
          // Validate time
          if (hours >= 0 && hours < 24 && minutes >= 0 && minutes < 60) {
            title = title.replace(firstMatch, ' ').trim();
            break;
          }
        }
      }
    }

    // ============ STEP 3: EXTRACT & REMOVE DATE ============
    const dateKeywords = [
      { patterns: [/×ž×—×¨×ª×™×™×/gi], days: 2 },
      { patterns: [/×‘×¢×•×“ ×™×•×ž×™×™×/gi, /in 2 days/gi], days: 2 },
      { patterns: [/×‘×¢×•×“ 3 ×™×ž×™×/gi, /in 3 days/gi], days: 3 },
      { patterns: [/×‘×¢×•×“ 4 ×™×ž×™×/gi, /in 4 days/gi], days: 4 },
      { patterns: [/×‘×¢×•×“ 5 ×™×ž×™×/gi, /in 5 days/gi], days: 5 },
      { patterns: [/×œ×”×™×•×/gi, /×”×™×•×/gi, /today/gi], days: 0 },
      { patterns: [/×œ×ž×—×¨/gi, /×ž×—×¨/gi, /tomorrow/gi], days: 1 },
      { patterns: [/×‘×¢×•×“ ×©×‘×•×¢×™×™×/gi, /in 2 weeks/gi], days: 14 },
      { patterns: [/×‘×¢×•×“ ×©×‘×•×¢/gi, /in a week/gi], days: 7 },
      { patterns: [/×”×©×‘×•×¢/gi, /×‘×©×‘×•×¢ ×”×‘×/gi, /this week/gi, /next week/gi], days: 7 },
      { patterns: [/×‘×¢×•×“ ×—×•×“×©/gi, /in a month/gi], days: 30 },
    ];

    for (const { patterns, days } of dateKeywords) {
      let matched = false;
      for (const pattern of patterns) {
        const matches = title.match(pattern);
        if (matches) {
          dueDate = new Date(today);
          dueDate.setDate(dueDate.getDate() + days);
          dueDate.setHours(hours, minutes, 0, 0);
          // Remove all matches
          matches.forEach(match => {
            title = title.replace(match, ' ');
          });
          matched = true;
          break;
        }
      }
      if (matched) break;
    }

    // Hebrew & English day names
    if (!dueDate) {
      const hebrewDays = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—×ž×™×©×™', '×©×™×©×™', '×©×‘×ª'];
      const englishDays = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
      
      for (let i = 0; i < 7; i++) {
        const hebrewPattern = new RegExp(`(×‘×™×•×\\s+|×™×•×\\s+)?${hebrewDays[i]}`, 'gi');
        const englishPattern = new RegExp(`(on\\s+)?${englishDays[i]}`, 'gi');
        
        const heMatches = title.match(hebrewPattern);
        const enMatches = title.match(englishPattern);
        
        if (heMatches || enMatches) {
          const currentDay = today.getDay();
          let daysToAdd = i - currentDay;
          if (daysToAdd <= 0) daysToAdd += 7;
          
          dueDate = new Date(today);
          dueDate.setDate(dueDate.getDate() + daysToAdd);
          dueDate.setHours(hours, minutes, 0, 0);
          
          if (heMatches) heMatches.forEach(m => title = title.replace(m, ' '));
          if (enMatches) enMatches.forEach(m => title = title.replace(m, ' '));
          break;
        }
      }
    }

    // Specific date formats: DD/MM or DD.MM
    if (!dueDate) {
      const datePattern = /\b(\d{1,2})[\/\.](\d{1,2})\b/g;
      const match = title.match(datePattern);
      if (match) {
        const firstMatch = match[0];
        const parts = firstMatch.split(/[\/\.]/);
        const day = parseInt(parts[0]);
        const month = parseInt(parts[1]) - 1; // JS months are 0-indexed
        
        if (day >= 1 && day <= 31 && month >= 0 && month <= 11) {
          dueDate = new Date(today.getFullYear(), month, day, hours, minutes, 0, 0);
          
          // If date is in the past, assume next year
          if (dueDate < now) {
            dueDate.setFullYear(dueDate.getFullYear() + 1);
          }
          
          title = title.replace(firstMatch, ' ').trim();
        }
      }
    }

    // ============ STEP 4: ENHANCED SUBJECT DETECTION ============
    // Sort subjects by name length (longest first) to prevent partial matches
    const sortedSubjects = [...subjects].sort((a, b) => b.name.length - a.name.length);
    let matchedSubject = null;
    let textToRemove = '';

    // METHOD 1: Hashtag with hierarchy #parent/child or #parent/child/grandchild
    const hierarchyMatch = title.match(/#([^#\s]+)\/([^#\s\/]+)(?:\/([^#\s\/]+))?/);
    if (hierarchyMatch) {
      const parentSearch = normalize(hierarchyMatch[1].replace(/_/g, ' '));
      const childSearch = normalize(hierarchyMatch[2].replace(/_/g, ' '));
      const grandchildSearch = hierarchyMatch[3] ? normalize(hierarchyMatch[3].replace(/_/g, ' ')) : null;
      
      // Find parent
      const parent = sortedSubjects.find(s => 
        !s.parentId && normalize(s.name).includes(parentSearch)
      );
      
      if (parent) {
        // Find child
        let child = subjects.find(s => 
          s.parentId === parent.id && normalize(s.name).includes(childSearch)
        );
        
        // If grandchild specified, find it
        if (child && grandchildSearch) {
          const grandchild = subjects.find(s =>
            s.parentId === child.id && normalize(s.name).includes(grandchildSearch)
          );
          if (grandchild) {
            matchedSubject = grandchild;
          } else {
            matchedSubject = child; // Fallback to child if grandchild not found
          }
        } else if (child) {
          matchedSubject = child;
        }
        
        if (matchedSubject) {
          textToRemove = hierarchyMatch[0];
        }
      }
    }

    // METHOD 2: Explicit Hashtag - Search ALL subjects (parent and children)
    if (!matchedSubject) {
      const hashIndex = title.indexOf('#');
      
      if (hashIndex !== -1) {
        const afterHash = title.substring(hashIndex + 1);
        
        // Check for quoted format first
        const quotedMatch = afterHash.match(/^"([^"]+)"/);
        if (quotedMatch) {
          const searchNorm = normalize(quotedMatch[1]);
          // Search in ALL subjects (including children)
          matchedSubject = sortedSubjects.find(s => normalize(s.name) === searchNorm);
          if (matchedSubject) {
            textToRemove = '#"' + quotedMatch[1] + '"';
          }
        }
        
        // Check for underscore format
        if (!matchedSubject) {
          const underscoreMatch = afterHash.match(/^([^\s]+)/);
          if (underscoreMatch) {
            const searchText = underscoreMatch[1].replace(/_/g, ' ');
            const searchNorm = normalize(searchText);
            // Search in ALL subjects (including children)
            matchedSubject = sortedSubjects.find(s => normalize(s.name) === searchNorm);
            if (matchedSubject) {
              textToRemove = '#' + underscoreMatch[1];
            }
          }
        }
        
        // Character-by-character matching (space-insensitive)
        if (!matchedSubject) {
          const afterHashNormalized = normalize(afterHash);
          
          // Search in ALL subjects (including children)
          for (const subject of sortedSubjects) {
            const subjectNormalized = normalize(subject.name);
            
            if (afterHashNormalized.startsWith(subjectNormalized)) {
              matchedSubject = subject;
              
              // Calculate exact length to remove
              let matchLength = 0;
              let subjectCharIdx = 0;
              const subjectNoSpaces = subject.name.replace(/\s+/g, '').toLowerCase();
              
              for (let i = 0; i < afterHash.length; i++) {
                const char = afterHash[i].toLowerCase();
                if (/\s/.test(char)) {
                  matchLength++;
                  continue;
                }
                if (char === subjectNoSpaces[subjectCharIdx]) {
                  matchLength++;
                  subjectCharIdx++;
                  if (subjectCharIdx >= subjectNoSpaces.length) break;
                } else {
                  break;
                }
              }
              
              textToRemove = '#' + afterHash.substring(0, matchLength);
              break;
            }
          }
        }
      }
    }

    // METHOD 3: Auto-detect subject name anywhere in text (without #)
    // Search ALL subjects - children are prioritized because sortedSubjects is by length
    if (!matchedSubject) {
      for (const subject of sortedSubjects) {
        // Create flexible regex that allows optional spaces between letters
        const words = subject.name.split(/\s+/);
        const pattern = words.map(w => 
          w.split('').map(c => c.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('\\s*')
        ).join('\\s+');
        const boundary = "(?:^|\\s|[\\.,!\\?;:\\-\\(\\)\\[\\]{}\"'])";
        const regex = new RegExp(`${boundary}(${pattern})(?=$|\\s|[\\.,!\\?;:\\-\\(\\)\\[\\]{}\"'])`, 'i');
        
        const match = title.match(regex);
        if (match) {
          matchedSubject = subject;
          textToRemove = match[1] || match[0];
          break;
        }
      }
    }

    // Apply subject match
    if (matchedSubject) {
      subjectId = matchedSubject.id;
      if (textToRemove) {
        title = title.replace(textToRemove, ' ').trim();
      }
    }

    // ============ STEP 5: FINAL CLEANUP ============
    title = title.replace(/#\s*/g, ' ');
    title = title.replace(/\s+/g, ' ').trim();
    title = title.replace(/^[,.:;\-]+\s*/, '').replace(/\s*[,.:;\-]+$/, '').trim();

    return { title, dueDate, priority, subjectId };
  }
  
  // Legacy helper - kept for compatibility
  function normalizeForComparison(text) {
    return text.toLowerCase().replace(/\s+/g, '').trim();
  }
  
  // Helper function to find best matching subject (used by some methods)
  function findBestSubjectMatch(searchTerm, sortedSubjects) {
    const normalize = (str) => str.replace(/\s+/g, '').toLowerCase();
    const searchNorm = normalize(searchTerm);
    const searchLower = searchTerm.toLowerCase().trim(); // Define searchLower for fuzzy matching
    
    // 1. Exact match (space-insensitive)
    let found = sortedSubjects.find(s => normalize(s.name) === searchNorm);
    if (found) return found;
    
    // 2. Starts with
    found = sortedSubjects.find(s => normalize(s.name).startsWith(searchNorm));
    if (found) return found;
    
    // 3. Search term starts with subject name
    found = sortedSubjects.find(s => searchNorm.startsWith(normalize(s.name)));
    if (found) return found;
    
    // 4. Contains
    found = sortedSubjects.find(s => normalize(s.name).includes(searchNorm));
    if (found) return found;
    
    // 5. Reverse contains
    found = sortedSubjects.find(s => searchLower.includes(s.name.toLowerCase()));
    if (found) return found;
    
    // 6. Fuzzy match - check if all words from search appear in subject name
    const searchWords = searchLower.split(/\s+/);
    found = sortedSubjects.find(s => {
      const subjectLower = s.name.toLowerCase();
      return searchWords.every(word => subjectLower.includes(word));
    });
    if (found) return found;
    
    return null;
  }
  
  // Smart quick add with natural language + Enter to add
  newTaskTitle.addEventListener('keydown', (e) => {
    if (e.key !== 'Enter') return;
    e.preventDefault();
    const input = newTaskTitle.value.trim();
    if (!input) return;
    
    const parsed = parseNaturalLanguage(input);
    const hasParsed = parsed.dueDate || parsed.subjectId || parsed.priority !== 'medium';
    
    if (hasParsed) {
      const defaultSubjectId = getDefaultSubjectId();
      const selectedSubjectId = parsed.subjectId || defaultSubjectId;
      const orderValue = hasManualOrder() ? getNextTaskOrder(false) : null;
      const recurrence = newTaskRecurrence ? newTaskRecurrence.value : 'none';
      
        const taskData = {
          title: parsed.title || input,
          content: '',
          priority: parsed.priority,
          dueDate: parsed.dueDate ? parsed.dueDate.toISOString() : null,
          subject: selectedSubjectId || '',
          checklist: [],
          completed: false,
          createdAt: new Date().toISOString(),
          ...(Number.isFinite(orderValue) ? { order: orderValue } : {}),
          ...(selectedTaskColor ? { color: selectedTaskColor } : {}),
          ...(recurrence && recurrence !== 'none' ? { recurrence } : {})
        };
      
      createTask(taskData);
      
      const taskSections = $("taskSections");
      if (taskSections) {
        taskSections.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
        newTaskTitle.value = '';
        quickAddRow.style.display = 'none';
        selectedTaskColor = '';
        if (newTaskRecurrence) newTaskRecurrence.value = 'none';
        setTaskColorSelection(quickTaskColorPicker, selectedTaskColor);
        syncQuickAddSubject();
    } else {
      addTask();
    }
  });

  if (newTaskDue) {
    newTaskDue.addEventListener('keydown', (e) => {
      if (e.key !== 'Enter') return;
      e.preventDefault();
      addTask();
    });
  }

  // Kick off Pomodoro UI
  Pomodoro.init();

  // ============ DAILY REMINDER ============
  const closeReminderBtn = $("closeReminderBtn");
  const reminderDate = $("reminderDate");
  const todayTasksList = $("todayTasksList");
  const tomorrowTasksList = $("tomorrowTasksList");
  const todayTasksSection = $("todayTasksSection");
  const tomorrowTasksSection = $("tomorrowTasksSection");
  
  function showDailyReminder() {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    const dayAfterTomorrow = new Date(tomorrow);
    dayAfterTomorrow.setDate(dayAfterTomorrow.getDate() + 1);
    
    // Format date in Hebrew
    const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    reminderDate.textContent = now.toLocaleDateString('he-IL', dateOptions);
    
    // Get today's tasks
    const todayTasks = tasks.filter(t => {
      if (!t.dueDate || t.completed) return false;
      const due = new Date(t.dueDate);
      return due >= today && due < tomorrow;
    }).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
    
    // Get tomorrow's tasks
    const tomorrowTasks = tasks.filter(t => {
      if (!t.dueDate || t.completed) return false;
      const due = new Date(t.dueDate);
      return due >= tomorrow && due < dayAfterTomorrow;
    }).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
    
    // Render today's tasks
    if (todayTasks.length > 0) {
      todayTasksSection.style.display = 'block';
      todayTasksList.innerHTML = todayTasks.map(t => renderReminderTask(t)).join('');
    } else {
      todayTasksSection.style.display = 'block';
      todayTasksList.innerHTML = '<div class="reminder-empty">ðŸŽ‰ ××™×Ÿ ×ž×©×™×ž×•×ª ×œ×”×™×•×!</div>';
    }
    
    // Render tomorrow's tasks
    if (tomorrowTasks.length > 0) {
      tomorrowTasksSection.style.display = 'block';
      tomorrowTasksList.innerHTML = tomorrowTasks.map(t => renderReminderTask(t)).join('');
    } else {
      tomorrowTasksSection.style.display = 'none';
    }
    
    reminderModal.classList.add('open');
  }
  
  function renderReminderTask(task) {
    const priorityColors = {
      urgent: '#ef4444',
      high: '#f97316',
      medium: '#eab308',
      low: '#22c55e',
      none: '#6b7280'
    };
    const color = priorityColors[task.priority || 'none'];
    const time = task.dueDate ? new Date(task.dueDate).toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }) : '';
    
    return `
      <div class="reminder-task-item">
        <div class="task-priority-dot" style="background: ${color};"></div>
        <div class="task-info">
          <div class="task-title">${escapeHtml(task.title)}</div>
          ${time ? `<div class="task-time">â° ${time}</div>` : ''}
        </div>
      </div>
    `;
  }
  
  closeReminderBtn.onclick = () => {
    reminderModal.classList.remove('open');
    localStorage.setItem('lastReminderDate', new Date().toDateString());
  };
  
  // Check if we should show reminder (at 9:00 AM)
  function checkDailyReminder() {
    const now = new Date();
    const lastReminder = localStorage.getItem('lastReminderDate');
    const todayString = now.toDateString();
    
    // If already shown today, skip
    if (lastReminder === todayString) return;
    
    // If it's between 9:00 and 9:30 AM, show reminder
    if (now.getHours() === 9 && now.getMinutes() < 30) {
      // Wait for tasks to load
      if (tasks.length > 0 || subjects.length > 0) {
        showDailyReminder();
      }
    }
  }
  
  // Check every minute
  setInterval(checkDailyReminder, 60000);
  
  // Also check on page load (with delay to let data load)
  setTimeout(checkDailyReminder, 3000);

  // ============ INITIALIZE SMART VIEWS ============
  setupSmartViewsHandlers();

  // ============ DAILY PLANNER MODULE ============
  const DailyPlanner = (() => {
    // State
    let currentDate = new Date();
    let plannerView = 'day'; // 'day' or 'week'
    let plannerBlocks = [];
    let editingBlockId = null;
    let miniCalendarDate = new Date();
    
    // Storage key
    const STORAGE_KEY = 'dailyPlannerBlocks';
    
    // DOM References
    const refs = {
      overlay: null,
      currentDate: null,
      prevDay: null,
      nextDay: null,
      todayBtn: null,
      viewToggle: null,
      timeline: null,
      dayView: null,
      weekView: null,
      miniGrid: null,
      miniTitle: null,
      quickTasks: null,
      addModal: null,
      totalBlocks: null,
      totalHours: null,
      completedBlocks: null,
      progress: null,
      dayTitle: null,
      daySummary: null,
      countdownsList: null,
      scheduledTasksList: null,
      syncAllBtn: null,
      syncCountdownsBtn: null,
      syncTasksBtn: null
    };
    
    // Hebrew day names
    const hebrewDays = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—×ž×™×©×™', '×©×™×©×™', '×©×‘×ª'];
    const hebrewMonths = ['×™× ×•××¨', '×¤×‘×¨×•××¨', '×ž×¨×¥', '××¤×¨×™×œ', '×ž××™', '×™×•× ×™', '×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¤×˜×ž×‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘×ž×‘×¨', '×“×¦×ž×‘×¨'];
    
    // Priority colors
    const priorityColors = {
      urgent: { color: '#ef4444', bg: '#fef2f2' },
      high: { color: '#f97316', bg: '#fff7ed' },
      medium: { color: '#eab308', bg: '#fefce8' },
      low: { color: '#22c55e', bg: '#f0fdf4' },
      none: { color: '#6b7280', bg: '#f3f4f6' }
    };
    
    // Category icons
    const categoryIcons = {
      work: 'ðŸ’¼',
      study: 'ðŸ“š',
      health: 'ðŸƒ',
      personal: 'ðŸ ',
      social: 'ðŸ‘¥',
      creative: 'ðŸŽ¨',
      rest: 'ðŸ§˜'
    };
    
    // Templates
    const templates = {
      morning: [
        { title: '×”×ª×¢×•×¨×¨×•×ª ×•×”×ª××¨×’× ×•×ª', start: '06:00', duration: 30, priority: 'medium', category: 'personal' },
        { title: '××¨×•×—×ª ×‘×•×§×¨', start: '06:30', duration: 30, priority: 'low', category: 'health' },
        { title: '×¤×¢×™×œ×•×ª ×’×•×¤× ×™×ª', start: '07:00', duration: 45, priority: 'high', category: 'health' },
        { title: '×ž×§×œ×—×ª ×•×”×ª××¨×’× ×•×ª', start: '07:45', duration: 30, priority: 'medium', category: 'personal' }
      ],
      work: [
        { title: '×‘×“×™×§×ª ×ž×™×™×œ×™× ×•×ª×›× ×•×Ÿ ×™×•×', start: '09:00', duration: 30, priority: 'medium', category: 'work' },
        { title: '×¢×‘×•×“×” ×ž×ž×•×§×“×ª - ×‘×œ×•×§ 1', start: '09:30', duration: 90, priority: 'high', category: 'work' },
        { title: '×”×¤×¡×§×” ×§×¦×¨×”', start: '11:00', duration: 15, priority: 'low', category: 'rest' },
        { title: '×¢×‘×•×“×” ×ž×ž×•×§×“×ª - ×‘×œ×•×§ 2', start: '11:15', duration: 90, priority: 'high', category: 'work' },
        { title: '××¨×•×—×ª ×¦×”×¨×™×™×', start: '12:45', duration: 45, priority: 'medium', category: 'health' },
        { title: '×¤×’×™×©×•×ª / ×©×™×—×•×ª', start: '13:30', duration: 60, priority: 'medium', category: 'work' },
        { title: '×¢×‘×•×“×” ×ž×ž×•×§×“×ª - ×‘×œ×•×§ 3', start: '14:30', duration: 90, priority: 'high', category: 'work' },
        { title: '×¡×™×›×•× ×™×•× ×•×ª×›× ×•×Ÿ ×ž×—×¨', start: '16:00', duration: 30, priority: 'medium', category: 'work' }
      ],
      study: [
        { title: '×œ×™×ž×•×“ - × ×•×©× ×¨××©×™', start: '08:00', duration: 90, priority: 'high', category: 'study' },
        { title: '×”×¤×¡×§×” ×•×—×˜×™×£', start: '09:30', duration: 15, priority: 'low', category: 'rest' },
        { title: '×ª×¨×’×•×œ ×•×¤×ª×¨×•×Ÿ ×‘×¢×™×•×ª', start: '09:45', duration: 60, priority: 'high', category: 'study' },
        { title: '××¨×•×—×ª ×¦×”×¨×™×™×', start: '10:45', duration: 45, priority: 'medium', category: 'health' },
        { title: '×œ×™×ž×•×“ - × ×•×©× ×ž×©× ×™', start: '11:30', duration: 75, priority: 'medium', category: 'study' },
        { title: '×”×¤×¡×§×” ××¨×•×›×”', start: '12:45', duration: 30, priority: 'low', category: 'rest' },
        { title: '×—×–×¨×” ×•×¡×™×›×•×', start: '13:15', duration: 60, priority: 'medium', category: 'study' },
        { title: '×”×›× ×ª ×©×™×¢×•×¨×™ ×‘×™×ª', start: '14:15', duration: 90, priority: 'high', category: 'study' }
      ],
      relax: [
        { title: '×”×ª×¢×•×¨×¨×•×ª ×˜×‘×¢×™×ª', start: '09:00', duration: 30, priority: 'low', category: 'rest' },
        { title: '××¨×•×—×ª ×‘×•×§×¨ × ×™× ×•×—×”', start: '09:30', duration: 45, priority: 'low', category: 'health' },
        { title: '×§×¨×™××” / ×ž×“×™×˜×¦×™×”', start: '10:15', duration: 60, priority: 'low', category: 'rest' },
        { title: '×˜×™×•×œ / ×¤×¢×™×œ×•×ª ×—×•×¥', start: '11:15', duration: 90, priority: 'medium', category: 'health' },
        { title: '××¨×•×—×ª ×¦×”×¨×™×™×', start: '12:45', duration: 60, priority: 'low', category: 'health' },
        { title: '×ª×—×‘×™×‘ / ×¤×¢×™×œ×•×ª ×™×¦×™×¨×ª×™×ª', start: '13:45', duration: 120, priority: 'medium', category: 'creative' },
        { title: '×–×ž×Ÿ ×—×‘×¨×ª×™ / ×ž×©×¤×—×ª×™', start: '16:00', duration: 120, priority: 'medium', category: 'social' }
      ]
    };
    
    // Load blocks from storage
    const loadBlocks = () => {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          plannerBlocks = JSON.parse(saved);
        }
      } catch (e) {
        console.error('Error loading planner blocks:', e);
        plannerBlocks = [];
      }
    };
    
    // Save blocks to storage
    const saveBlocks = () => {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(plannerBlocks));
      } catch (e) {
        console.error('Error saving planner blocks:', e);
      }
    };
    
    // Generate unique ID
    const generateId = () => 'block_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    // Format date for display
    const formatDate = (date) => {
      const day = hebrewDays[date.getDay()];
      const dayNum = date.getDate();
      const month = hebrewMonths[date.getMonth()];
      const year = date.getFullYear();
      return `×™×•× ${day}, ${dayNum} ×‘${month} ${year}`;
    };
    
    // Check if two dates are the same day
    const isSameDay = (d1, d2) => {
      return d1.getFullYear() === d2.getFullYear() &&
             d1.getMonth() === d2.getMonth() &&
             d1.getDate() === d2.getDate();
    };
    
    // Check if date is today
    const isToday = (date) => isSameDay(date, new Date());
    
    // Get date string for storage (YYYY-MM-DD)
    const getDateKey = (date) => {
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    };
    
    // Parse time string to minutes from midnight
    const parseTime = (timeStr) => {
      if (!timeStr) return 0;
      const [h, m] = timeStr.split(':').map(Number);
      return h * 60 + (m || 0);
    };
    
    // Format minutes to time string
    const formatTime = (minutes) => {
      const h = Math.floor(minutes / 60);
      const m = minutes % 60;
      return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
    };
    
    // Ensure recurring blocks are instantiated for the target date
    const ensureRecurringForDate = (date) => {
      const dateKey = getDateKey(date);
      let created = 0;
      plannerBlocks
        .filter(b => b.repeat)
        .forEach(base => {
          if (!base.date) return;
          const baseDate = new Date(base.date);
          // Only create occurrences after (or same as) the base date
          if (baseDate > date || isSameDay(baseDate, date)) return;
          // Avoid duplicate clones
          const alreadyExists = plannerBlocks.some(b => b.originId === (base.originId || base.id) && b.date === dateKey);
          if (alreadyExists) return;
          const clone = {
            ...base,
            id: generateId(),
            date: dateKey,
            completed: false,
            repeat: false, // clones themselves do not auto-repeat; the base drives future creation
            originId: base.originId || base.id,
            createdAt: new Date().toISOString()
          };
          plannerBlocks.push(clone);
          created++;
        });
      if (created > 0) saveBlocks();
    };

    // Get blocks for a specific date
    const getBlocksForDate = (date) => {
      ensureRecurringForDate(date);
      const dateKey = getDateKey(date);
      return plannerBlocks
        .filter(b => b.date === dateKey)
        .sort((a, b) => parseTime(a.start) - parseTime(b.start));
    };
    
    // Calculate stats for a date
    const calculateStats = (date) => {
      const blocks = getBlocksForDate(date);
      const total = blocks.length;
      const completed = blocks.filter(b => b.completed).length;
      const totalMinutes = blocks.reduce((sum, b) => sum + (b.duration || 60), 0);
      const hours = Math.floor(totalMinutes / 60);
      const mins = totalMinutes % 60;
      const progress = total > 0 ? Math.round((completed / total) * 100) : 0;
      
      return { total, completed, hours, mins, progress, totalMinutes };
    };
    
    // Update stats display
    const updateStats = () => {
      const stats = calculateStats(currentDate);
      
      if (refs.totalBlocks) refs.totalBlocks.textContent = stats.total;
      if (refs.totalHours) {
        refs.totalHours.textContent = stats.mins > 0 ? `${stats.hours}:${String(stats.mins).padStart(2, '0')} ×©×¢×•×ª` : `${stats.hours} ×©×¢×•×ª`;
      }
      if (refs.completedBlocks) refs.completedBlocks.textContent = stats.completed;
      if (refs.progress) refs.progress.textContent = `${stats.progress}%`;
      if (refs.daySummary) {
        refs.daySummary.textContent = `${stats.total} ×¤×¢×™×œ×•×™×•×ª â€¢ ${stats.hours}:${String(stats.mins).padStart(2, '0')} ×©×¢×•×ª`;
      }
    };
    
    // Render timeline for day view
    const renderTimeline = () => {
      if (!refs.timeline) return;
      
      const blocks = getBlocksForDate(currentDate);
      const now = new Date();
      const isCurrentDay = isToday(currentDate);
      const currentMinutes = now.getHours() * 60 + now.getMinutes();
      
      let html = '';
      
      // Generate hour rows (6 AM to 11 PM)
      for (let hour = 6; hour <= 23; hour++) {
        const hourLabel = `${String(hour).padStart(2, '0')}:00`;
        const hourMinutes = hour * 60;
        
        // Find blocks that start in this hour
        const hourBlocks = blocks.filter(b => {
          const startMin = parseTime(b.start);
          return startMin >= hourMinutes && startMin < hourMinutes + 60;
        });
        
        html += `
          <div class="planner-hour-row" data-hour="${hour}">
            <div class="planner-hour-label">${hourLabel}</div>
            <div class="planner-hour-content" data-hour="${hour}">
              <span class="planner-empty-hour">+ ×œ×—×¥ ×œ×”×•×¡×¤×”</span>
              ${hourBlocks.map(block => renderBlock(block, hourMinutes)).join('')}
              ${isCurrentDay && currentMinutes >= hourMinutes && currentMinutes < hourMinutes + 60 ? renderNowLine(currentMinutes - hourMinutes) : ''}
            </div>
          </div>
        `;
      }
      
      refs.timeline.innerHTML = html;
      
      // Add click handlers for hour content
      refs.timeline.querySelectorAll('.planner-hour-content').forEach(el => {
        el.addEventListener('click', (e) => {
          if (e.target.closest('.planner-block')) return;
          const hour = parseInt(el.dataset.hour);
          openAddModal(hour);
        });
        
        // Drag and drop handlers for tasks from sidebar
        el.addEventListener('dragover', (e) => {
          e.preventDefault();
          el.classList.add('drop-target');
        });
        el.addEventListener('dragleave', () => {
          el.classList.remove('drop-target');
        });
        el.addEventListener('drop', (e) => {
          e.preventDefault();
          el.classList.remove('drop-target');
          const taskId = e.dataTransfer.getData('text/plain');
          if (taskId) {
            handleTaskDrop(taskId, parseInt(el.dataset.hour));
          }
        });
      });
      
      // Add click handlers for blocks
      refs.timeline.querySelectorAll('.planner-block').forEach(el => {
        el.addEventListener('click', (e) => {
          if (e.target.classList.contains('planner-block-checkbox')) return;
          openEditModal(el.dataset.id);
        });
      });
      
      // Add checkbox handlers
      refs.timeline.querySelectorAll('.planner-block-checkbox').forEach(el => {
        el.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleBlockComplete(el.dataset.id);
        });
      });
      
      // Update day title
      if (refs.dayTitle) {
        const dayName = hebrewDays[currentDate.getDay()];
        const dayLabel = isToday(currentDate) ? '×”×™×•×' : (isSameDay(currentDate, new Date(Date.now() + 86400000)) ? '×ž×—×¨' : `×™×•× ${dayName}`);
        refs.dayTitle.textContent = `${dayLabel} - ×™×•× ${dayName}`;
      }
      
      updateStats();
    };
    
    // Handle dropping a task from sidebar onto the timeline
    const handleTaskDrop = (taskId, hour) => {
      // Find the task
      const task = (typeof tasks !== 'undefined' ? tasks : []).find(t => t.id === taskId);
      if (!task) return;
      
      // Get duration from task or default to 30 minutes
      const duration = task.duration || 30;
      
      // Create a new block from the task
      const newBlock = {
        id: generateId(),
        title: task.title,
        start: formatTime(hour * 60),
        duration: duration,
        category: '',
        notes: '',
        repeat: false,
        priority: task.priority || 'medium',
        color: task.color || '',
        reminder: 0,
        completed: false,
        date: getDateKey(currentDate),
        createdAt: new Date().toISOString(),
        linkedTaskId: taskId // Link to original task
      };
      plannerBlocks.push(newBlock);
      
      saveBlocks();
      render();
    };
    
    // Render a single block
    const renderBlock = (block, hourMinutes) => {
      const startMin = parseTime(block.start);
      const offsetMin = startMin - hourMinutes;
      const duration = block.duration || 60;
      const heightPx = Math.max(15, duration * 1); // 1px per minute, min 15px
      const topPx = offsetMin * 1;
      
      // Determine compact mode based on duration
      let compactClass = '';
      if (duration <= 15) {
        compactClass = 'extra-compact';
      } else if (duration <= 30) {
        compactClass = 'compact';
      }
      
      const priority = block.priority || 'none';
      const defaultColors = priorityColors[priority] || priorityColors.none;
      // Use custom color if set, otherwise use priority color
      const blockColor = block.color || defaultColors.color;
      const blockBg = block.color ? `${block.color}20` : defaultColors.bg;
      const categoryIcon = block.category ? (categoryIcons[block.category] || '') : '';
      const endTime = formatTime(startMin + duration);
      const reminderText = block.reminder > 0 ? `ðŸ”” ${block.reminder} ×“×§×³ ×œ×¤× ×™` : '';
      
      // Determine notes display for day view (not compact/weekly)
      let notesHtml = '';
      if (!compactClass && block.notes && block.notes.trim()) {
        const notesText = escapeHtml(block.notes.trim());
        const notesLength = block.notes.length;
        // Calculate available space based on duration
        // Each line ~30 chars, each line takes ~14px
        const availableHeight = heightPx - 32; // subtract title and time area
        const maxLines = Math.min(4, Math.max(1, Math.floor(availableHeight / 14)));
        
        // Determine font size class based on notes length and available lines
        let fontClass = '';
        if (notesLength > maxLines * 40) {
          fontClass = 'tiny-text';
        } else if (notesLength > maxLines * 30) {
          fontClass = 'small-text';
        }
        
        // Only show notes if we have at least 45px height (45 min+)
        if (duration >= 45) {
          notesHtml = `<div class="planner-block-notes ${fontClass}" style="--notes-lines: ${maxLines};">${notesText}</div>`;
        }
      }
      
      return `
        <div class="planner-block priority-${priority} ${block.completed ? 'planner-block-completed' : ''} ${compactClass}" 
             data-id="${block.id}" 
             style="top: ${topPx}px; height: ${heightPx}px; --priority-color: ${blockColor}; --priority-bg: ${blockBg};">
          <div class="planner-block-checkbox ${block.completed ? 'checked' : ''}" data-id="${block.id}"></div>
          <div class="planner-block-title">${categoryIcon} ${escapeHtml(block.title)}</div>
          <div class="planner-block-time">${block.start} - ${endTime}${reminderText ? ' Â· ' + reminderText : ''}</div>
          ${notesHtml}
        </div>
      `;
    };
    
    // Render current time indicator
    const renderNowLine = (offsetMinutes) => {
      const topPx = offsetMinutes * 1;
      const now = new Date();
      const timeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
      return `
        <div class="planner-now-line" style="top: ${topPx}px;">
          <span class="planner-now-label">${timeStr}</span>
        </div>
      `;
    };
    
    // Render week view
    const renderWeekView = () => {
      if (!refs.weekView) return;
      
      const startOfWeek = new Date(currentDate);
      const dayOfWeek = startOfWeek.getDay();
      startOfWeek.setDate(startOfWeek.getDate() - dayOfWeek);
      
      let html = '';
      
      for (let i = 0; i < 7; i++) {
        const date = new Date(startOfWeek);
        date.setDate(date.getDate() + i);
        const blocks = getBlocksForDate(date);
        const isCurrentDay = isToday(date);
        const isSelected = isSameDay(date, currentDate);
        
        html += `
          <div class="planner-week-day ${isCurrentDay ? 'today' : ''} ${isSelected ? 'selected' : ''}" data-date="${getDateKey(date)}">
            <div class="planner-week-day-header">
              <div class="planner-week-day-name">${hebrewDays[date.getDay()]}</div>
              <div class="planner-week-day-number">${date.getDate()}</div>
            </div>
            <div class="planner-week-day-content">
              ${blocks.slice(0, 8).map(block => `
                <div class="planner-week-block priority-${block.priority || 'none'}" data-id="${block.id}"
                     style="--priority-color: ${(priorityColors[block.priority] || priorityColors.none).color}; --priority-bg: ${(priorityColors[block.priority] || priorityColors.none).bg};">
                  <div class="planner-week-block-time">${block.start}</div>
                  <div class="planner-week-block-title">${escapeHtml(block.title)}</div>
                </div>
              `).join('')}
              ${blocks.length > 8 ? `<div style="text-align: center; font-size: 11px; color: var(--muted);">+${blocks.length - 8} ×¢×•×“</div>` : ''}
            </div>
          </div>
        `;
      }
      
      refs.weekView.innerHTML = html;
      
      // Add click handlers for week days
      refs.weekView.querySelectorAll('.planner-week-day').forEach(el => {
        el.addEventListener('click', (e) => {
          if (e.target.closest('.planner-week-block')) {
            const blockEl = e.target.closest('.planner-week-block');
            openEditModal(blockEl.dataset.id);
          } else {
            const parts = el.dataset.date.split('-');
            currentDate = new Date(parts[0], parts[1] - 1, parts[2]);
            plannerView = 'day';
            updateViewToggle();
            render();
          }
        });
      });
      
      updateStats();
    };
    
    // Render mini calendar
    const renderMiniCalendar = () => {
      if (!refs.miniGrid || !refs.miniTitle) return;
      
      const year = miniCalendarDate.getFullYear();
      const month = miniCalendarDate.getMonth();
      
      refs.miniTitle.textContent = `${hebrewMonths[month]} ${year}`;
      
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startOffset = firstDay.getDay();
      
      let html = '';
      
      // Day names
      const dayNames = ['×', '×‘', '×’', '×“', '×”', '×•', '×©'];
      dayNames.forEach(name => {
        html += `<div class="planner-mini-day-name">${name}</div>`;
      });
      
      // Empty cells before first day
      for (let i = 0; i < startOffset; i++) {
        const prevDate = new Date(year, month, -(startOffset - i - 1));
        html += `<div class="planner-mini-day other-month" data-date="${getDateKey(prevDate)}">${prevDate.getDate()}</div>`;
      }
      
      // Days of month
      for (let d = 1; d <= lastDay.getDate(); d++) {
        const date = new Date(year, month, d);
        const hasEvents = getBlocksForDate(date).length > 0;
        const isCurrentDay = isToday(date);
        const isSelected = isSameDay(date, currentDate);
        
        html += `<div class="planner-mini-day ${isCurrentDay ? 'today' : ''} ${isSelected ? 'selected' : ''} ${hasEvents ? 'has-events' : ''}" data-date="${getDateKey(date)}">${d}</div>`;
      }
      
      // Empty cells after last day
      const endOffset = 6 - lastDay.getDay();
      for (let i = 1; i <= endOffset; i++) {
        const nextDate = new Date(year, month + 1, i);
        html += `<div class="planner-mini-day other-month" data-date="${getDateKey(nextDate)}">${i}</div>`;
      }
      
      refs.miniGrid.innerHTML = html;
      
      // Add click handlers
      refs.miniGrid.querySelectorAll('.planner-mini-day').forEach(el => {
        el.addEventListener('click', () => {
          const parts = el.dataset.date.split('-');
          currentDate = new Date(parts[0], parts[1] - 1, parts[2]);
          miniCalendarDate = new Date(currentDate);
          render();
        });
      });
    };
    
    // Render unscheduled tasks from the task manager
    const renderQuickTasks = () => {
      if (!refs.quickTasks) return;
      
      // Get tasks without due date or without time
      const unscheduledTasks = (typeof tasks !== 'undefined' ? tasks : [])
        .filter(t => !t.completed && (!t.dueDate || !t.dueDate.includes('T')))
        .slice(0, 10);
      
      if (unscheduledTasks.length === 0) {
        refs.quickTasks.innerHTML = '<div class="no-events-msg" id="plannerNoTasks">××™×Ÿ ×ž×©×™×ž×•×ª ×œ×œ× ×ª×–×ž×•×Ÿ</div>';
        return;
      }
      
      refs.quickTasks.innerHTML = unscheduledTasks.map(task => {
        const subject = (typeof subjects !== 'undefined' ? subjects : []).find(s => s.id === task.subject);
        const color = subject ? subject.color : '#667eea';
        const priorityLabel = { urgent: 'ðŸ”´', high: 'ðŸŸ ', medium: 'ðŸŸ¡', low: 'ðŸŸ¢', none: 'âšª' };
        const taskDuration = task.duration || 30; // Default to 30 minutes if not set
        const durationText = taskDuration >= 60 
          ? (taskDuration % 60 === 0 ? `${taskDuration / 60} ×©×¢×•×ª` : `${Math.floor(taskDuration / 60)}:${String(taskDuration % 60).padStart(2, '0')}`)
          : `${taskDuration} ×“×§×³`;
        
        return `
          <div class="planner-task-item" draggable="true" data-task-id="${task.id}" data-duration="${taskDuration}">
            <div class="task-color-dot" style="background: ${color};"></div>
            <div class="task-info">
              <div class="task-title">${priorityLabel[task.priority || 'none']} ${escapeHtml(task.title)}</div>
              ${subject ? `<div class="task-subject">${subject.name}</div>` : ''}
            </div>
            <div class="task-duration">${durationText}</div>
          </div>
        `;
      }).join('');
      
      // Add drag handlers
      refs.quickTasks.querySelectorAll('.planner-task-item').forEach(el => {
        el.addEventListener('dragstart', (e) => {
          e.dataTransfer.setData('text/plain', el.dataset.taskId);
          el.classList.add('dragging');
        });
        el.addEventListener('dragend', () => {
          el.classList.remove('dragging');
        });
      });
    };
    
    // Render countdowns for the current date
    const renderCountdowns = () => {
      if (!refs.countdownsList) return;
      
      const currentDateKey = getDateKey(currentDate);
      const currentBlocks = getBlocksForDate(currentDate);
      
      // Get countdowns (events) for the current date
      const countdownsForDate = (typeof events !== 'undefined' ? events : [])
        .filter(evt => {
          if (!evt.date) return false;
          const evtDate = new Date(evt.date);
          return getDateKey(evtDate) === currentDateKey;
        })
        .slice(0, 10);
      
      if (countdownsForDate.length === 0) {
        refs.countdownsList.innerHTML = '<div class="no-events-msg">××™×Ÿ ×¡×¤×™×¨×•×ª ×œ××—×•×¨ ×œ×”×™×•×</div>';
        return;
      }
      
      refs.countdownsList.innerHTML = countdownsForDate.map(evt => {
        const evtDate = new Date(evt.date);
        const timeStr = evtDate.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
        const color = evt.color || '#667eea';
        
        // Check if already synced to planner
        const isSynced = currentBlocks.some(b => b.linkedEventId === evt.id);
        
        // Calculate time left
        const now = new Date();
        const diff = evtDate - now;
        let timeLeft = '';
        if (diff > 0) {
          const hours = Math.floor(diff / (1000 * 60 * 60));
          const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
          if (hours > 0) {
            timeLeft = `${hours} ×©×¢×•×ª`;
          } else {
            timeLeft = `${mins} ×“×§×•×ª`;
          }
        } else {
          timeLeft = '×¢×‘×¨';
        }
        
        return `
          <div class="planner-countdown-item" data-event-id="${evt.id}">
            <div class="countdown-color-dot" style="background: ${color};"></div>
            <div class="countdown-info">
              <div class="countdown-title">${escapeHtml(evt.name || '××™×¨×•×¢')}</div>
              <div class="countdown-date">${timeStr}</div>
            </div>
            <div class="countdown-time-left">${timeLeft}</div>
            ${isSynced 
              ? '<span class="planner-synced-indicator">âœ“ ×¡×•× ×›×¨×Ÿ</span>'
              : `<button class="add-to-planner-btn" data-event-id="${evt.id}" title="×”×•×¡×£ ×œ×™×•×ž×Ÿ">+</button>`
            }
          </div>
        `;
      }).join('');
      
      // Add click handlers for adding to planner
      refs.countdownsList.querySelectorAll('.add-to-planner-btn').forEach(el => {
        el.addEventListener('click', (e) => {
          e.stopPropagation();
          const eventId = el.dataset.eventId;
          addCountdownToPlanner(eventId);
        });
      });
    };
    
    // Render scheduled tasks (tasks with due date/time) for the current date
    const renderScheduledTasks = () => {
      if (!refs.scheduledTasksList) return;
      
      const currentDateKey = getDateKey(currentDate);
      const currentBlocks = getBlocksForDate(currentDate);
      
      // Get tasks with due date matching current date
      const scheduledTasks = (typeof tasks !== 'undefined' ? tasks : [])
        .filter(t => {
          if (t.completed || !t.dueDate) return false;
          const dueDate = new Date(t.dueDate);
          return getDateKey(dueDate) === currentDateKey;
        })
        .slice(0, 10);
      
      if (scheduledTasks.length === 0) {
        refs.scheduledTasksList.innerHTML = '<div class="no-events-msg">××™×Ÿ ×ž×©×™×ž×•×ª ×ž×ª×•×–×ž× ×•×ª ×œ×”×™×•×</div>';
        return;
      }
      
      const priorityLabel = { urgent: 'ðŸ”´', high: 'ðŸŸ ', medium: 'ðŸŸ¡', low: 'ðŸŸ¢', none: 'âšª' };
      
      refs.scheduledTasksList.innerHTML = scheduledTasks.map(task => {
        const subject = (typeof subjects !== 'undefined' ? subjects : []).find(s => s.id === task.subject);
        const color = subject ? subject.color : '#10b981';
        const dueDate = new Date(task.dueDate);
        const hasTime = task.dueDate.includes('T');
        const timeStr = hasTime ? dueDate.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }) : '×›×œ ×”×™×•×';
        

        // Check if already synced to planner
        const isSynced = currentBlocks.some(b => b.linkedTaskId === task.id);
        
        return `
          <div class="planner-scheduled-task-item" data-task-id="${task.id}">
            <div class="task-color-dot" style="background: ${color};"></div>
            <div class="task-info">
              <div class="task-title">${priorityLabel[task.priority || 'none']} ${escapeHtml(task.title)}</div>
              <div class="task-due">${timeStr}</div>
            </div>
            ${isSynced 
              ? '<span class="planner-synced-indicator">âœ“ ×¡×•× ×›×¨×Ÿ</span>'
              : `<button class="add-to-planner-btn" data-task-id="${task.id}" title="×”×•×¡×£ ×œ×™×•×ž×Ÿ">+</button>`
            }
          </div>
        `;
      }).join('');
      
      // Add click handlers for adding to planner
      refs.scheduledTasksList.querySelectorAll('.add-to-planner-btn').forEach(el => {
        el.addEventListener('click', (e) => {
          e.stopPropagation();
          const taskId = el.dataset.taskId;
          addScheduledTaskToPlanner(taskId);
        });
      });
    };
    
    // Add a countdown event to the planner (standalone copy)
    const addCountdownToPlanner = (eventId) => {
      const evt = (typeof events !== 'undefined' ? events : []).find(e => e.id === eventId);
      if (!evt) return;
      
      const evtDate = new Date(evt.date);
      const startMinutes = evtDate.getHours() * 60 + evtDate.getMinutes();
      
      // Create a standalone block (copy, not linked for editing)
      const newBlock = {
        id: generateId(),
        title: evt.name || '××™×¨×•×¢',
        start: formatTime(startMinutes),
        duration: 60, // Default 1 hour for events
        category: '',
        notes: evt.notes || '',
        repeat: false,
        priority: 'medium',
        color: evt.color || '',
        reminder: 0,
        completed: false,
        date: getDateKey(currentDate),
        createdAt: new Date().toISOString(),
        linkedEventId: eventId, // Track source for sync indicator only
        sourceType: 'countdown'
      };
      
      plannerBlocks.push(newBlock);
      saveBlocks();
      render();
    };
    
    // Add a scheduled task to the planner (standalone copy)
    const addScheduledTaskToPlanner = (taskId) => {
      const task = (typeof tasks !== 'undefined' ? tasks : []).find(t => t.id === taskId);
      if (!task) return;
      
      let startMinutes = 9 * 60; // Default to 9 AM
      if (task.dueDate && task.dueDate.includes('T')) {
        const dueDate = new Date(task.dueDate);
        startMinutes = dueDate.getHours() * 60 + dueDate.getMinutes();
      }
      
      const subject = (typeof subjects !== 'undefined' ? subjects : []).find(s => s.id === task.subject);
      
      // Create a standalone block (copy, not linked for editing)
      const newBlock = {
        id: generateId(),
        title: task.title,
        start: formatTime(startMinutes),
        duration: task.duration || 30,
        category: '',
        notes: task.notes || '',
        repeat: false,
        priority: task.priority || 'medium',
        color: subject ? subject.color : (task.color || ''),
        reminder: 0,
        completed: false,
        date: getDateKey(currentDate),
        createdAt: new Date().toISOString(),
        linkedTaskId: taskId, // Track source for sync indicator only
        sourceType: 'task'
      };
      
      plannerBlocks.push(newBlock);
      saveBlocks();
      render();
    };
    
    // Sync all countdowns for current date to planner
    const syncAllCountdowns = () => {
      const currentDateKey = getDateKey(currentDate);
      const currentBlocks = getBlocksForDate(currentDate);
      
      const countdownsForDate = (typeof events !== 'undefined' ? events : [])
        .filter(evt => {
          if (!evt.date) return false;
          const evtDate = new Date(evt.date);
          return getDateKey(evtDate) === currentDateKey;
        });
      
      let added = 0;
      countdownsForDate.forEach(evt => {
        // Skip if already synced
        if (currentBlocks.some(b => b.linkedEventId === evt.id)) return;
        addCountdownToPlanner(evt.id);
        added++;
      });
      
      if (added > 0) {
        render();
      }
      return added;
    };
    
    // Sync all scheduled tasks for current date to planner
    const syncAllScheduledTasks = () => {
      const currentDateKey = getDateKey(currentDate);
      const currentBlocks = getBlocksForDate(currentDate);
      
      const scheduledTasks = (typeof tasks !== 'undefined' ? tasks : [])
        .filter(t => {
          if (t.completed || !t.dueDate) return false;
          const dueDate = new Date(t.dueDate);
          return getDateKey(dueDate) === currentDateKey;
        });
      
      let added = 0;
      scheduledTasks.forEach(task => {
        // Skip if already synced
        if (currentBlocks.some(b => b.linkedTaskId === task.id)) return;
        addScheduledTaskToPlanner(task.id);
        added++;
      });
      
      if (added > 0) {
        render();
      }
      return added;
    };
    
    // Sync everything for current date
    const syncAll = () => {
      const countdownsAdded = syncAllCountdowns();
      const tasksAdded = syncAllScheduledTasks();
      return countdownsAdded + tasksAdded;
    };

    // AI: Plan entire day (reorders tasks and lays out schedule)
    const aiPlanEntireDay = async () => {
      const dateKey = getDateKey(currentDate);
      const dayLabel = formatDate(currentDate);

      const availableTasks = (typeof tasks !== 'undefined' ? tasks : [])
        .filter(t => t && !t.completed && t.title)
        .slice(0, 10); // cap at 10 to avoid truncation

      if (availableTasks.length === 0) {
        alert('××™×Ÿ ×ž×©×™×ž×•×ª ×œ×ª×›× ×•×Ÿ / No tasks to plan');
        return;
      }

      const existingBlocks = getBlocksForDate(currentDate);
      if (existingBlocks.length > 0) {
        const confirmReplace = confirm(`×¤×¢×•×œ×” ×–×• ×ª×—×œ×™×£ ××ª ×›×œ ×”×‘×œ×•×§×™× ×‘×ª××¨×™×š ×–×” (${dayLabel}).\nThis will replace the current plan for this day. Continue?`);
        if (!confirmReplace) return;
      }

      const normalizedTasks = availableTasks.map(t => {
        const subj = (typeof subjects !== 'undefined' ? subjects : []).find(s => s.id === t.subject);
        return {
          id: t.id,
          title: t.title.substring(0, 50),
          priority: t.priority || 'none',
          estimatedMinutes: t.estimatedMinutes || 60,
          subject: subj ? subj.name : (t.subject || 'general')
        };
      });

      const tasksText = normalizedTasks.map((t, i) => `${i + 1}. ${t.id}|${t.title}|${t.priority}|${t.estimatedMinutes}m`).join('\n');

      const prompt = `Schedule for ${dateKey}. Start at 09:00. Return ONLY JSON array:

Tasks:
${tasksText}

Rules: Start 09:00, end by 23:00, no overlaps, urgent first. Use task durations.
JSON: [{"taskId":"id","start":"HH:MM","durationMinutes":60}]

Array:`;

      const text = await callAI(prompt);
      const plan = parseAIJsonResponse(text);
      if (!Array.isArray(plan)) throw new Error('Invalid plan format from AI');

      const MIN_START = 9 * 60; // 9:00 AM
      const MAX_END = 23 * 60; // 11:00 PM

      const newBlocks = [];

      plan.forEach((item, idx) => {
        const startStr = (item && item.start) ? String(item.start).trim() : null;
        const startMinutes = startStr ? parseTime(startStr) : null;
        if (startMinutes === null || isNaN(startMinutes)) return;
        const rawDuration = parseInt(item.durationMinutes || item.duration || 0, 10);
        const duration = Math.min(240, Math.max(15, rawDuration || 60));
        const endMinutes = startMinutes + duration;
        if (startMinutes < MIN_START || endMinutes > MAX_END) return;

        // Avoid overlaps with already accepted blocks
        const overlaps = newBlocks.some(b => {
          const bStart = parseTime(b.start);
          const bEnd = bStart + (b.duration || 60);
          return startMinutes < bEnd && endMinutes > bStart;
        });
        if (overlaps) return;

        const taskMatch = normalizedTasks.find(t => t.id === item.taskId) || normalizedTasks[idx];
        if (!taskMatch) return;

        const subj = (typeof subjects !== 'undefined' ? subjects : []).find(s => s.id === taskMatch.subject);
        const block = {
          id: generateId(),
          title: item.title || taskMatch.title,
          start: formatTime(startMinutes),
          duration: duration,
          priority: taskMatch.priority || 'medium',
          category: taskMatch.subject || 'work',
          color: subj ? subj.color : '#667eea',
          date: dateKey,
          completed: false,
          reminder: 0,
          sourceType: 'ai-plan',
          linkedTaskId: taskMatch.id,
          note: item.note || ''
        };

        newBlocks.push(block);
      });

      if (newBlocks.length === 0) {
        throw new Error('AI did not return a usable schedule');
      }

      // Replace plan for the day
      plannerBlocks = plannerBlocks.filter(b => b.date !== dateKey);
      plannerBlocks.push(...newBlocks.sort((a, b) => parseTime(a.start) - parseTime(b.start)));
      saveBlocks();
      render();

      alert(`âœ… × ×‘× ×” ×œ×•×— ×–×ž× ×™× AI ×œ-${dayLabel} (${newBlocks.length} ×‘×œ×•×§×™×)`);
    };
    
    // Open add modal
    const openAddModal = (hour = 9) => {
      editingBlockId = null;
      
      const modal = refs.addModal;
      if (!modal) return;
      
      const titleEl = modal.querySelector('#plannerModalTitle');
      const blockTitle = modal.querySelector('#plannerBlockTitle');
      const blockStart = modal.querySelector('#plannerBlockStart');
      const blockEnd = modal.querySelector('#plannerBlockEnd');
      const blockCategory = modal.querySelector('#plannerBlockCategory');
      const blockNotes = modal.querySelector('#plannerBlockNotes');
      const blockRepeat = modal.querySelector('#plannerBlockRepeat');
      const deleteBtn = modal.querySelector('#plannerDeleteBtn');
      const priorityPicker = modal.querySelector('#plannerPriorityPicker');
      
      if (titleEl) titleEl.textContent = 'âž• ×”×•×¡×£ ×¤×¢×™×œ×•×ª';
      if (blockTitle) blockTitle.value = '';
      if (blockStart) blockStart.value = formatTime(hour * 60);
      if (blockEnd) blockEnd.value = formatTime((hour + 1) * 60);
      if (blockCategory) blockCategory.value = '';
      if (blockNotes) blockNotes.value = '';
      if (blockRepeat) blockRepeat.checked = false;
      if (deleteBtn) deleteBtn.style.display = 'none';
      
      // Reset reminder
      const blockReminder = modal.querySelector('#plannerBlockReminder');
      if (blockReminder) blockReminder.value = '0';
      
      // Reset priority
      if (priorityPicker) {
        priorityPicker.querySelectorAll('.planner-priority-option').forEach(el => el.classList.remove('selected'));
        const mediumBtn = priorityPicker.querySelector('[data-priority="medium"]');
        if (mediumBtn) mediumBtn.classList.add('selected');
      }
      
      // Reset color picker
      const colorPicker = modal.querySelector('#plannerColorPicker');
      if (colorPicker) {
        colorPicker.querySelectorAll('.planner-color-option').forEach(el => el.classList.remove('selected'));
        const defaultColor = colorPicker.querySelector('[data-color=""]');
        if (defaultColor) defaultColor.classList.add('selected');
      }
      
      // Reset duration buttons
      modal.querySelectorAll('.planner-duration-btn').forEach(el => el.classList.remove('active'));
      const defaultDuration = modal.querySelector('[data-duration="60"]');
      if (defaultDuration) defaultDuration.classList.add('active');
      
      modal.classList.add('open');
      if (blockTitle) blockTitle.focus();
    };
    
    // Open edit modal
    const openEditModal = (blockId) => {
      const block = plannerBlocks.find(b => b.id === blockId);
      if (!block) return;
      
      editingBlockId = blockId;
      
      const modal = refs.addModal;
      if (!modal) return;
      
      const titleEl = modal.querySelector('#plannerModalTitle');
      const blockTitle = modal.querySelector('#plannerBlockTitle');
      const blockStart = modal.querySelector('#plannerBlockStart');
      const blockEnd = modal.querySelector('#plannerBlockEnd');
      const blockCategory = modal.querySelector('#plannerBlockCategory');
      const blockNotes = modal.querySelector('#plannerBlockNotes');
      const blockRepeat = modal.querySelector('#plannerBlockRepeat');
      const deleteBtn = modal.querySelector('#plannerDeleteBtn');
      const priorityPicker = modal.querySelector('#plannerPriorityPicker');
      
      if (titleEl) titleEl.textContent = 'âœï¸ ×¢×¨×•×š ×¤×¢×™×œ×•×ª';
      if (blockTitle) blockTitle.value = block.title || '';
      if (blockStart) blockStart.value = block.start || '09:00';
      if (blockEnd) blockEnd.value = formatTime(parseTime(block.start) + (block.duration || 60));
      if (blockCategory) blockCategory.value = block.category || '';
      if (blockNotes) blockNotes.value = block.notes || '';
      if (blockRepeat) blockRepeat.checked = block.repeat || false;
      
      // Set reminder
      const blockReminder = modal.querySelector('#plannerBlockReminder');
      if (blockReminder) blockReminder.value = block.reminder || '0';
      if (deleteBtn) deleteBtn.style.display = '';
      
      // Set priority
      if (priorityPicker) {
        priorityPicker.querySelectorAll('.planner-priority-option').forEach(el => el.classList.remove('selected'));
        const priorityBtn = priorityPicker.querySelector(`[data-priority="${block.priority || 'medium'}"]`);
        if (priorityBtn) priorityBtn.classList.add('selected');
      }
      
      // Set color
      const colorPicker = modal.querySelector('#plannerColorPicker');
      if (colorPicker) {
        colorPicker.querySelectorAll('.planner-color-option').forEach(el => el.classList.remove('selected'));
        const colorBtn = colorPicker.querySelector(`[data-color="${block.color || ''}"]`);
        if (colorBtn) colorBtn.classList.add('selected');
      }
      
      modal.classList.add('open');
    };
    
    // Close modal
    const closeModal = () => {
      if (refs.addModal) refs.addModal.classList.remove('open');
      editingBlockId = null;
    };
    
    // Save block
    const saveBlock = () => {
      const modal = refs.addModal;
      if (!modal) return;
      
      const blockTitle = modal.querySelector('#plannerBlockTitle');
      const blockStart = modal.querySelector('#plannerBlockStart');
      const blockEnd = modal.querySelector('#plannerBlockEnd');
      const blockCategory = modal.querySelector('#plannerBlockCategory');
      const blockNotes = modal.querySelector('#plannerBlockNotes');
      const blockRepeat = modal.querySelector('#plannerBlockRepeat');
      const priorityPicker = modal.querySelector('#plannerPriorityPicker');
      
      const title = blockTitle ? blockTitle.value.trim() : '';
      if (!title) {
        if (blockTitle) blockTitle.focus();
        return;
      }
      
      const start = blockStart ? blockStart.value : '09:00';
      const end = blockEnd ? blockEnd.value : '10:00';
      const duration = parseTime(end) - parseTime(start);
      const category = blockCategory ? blockCategory.value : '';
      const notes = blockNotes ? blockNotes.value.trim() : '';
      const repeat = blockRepeat ? blockRepeat.checked : false;
      const blockReminder = modal.querySelector('#plannerBlockReminder');
      const reminder = blockReminder ? parseInt(blockReminder.value) || 0 : 0;
      const selectedPriority = priorityPicker ? priorityPicker.querySelector('.selected') : null;
      const priority = selectedPriority ? selectedPriority.dataset.priority : 'medium';
      const colorPicker = modal.querySelector('#plannerColorPicker');
      const selectedColor = colorPicker ? colorPicker.querySelector('.selected') : null;
      const color = selectedColor ? selectedColor.dataset.color : '';
      
      if (editingBlockId) {
        // Update existing block
        const index = plannerBlocks.findIndex(b => b.id === editingBlockId);
        if (index !== -1) {
          plannerBlocks[index] = {
            ...plannerBlocks[index],
            title,
            start,
            duration: Math.max(15, duration),
            category,
            notes,
            repeat,
            reminder,
            priority,
            color
          };
        }
      } else {
        // Create new block
        const newBlock = {
          id: generateId(),
          title,
          start,
          duration: Math.max(15, duration),
          category,
          notes,
          repeat,
          reminder,
          priority,
          color,
          completed: false,
          date: getDateKey(currentDate),
          createdAt: new Date().toISOString(),
          originId: null
        };
        plannerBlocks.push(newBlock);
      }
      
      saveBlocks();
      closeModal();
      render();
    };
    
    // Delete block (removes only the planner block, NOT the linked task)
    const deleteBlock = () => {
      if (!editingBlockId) return;
      
      // Only remove the planner block - tasks remain intact
      plannerBlocks = plannerBlocks.filter(b => b.id !== editingBlockId);
      saveBlocks();
      closeModal();
      render();
    };
    
    // Toggle block completion
    const toggleBlockComplete = (blockId) => {
      const block = plannerBlocks.find(b => b.id === blockId);
      if (block) {
        block.completed = !block.completed;
        saveBlocks();
        render();
      }
    };
    
    // Apply template
    const applyTemplate = (templateKey) => {
      const template = templates[templateKey];
      if (!template) return;
      
      const dateKey = getDateKey(currentDate);
      
      template.forEach(item => {
        const newBlock = {
          id: generateId(),
          title: item.title,
          start: item.start,
          duration: item.duration,
          category: item.category,
          priority: item.priority,
          completed: false,
          date: dateKey,
          createdAt: new Date().toISOString()
        };
        plannerBlocks.push(newBlock);
      });
      
      saveBlocks();
      render();
    };
    
    // Update view toggle buttons
    const updateViewToggle = () => {
      if (!refs.viewToggle) return;
      refs.viewToggle.querySelectorAll('button').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === plannerView);
      });
    };
    
    // Main render function
    const render = () => {
      // Update date display
      if (refs.currentDate) {
        refs.currentDate.textContent = formatDate(currentDate);
      }
      
      // Show/hide views
      if (refs.dayView) refs.dayView.style.display = plannerView === 'day' ? '' : 'none';
      if (refs.weekView) refs.weekView.style.display = plannerView === 'week' ? '' : 'none';
      
      // Render appropriate view
      if (plannerView === 'day') {
        renderTimeline();
      } else {
        renderWeekView();
      }
      
      renderMiniCalendar();
      renderQuickTasks();
      renderCountdowns();
      renderScheduledTasks();
    };
    
    // Navigate date
    const navigateDate = (delta) => {
      if (plannerView === 'week') {
        currentDate.setDate(currentDate.getDate() + (delta * 7));
      } else {
        currentDate.setDate(currentDate.getDate() + delta);
      }
      miniCalendarDate = new Date(currentDate);
      render();
    };
    
    // Go to today
    const goToToday = () => {
      currentDate = new Date();
      miniCalendarDate = new Date();
      render();
    };
    
    // Initialize
    const init = () => {
      // Get DOM references
      refs.overlay = $('plannerOverlay');
      refs.currentDate = $('plannerCurrentDate');
      refs.prevDay = $('plannerPrevDay');
      refs.nextDay = $('plannerNextDay');
      refs.todayBtn = $('plannerTodayBtn');
      refs.timeline = $('plannerTimeline');
      refs.dayView = $('plannerDayView');
      refs.weekView = $('plannerWeekView');
      refs.miniGrid = $('plannerMiniGrid');
      refs.miniTitle = $('plannerMiniTitle');
      refs.quickTasks = $('plannerQuickTasks');
      refs.addModal = $('plannerAddModal');
      refs.totalBlocks = $('plannerTotalBlocks');
      refs.totalHours = $('plannerTotalHours');
      refs.completedBlocks = $('plannerCompletedBlocks');
      refs.progress = $('plannerProgress');
      refs.dayTitle = $('plannerDayTitle');
      refs.daySummary = $('plannerDaySummary');
      refs.countdownsList = $('plannerCountdownsList');
      refs.scheduledTasksList = $('plannerScheduledTasksList');
      refs.syncAllBtn = $('plannerSyncAllBtn');
      refs.syncCountdownsBtn = $('plannerSyncCountdownsBtn');
      refs.syncTasksBtn = $('plannerSyncTasksBtn');
      
      // View toggle
      refs.viewToggle = refs.overlay ? refs.overlay.querySelector('.planner-view-toggle') : null;
      
      // Load saved blocks
      loadBlocks();
      
      // Set up event listeners
      if (refs.prevDay) refs.prevDay.onclick = () => navigateDate(-1);
      if (refs.nextDay) refs.nextDay.onclick = () => navigateDate(1);
      if (refs.todayBtn) refs.todayBtn.onclick = goToToday;
      
      // AI Plan Day button
      const aiPlanDayBtn = $('aiPlanDayBtn');
      if (aiPlanDayBtn) {
        aiPlanDayBtn.onclick = async () => {
          if (!tasksLoaded) {
            alert('â³ ×˜×•×¢×Ÿ ×ž×©×™×ž×•×ª... / Loading tasks...');
            return;
          }

          aiPlanDayBtn.disabled = true;
          aiPlanDayBtn.innerHTML = 'â³ Planning...';
          try {
            await aiPlanEntireDay();
          } catch (error) {
            console.error('AI plan day error:', error);
            alert(`âŒ ×©×’×™××” ×‘×ª×›× ×•×Ÿ AI / Error: ${error.message}`);
          } finally {
            aiPlanDayBtn.disabled = false;
            aiPlanDayBtn.innerHTML = 'ðŸ§  Plan Day';
          }
        };
      }
      
      // AI Auto-Schedule button
      const aiAutoScheduleBtn = $('aiAutoScheduleBtn');
      if (aiAutoScheduleBtn) {
        aiAutoScheduleBtn.onclick = async () => {
          // Check if tasks are loaded
          if (!tasksLoaded) {
            alert('â³ ×˜×•×¢×Ÿ ×ž×©×™×ž×•×ª... / Loading tasks...');
            return;
          }
          
          aiAutoScheduleBtn.disabled = true;
          aiAutoScheduleBtn.innerHTML = 'â³ ×ž×ª×–×ž×Ÿ...';
          
          try {
            await autoScheduleTasks();
          } catch (error) {
            console.error('Auto-schedule error:', error);
            alert(`âŒ ×©×’×™××” ×‘×ª×–×ž×•×Ÿ ××•×˜×•×ž×˜×™ / Error: ${error.message}`);
          } finally {
            aiAutoScheduleBtn.disabled = false;
            aiAutoScheduleBtn.innerHTML = 'âœ¨ Auto-Schedule';
          }
        };
      }
      
      // AI Suggestions button
      const aiSuggestionsBtn = $('aiSuggestionsBtn');
      if (aiSuggestionsBtn) {
        aiSuggestionsBtn.onclick = async () => {
          // Check API key configuration
          if (AI_CONFIG.gemini.apiKey === 'YOUR_GEMINI_API_KEY' && AI_CONFIG.openai.apiKey === 'YOUR_OPENAI_API_KEY') {
            alert('âš ï¸ Please configure AI API keys in the code!\n\nEdit index.html and search for "AI_CONFIG" to add your Gemini or OpenAI API key.\n\nGet Gemini key: https://makersuite.google.com/app/apikey\nGet OpenAI key: https://platform.openai.com/api-keys');
            return;
          }
          
          if (!tasksLoaded) {
            alert('â³ ×˜×•×¢×Ÿ ×ž×©×™×ž×•×ª... / Loading tasks...');
            return;
          }
          
          aiSuggestionsBtn.disabled = true;
          aiSuggestionsBtn.innerHTML = 'â³ ×ž×¢×‘×“...';
          
          try {
            await getAISuggestionsForTasks();
          } catch (error) {
            console.error('AI suggestions error:', error);
            alert(`âŒ ×©×’×™××” ×‘×§×‘×œ×ª ×”×¦×¢×•×ª / Error: ${error.message}`);
          } finally {
            aiSuggestionsBtn.disabled = false;
            aiSuggestionsBtn.innerHTML = 'ðŸ¤– AI Suggestions';
          }
        };
      }
      
      // View toggle
      if (refs.viewToggle) {
        refs.viewToggle.querySelectorAll('button').forEach(btn => {
          btn.onclick = () => {
            plannerView = btn.dataset.view;
            updateViewToggle();
            render();
          };
        });
      }
      
      // Mini calendar navigation
      const miniPrev = $('plannerMiniPrev');
      const miniNext = $('plannerMiniNext');
      if (miniPrev) miniPrev.onclick = () => {
        miniCalendarDate.setMonth(miniCalendarDate.getMonth() - 1);
        renderMiniCalendar();
      };
      if (miniNext) miniNext.onclick = () => {
        miniCalendarDate.setMonth(miniCalendarDate.getMonth() + 1);
        renderMiniCalendar();
      };
      
      // Template buttons
      const templateBtns = refs.overlay ? refs.overlay.querySelectorAll('.planner-template-btn') : [];
      templateBtns.forEach(btn => {
        btn.onclick = () => applyTemplate(btn.dataset.template);
      });
      
      // Sync buttons
      if (refs.syncAllBtn) {
        refs.syncAllBtn.onclick = () => {
          refs.syncAllBtn.classList.add('syncing');
          const count = syncAll();
          setTimeout(() => {
            refs.syncAllBtn.classList.remove('syncing');
          }, 500);
        };
      }
      
      if (refs.syncCountdownsBtn) {
        refs.syncCountdownsBtn.onclick = () => {
          refs.syncCountdownsBtn.classList.add('syncing');
          syncAllCountdowns();
          setTimeout(() => {
            refs.syncCountdownsBtn.classList.remove('syncing');
          }, 500);
        };
      }
      
      if (refs.syncTasksBtn) {
        refs.syncTasksBtn.onclick = () => {
          refs.syncTasksBtn.classList.add('syncing');
          syncAllScheduledTasks();
          setTimeout(() => {
            refs.syncTasksBtn.classList.remove('syncing');
          }, 500);
        };
      }
      
      // Section collapse toggles
      const countdownsToggle = $('plannerCountdownsToggle');
      const scheduledTasksToggle = $('plannerScheduledTasksToggle');
      
      if (countdownsToggle && refs.countdownsList) {
        countdownsToggle.onclick = () => {
          countdownsToggle.classList.toggle('collapsed');
          refs.countdownsList.classList.toggle('collapsed');
        };
      }
      
      if (scheduledTasksToggle && refs.scheduledTasksList) {
        scheduledTasksToggle.onclick = () => {
          scheduledTasksToggle.classList.toggle('collapsed');
          refs.scheduledTasksList.classList.toggle('collapsed');
        };
      }
      
      // Modal events
      if (refs.addModal) {
        const cancelBtn = refs.addModal.querySelector('#plannerCancelBtn');
        const saveBtn = refs.addModal.querySelector('#plannerSaveBtn');
        const deleteBtn = refs.addModal.querySelector('#plannerDeleteBtn');
        const priorityPicker = refs.addModal.querySelector('#plannerPriorityPicker');
        const durationBtns = refs.addModal.querySelectorAll('.planner-duration-btn');
        
        if (cancelBtn) cancelBtn.onclick = closeModal;
        if (saveBtn) saveBtn.onclick = saveBlock;
        if (deleteBtn) deleteBtn.onclick = deleteBlock;
        
        // Enter key to save
        refs.addModal.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            const activeEl = document.activeElement;
            // Don't trigger if in textarea
            if (activeEl && activeEl.tagName === 'TEXTAREA') return;
            e.preventDefault();
            saveBlock();
          }
          if (e.key === 'Escape') {
            closeModal();
          }
        });
        
        // Color picker
        const colorPicker = refs.addModal.querySelector('#plannerColorPicker');
        if (colorPicker) {
          colorPicker.addEventListener('click', (e) => {
            const option = e.target.closest('.planner-color-option');
            if (!option) return;
            colorPicker.querySelectorAll('.planner-color-option').forEach(el => el.classList.remove('selected'));
            option.classList.add('selected');
          });
        }
        
        // Priority picker
        if (priorityPicker) {
          priorityPicker.addEventListener('click', (e) => {
            const option = e.target.closest('.planner-priority-option');
            if (!option) return;
            priorityPicker.querySelectorAll('.planner-priority-option').forEach(el => el.classList.remove('selected'));
            option.classList.add('selected');
          });
        }
        
        // Duration presets
        durationBtns.forEach(btn => {
          btn.onclick = () => {
            durationBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            const duration = parseInt(btn.dataset.duration);
            const startInput = refs.addModal.querySelector('#plannerBlockStart');
            const endInput = refs.addModal.querySelector('#plannerBlockEnd');
            
            if (startInput && endInput) {
              const startMins = parseTime(startInput.value);
              endInput.value = formatTime(startMins + duration);
            }
          };
        });
        
        // Close on backdrop click
        refs.addModal.addEventListener('click', (e) => {
          if (e.target === refs.addModal) closeModal();
        });
      }
      
      // Initial render
      render();
      
      // Update now line every minute
      setInterval(() => {
        if (plannerView === 'day' && isToday(currentDate)) {
          renderTimeline();
        }
      }, 60000);
    };
    
    // Refresh scheduled tasks (called when tasks change)
    const refreshTasks = () => {
      if (refs.scheduledTasksList) {
        renderScheduledTasks();
      }
    };
    
    return { init, render, refreshTasks };
  })();
</script>

<!-- Mobile Bottom Navigation Bar -->
<nav class="mobile-bottom-nav" id="mobileBottomNav" style="display: none;">
  <button class="mobile-nav-item active" data-view="countdown">
    <span class="mobile-nav-icon">â±ï¸</span>
    <span class="mobile-nav-label">×¡×¤×™×¨×”</span>
  </button>
  <button class="mobile-nav-item" data-view="tasks">
    <span class="mobile-nav-icon">ðŸ“</span>
    <span class="mobile-nav-label">×ž×©×™×ž×•×ª</span>
  </button>
  <button class="mobile-nav-item" data-view="pomodoro">
    <span class="mobile-nav-icon">ðŸ…</span>
    <span class="mobile-nav-label">×¤×•×ž×•×“×•×¨×•</span>
  </button>
  <button class="mobile-nav-item" data-view="planner">
    <span class="mobile-nav-icon">ðŸ“…</span>
    <span class="mobile-nav-label">×ž×ª×›× ×Ÿ</span>
  </button>
  <button class="mobile-nav-item" data-view="calendar">
    <span class="mobile-nav-icon">ðŸ“†</span>
    <span class="mobile-nav-label">×œ×•×—</span>
  </button>
</nav>

<script>
// Mobile Bottom Navigation Handler
(function() {
  const isMobile = () => window.innerWidth <= 768 || 
    (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches && window.innerWidth <= 1024);
  
  const mobileNav = document.getElementById('mobileBottomNav');
  const navItems = mobileNav.querySelectorAll('.mobile-nav-item');
  
  // Show/hide mobile nav based on screen size
  const updateMobileNavVisibility = () => {
    if (isMobile()) {
      mobileNav.style.display = 'flex';
    } else {
      mobileNav.style.display = 'none';
    }
  };
  
  // Initial check
  updateMobileNavVisibility();
  
  // Update on resize
  window.addEventListener('resize', updateMobileNavVisibility);
  
  // Handle navigation clicks
  navItems.forEach(item => {
    item.addEventListener('click', () => {
      const view = item.dataset.view;
      
      // Update active state
      navItems.forEach(i => i.classList.remove('active'));
      item.classList.add('active');
      
      // Update header buttons active state
      const headerBtns = document.querySelectorAll('.fixed-header-bar .header-btn');
      headerBtns.forEach(btn => btn.classList.remove('active'));
      
      // Navigate to the correct view
      switch(view) {
        case 'countdown':
          // Close all overlays, show countdown
          document.getElementById('taskManagerOverlay')?.classList.remove('open');
          document.getElementById('pomodoroOverlay')?.classList.remove('open');
          document.getElementById('plannerOverlay')?.classList.remove('open');
          document.getElementById('sidebar')?.classList.add('hidden');
          document.getElementById('toggleCountdown')?.classList.add('active');
          break;
        case 'tasks':
          document.getElementById('taskManagerOverlay')?.classList.add('open');
          document.getElementById('pomodoroOverlay')?.classList.remove('open');
          document.getElementById('plannerOverlay')?.classList.remove('open');
          document.getElementById('sidebar')?.classList.add('hidden');
          document.getElementById('toggleTasks')?.classList.add('active');
          break;
        case 'pomodoro':
          document.getElementById('taskManagerOverlay')?.classList.remove('open');
          document.getElementById('pomodoroOverlay')?.classList.add('open');
          document.getElementById('plannerOverlay')?.classList.remove('open');
          document.getElementById('sidebar')?.classList.add('hidden');
          document.getElementById('togglePomodoro')?.classList.add('active');
          break;
        case 'planner':
          document.getElementById('taskManagerOverlay')?.classList.remove('open');
          document.getElementById('pomodoroOverlay')?.classList.remove('open');
          document.getElementById('plannerOverlay')?.classList.add('open');
          document.getElementById('sidebar')?.classList.add('hidden');
          document.getElementById('togglePlanner')?.classList.add('active');
          break;
        case 'calendar':
          document.getElementById('taskManagerOverlay')?.classList.remove('open');
          document.getElementById('pomodoroOverlay')?.classList.remove('open');
          document.getElementById('plannerOverlay')?.classList.remove('open');
          const sidebar = document.getElementById('sidebar');
          if (sidebar) {
            sidebar.classList.toggle('hidden');
          }
          document.getElementById('toggleSidebar')?.classList.add('active');
          break;
      }
    });
  });
  
  // Sync with existing header button clicks
  const syncWithHeader = () => {
    const toggleCountdown = document.getElementById('toggleCountdown');
    const toggleTasks = document.getElementById('toggleTasks');
    const togglePomodoro = document.getElementById('togglePomodoro');
    const togglePlanner = document.getElementById('togglePlanner');
    const toggleSidebar = document.getElementById('toggleSidebar');
    
    const updateNav = (view) => {
      navItems.forEach(item => {
        item.classList.toggle('active', item.dataset.view === view);
      });
    };
    
    toggleCountdown?.addEventListener('click', () => updateNav('countdown'));
    toggleTasks?.addEventListener('click', () => updateNav('tasks'));
    togglePomodoro?.addEventListener('click', () => updateNav('pomodoro'));
    togglePlanner?.addEventListener('click', () => updateNav('planner'));
    toggleSidebar?.addEventListener('click', () => updateNav('calendar'));
  };
  
  syncWithHeader();
  
  // Mobile Task Sidebar Handler
  const taskSidebar = document.getElementById('taskSidebar');
  const toggleTaskSidebarBtn = document.getElementById('toggleTaskSidebar');
  const mobileSidebarBackdrop = document.getElementById('mobileSidebarBackdrop');
  
  const toggleMobileTaskSidebar = () => {
    if (!isMobile()) return;
    
    const isOpen = taskSidebar.classList.contains('open');
    
    if (isOpen) {
      taskSidebar.classList.remove('open');
      mobileSidebarBackdrop.classList.remove('visible');
      toggleTaskSidebarBtn?.classList.remove('active');
    } else {
      taskSidebar.classList.add('open');
      mobileSidebarBackdrop.classList.add('visible');
      toggleTaskSidebarBtn?.classList.add('active');
    }
  };
  
  toggleTaskSidebarBtn?.addEventListener('click', (e) => {
    if (isMobile()) {
      e.preventDefault();
      e.stopPropagation();
      toggleMobileTaskSidebar();
    }
  });
  
  mobileSidebarBackdrop?.addEventListener('click', () => {
    if (taskSidebar?.classList.contains('open')) {
      toggleMobileTaskSidebar();
    }
  });
  
  // Close task sidebar when clicking on a subject/view on mobile
  if (taskSidebar) {
    taskSidebar.addEventListener('click', (e) => {
      if (isMobile() && (e.target.closest('.smart-view-item') || e.target.closest('.subject-list-header'))) {
        setTimeout(() => {
          toggleMobileTaskSidebar();
        }, 200);
      }
    });
  }
  
  // Mobile Floating Action Button (FAB)
  const mobileFab = document.getElementById('mobileFab');
  
  const updateFabVisibility = () => {
    if (isMobile()) {
      mobileFab.style.display = 'flex';
    } else {
      mobileFab.style.display = 'none';
    }
  };
  
  updateFabVisibility();
  window.addEventListener('resize', updateFabVisibility);
  
  // FAB click handler - context-aware action
  mobileFab?.addEventListener('click', () => {
    const activeNavItem = document.querySelector('.mobile-nav-item.active');
    const currentView = activeNavItem?.dataset.view || 'countdown';
    
    switch(currentView) {
      case 'countdown':
        // Focus on event name input
        const eventNameInput = document.getElementById('eventName');
        if (eventNameInput) {
          eventNameInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
          setTimeout(() => eventNameInput.focus(), 300);
        }
        break;
      case 'tasks':
        // Focus on task input
        const taskInput = document.getElementById('newTaskTitle');
        if (taskInput) {
          taskInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
          setTimeout(() => taskInput.focus(), 300);
        }
        break;
      case 'pomodoro':
        // Start/pause pomodoro
        const pomodoroStartBtn = document.querySelector('.pomodoro-btn.primary');
        pomodoroStartBtn?.click();
        break;
      case 'planner':
        // Open planner add task
        const plannerAddBtn = document.querySelector('.planner-add-task-btn');
        plannerAddBtn?.click();
        break;
      case 'calendar':
        // Focus on event input
        const eventInput = document.getElementById('eventName');
        if (eventInput) {
          document.querySelector('.mobile-nav-item[data-view="countdown"]')?.click();
          setTimeout(() => {
            eventInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            eventInput.focus();
          }, 350);
        }
        break;
    }
  });
})();
</script>

</body>
</html>
